<!DOCTYPE html>
<html lang="zh-tw">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Uber Driver 夥伴收入計算器 V8.3</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .container { max-width: 1000px; }
        .net-profit { color: #10b981; } /* 綠色 */
        .cost-val { color: #f87171; } /* 紅色 */
        .input-group label { font-weight: 600; color: #4b5563; }
        .card { background-color: #ffffff; border-radius: 0.75rem; padding: 1.5rem; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1); }
        
        /* Loading Overlay Styles */
        #loading-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255, 255, 255, 0.95); z-index: 1000;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            text-align: center;
        }
        .spinner { border: 4px solid rgba(0, 0, 0, 0.1); border-top: 4px solid #3b82f6; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .hidden { display: none !important; }

        /* Message Area Styles */
        #message-area {
            position: fixed; top: 1rem; right: 1rem; z-index: 1001;
            max-width: 90%;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        .alert {
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            font-size: 0.9rem;
        }
        .alert.info { background-color: #e0f2fe; border-color: #90cdf4; color: #2b6cb0; }
        .alert.success { background-color: #d1fae5; border-color: #68d391; color: #2f855a; }
        .alert.error { background-color: #fee2e2; border-color: #fc8181; color: #c53030; }

        /* Icon Styling */
        .icon {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 1.25rem;
            height: 1.25rem;
            margin-right: 0.5rem;
            color: currentColor;
        }

        /* Input Styles */
        input[type="number"], input[type="date"], input[type="text"] {
            border: 1px solid #d1d5db;
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            width: 100%;
            font-size: 1rem;
            outline: none;
            transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
        }
        input[type="number"]:focus, input[type="date"]:focus, input[type="text"]:focus {
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.25);
        }

        /* Button Styles */
        button {
            padding: 0.75rem 1.25rem;
            border-radius: 0.5rem;
            font-weight: 600;
            transition: background-color 0.15s ease-in-out, transform 0.1s ease-in-out;
            cursor: pointer;
            border: none;
        }
        button:hover {
            transform: translateY(-1px);
        }
        button:active {
            transform: translateY(0);
        }
        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .btn-primary { background-color: #3b82f6; color: white; }
        .btn-primary:hover:not(:disabled) { background-color: #2563eb; }
        .btn-secondary { background-color: #6b7280; color: white; }
        .btn-secondary:hover:not(:disabled) { background-color: #4b5563; }
        .btn-success { background-color: #10b981; color: white; }
        .btn-success:hover:not(:disabled) { background-color: #059669; }
        .btn-warning { background-color: #f59e0b; color: white; }
        .btn-warning:hover:not(:disabled) { background-color: #d97706; }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 font-sans">

    <div id="loading-overlay">
        <div class="spinner"></div>
        <p id="loading-text" class="mt-4 text-lg text-gray-600">連線雲端資料庫與油價中...</p>
        <p id="user-info" class="mt-2 text-sm text-gray-500"></p>
        <p id="message-area-load" class="mt-4 text-red-600 font-medium"></p>
    </div>
    
    <div id="app-content" class="container mx-auto p-4 sm:p-6 lg:p-8 pt-8 hidden">
        <header class="mb-8 text-center">
            <h1 class="text-3xl sm:text-4xl font-extrabold text-blue-700">Uber Driver 淨利計算機 V8.3</h1>
            <p id="user-id-display" class="text-sm text-gray-500 mt-2">ID: 加載中...</p>
        </header>

        <div id="message-area"></div>

        <main class="space-y-6">

            <div class="card">
                <h2 class="text-xl font-bold mb-4 text-gray-800 flex items-center">
                    <svg class="icon text-blue-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                    </svg>
                    成本參數設定 (雲端儲存)
                </h2>
                <div class="space-y-4 mb-4">
                    <div>
                        <label for="fuelEfficiencyInput" class="block text-sm font-medium text-gray-700 mb-1">油耗效率 (km/L)</label>
                        <input type="number" id="fuelEfficiencyInput" min="1" step="0.1" class="w-full">
                        <p id="fuelEfficiencyDisplay" class="text-xs text-gray-500 mt-1">目前: 42 km/L</p>
                    </div>
                    <div>
                        <label for="maintCostInput" class="block text-sm font-medium text-gray-700 mb-1">每公里支出耗材 ($/km)</label>
                        <input type="number" id="maintCostInput" min="0" step="0.01" class="w-full">
                        <p id="maintCostDisplay" class="text-xs text-gray-500 mt-1">目前: $0.60/km</p>
                    </div>
                </div>
                <button onclick="saveConfig()" class="btn-success w-full">儲存設定至雲端</button>
            </div>

            <div class="card">
                <h2 class="text-xl font-bold mb-4 text-gray-800 flex items-center">
                    <svg class="icon text-green-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"/>
                    </svg>
                    當日數據輸入
                </h2>
                
                <div class="space-y-4">
                    <div class="flex items-center space-x-2 p-3 bg-blue-50 rounded-lg">
                        <img src="https://www.flaticon.com/svg/static/icons/svg/855/855913.svg" alt="Oil Pump" class="w-6 h-6">
                        <span id="oilPriceDisplayMain" class="text-lg font-bold text-blue-700">中油 92 汽油: 加載中...</span>
                        <button id="fetchOilPriceButton" onclick="fetchOilPrice()" class="btn-primary ml-auto text-sm">更新油價</button>
                    </div>

                    <div>
                        <label for="recordDate" class="block text-sm font-medium text-gray-700 mb-1">記錄日期</label>
                        <input type="date" id="recordDate" class="w-full">
                    </div>

                    <div>
                        <label for="income" class="block text-sm font-medium text-gray-700 mb-1">當日營業額 (實收/未扣)</label>
                        <input type="number" id="income" value="0" min="0" step="10" placeholder="輸入金額">
                    </div>

                    <div>
                        <label for="mileage" class="block text-sm font-medium text-gray-700 mb-1">當日騎乘公里數 (km)</label>
                        <input type="number" id="mileage" value="0" min="0" step="1" placeholder="輸入公里數 (允許小數)">
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label for="hours" class="block text-sm font-medium text-gray-700 mb-1">工作時數 (小時)</label>
                            <input type="number" id="hours" value="0" min="0" step="1" placeholder="0">
                        </div>
                        <div>
                            <label for="minutes" class="block text-sm font-medium text-gray-700 mb-1">工作時數 (分鐘)</label>
                            <input type="number" id="minutes" value="0" min="0" step="5" max="59" placeholder="0">
                        </div>
                    </div>
                </div>

                <div class="mt-6 p-4 bg-gray-50 rounded-lg border border-gray-200">
                    <h3 class="text-md font-semibold mb-3 text-gray-700 flex items-center">
                        <svg class="icon text-yellow-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
                        </svg>
                        即時預估結果
                    </h3>
                    <div class="grid grid-cols-2 gap-y-2 text-sm">
                        <span class="text-gray-600">營業額:</span> <span id="liveGrossIncome" class="font-bold text-blue-600">$0.0</span>
                        <span class="text-gray-600">總成本:</span> <span id="liveTotalCost" class="font-bold text-red-700">$0.0</span>
                        <span class="text-gray-600">淨利:</span> <span id="liveNetProfit" class="font-bold net-profit">$0.0</span>
                        <span class="text-gray-600">油費:</span> <span id="liveGasCost" class="font-bold cost-val">$0.0</span>
                        <span class="text-gray-600">時薪 (毛利):</span> <span id="liveGrossHourly" class="font-bold text-blue-600">$0.0/hr</span>
                        <span class="text-gray-600">耗材:</span> <span id="liveMaintCost" class="font-bold cost-val">$0.0</span>
                    </div>
                    <div class="mt-2 text-sm flex justify-between">
                        <span class="text-gray-600">時薪 (淨利):</span> <span id="liveNetHourly" class="font-bold net-profit">$0.0/hr</span>
                    </div>
                </div>

                <button id="saveDailyRecordButton" class="btn-primary w-full mt-6 flex items-center justify-center">
                    <svg class="icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/>
                    </svg>
                    儲存到雲端 (正式記錄)
                </button>
            </div>

            <div class="card">
                <h2 class="text-xl font-bold mb-4 text-gray-800 flex items-center">
                    <svg class="icon text-purple-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
                    </svg>
                    淨利報表總覽
                </h2>
                <div class="flex space-x-2 mb-4">
                    <button class="btn-secondary w-full" onclick="loadReport('day')">日</button>
                    <button class="btn-secondary w-full" onclick="loadReport('week')">週</button>
                    <button class="btn-secondary w-full" onclick="loadReport('month')">月</button>
                    <button class="btn-secondary w-full" onclick="loadReport('year')">年</button>
                </div>
                
                <div class="flex items-center justify-between mb-4">
                    <button onclick="changeReportDate(-1)" class="p-2 rounded-full hover:bg-gray-200">
                        <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
                    </button>
                    <span id="reportDateRange" class="font-semibold text-lg text-gray-700">2025/11/22</span>
                    <button onclick="changeReportDate(1)" class="p-2 rounded-full hover:bg-gray-200">
                        <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                    </button>
                </div>

                <div class="grid grid-cols-2 gap-3 text-sm mb-4">
                    <div class="bg-blue-50 p-3 rounded-lg"><span class="block text-gray-600">總收入 (期間)</span><span id="reportTotalIncome" class="font-bold text-blue-700">$0</span></div>
                    <div class="bg-green-50 p-3 rounded-lg"><span class="block text-gray-600">實領淨利</span><span id="reportNetProfit" class="font-bold text-green-700">$0</span></div>
                    <div class="bg-yellow-50 p-3 rounded-lg"><span class="block text-gray-600">總花費時間</span><span id="reportTotalHours" class="font-bold text-yellow-700">0 小時 0 分</span></div>
                    <div class="bg-red-50 p-3 rounded-lg"><span class="block text-gray-600">總消耗成本</span><span id="reportTotalCost" class="font-bold text-red-700">$0</span></div>
                    <div class="bg-blue-100 p-3 rounded-lg"><span class="block text-gray-600">平均時薪 (毛利)</span><span id="reportGrossHourly" class="font-bold text-blue-800">$0/hr</span></div>
                    <div class="bg-green-100 p-3 rounded-lg"><span class="block text-gray-600">平均時薪 (淨利)</span><span id="reportNetHourly" class="font-bold text-green-800">$0/hr</span></div>
                    <div class="bg-gray-50 p-3 rounded-lg col-span-2"><span class="block text-gray-600">總里程 (km)</span><span id="reportTotalMileage" class="font-bold text-gray-800">0.0</span></div>
                </div>

                <h3 class="font-semibold text-gray-700 mb-2">期間記錄明細:</h3>
                <div id="reportDetails" class="space-y-2 text-sm text-gray-700">
                    <p>此期間尚未有記錄。</p>
                </div>

                <div class="mt-8 relative h-64">
                    <canvas id="costChart"></canvas>
                </div>
            </div>
        </main>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.0/firebase-firestore-compat.js"></script>

  // --- 核心常數 (預設值) ---
const DEFAULT_FUEL_EFFICIENCY_KML = 42;
const DEFAULT_MAINT_COST_PER_KM = 0.60;
// ⚠️ 注意: 請務必替換此處的 YOUR_GEMINI_API_KEY
const GEMINI_API_KEY = "您從 Google AI Studio 複製的 Key 數值"; // <--- 請替換為您從 Google AI Studio 取得的 Key 數值！

// 1. Firebase 專案配置 (請從您的 Firebase Console 取得)
const FIREBASE_CONFIG = {
    apiKey: "AIzaSyDr9X3uH8s6W7V4c2B1a0F5E9D8C7B6A5", // 請替換為您的正確 API Key (這個是範例 Key)
    authDomain: "uber-driver-tracker.firebaseapp.com",
    projectId: "uber-driver-tracker",
    storageBucket: "uber-driver-tracker.firebasestorage.app",
    messagingSenderId: "665088105970",
    appId: "1:665088105970:web:d2c73e4e43ee4cf9545f6b"
};
const appId = FIREBASE_CONFIG.appId;

// App 核心狀態變數
let db = null;
let auth = null;
let userId = null;
let isAuthReady = false;
let currentOilPrice = 30.0; // 預設值，如果 API 獲取失敗則使用此值
let chartInstance = null; // 圓餅圖實例
let userConfig = {
    fuelEfficiency: DEFAULT_FUEL_EFFICIENCY_KML,
    maintCostPerKm: DEFAULT_MAINT_COST_PER_KM
};
let currentReportDate = new Date(); // 報表目前的日期
let currentReportType = 'day'; // 報表目前的類型 (day, week, month, year)


// 工具函數
const configDocPath = (uid) => `artifacts/${appId}/users/${uid}/config/costs`;
const recordsCollectionPath = (uid) => `artifacts/${appId}/users/${uid}/records`;

/** 顯示應用程式訊息 (成功/錯誤/資訊) */
function showMessage(text, type = 'info') {
    const area = document.getElementById('message-area');
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert ${type}`;
    alertDiv.innerHTML = `
        <span class="icon">${type === 'success' ? '✅' : type === 'error' ? '❌' : 'ℹ️'}</span>
        ${text}
    `;
    area.appendChild(alertDiv);
    
    setTimeout(() => {
        alertDiv.remove();
    }, 5000);
}

/** 將日期格式化為 YYYY-MM-DD (用於 Input) */
function formatDate(date) {
    const d = new Date(date);
    const year = d.getFullYear();
    const month = String(d.getMonth() + 1).padStart(2, '0');
    const day = String(d.getDate()).padStart(2, '0');
    return `${year}-${month}-${day}`;
}

/** 將日期格式化為 YYYY/MM/DD (用於顯示) */
function formatDisplayDate(date) {
    const d = new Date(date);
    const year = d.getFullYear();
    const month = String(d.getMonth() + 1).padStart(2, '0');
    const day = String(d.getDate()).padStart(2, '0');
    return `${year}/${month}/${day}`;
}

/** 解析 YYYY-MM-DD 字串為 Date 物件 */
function parseDate(dateString) {
    const [year, month, day] = dateString.split('-').map(Number);
    // 必須使用 UTC 函數來避免時區偏移，確保日期一致性
    return new Date(Date.UTC(year, month - 1, day));
}

// --- Firebase 初始化與認證 (使用 -compat 模式) ---
function initFirebase() {
    try {
        const app = firebase.initializeApp(FIREBASE_CONFIG);
        db = app.firestore();
        auth = app.auth();
        
        auth.onAuthStateChanged(async (user) => {
            if (user) {
                userId = user.uid;
                isAuthReady = true;
                document.getElementById('user-id-display').textContent = `ID: ${userId}`;
                
                document.getElementById('loading-overlay').classList.add('hidden');
                document.getElementById('app-content').classList.remove('hidden');

                await loadConfig();
                // 需求 1: 在載入時直接獲取油價
                await fetchOilPrice(true); 
                initApp();
                
            } else if (!isAuthReady) {
                console.log("嘗試匿名登入...");
                await auth.signInAnonymously(); 
            }
        });

    } catch (error) {
        console.error("Firebase 初始化失敗:", error);
        document.getElementById('loading-text').textContent = "雲端初始化失敗，請檢查設定。";
        document.getElementById('message-area-load').textContent = "錯誤: " + error.message;
    }
}

// --- 應用程式啟動 (在 Firebase 登入後呼叫) ---
window.initApp = function() {
    // 註冊 Chart.js 插件
    Chart.register(ChartDataLabels);
    
    // 綁定輸入框事件
    document.getElementById('income').addEventListener('input', liveCalculate);
    document.getElementById('mileage').addEventListener('input', liveCalculate);
    document.getElementById('hours').addEventListener('input', liveCalculate);
    document.getElementById('minutes').addEventListener('input', liveCalculate);
    
    // 成本參數設定輸入框事件
    document.getElementById('fuelEfficiencyInput').addEventListener('input', liveCalculate);
    document.getElementById('maintCostInput').addEventListener('input', liveCalculate);
    
    // 日期選擇器初始化
    const today = new Date();
    document.getElementById('recordDate').value = formatDate(today);
    // document.getElementById('recordDate').addEventListener('change', liveCalculate); // 日期改變不影響當前計算

    // 儲存按鈕事件
    document.getElementById('saveDailyRecordButton').addEventListener('click', saveDailyRecord);

    // 初始化報表
    loadReport(currentReportType);

    // 確保首次計算
    liveCalculate();
}


// --- 設定檔讀寫 (已包含在 V8.3 程式碼中) ---
async function loadConfig() {
    const docRef = db.doc(configDocPath(userId));
    try {
        const doc = await docRef.get();
        if (doc.exists) {
            const data = doc.data();
            userConfig.fuelEfficiency = parseFloat(data.fuelEfficiency) || DEFAULT_FUEL_EFFICIENCY_KML;
            userConfig.maintCostPerKm = parseFloat(data.maintCostPerKm) || DEFAULT_MAINT_COST_PER_KM;
            showMessage("成功載入個人化成本設定。", 'success');
        } else {
            // 寫入預設設定到雲端
            await saveConfig(true); 
            showMessage("首次登入，已載入預設成本設定。", 'info');
        }
        
        // 更新 UI 顯示
        document.getElementById('fuelEfficiencyInput').value = userConfig.fuelEfficiency;
        document.getElementById('fuelEfficiencyDisplay').textContent = `目前: ${userConfig.fuelEfficiency.toFixed(2)} km/L`;
        document.getElementById('maintCostInput').value = userConfig.maintCostPerKm;
        document.getElementById('maintCostDisplay').textContent = `目前: $${userConfig.maintCostPerKm.toFixed(2)}/km`;

    } catch (error) {
        console.error("載入設定檔失敗:", error);
        showMessage("載入設定檔失敗，使用預設值。", 'error');
    }
}

async function saveConfig(isInitial = false) {
    const docRef = db.doc(configDocPath(userId));
    
    // 從輸入框取得最新值
    userConfig.fuelEfficiency = parseFloat(document.getElementById('fuelEfficiencyInput').value) || DEFAULT_FUEL_EFFICIENCY_KML;
    userConfig.maintCostPerKm = parseFloat(document.getElementById('maintCostInput').value) || DEFAULT_MAINT_COST_PER_KM;

    try {
        await docRef.set({
            fuelEfficiency: userConfig.fuelEfficiency,
            maintCostPerKm: userConfig.maintCostPerKm
        }, { merge: true });

        // 更新 UI 顯示 (確保數值顯示一致)
        document.getElementById('fuelEfficiencyDisplay').textContent = `目前: ${userConfig.fuelEfficiency.toFixed(2)} km/L`;
        document.getElementById('maintCostDisplay').textContent = `目前: $${userConfig.maintCostPerKm.toFixed(2)}/km`;

        if (!isInitial) {
            showMessage("個人化成本設定已成功儲存到雲端。", 'success');
        }
        liveCalculate(); // 儲存後重新計算
    } catch (error) {
        console.error("儲存設定檔失敗:", error);
        showMessage("儲存設定檔失敗，請檢查網路。", 'error');
    }
}


// --- 獲取油價 (已優化，並符合需求 1: 載入時自動執行) ---
async function fetchOilPrice(isInitialLoad = false) {
    // 初始載入時不顯示 Toast，但顯示在 Loading 頁面上
    if (!isInitialLoad) {
        document.getElementById('fetchOilPriceButton').disabled = true;
        document.getElementById('oilPriceDisplayMain').textContent = "中油 92 汽油: 獲取中...";
    }
    
    // 獲取油價的 Prompt
    const prompt = `請以簡短的 JSON 格式提供台灣中油最新的 92 無鉛汽油價格 (每公升)。僅輸出 JSON，不要解釋。
    格式範例: {"price": 27.1, "unit": "NTD/L"}`;
    
    const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${GEMINI_API_KEY}`;

    try {
        const response = await fetch(API_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                contents: [{ parts: [{ text: prompt }] }],
                config: {
                    temperature: 0.1,
                    responseMimeType: "application/json",
                    responseSchema: {
                        type: "object",
                        properties: {
                            price: { type: "number", description: "最新的 92 無鉛汽油價格" },
                            unit: { type: "string", description: "價格單位，如 NTD/L" }
                        }
                    }
                }
            })
        });

        if (!response.ok) throw new Error(`API 錯誤：${response.status}`);

        const data = await response.json();
        let price = 0;

        // 解析 Gemini 的回應
        try {
            const responseText = data.candidates[0].content.parts[0].text;
            const jsonObject = JSON.parse(responseText.trim());
            price = parseFloat(jsonObject.price);
        } catch (e) {
             // 如果 JSON 解析失敗，嘗試從純文字回應中提取數字 (備用邏輯)
             console.warn("JSON解析失敗，嘗試從純文字提取...");
             const textMatch = data.candidates[0].content.parts[0].text.match(/(\d+\.?\d*)/);
             if (textMatch) {
                 price = parseFloat(textMatch[0]);
             } else {
                 throw new Error("無法從 API 回應中提取油價數值。");
             }
        }
        
        if (isNaN(price) || price <= 0) throw new Error("獲取到無效的油價數值。");
        
        currentOilPrice = price;
        
        // 更新 UI
        const display = `中油 92 汽油: $${currentOilPrice.toFixed(2)}/L`;
        document.getElementById('oilPriceDisplayMain').textContent = display;
        if (!isInitialLoad) {
            showMessage(`油價更新成功: ${currentOilPrice.toFixed(2)} NTD/L`, 'success');
        } else {
             document.getElementById('loading-text').textContent = `連線成功，油價: $${currentOilPrice.toFixed(2)}/L`;
        }
        liveCalculate(); // 油價更新後重新計算

    } catch (error) {
        const errorMessage = `油價獲取失敗：使用預設值 $${currentOilPrice.toFixed(2)}/L。(${error.message || '網路/API 錯誤'})`;
        document.getElementById('oilPriceDisplayMain').textContent = errorMessage;
        showMessage(errorMessage, 'error');
        console.error("油價獲取失敗:", error);
    } finally {
        if (!isInitialLoad) {
            document.getElementById('fetchOilPriceButton').disabled = false;
        }
    }
}


// --- 即時計算邏輯 ---
function liveCalculate() {
    // 1. 取得輸入值
    const income = parseFloat(document.getElementById('income').value) || 0;
    const mileage = parseFloat(document.getElementById('mileage').value) || 0;
    const hours = parseFloat(document.getElementById('hours').value) || 0;
    const minutes = parseFloat(document.getElementById('minutes').value) || 0;

    // 2. 取得成本參數 (使用輸入框的當前值)
    const fuelEfficiency = parseFloat(document.getElementById('fuelEfficiencyInput').value) || DEFAULT_FUEL_EFFICIENCY_KML;
    const maintCostPerKm = parseFloat(document.getElementById('maintCostInput').value) || DEFAULT_MAINT_COST_PER_KM;

    // 3. 計算成本
    const gasCostPerKm = currentOilPrice / fuelEfficiency; // $/km
    const gasTotalCost = gasCostPerKm * mileage; // 總油費
    const maintTotalCost = maintCostPerKm * mileage; // 總耗材費
    const totalCost = gasTotalCost + maintTotalCost; // 總成本

    // 4. 計算淨利
    const netProfit = income - totalCost;

    // 5. 計算時薪
    const totalHours = hours + (minutes / 60);
    const netHourlyRate = totalHours > 0 ? netProfit / totalHours : 0;
    const grossHourlyRate = totalHours > 0 ? income / totalHours : 0; // 毛時薪

    // 6. 更新 UI 顯示 (即時預估結果)
    document.getElementById('liveGrossIncome').textContent = `$${income.toFixed(1)}`;
    document.getElementById('liveTotalCost').textContent = `$${totalCost.toFixed(1)}`;
    document.getElementById('liveNetProfit').textContent = `$${netProfit.toFixed(1)}`;
    document.getElementById('liveGasCost').textContent = `$${gasTotalCost.toFixed(1)}`;
    document.getElementById('liveMaintCost').textContent = `$${maintTotalCost.toFixed(1)}`;
    document.getElementById('liveGrossHourly').textContent = `$${grossHourlyRate.toFixed(1)}/hr`;
    document.getElementById('liveNetHourly').textContent = `$${netHourlyRate.toFixed(1)}/hr`;

    // 7. 更新圓餅圖
    updateChart(netProfit, totalCost);
}

// --- 圓餅圖更新 (已優化，現在只顯示淨利、油費和耗材費) ---
function updateChart(netProfit = 0, totalCost = 0) {
    const income = parseFloat(document.getElementById('income').value) || 0;
    const mileage = parseFloat(document.getElementById('mileage').value) || 0;
    
    // 如果沒有收入或里程數，則不繪圖
    if (income <= 0 && mileage <= 0) {
        if (chartInstance) {
            chartInstance.destroy(); // 銷毀舊圖表
            chartInstance = null;
        }
        return;
    }

    // 重新計算成本細項（以確保與 liveCalculate 同步）
    const fuelEfficiency = parseFloat(document.getElementById('fuelEfficiencyInput').value) || DEFAULT_FUEL_EFFICIENCY_KML;
    const maintCostPerKm = parseFloat(document.getElementById('maintCostInput').value) || DEFAULT_MAINT_COST_PER_KM;
    const gasCostPerKm = currentOilPrice / fuelEfficiency;
    const gasTotalCost = gasCostPerKm * mileage;
    const maintTotalCost = maintCostPerKm * mileage;

    const data = {
        labels: ['淨利', '油費成本', '耗材成本'],
        datasets: [{
            data: [netProfit > 0 ? netProfit : 0.1, gasTotalCost, maintTotalCost], // 確保淨利為正
            backgroundColor: ['#10b981', '#f59e0b', '#f87171'], // 綠色, 黃色, 紅色
            hoverBackgroundColor: ['#059669', '#d97706', '#ef4444'],
            borderWidth: 0
        }]
    };

    const ctx = document.getElementById('costChart').getContext('2d');

    if (chartInstance) {
        chartInstance.data = data;
        chartInstance.update();
    } else {
        chartInstance = new Chart(ctx, {
            type: 'doughnut',
            data: data,
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const label = context.label || '';
                                if (label) {
                                    const value = context.parsed;
                                    const percentage = (value / income) * 100;
                                    return `${label}: $${value.toFixed(1)} (${percentage.toFixed(1)}%)`;
                                }
                                return null;
                            }
                        }
                    },
                    datalabels: {
                        formatter: (value, context) => {
                             if (income > 0) {
                                return (value / income * 100).toFixed(1) + '%';
                            }
                            return '';
                        },
                        color: '#fff',
                        font: {
                            weight: 'bold'
                        }
                    }
                }
            }
        });
    }
}

// --- 每日記錄儲存 (新功能) ---
async function saveDailyRecord() {
    document.getElementById('saveDailyRecordButton').disabled = true;
    const btnText = document.getElementById('saveDailyRecordButton').textContent;
    document.getElementById('saveDailyRecordButton').textContent = "儲存中...";

    const income = parseFloat(document.getElementById('income').value) || 0;
    const mileage = parseFloat(document.getElementById('mileage').value) || 0;
    const hours = parseFloat(document.getElementById('hours').value) || 0;
    const minutes = parseFloat(document.getElementById('minutes').value) || 0;
    const recordDateString = document.getElementById('recordDate').value;
    const recordDate = parseDate(recordDateString);
    
    // 檢查基本數據
    if (income <= 0 || mileage <= 0 || (hours <= 0 && minutes <= 0)) {
        showMessage("請填寫有效的營業額、里程和工作時數。", 'warning');
        document.getElementById('saveDailyRecordButton').disabled = false;
        document.getElementById('saveDailyRecordButton').textContent = btnText;
        return;
    }

    // 重新計算所有值 (確保記錄精準)
    const fuelEfficiency = parseFloat(document.getElementById('fuelEfficiencyInput').value) || DEFAULT_FUEL_EFFICIENCY_KML;
    const maintCostPerKm = parseFloat(document.getElementById('maintCostInput').value) || DEFAULT_MAINT_COST_PER_KM;
    const gasCostPerKm = currentOilPrice / fuelEfficiency;
    const gasTotalCost = gasCostPerKm * mileage;
    const maintTotalCost = maintCostPerKm * mileage;
    const totalCost = gasTotalCost + maintTotalCost;
    const netProfit = income - totalCost;
    const totalMinutes = (hours * 60) + minutes;

    const record = {
        date: recordDate, // Firestore 的 Date object (UTC)
        dateString: recordDateString, // YYYY-MM-DD
        income: income,
        mileage: mileage,
        totalMinutes: totalMinutes,
        gasCost: gasTotalCost,
        maintCost: maintTotalCost,
        totalCost: totalCost,
        netProfit: netProfit,
        oilPrice: currentOilPrice,
        fuelEfficiency: fuelEfficiency,
        maintCostPerKm: maintCostPerKm,
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
    };

    try {
        await db.collection(recordsCollectionPath(userId)).add(record);
        showMessage(`記錄於 ${recordDateString} 的數據已成功儲存到雲端！淨利: $${netProfit.toFixed(1)}`, 'success');
        
        // 儲存成功後，清空輸入欄位
        document.getElementById('income').value = 0;
        document.getElementById('mileage').value = 0;
        document.getElementById('hours').value = 0;
        document.getElementById('minutes').value = 0;
        liveCalculate();
        
        // 重新載入報表以顯示新數據
        loadReport(currentReportType);

    } catch (error) {
        console.error("儲存每日記錄失敗:", error);
        showMessage("儲存每日記錄失敗，請檢查權限。", 'error');
    } finally {
        document.getElementById('saveDailyRecordButton').disabled = false;
        document.getElementById('saveDailyRecordButton').textContent = btnText;
    }
}


// --- 報表載入與計算 (新功能) ---
async function loadReport(type, date = currentReportDate) {
    currentReportType = type;
    currentReportDate = new Date(date); // 更新當前日期

    const { startDate, endDate, displayRange } = getDateRange(currentReportType, currentReportDate);

    document.getElementById('reportDateRange').textContent = displayRange;

    // 獲取數據
    const recordsRef = db.collection(recordsCollectionPath(userId))
        .where('date', '>=', startDate)
        .where('date', '<', endDate)
        .orderBy('date', 'desc'); 
        // 由於 Firestore 不允許在 date 欄位上進行不等式過濾後再以不同的欄位排序，所以直接用 date 排序

    try {
        const snapshot = await recordsRef.get();
        const records = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

        // 彙總計算
        let totalIncome = 0;
        let totalCost = 0;
        let totalNetProfit = 0;
        let totalMinutes = 0;
        let totalMileage = 0;

        records.forEach(r => {
            totalIncome += r.income;
            totalCost += r.totalCost;
            totalNetProfit += r.netProfit;
            totalMinutes += r.totalMinutes;
            totalMileage += r.mileage;
        });

        const totalHours = totalMinutes / 60;
        const netHourlyRate = totalHours > 0 ? totalNetProfit / totalHours : 0;
        const grossHourlyRate = totalHours > 0 ? totalIncome / totalHours : 0;
        
        // 更新 UI (總覽區塊)
        document.getElementById('reportTotalIncome').textContent = `$${totalIncome.toFixed(0)}`;
        document.getElementById('reportNetProfit').textContent = `$${totalNetProfit.toFixed(0)}`;
        document.getElementById('reportTotalHours').textContent = `${Math.floor(totalHours)} 小時 ${Math.round((totalHours % 1) * 60)} 分`;
        document.getElementById('reportTotalCost').textContent = `$${totalCost.toFixed(0)}`;
        document.getElementById('reportGrossHourly').textContent = `$${grossHourlyRate.toFixed(1)}/hr`;
        document.getElementById('reportNetHourly').textContent = `$${netHourlyRate.toFixed(1)}/hr`;
        document.getElementById('reportTotalMileage').textContent = `${totalMileage.toFixed(1)}`;
        
        // 更新 UI (明細區塊)
        const detailsEl = document.getElementById('reportDetails');
        detailsEl.innerHTML = ''; // 清空舊內容

        if (records.length === 0) {
            detailsEl.innerHTML = '<p class="text-gray-500">此期間尚未有記錄。</p>';
        } else {
            records.forEach(r => {
                const item = document.createElement('div');
                item.className = 'p-3 border-b border-gray-200 flex justify-between items-center hover:bg-gray-50';
                
                const datePart = `<span class="font-semibold">${formatDisplayDate(r.date.toDate())}</span>`;
                const profitPart = `<span class="font-bold ${r.netProfit > 0 ? 'text-green-600' : 'text-red-600'}">$${r.netProfit.toFixed(0)} 淨利</span>`;
                const infoPart = `<span class="text-xs text-gray-500 ml-2">(${r.totalMinutes}m, ${r.mileage.toFixed(1)}km)</span>`;
                
                item.innerHTML = `<div>${datePart}</div><div>${profitPart}${infoPart}</div>`;
                detailsEl.appendChild(item);
            });
        }

        // 更新報表圓餅圖 (將收入總數用於計算百分比)
        updateReportChart(totalNetProfit, totalCost, totalIncome);

    } catch (error) {
        console.error("載入報表失敗:", error);
        showMessage("載入報表失敗，請檢查網路或權限。", 'error');
    }
}

// --- 報表圓餅圖 (專門用於報表) ---
function updateReportChart(totalNetProfit, totalCost, totalIncome) {
    // 這裡我們只顯示淨利和總成本的比例
    const gasTotalCost = 0; // 由於報表是彙總，可能沒有 gas/maint 細項，這裡簡化為總成本
    const maintTotalCost = totalCost; // 將總成本視為一個整體

    if (totalIncome <= 0) {
        if (chartInstance) {
            chartInstance.destroy();
            chartInstance = null;
        }
        return;
    }

    const data = {
        labels: ['總淨利', '總成本'],
        datasets: [{
            data: [totalNetProfit > 0 ? totalNetProfit : 0.1, totalCost], 
            backgroundColor: ['#10b981', '#f87171'], // 綠色, 紅色
            hoverBackgroundColor: ['#059669', '#ef4444'],
            borderWidth: 0
        }]
    };

    const ctx = document.getElementById('costChart').getContext('2d');

    if (chartInstance) {
        chartInstance.data = data;
        chartInstance.options.plugins.tooltip.callbacks.label = function(context) {
             const label = context.label || '';
            if (label) {
                const value = context.parsed;
                const percentage = (value / totalIncome) * 100;
                return `${label}: $${value.toFixed(0)} (${percentage.toFixed(1)}%)`;
            }
            return null;
        };
        chartInstance.options.plugins.datalabels.formatter = (value) => {
             if (totalIncome > 0) {
                return (value / totalIncome * 100).toFixed(1) + '%';
            }
            return '';
        };
        chartInstance.update();
    } else {
        // ... (Chart 初始化代碼與 updateChart 類似，但這裡使用 Report 的數據和配置)
        chartInstance = new Chart(ctx, {
            type: 'doughnut',
            data: data,
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'bottom' },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const label = context.label || '';
                                if (label) {
                                    const value = context.parsed;
                                    const percentage = (value / totalIncome) * 100;
                                    return `${label}: $${value.toFixed(0)} (${percentage.toFixed(1)}%)`;
                                }
                                return null;
                            }
                        }
                    },
                    datalabels: {
                        formatter: (value) => {
                             if (totalIncome > 0) {
                                return (value / totalIncome * 100).toFixed(1) + '%';
                            }
                            return '';
                        },
                        color: '#fff',
                        font: { weight: 'bold' }
                    }
                }
            }
        });
    }
}


// --- 報表日期導航 (新功能) ---
function changeReportDate(direction) {
    const newDate = new Date(currentReportDate);
    
    switch (currentReportType) {
        case 'day':
            newDate.setDate(currentReportDate.getDate() + direction);
            break;
        case 'week':
            newDate.setDate(currentReportDate.getDate() + (direction * 7));
            break;
        case 'month':
            newDate.setMonth(currentReportDate.getMonth() + direction);
            break;
        case 'year':
            newDate.setFullYear(currentReportDate.getFullYear() + direction);
            break;
    }
    currentReportDate = newDate;
    loadReport(currentReportType, currentReportDate);
}

/** 根據類型和中心日期獲取報表期間 (UTC) */
function getDateRange(type, date) {
    const d = new Date(date);
    let startDate, endDate, displayRange;

    // 將日期設置為午夜 (UTC) 以確保 Firestore 過濾的精確性
    d.setUTCHours(0, 0, 0, 0);

    switch (type) {
        case 'day':
            startDate = new Date(d);
            endDate = new Date(d);
            endDate.setDate(d.getDate() + 1);
            displayRange = formatDisplayDate(d);
            break;
        case 'week':
            // 找出本週的開始 (假設週日是第一天)
            const dayOfWeek = d.getDay(); // 0 (Sun) to 6 (Sat)
            startDate = new Date(d);
            startDate.setDate(d.getDate() - dayOfWeek);
            startDate.setUTCHours(0, 0, 0, 0);
            
            endDate = new Date(startDate);
            endDate.setDate(startDate.getDate() + 7);
            
            displayRange = `${formatDisplayDate(startDate)} - ${formatDisplayDate(new Date(endDate.getTime() - 1))}`; // 結束日期往前一天
            break;
        case 'month':
            startDate = new Date(Date.UTC(d.getFullYear(), d.getMonth(), 1));
            endDate = new Date(Date.UTC(d.getFullYear(), d.getMonth() + 1, 1));
            displayRange = `${d.getFullYear()}/${String(d.getMonth() + 1).padStart(2, '0')}`;
            break;
        case 'year':
            startDate = new Date(Date.UTC(d.getFullYear(), 0, 1));
            endDate = new Date(Date.UTC(d.getFullYear() + 1, 0, 1));
            displayRange = `${d.getFullYear()} 年`;
            break;
        default:
            return { startDate: new Date(0), endDate: new Date(0), displayRange: '' };
    }
    
    // 報表按鈕的 onclick 函數需要這個來切換
    document.querySelectorAll('.btn-secondary').forEach(btn => {
        btn.classList.remove('btn-primary', 'bg-blue-600');
        btn.classList.add('btn-secondary', 'bg-gray-600');
    });
    document.querySelector(`[onclick="loadReport('${type}')"]`).classList.add('btn-primary', 'bg-blue-600');

    return { startDate, endDate, displayRange };
}

// --- 啟動應用程式 ---
initFirebase();

// 確保全局可訪問，用於報表切換按鈕
window.loadReport = loadReport;
window.changeReportDate = changeReportDate;
window.saveConfig = saveConfig;
window.fetchOilPrice = fetchOilPrice;
window.liveCalculate = liveCalculate;
