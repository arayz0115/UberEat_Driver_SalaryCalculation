<!DOCTYPE html>
<html lang="zh-tw">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Uber Driver å¤±æ•—ç‰ˆæœ¬ç”¢ç”Ÿå™¨</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .container { max-width: 1000px; }
        .net-profit { color: #10b981; } /* ç¶ è‰² */
        .cost-val { color: #f87171; } /* ç´…è‰² */
        .input-group label { font-weight: 600; color: #4b5563; }
        .card { background-color: #ffffff; border-radius: 0.75rem; padding: 1.5rem; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1); }
        
        /* Loading Overlay Styles */
        #loading-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255, 255, 255, 0.95); z-index: 1000;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            text-align: center;
        }
        .spinner { border: 4px solid rgba(0, 0, 0, 0.1); border-top: 4px solid #3b82f6; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .hidden { display: none !important; }

        /* Message Area Styles */
        #message-area {
            position: fixed; top: 1rem; right: 1rem; z-index: 1001;
            max-width: 90%;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        .alert {
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            font-size: 0.9rem;
        }
        .alert.info { background-color: #e0f2fe; border-color: #90cdf4; color: #2b6cb0; }
        .alert.success { background-color: #d1fae5; border-color: #68d391; color: #2f855a; }
        .alert.error { background-color: #fee2e2; border-color: #fc8181; color: #c53030; }

        /* Icon Styling */
        .icon {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 1.25rem;
            height: 1.25rem;
            margin-right: 0.5rem;
            color: currentColor;
        }

        /* Input Styles */
        input[type="number"], input[type="date"], input[type="text"] {
            border: 1px solid #d1d5db;
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            width: 100%;
            font-size: 1rem;
            outline: none;
            transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
        }
        input[type="number"]:focus, input[type="date"]:focus, input[type="text"]:focus {
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.25);
        }

        /* Button Styles */
        button {
            padding: 0.75rem 1.25rem;
            border-radius: 0.5rem;
            font-weight: 600;
            transition: background-color 0.15s ease-in-out, transform 0.1s ease-in-out;
            cursor: pointer;
            border: none;
        }
        button:hover {
            transform: translateY(-1px);
        }
        button:active {
            transform: translateY(0);
        }
        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .btn-primary { background-color: #3b82f6; color: white; }
        .btn-primary:hover:not(:disabled) { background-color: #2563eb; }
        .btn-secondary { background-color: #6b7280; color: white; }
        .btn-secondary:hover:not(:disabled) { background-color: #4b5563; }
        .btn-success { background-color: #10b981; color: white; }
        .btn-success:hover:not(:disabled) { background-color: #059669; }
        .btn-warning { background-color: #f59e0b; color: white; }
        .btn-warning:hover:not(:disabled) { background-color: #d97706; }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 font-sans">

    <div id="loading-overlay">
        <div class="spinner"></div>
        <p id="loading-text" class="mt-4 text-lg text-gray-600">é€£ç·šé›²ç«¯è³‡æ–™åº«èˆ‡æ²¹åƒ¹ä¸­...</p>
        <p id="user-info" class="mt-2 text-sm text-gray-500"></p>
        <p id="message-area-load" class="mt-4 text-red-600 font-medium"></p>
    </div>
    
    <div id="app-content" class="container mx-auto p-4 sm:p-6 lg:p-8 pt-8 hidden">
        <header class="mb-8 text-center">
            <h1 class="text-3xl sm:text-4xl font-extrabold text-blue-700">Uber Driver é˜¿ç‘å¤±æ•—ç”¢ç”Ÿå™¨ V1.0</h1>
            <p id="user-id-display" class="text-sm text-gray-500 mt-2">ID: åŠ è¼‰ä¸­...</p>
        </header>

        <div id="message-area"></div>

        <main class="space-y-6">

            <div class="card">
                <h2 class="text-xl font-bold mb-4 text-gray-800 flex items-center">
                    <svg class="icon text-blue-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                    </svg>
                    æˆæœ¬åƒæ•¸è¨­å®š (é›²ç«¯å„²å­˜)
                </h2>
                <div class="space-y-4 mb-4">
                    <div>
                        <label for="fuelEfficiencyInput" class="block text-sm font-medium text-gray-700 mb-1">æ²¹è€—æ•ˆç‡ (km/L)</label>
                        <input type="number" id="fuelEfficiencyInput" min="1" step="0.1" class="w-full">
                        <p id="fuelEfficiencyDisplay" class="text-xs text-gray-500 mt-1">ç›®å‰: 42 km/L</p>
                    </div>
                    <div>
                        <label for="maintCostInput" class="block text-sm font-medium text-gray-700 mb-1">æ¯å…¬é‡Œæ”¯å‡ºè€—æ ($/km)</label>
                        <input type="number" id="maintCostInput" min="0" step="0.01" class="w-full">
                        <p id="maintCostDisplay" class="text-xs text-gray-500 mt-1">ç›®å‰: $0.60/km</p>
                    </div>
                </div>
                <button onclick="saveConfig()" class="btn-success w-full">å„²å­˜è¨­å®šè‡³é›²ç«¯</button>
            </div>

            <div class="card">
                <h2 class="text-xl font-bold mb-4 text-gray-800 flex items-center">
                    <svg class="icon text-green-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"/>
                    </svg>
                    ç•¶æ—¥æ•¸æ“šè¼¸å…¥
                </h2>
                
                <div class="space-y-4">
                    <div class="flex items-center space-x-2 p-3 bg-blue-50 rounded-lg">
                        <svg class="w-6 h-6 text-blue-700" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.828 0l-4.243-4.243a8 8 0 1111.314 0z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
                        <span id="oilPriceDisplayMain" class="text-lg font-bold text-blue-700">ä¸­æ²¹ 92 æ±½æ²¹: åŠ è¼‰ä¸­...</span>
                        <button id="fetchOilPriceButton" onclick="fetchOilPrice()" class="btn-primary ml-auto text-sm">æ›´æ–°æ²¹åƒ¹</button>
                    </div>

                    <div>
                        <label for="recordDate" class="block text-sm font-medium text-gray-700 mb-1">è¨˜éŒ„æ—¥æœŸ</label>
                        <input type="date" id="recordDate" class="w-full">
                    </div>

                    <div>
                        <label for="income" class="block text-sm font-medium text-gray-700 mb-1">ç•¶æ—¥ç‡Ÿæ¥­é¡ (å¯¦æ”¶/æœªæ‰£)</label>
                        <input type="number" id="income" value="0" min="0" step="10" placeholder="è¼¸å…¥é‡‘é¡">
                    </div>

                    <div>
                        <label for="mileage" class="block text-sm font-medium text-gray-700 mb-1">ç•¶æ—¥é¨ä¹˜å…¬é‡Œæ•¸ (km)</label>
                        <input type="number" id="mileage" value="0" min="0" step="1" placeholder="è¼¸å…¥å…¬é‡Œæ•¸ (å…è¨±å°æ•¸)">
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label for="hours" class="block text-sm font-medium text-gray-700 mb-1">å·¥ä½œæ™‚æ•¸ (å°æ™‚)</label>
                            <input type="number" id="hours" value="0" min="0" step="1" placeholder="0">
                        </div>
                        <div>
                            <label for="minutes" class="block text-sm font-medium text-gray-700 mb-1">å·¥ä½œæ™‚æ•¸ (åˆ†é˜)</label>
                            <input type="number" id="minutes" value="0" min="0" step="5" max="59" placeholder="0">
                        </div>
                    </div>
                </div>

                <div class="mt-6 p-4 bg-gray-50 rounded-lg border border-gray-200">
                    <h3 class="text-md font-semibold mb-3 text-gray-700 flex items-center">
                        <svg class="icon text-yellow-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
                        </svg>
                        å³æ™‚é ä¼°çµæœ
                    </h3>
                    <div class="grid grid-cols-2 gap-y-2 text-sm">
                        <span class="text-gray-600">ç‡Ÿæ¥­é¡:</span> <span id="liveGrossIncome" class="font-bold text-blue-600">$0.0</span>
                        <span class="text-gray-600">ç¸½æˆæœ¬:</span> <span id="liveTotalCost" class="font-bold text-red-700">$0.0</span>
                        <span class="text-gray-600">æ·¨åˆ©:</span> <span id="liveNetProfit" class="font-bold net-profit">$0.0</span>
                        <span class="text-gray-600">æ²¹è²»:</span> <span id="liveGasCost" class="font-bold cost-val">$0.0</span>
                        <span class="text-gray-600">æ™‚è–ª (æ¯›åˆ©):</span> <span id="liveGrossHourly" class="font-bold text-blue-600">$0.0/hr</span>
                        <span class="text-gray-600">è€—æ:</span> <span id="liveMaintCost" class="font-bold cost-val">$0.0</span>
                    </div>
                    <div class="mt-2 text-sm flex justify-between">
                        <span class="text-gray-600">æ™‚è–ª (æ·¨åˆ©):</span> <span id="liveNetHourly" class="font-bold net-profit">$0.0/hr</span>
                    </div>
                </div>

                <button id="saveDailyRecordButton" class="btn-primary w-full mt-6 flex items-center justify-center">
                    <svg class="icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/>
                    </svg>
                    å„²å­˜åˆ°é›²ç«¯ (æ­£å¼è¨˜éŒ„)
                </button>
            </div>

            <div class="card">
                <h2 class="text-xl font-bold mb-4 text-gray-800 flex items-center">
                    <svg class="icon text-purple-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
                    </svg>
                    æ·¨åˆ©å ±è¡¨ç¸½è¦½
                </h2>
                <div class="flex space-x-2 mb-4">
                    <button class="btn-secondary w-full" onclick="loadReport('day')">æ—¥</button>
                    <button class="btn-secondary w-full" onclick="loadReport('week')">é€±</button>
                    <button class="btn-secondary w-full" onclick="loadReport('month')">æœˆ</button>
                    <button class="btn-secondary w-full" onclick="loadReport('year')">å¹´</button>
                </div>
                
                <div class="flex items-center justify-between mb-4">
                    <button onclick="changeReportDate(-1)" class="p-2 rounded-full hover:bg-gray-200">
                        <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
                    </button>
                    <span id="reportDateRange" class="font-semibold text-lg text-gray-700">2025/11/22</span>
                    <button onclick="changeReportDate(1)" class="p-2 rounded-full hover:bg-gray-200">
                        <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                    </button>
                </div>

                <div class="grid grid-cols-2 gap-3 text-sm mb-4">
                    <div class="bg-blue-50 p-3 rounded-lg"><span class="block text-gray-600">ç¸½æ”¶å…¥ (æœŸé–“)</span><span id="reportTotalIncome" class="font-bold text-blue-700">$0</span></div>
                    <div class="bg-green-50 p-3 rounded-lg"><span class="block text-gray-600">å¯¦é ˜æ·¨åˆ©</span><span id="reportNetProfit" class="font-bold text-green-700">$0</span></div>
                    <div class="bg-yellow-50 p-3 rounded-lg"><span class="block text-gray-600">ç¸½èŠ±è²»æ™‚é–“</span><span id="reportTotalHours" class="font-bold text-yellow-700">0 å°æ™‚ 0 åˆ†</span></div>
                    <div class="bg-red-50 p-3 rounded-lg"><span class="block text-gray-600">ç¸½æ¶ˆè€—æˆæœ¬</span><span id="reportTotalCost" class="font-bold text-red-700">$0</span></div>
                    <div class="bg-blue-100 p-3 rounded-lg"><span class="block text-gray-600">å¹³å‡æ™‚è–ª (æ¯›åˆ©)</span><span id="reportGrossHourly" class="font-bold text-blue-800">$0/hr</span></div>
                    <div class="bg-green-100 p-3 rounded-lg"><span class="block text-gray-600">å¹³å‡æ™‚è–ª (æ·¨åˆ©)</span><span id="reportNetHourly" class="font-bold text-green-800">$0/hr</span></div>
                    <div class="bg-gray-50 p-3 rounded-lg col-span-2"><span class="block text-gray-600">ç¸½é‡Œç¨‹ (km)</span><span id="reportTotalMileage" class="font-bold text-gray-800">0.0</span></div>
                </div>

                <h3 class="font-semibold text-gray-700 mb-2">æœŸé–“è¨˜éŒ„æ˜ç´°:</h3>
                <div id="reportDetails" class="space-y-2 text-sm text-gray-700">
                    <p>æ­¤æœŸé–“å°šæœªæœ‰è¨˜éŒ„ã€‚</p>
                </div>

                <div class="mt-8 relative h-64">
                    <canvas id="costChart"></canvas>
                </div>
            </div>
        </main>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>
    
    <script src="https://www.gstatic.com/firebasejs/9.1.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.0/firebase-firestore-compat.js"></script>

    <script>
        // --- æ ¸å¿ƒå¸¸æ•¸ (é è¨­å€¼) ---
        const DEFAULT_FUEL_EFFICIENCY_KML = 42;
        const DEFAULT_MAINT_COST_PER_KM = 0.60;
        
        // âš ï¸ æ›¿æ›æ‚¨çš„ Gemini API é‡‘é‘°
        // é€™æ˜¯æ‚¨å …æŒæœ‰æ•ˆçš„é‡‘é‘°ï¼Œè‹¥ä»å ±éŒ¯ 400ï¼Œè«‹å‹™å¿…æŸ¥çœ‹å…¶è©³ç´°éŒ¯èª¤è¨Šæ¯
        const GEMINI_API_KEY = "AIzaSyBJ0mQy-pr1KLYFWjG2KHNnToRNXkDAN-s"; 

        const FIREBASE_CONFIG = {
            // âš ï¸ æ›¿æ›æ‚¨çš„ Firebase API é‡‘é‘°
            apiKey: "AIzaSyAqiTFbvsIkUVUrBmwaR28448EFMg4FO-w", // è«‹æ›¿æ›ç‚ºæ‚¨çš„ Firebase é‡‘é‘°
            authDomain: "uber-driver-tracker.firebaseapp.com",
            projectId: "uber-driver-tracker",
            storageBucket: "uber-driver-tracker.firebasestorage.app",
            messagingSenderId: "665088105970",
            appId: "1:665088105970:web:d2c73e4e43ee4cf9545f6b"
        };
        const appId = FIREBASE_CONFIG.appId;

        // App æ ¸å¿ƒç‹€æ…‹è®Šæ•¸
        let db = null;
        let auth = null;
        let userId = null;
        let isAuthReady = false;
        let currentOilPrice = 27.1; // é è¨­å€¼ï¼Œå¦‚æœ API ç²å–å¤±æ•—å‰‡ä½¿ç”¨æ­¤å€¼
        let chartInstance = null; // åœ“é¤…åœ–å¯¦ä¾‹
        let userConfig = {
            fuelEfficiency: DEFAULT_FUEL_EFFICIENCY_KML,
            maintCostPerKm: DEFAULT_MAINT_COST_PER_KM
        };
        let currentReportDate = new Date(); // å ±è¡¨ç›®å‰çš„æ—¥æœŸ
        let currentReportType = 'day'; // å ±è¡¨ç›®å‰çš„é¡å‹ (day, week, month, year)


        // å·¥å…·å‡½æ•¸
        const configDocPath = (uid) => `artifacts/${appId}/users/${uid}/config/costs`;
        const recordsCollectionPath = (uid) => `artifacts/${appId}/users/${uid}/records`;

        /** é¡¯ç¤ºæ‡‰ç”¨ç¨‹å¼è¨Šæ¯ (æˆåŠŸ/éŒ¯èª¤/è³‡è¨Š) */
        function showMessage(text, type = 'info') {
            const area = document.getElementById('message-area');
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert ${type}`;
            alertDiv.innerHTML = `
                <span class="icon">${type === 'success' ? 'âœ…' : type === 'error' ? 'âŒ' : 'â„¹ï¸'}</span>
                ${text}
            `;
            area.appendChild(alertDiv);
            
            setTimeout(() => {
                alertDiv.remove();
            }, 5000);
        }

        /** å°‡æ—¥æœŸæ ¼å¼åŒ–ç‚º YYYY-MM-DD (ç”¨æ–¼ Input) */
        function formatDate(date) {
            const d = new Date(date);
            const year = d.getFullYear();
            const month = String(d.getMonth() + 1).padStart(2, '0');
            const day = String(d.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        /** å°‡æ—¥æœŸæ ¼å¼åŒ–ç‚º YYYY/MM/DD (ç”¨æ–¼é¡¯ç¤º) */
        function formatDisplayDate(date) {
            const d = new Date(date);
            const year = d.getFullYear();
            const month = String(d.getMonth() + 1).padStart(2, '0');
            const day = String(d.getDate()).padStart(2, '0');
            return `${year}/${month}/${day}`;
        }

        /** è§£æ YYYY-MM-DD å­—ä¸²ç‚º Date ç‰©ä»¶ (UTC) */
        function parseDate(dateString) {
            const [year, month, day] = dateString.split('-').map(Number);
            // å¿…é ˆä½¿ç”¨ UTC å‡½æ•¸ä¾†é¿å…æ™‚å€åç§»ï¼Œç¢ºä¿æ—¥æœŸä¸€è‡´æ€§
            return new Date(Date.UTC(year, month - 1, day));
        }

        /** å°‡ç§’æ•¸è½‰ç‚º H å°æ™‚ M åˆ†é˜ */
        function formatDuration(totalMinutes) {
            const hours = Math.floor(totalMinutes / 60);
            const minutes = Math.round(totalMinutes % 60);
            return `${hours} å°æ™‚ ${minutes} åˆ†`;
        }

        /** æ ¼å¼åŒ–é‡‘é¡ */
        function formatCurrency(amount) {
            return new Intl.NumberFormat('zh-TW', {
                style: 'currency',
                currency: 'TWD',
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(amount);
        }

        // --- Firebase åˆå§‹åŒ–èˆ‡èªè­‰ (ä½¿ç”¨ -compat æ¨¡å¼) ---
        function initFirebase() {
            try {
                // æª¢æŸ¥æ˜¯å¦å·²åˆå§‹åŒ–
                if (firebase.apps.length === 0) {
                    const app = firebase.initializeApp(FIREBASE_CONFIG);
                    db = app.firestore();
                    auth = app.auth();
                } else {
                    const app = firebase.app();
                    db = app.firestore();
                    auth = app.auth();
                }
                
                auth.onAuthStateChanged(async (user) => {
                    if (user) {
                        userId = user.uid;
                        isAuthReady = true;
                        document.getElementById('user-id-display').textContent = `ID: ${userId}`;
                        
                        document.getElementById('loading-overlay').classList.add('hidden');
                        document.getElementById('app-content').classList.remove('hidden');

                        await loadConfig();
                        // éœ€æ±‚ 1: åœ¨è¼‰å…¥æ™‚ç›´æ¥ç²å–æ²¹åƒ¹
                        await fetchOilPrice(true);
                        initApp();
                        
                    } else if (!isAuthReady) {
                        console.log("å˜—è©¦åŒ¿åç™»å…¥...");
                        await auth.signInAnonymously();
                    }
                });

            } catch (error) {
                console.error("Firebase åˆå§‹åŒ–å¤±æ•—:", error);
                document.getElementById('loading-text').textContent = "é›²ç«¯åˆå§‹åŒ–å¤±æ•—ï¼Œè«‹æª¢æŸ¥è¨­å®šã€‚";
                document.getElementById('message-area-load').textContent = "éŒ¯èª¤: " + error.message;
            }
        }

        // --- æ‡‰ç”¨ç¨‹å¼å•Ÿå‹• (åœ¨ Firebase ç™»å…¥å¾Œå‘¼å«) ---
        window.initApp = function() {
            // è¨»å†Š Chart.js æ’ä»¶
            Chart.register(ChartDataLabels);
            
            // ç¶å®šè¼¸å…¥æ¡†äº‹ä»¶
            document.getElementById('income').addEventListener('input', liveCalculate);
            document.getElementById('mileage').addEventListener('input', liveCalculate);
            document.getElementById('hours').addEventListener('input', liveCalculate);
            document.getElementById('minutes').addEventListener('input', liveCalculate);
            
            // æˆæœ¬åƒæ•¸è¨­å®šè¼¸å…¥æ¡†äº‹ä»¶
            document.getElementById('fuelEfficiencyInput').addEventListener('input', liveCalculate);
            document.getElementById('maintCostInput').addEventListener('input', liveCalculate);
            
            // æ—¥æœŸé¸æ“‡å™¨åˆå§‹åŒ–
            const today = new Date();
            document.getElementById('recordDate').value = formatDate(today);

            // å„²å­˜æŒ‰éˆ•äº‹ä»¶
            document.getElementById('saveDailyRecordButton').addEventListener('click', saveDailyRecord);

            // åˆå§‹åŒ–å ±è¡¨
            loadReport(currentReportType);

            // ç¢ºä¿é¦–æ¬¡è¨ˆç®—
            liveCalculate();
        }


        // --- è¨­å®šæª”è®€å¯« ---
        async function loadConfig() {
            const docRef = db.doc(configDocPath(userId));
            try {
                const doc = await docRef.get();
                if (doc.exists) {
                    const data = doc.data();
                    userConfig.fuelEfficiency = parseFloat(data.fuelEfficiency) || DEFAULT_FUEL_EFFICIENCY_KML;
                    userConfig.maintCostPerKm = parseFloat(data.maintCostPerKm) || DEFAULT_MAINT_COST_PER_KM;
                    // ä¸åœ¨åˆå§‹è¼‰å…¥æ™‚é¡¯ç¤º Toast
                } else {
                    // å¯«å…¥é è¨­è¨­å®šåˆ°é›²ç«¯
                    await saveConfig(true); 
                    // ä¸åœ¨åˆå§‹è¼‰å…¥æ™‚é¡¯ç¤º Toast
                }
                
                // æ›´æ–° UI é¡¯ç¤º
                document.getElementById('fuelEfficiencyInput').value = userConfig.fuelEfficiency;
                document.getElementById('fuelEfficiencyDisplay').textContent = `ç›®å‰: ${userConfig.fuelEfficiency.toFixed(2)} km/L`;
                document.getElementById('maintCostInput').value = userConfig.maintCostPerKm;
                document.getElementById('maintCostDisplay').textContent = `ç›®å‰: $${userConfig.maintCostPerKm.toFixed(2)}/km`;

            } catch (error) {
                console.error("è¼‰å…¥è¨­å®šæª”å¤±æ•—:", error);
                showMessage("è¼‰å…¥è¨­å®šæª”å¤±æ•—ï¼Œä½¿ç”¨é è¨­å€¼ã€‚", 'error');
            }
        }

        async function saveConfig(isInitial = false) {
            const docRef = db.doc(configDocPath(userId));
            
            // å¾è¼¸å…¥æ¡†å–å¾—æœ€æ–°å€¼
            userConfig.fuelEfficiency = parseFloat(document.getElementById('fuelEfficiencyInput').value) || DEFAULT_FUEL_EFFICIENCY_KML;
            userConfig.maintCostPerKm = parseFloat(document.getElementById('maintCostInput').value) || DEFAULT_MAINT_COST_PER_KM;

            try {
                await docRef.set({
                    fuelEfficiency: userConfig.fuelEfficiency,
                    maintCostPerKm: userConfig.maintCostPerKm
                }, { merge: true });

                // æ›´æ–° UI é¡¯ç¤º (ç¢ºä¿æ•¸å€¼é¡¯ç¤ºä¸€è‡´)
                document.getElementById('fuelEfficiencyDisplay').textContent = `ç›®å‰: ${userConfig.fuelEfficiency.toFixed(2)} km/L`;
                document.getElementById('maintCostDisplay').textContent = `ç›®å‰: $${userConfig.maintCostPerKm.toFixed(2)}/km`;

                if (!isInitial) {
                    showMessage("å€‹äººåŒ–æˆæœ¬è¨­å®šå·²æˆåŠŸå„²å­˜åˆ°é›²ç«¯ã€‚", 'success');
                }
                liveCalculate(); // å„²å­˜å¾Œé‡æ–°è¨ˆç®—
            } catch (error) {
                console.error("å„²å­˜è¨­å®šæª”å¤±æ•—:", error);
                showMessage("å„²å­˜è¨­å®šæª”å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯ã€‚", 'error');
            }
        }


        // --- ç²å–æ²¹åƒ¹ (ä½¿ç”¨ Gemini API) ---
        async function fetchOilPrice(isInitialLoad = false) {
            if (!isInitialLoad) {
                document.getElementById('fetchOilPriceButton').disabled = true;
                document.getElementById('oilPriceDisplayMain').textContent = "ä¸­æ²¹ 92 æ±½æ²¹: ç²å–ä¸­...";
            }
            
            // ç§»é™¤ responseSchema å’Œ responseMimeTypeï¼Œè®“ API è¿”å›ç´”æ–‡å­—
            const prompt = `è«‹ä»¥ç°¡çŸ­çš„ JSON æ ¼å¼æä¾›å°ç£ä¸­æ²¹æœ€æ–°çš„ 92 ç„¡é‰›æ±½æ²¹åƒ¹æ ¼ (æ¯å…¬å‡)ã€‚åƒ…è¼¸å‡º JSONï¼Œä¸è¦è§£é‡‹ã€‚
            æ ¼å¼ç¯„ä¾‹: {"price": 27.1, "unit": "NTD/L"}`;
            
            const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${GEMINI_API_KEY}`;

            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: prompt }] }],
                        config: {
                            temperature: 0.1,
                            // responseMimeType å’Œ responseSchema å·²è¢«ç§»é™¤
                        }
                    })
                });

                // ğŸš¨ é—œéµé™¤éŒ¯æ­¥é©Ÿï¼šæª¢æŸ¥ API ç‹€æ…‹ç¢¼ï¼Œä¸¦å˜—è©¦æå–éŒ¯èª¤ç´°ç¯€
                if (!response.ok) {
                    let errorDetail = `API éŒ¯èª¤ï¼š${response.status} (${response.statusText})`;
                    
                    // å˜—è©¦è®€å– API æœå‹™è¿”å›çš„å…·é«”éŒ¯èª¤è¨Šæ¯
                    try {
                        // è¤‡è£½ response ä»¥ä¾›å¤šæ¬¡è®€å–
                        const clonedResponse = response.clone();
                        const errorData = await clonedResponse.json();
                        if (errorData.error && errorData.error.message) {
                            // æå– Google API éŒ¯èª¤çš„è©³ç´°è¨Šæ¯
                            errorDetail += ` - è©³ç´°éŒ¯èª¤: ${errorData.error.message}`;
                        } else {
                            errorDetail += ` - ç„¡æ³•è§£æå…·é«”éŒ¯èª¤è¨Šæ¯ã€‚`;
                        }
                    } catch (e) {
                        // å¦‚æœé€£å›æ‡‰éƒ½ä¸èƒ½è§£ææˆ JSONï¼Œå‰‡å¿½ç•¥
                        errorDetail += ` - å›æ‡‰é JSON æ ¼å¼æˆ–ç„¡ä¸»é«”ã€‚`;
                    }
                    
                    // æ‹‹å‡ºåŒ…å«è©³ç´°éŒ¯èª¤è¨Šæ¯çš„éŒ¯èª¤
                    throw new Error(errorDetail);
                }

                // æ­£å¸¸è™•ç† API å›æ‡‰
                const data = await response.json();
                let price = 0;

                // è§£æ Gemini çš„å›æ‡‰ (JSON å„ªå…ˆï¼Œç´”æ–‡å­—å‚™ç”¨)
                try {
                    const responseText = data.candidates[0].content.parts[0].text;
                    // å˜—è©¦ JSON è§£æ
                    const jsonObject = JSON.parse(responseText.trim());
                    price = parseFloat(jsonObject.price);
                } catch (e) {
                    // å¦‚æœ JSON è§£æå¤±æ•—ï¼ŒåŸ·è¡Œç´”æ–‡å­—æå–é‚è¼¯
                    console.warn("API å›æ‡‰è§£æå¤±æ•—ï¼Œå˜—è©¦å¾ç´”æ–‡å­—æå–æ²¹åƒ¹...");
                    const responseText = data.candidates[0].content.parts[0].text;
                    const textMatch = responseText.match(/(\d+\.?\d*)/); // æå–ç¬¬ä¸€å€‹æ‰¾åˆ°çš„æ•¸å­—
                    if (textMatch) {
                        price = parseFloat(textMatch[0]);
                    } else {
                        throw new Error("ç„¡æ³•å¾ API å›æ‡‰ä¸­æå–æ²¹åƒ¹æ•¸å€¼ï¼Œè«‹æª¢æŸ¥æ¨¡å‹è¼¸å‡ºã€‚");
                    }
                }
                
                if (isNaN(price) || price <= 0) throw new Error("ç²å–åˆ°ç„¡æ•ˆçš„æ²¹åƒ¹æ•¸å€¼ã€‚");
                
                currentOilPrice = price;
                
                // æ›´æ–° UI
                const display = `ä¸­æ²¹ 92 æ±½æ²¹: $${currentOilPrice.toFixed(2)}/L`;
                document.getElementById('oilPriceDisplayMain').textContent = display;
                if (!isInitialLoad) {
                    showMessage(`æ²¹åƒ¹æ›´æ–°æˆåŠŸ: ${currentOilPrice.toFixed(2)} NTD/L`, 'success');
                } else {
                    document.getElementById('loading-text').textContent = `é€£ç·šæˆåŠŸï¼Œæ²¹åƒ¹: $${currentOilPrice.toFixed(2)}/L`;
                }
                liveCalculate(); // æ²¹åƒ¹æ›´æ–°å¾Œé‡æ–°è¨ˆç®—

            } catch (error) {
                const errorMessage = `æ²¹åƒ¹ç²å–å¤±æ•—ï¼šä½¿ç”¨é è¨­å€¼ $${currentOilPrice.toFixed(2)}/Lã€‚(${error.message || 'ç¶²è·¯é€£ç·šéŒ¯èª¤'})`;
                document.getElementById('oilPriceDisplayMain').textContent = errorMessage;
                showMessage(errorMessage, 'error');
                console.error("æ²¹åƒ¹ç²å–å¤±æ•—:", error);
                
                // å¦‚æœæ˜¯åˆå§‹è¼‰å…¥éšæ®µçš„éŒ¯èª¤ï¼Œå°‡éŒ¯èª¤è¨Šæ¯é¡¯ç¤ºåœ¨è¼‰å…¥ç•«é¢ä¸Š
                if (isInitialLoad) {
                     document.getElementById('message-area-load').textContent = error.message;
                }

            } finally {
                if (!isInitialLoad) {
                    document.getElementById('fetchOilPriceButton').disabled = false;
                }
            }
        }


        // --- å³æ™‚è¨ˆç®—é‚è¼¯ ---
        function liveCalculate() {
            // 1. å–å¾—è¼¸å…¥å€¼
            const income = parseFloat(document.getElementById('income').value) || 0;
            const mileage = parseFloat(document.getElementById('mileage').value) || 0;
            const hours = parseFloat(document.getElementById('hours').value) || 0;
            const minutes = parseFloat(document.getElementById('minutes').value) || 0;

            // 2. å–å¾—æˆæœ¬åƒæ•¸ (ä½¿ç”¨è¼¸å…¥æ¡†çš„ç•¶å‰å€¼)
            const fuelEfficiency = parseFloat(document.getElementById('fuelEfficiencyInput').value) || DEFAULT_FUEL_EFFICIENCY_KML;
            const maintCostPerKm = parseFloat(document.getElementById('maintCostInput').value) || DEFAULT_MAINT_COST_PER_KM;

            // 3. è¨ˆç®—æˆæœ¬
            const gasCostPerKm = currentOilPrice / fuelEfficiency; // $/km
            const gasTotalCost = gasCostPerKm * mileage; // ç¸½æ²¹è²»
            const maintTotalCost = maintCostPerKm * mileage; // ç¸½è€—æè²»
            const totalCost = gasTotalCost + maintTotalCost; // ç¸½æˆæœ¬

            // 4. è¨ˆç®—æ·¨åˆ©
            const netProfit = income - totalCost;

            // 5. è¨ˆç®—æ™‚è–ª
            const totalHours = hours + (minutes / 60);
            const netHourlyRate = totalHours > 0 ? netProfit / totalHours : 0;
            const grossHourlyRate = totalHours > 0 ? income / totalHours : 0; // æ¯›æ™‚è–ª

            // 6. æ›´æ–° UI é¡¯ç¤º (å³æ™‚é ä¼°çµæœ)
            document.getElementById('liveGrossIncome').textContent = `$${income.toFixed(1)}`;
            document.getElementById('liveTotalCost').textContent = `$${totalCost.toFixed(1)}`;
            document.getElementById('liveNetProfit').textContent = `$${netProfit.toFixed(1)}`;
            document.getElementById('liveGasCost').textContent = `$${gasTotalCost.toFixed(1)}`;
            document.getElementById('liveMaintCost').textContent = `$${maintTotalCost.toFixed(1)}`;
            document.getElementById('liveGrossHourly').textContent = `$${grossHourlyRate.toFixed(1)}/hr`;
            document.getElementById('liveNetHourly').textContent = `$${netHourlyRate.toFixed(1)}/hr`;

            // 7. æ›´æ–°åœ“é¤…åœ–
            updateChart(netProfit, gasTotalCost, maintTotalCost, income);
        }

        // --- åœ“é¤…åœ–æ›´æ–° ---
        function updateChart(netProfit = 0, gasTotalCost = 0, maintTotalCost = 0, income = 0) {
            
            // å¦‚æœæ²’æœ‰æ”¶å…¥æˆ–æˆæœ¬ï¼Œå‰‡ä¸ç¹ªåœ–
            if (income <= 0 && gasTotalCost <= 0 && maintTotalCost <= 0) {
                if (chartInstance) {
                    chartInstance.destroy(); // éŠ·æ¯€èˆŠåœ–è¡¨
                    chartInstance = null;
                }
                return;
            }

            // æ•¸æ“šé»ï¼šç¢ºä¿æ·¨åˆ©å³ä½¿ç‚ºè² ï¼Œä¹Ÿä»¥ 0 æˆ–æ¥µå°æ­£å€¼é¡¯ç¤ºåœ¨åœ–ä¸Šï¼Œä½†è¨ˆç®—ä½¿ç”¨çœŸå¯¦å€¼
            const dataValues = [
                netProfit > 0 ? netProfit : 0.1, // æ·¨åˆ© (ç”¨ 0.1 é¿å…å®Œå…¨æ²’æœ‰åˆ‡ç‰‡)
                gasTotalCost,                     // æ²¹è²»æˆæœ¬
                maintTotalCost                    // è€—ææˆæœ¬
            ];
            const totalForPercentage = netProfit + gasTotalCost + maintTotalCost;

            const data = {
                labels: ['æ·¨åˆ©', 'æ²¹è²»æˆæœ¬', 'è€—ææˆæœ¬'],
                datasets: [{
                    data: dataValues, 
                    backgroundColor: ['#10b981', '#f59e0b', '#f87171'], // ç¶ è‰², é»ƒè‰², ç´…è‰²
                    hoverBackgroundColor: ['#059669', '#d97706', '#ef4444'],
                }]
            };

            const options = {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                let label = context.label || '';
                                if (label) {
                                    label += ': ';
                                }
                                const value = context.parsed;
                                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                const percentage = total > 0 ? (value / total * 100).toFixed(1) : 0;
                                return `${label}${formatCurrency(value)} (${percentage}%)`;
                            }
                        }
                    },
                    datalabels: {
                        color: '#fff',
                        formatter: (value, context) => {
                            const total = context.dataset.data.reduce((a, b) => a + b, 0);
                            const percentage = total > 0 ? (value / total * 100).toFixed(1) : 0;
                            return percentage > 5 ? `${percentage}%` : ''; // åªé¡¯ç¤ºå¤§æ–¼ 5% çš„æ¨™ç±¤
                        },
                        font: {
                            weight: 'bold'
                        }
                    }
                }
            };

            const ctx = document.getElementById('costChart').getContext('2d');
            
            if (chartInstance) {
                chartInstance.data = data;
                chartInstance.options = options;
                chartInstance.update();
            } else {
                chartInstance = new Chart(ctx, {
                    type: 'doughnut',
                    data: data,
                    options: options,
                });
            }
        }

        // --- è¨˜éŒ„ä¿å­˜ ---
        async function saveDailyRecord() {
            if (!userId) {
                showMessage("ç”¨æˆ¶ ID æœªè¼‰å…¥ï¼Œè«‹ç¨å€™æˆ–é‡è©¦ã€‚", 'error');
                return;
            }

            const recordDate = document.getElementById('recordDate').value;
            const income = parseFloat(document.getElementById('income').value) || 0;
            const mileage = parseFloat(document.getElementById('mileage').value) || 0;
            const hours = parseFloat(document.getElementById('hours').value) || 0;
            const minutes = parseFloat(document.getElementById('minutes').value) || 0;
            
            if (!recordDate || income <= 0 || mileage <= 0) {
                showMessage("è«‹è¼¸å…¥æœ‰æ•ˆçš„æ—¥æœŸã€ç‡Ÿæ¥­é¡å’Œå…¬é‡Œæ•¸ã€‚", 'warning');
                return;
            }

            const totalMinutes = hours * 60 + minutes;
            const totalHours = totalMinutes / 60;

            const gasCostPerKm = currentOilPrice / userConfig.fuelEfficiency; 
            const gasTotalCost = gasCostPerKm * mileage;
            const maintTotalCost = userConfig.maintCostPerKm * mileage; 
            const totalCost = gasTotalCost + maintTotalCost;
            const netProfit = income - totalCost;

            const recordData = {
                date: recordDate, // YYYY-MM-DD æ ¼å¼å­—ä¸²
                income: income,
                mileage: mileage,
                totalMinutes: totalMinutes,
                gasCost: gasTotalCost,
                maintCost: maintTotalCost,
                totalCost: totalCost,
                netProfit: netProfit,
                grossHourly: totalHours > 0 ? income / totalHours : 0,
                netHourly: totalHours > 0 ? netProfit / totalHours : 0,
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            };

            const docRef = db.collection(recordsCollectionPath(userId)).doc(recordDate);

            try {
                await docRef.set(recordData);
                showMessage(`æˆåŠŸå„²å­˜ ${recordDate} çš„è¨˜éŒ„ï¼`, 'success');
                loadReport(currentReportType); // é‡æ–°è¼‰å…¥å ±è¡¨
            } catch (error) {
                console.error("å„²å­˜è¨˜éŒ„å¤±æ•—:", error);
                showMessage("å„²å­˜è¨˜éŒ„å¤±æ•—ï¼Œè«‹æª¢æŸ¥éŒ¯èª¤è¨Šæ¯ã€‚", 'error');
            }
        }

        // --- å ±è¡¨é‚è¼¯ ---
        function getStartAndEndDate(date, type) {
            const start = new Date(date);
            const end = new Date(date);
            
            // é‡ç½®æ™‚é–“åˆ°ç•¶å¤©çš„ 00:00:00 (ä½¿ç”¨ UTC ä»¥ç¢ºä¿å…¨çƒä¸€è‡´æ€§)
            start.setUTCHours(0, 0, 0, 0);
            end.setUTCHours(23, 59, 59, 999);

            switch (type) {
                case 'day':
                    // å·²ç¶“è¨­ç½®ç‚ºç•¶æ—¥é–‹å§‹å’ŒçµæŸ
                    break;
                case 'week':
                    // æ˜ŸæœŸä¸€ç‚ºç¬¬ä¸€å¤© (å°ç£ç¿’æ…£)
                    const dayOfWeek = (start.getUTCDay() === 0 ? 6 : start.getUTCDay() - 1); // 0=æ—¥, 1=ä¸€...
                    start.setUTCDate(start.getUTCDate() - dayOfWeek);
                    end.setUTCDate(start.getUTCDate() + 6);
                    end.setUTCHours(23, 59, 59, 999);
                    break;
                case 'month':
                    start.setUTCDate(1);
                    end.setUTCMonth(end.getUTCMonth() + 1, 0); // è¨­å®šç‚ºä¸‹å€‹æœˆçš„ç¬¬ 0 å¤© (å³æœ¬æœˆæœ€å¾Œä¸€å¤©)
                    end.setUTCHours(23, 59, 59, 999);
                    break;
                case 'year':
                    start.setUTCMonth(0, 1);
                    end.setUTCMonth(11, 31);
                    end.setUTCHours(23, 59, 59, 999);
                    break;
            }
            
            // ç”±æ–¼ Firestore æŸ¥è©¢æ˜¯åŸºæ–¼å­—ä¸² (YYYY-MM-DD)ï¼Œæˆ‘å€‘éœ€è¦å°‡ Date ç‰©ä»¶è½‰æ›ç‚ºå­—ä¸²
            const startDateString = formatDate(start);
            const endDateString = formatDate(end);
            
            return {
                start: startDateString,
                end: endDateString
            };
        }
        
        function getReportRangeDisplay(startDateString, endDateString, type) {
            if (type === 'day') {
                return startDateString.replace(/-/g, '/');
            }
            return `${startDateString.replace(/-/g, '/')} ~ ${endDateString.replace(/-/g, '/')}`;
        }
        
        async function loadReport(type) {
            currentReportType = type;
            const { start, end } = getStartAndEndDate(currentReportDate, type);
            
            document.getElementById('reportDateRange').textContent = getReportRangeDisplay(start, end, type);
            
            const recordsRef = db.collection(recordsCollectionPath(userId));
            
            try {
                // ä½¿ç”¨ date å­—ä¸²é€²è¡Œç¯„åœæŸ¥è©¢
                const snapshot = await recordsRef
                    .where('date', '>=', start)
                    .where('date', '<=', end)
                    .orderBy('date', 'asc')
                    .get();

                let totalIncome = 0;
                let totalNetProfit = 0;
                let totalMinutes = 0;
                let totalCost = 0;
                let totalMileage = 0;
                let reportDetailsHtml = '';

                snapshot.forEach(doc => {
                    const data = doc.data();
                    totalIncome += data.income;
                    totalNetProfit += data.netProfit;
                    totalMinutes += data.totalMinutes;
                    totalCost += data.totalCost;
                    totalMileage += data.mileage;
                    
                    const statusClass = data.netProfit >= 0 ? 'text-green-600' : 'text-red-600';
                    reportDetailsHtml += `
                        <div class="flex justify-between items-center border-b pb-1">
                            <span class="font-medium">${data.date} (${formatDuration(data.totalMinutes)})</span>
                            <span class="${statusClass} font-bold">${formatCurrency(data.netProfit)}</span>
                        </div>
                    `;
                });

                const totalHours = totalMinutes / 60;
                const avgNetHourly = totalHours > 0 ? totalNetProfit / totalHours : 0;
                const avgGrossHourly = totalHours > 0 ? totalIncome / totalHours : 0;
                
                document.getElementById('reportTotalIncome').textContent = formatCurrency(totalIncome);
                document.getElementById('reportNetProfit').textContent = formatCurrency(totalNetProfit);
                document.getElementById('reportTotalHours').textContent = formatDuration(totalMinutes);
                document.getElementById('reportTotalCost').textContent = formatCurrency(totalCost);
                document.getElementById('reportTotalMileage').textContent = totalMileage.toFixed(1);
                document.getElementById('reportNetHourly').textContent = `${formatCurrency(avgNetHourly)}/hr`;
                document.getElementById('reportGrossHourly').textContent = `${formatCurrency(avgGrossHourly)}/hr`;
                document.getElementById('reportDetails').innerHTML = reportDetailsHtml || '<p>æ­¤æœŸé–“å°šæœªæœ‰è¨˜éŒ„ã€‚</p>';

            } catch (error) {
                console.error("è¼‰å…¥å ±è¡¨å¤±æ•—:", error);
                showMessage("è¼‰å…¥å ±è¡¨å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯æˆ–æ¬Šé™ã€‚", 'error');
            }
        }
        
        function changeReportDate(delta) {
            const tempDate = new Date(currentReportDate);
            
            switch (currentReportType) {
                case 'day':
                    tempDate.setDate(tempDate.getDate() + delta);
                    break;
                case 'week':
                    tempDate.setDate(tempDate.getDate() + (delta * 7));
                    break;
                case 'month':
                    tempDate.setMonth(tempDate.getMonth() + delta);
                    break;
                case 'year':
                    tempDate.setFullYear(tempDate.getFullYear() + delta);
                    break;
            }
            
            currentReportDate = tempDate;
            loadReport(currentReportType);
        }
        
        window.loadReport = loadReport; // æš´éœ²çµ¦ HTML æŒ‰éˆ•
        window.changeReportDate = changeReportDate; // æš´éœ²çµ¦ HTML æŒ‰éˆ•
        window.saveDailyRecord = saveDailyRecord; // æš´éœ²çµ¦ HTML æŒ‰éˆ•
        window.saveConfig = saveConfig; // æš´éœ²çµ¦ HTML æŒ‰éˆ•
        window.fetchOilPrice = fetchOilPrice; // æš´éœ²çµ¦ HTML æŒ‰éˆ•

        // å•Ÿå‹•æ‡‰ç”¨ç¨‹å¼
        document.addEventListener('DOMContentLoaded', initFirebase);
    </script>
</body>
</html>
