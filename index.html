<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
<title>Uber é›²ç«¯ç‰ˆ V5.1 (ä»¿è£½ç‰ˆ)</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
    /* å…¨å±€æ·±è‰²ä¸»é¡Œè¨­å®š */
    body { background-color: #0a0a0a; color: #e5e5e5; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; padding-bottom: 80px; }
    
    /* å¡ç‰‡æ¨£å¼ - æ¨¡ä»¿æˆªåœ– */
    .dashboard-card {
        background-color: #15161b; /* æ¥µæ·±è—ç° */
        border: 1px solid #262936;
        border-radius: 1.2rem;
        padding: 1.25rem;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    }

    /* ç´«è‰²æ¼¸å±¤å¡ç‰‡ */
    .card-purple-glow {
        background: linear-gradient(135deg, #1e1b2e 0%, #2d1f3f 100%);
        border: 1px solid #4c1d95;
        position: relative;
        overflow: hidden;
    }
    .card-purple-glow::after {
        content: 'âš¡';
        position: absolute;
        right: 10px;
        bottom: 5px;
        font-size: 2rem;
        opacity: 0.2;
        color: #d8b4fe;
    }

    /* è¼¸å…¥æ¡†æ¨£å¼ */
    .input-dark {
        background-color: #1f2128;
        border: 1px solid #333645;
        color: #fff;
        border-radius: 0.75rem;
        padding: 0.75rem;
        width: 100%;
        transition: border-color 0.2s;
        font-size: 1rem;
    }
    .input-dark:focus {
        outline: none;
        border-color: #6366f1;
    }

    /* æŒ‰éˆ•æ¨£å¼ */
    .btn-primary {
        background-color: #eab308; /* Uber é»ƒ/é‡‘ */
        color: #000;
        font-weight: 700;
        border-radius: 0.75rem;
        padding: 0.8rem;
        width: 100%;
        transition: 0.2s;
    }
    .btn-primary:active { transform: scale(0.98); }

    .filter-btn {
        background-color: #1f2128;
        color: #9ca3af;
        padding: 0.4rem 0.8rem;
        border-radius: 0.5rem;
        font-size: 0.85rem;
        border: 1px solid #333;
        white-space: nowrap;
    }
    .filter-btn.active {
        background-color: #3730a3;
        color: #fff;
        border-color: #6366f1;
    }

    /* æ–‡å­—å±¤ç´š */
    .label-text { color: #6b7280; font-size: 0.85rem; margin-bottom: 0.25rem; display: block; }
    .value-text { font-size: 1.5rem; font-weight: 600; color: #f3f4f6; }
    .value-sub { font-size: 0.9rem; color: #9ca3af; }

    /* éš±è—çš„å€å¡Š */
    .hidden-section { display: none; }
</style>
</head>
<body class="p-4 max-w-md mx-auto">

    <div class="flex justify-between items-center mb-4">
        <div class="flex items-center gap-2">
            <div class="bg-yellow-500 p-1.5 rounded-lg text-black font-bold text-xs">Uber</div>
            <h1 class="text-lg font-bold text-gray-100">é›²ç«¯ç‰ˆ V5.1 (Remix)</h1>
        </div>
        <button onclick="toggleSettings()" class="p-2 rounded-full bg-gray-800 text-gray-400 hover:text-white">
            âš™ï¸
        </button>
    </div>

    <div id="settingsPanel" class="hidden-section mb-4 dashboard-card border-yellow-600/30">
        <h3 class="text-yellow-500 font-bold mb-3">åƒæ•¸è¨­å®š</h3>
        <div class="grid grid-cols-2 gap-3 mb-3">
            <div>
                <label class="label-text">æ²¹å“é¸æ“‡</label>
                <select id="oilType" class="input-dark" onchange="fetchOilPrice()">
                    <option value="92">92 ç„¡é‰›</option>
                    <option value="95">95 ç„¡é‰›</option>
                    <option value="98">98 ç„¡é‰›</option>
                    <option value="diesel">æŸ´æ²¹</option>
                </select>
            </div>
            <div>
                <label class="label-text">ç•¶å‰æ²¹åƒ¹ ($/L)</label>
                <input id="currentOilPrice" class="input-dark text-yellow-400" readonly value="--" />
            </div>
        </div>
        <div class="grid grid-cols-2 gap-3 mb-4">
            <div>
                <label class="label-text">æ²¹è€— (km/L)</label>
                <input id="settingFuelRate" type="number" class="input-dark" placeholder="ä¾‹å¦‚ 12" />
            </div>
            <div>
                <label class="label-text">è€—ææˆæœ¬ ($/km)</label>
                <input id="settingMaint" type="number" step="0.1" class="input-dark" placeholder="ä¾‹å¦‚ 1.5" />
            </div>
        </div>
        <button onclick="saveSettings()" class="bg-gray-700 w-full py-2 rounded-lg text-white text-sm">å„²å­˜åƒæ•¸</button>
    </div>

    <div class="flex gap-2 overflow-x-auto pb-2 mb-2 no-scrollbar">
        <button class="filter-btn active" onclick="setFilter('day', this)">ä»Šæ—¥</button>
        <button class="filter-btn" onclick="setFilter('week', this)">æœ¬é€±</button>
        <button class="filter-btn" onclick="setFilter('month', this)">æœ¬æœˆ</button>
        <button class="filter-btn" onclick="setFilter('year', this)">ä»Šå¹´</button>
        <button class="filter-btn" onclick="setFilter('custom', this)">è‡ªè¨‚</button>
    </div>
    <div id="customDateRange" class="hidden-section flex gap-2 mb-3">
        <input type="date" id="startDate" class="input-dark py-1" onchange="refreshDashboard()" />
        <span class="self-center text-gray-500">to</span>
        <input type="date" id="endDate" class="input-dark py-1" onchange="refreshDashboard()" />
    </div>

    <div class="dashboard-card mb-4">
        <label class="label-text text-gray-400">å€é–“ç¸½é‡‘é¡</label>
        <div class="flex items-baseline gap-1">
            <span class="text-gray-400 text-xl">$</span>
            <span id="dashTotalIncome" class="text-4xl font-bold text-white tracking-wide">0</span>
        </div>
    </div>

    <div class="grid grid-cols-2 gap-3 mb-4">
        <div class="dashboard-card flex flex-col justify-center">
            <label class="label-text">é‡Œç¨‹ (KM)</label>
            <span id="dashDistance" class="text-2xl font-bold">0</span>
        </div>
        <div class="dashboard-card flex flex-col justify-center">
            <label class="label-text">ç¸½å–®æ•¸</label>
            <span id="dashOrders" class="text-2xl font-bold">0</span>
        </div>
    </div>

    <div class="dashboard-card mb-4 flex justify-between items-center px-6">
        <div class="flex items-center gap-2">
            <span class="text-gray-500">ğŸ•’</span>
            <label class="label-text mb-0">ä¸Šç·šæ™‚é–“</label>
        </div>
        <div class="text-xl font-bold">
            <span id="dashHours">0</span> <span class="text-sm font-normal text-gray-500">å°æ™‚</span>
            <span id="dashMinutes">0</span> <span class="text-sm font-normal text-gray-500">åˆ†é˜</span>
        </div>
    </div>

    <div class="grid grid-cols-2 gap-3 mb-4">
        <div class="dashboard-card">
            <label class="label-text">å¸³é¢æ™‚è–ª</label>
            <span id="dashNominalHourly" class="text-xl font-bold text-gray-300">$0</span>
        </div>
        <div class="dashboard-card card-purple-glow">
            <label class="label-text text-purple-200">çœŸå¯¦æ™‚è–ª</label>
            <span id="dashRealHourly" class="text-2xl font-bold text-white">$0</span>
        </div>
    </div>

    <div class="dashboard-card bg-slate-800/50 mb-6">
        <div class="mb-4">
            <label class="label-text">å€é–“å¯¦éš›æ·¨åˆ©</label>
            <div class="text-4xl font-bold text-white">$<span id="dashNetProfit">0</span></div>
        </div>
        <div class="grid grid-cols-2 gap-4 pt-4 border-t border-gray-700">
            <div>
                <label class="label-text">ç¸½æˆæœ¬ (æ²¹+è€—)</label>
                <div id="dashTotalCost" class="text-red-400 font-semibold">-$0</div>
            </div>
            <div>
                <label class="label-text">æ¯å–®å¯¦è³º</label>
                <div id="dashPerOrder" class="text-green-400 font-semibold">$0</div>
            </div>
        </div>
    </div>

    <div class="grid grid-cols-2 gap-3 mb-6">
        <button onclick="openModal()" class="btn-primary bg-indigo-600 text-white hover:bg-indigo-500">
            â• æ–°å¢/ç·¨è¼¯ç´€éŒ„
        </button>
        <button onclick="toggleCharts()" class="btn-primary bg-gray-700 text-gray-200 hover:bg-gray-600">
            ğŸ“Š æŸ¥çœ‹åœ–è¡¨åˆ†æ
        </button>
    </div>

    <div id="chartsPanel" class="hidden-section mb-8">
        <h3 class="text-lg font-bold mb-3 pl-1 border-l-4 border-indigo-500">æ•¸æ“šå¯è¦–åŒ–</h3>
        
        <div class="dashboard-card mb-4">
            <h4 class="text-sm text-gray-400 mb-2">ç‡Ÿæ”¶è¶¨å‹¢ (Bar)</h4>
            <canvas id="chartIncome"></canvas>
        </div>
        
        <div class="dashboard-card mb-4">
            <h4 class="text-sm text-gray-400 mb-2">æ·¨åˆ©èµ°å‹¢ (Line)</h4>
            <canvas id="chartProfit"></canvas>
        </div>

        <div class="dashboard-card">
            <h4 class="text-sm text-gray-400 mb-2">æˆæœ¬ä½”æ¯” (Pie)</h4>
            <div class="h-48 flex justify-center">
                <canvas id="chartCost"></canvas>
            </div>
        </div>
    </div>

    <div class="mb-20">
        <h3 class="text-lg font-bold mb-3 pl-1 border-l-4 border-yellow-500">æ­·å²æ˜ç´° (ç•¶å‰å€é–“)</h3>
        <div id="historyList" class="space-y-3">
            </div>
    </div>

    <div id="inputModal" class="fixed inset-0 bg-black/80 backdrop-blur-sm hidden z-50 flex items-end sm:items-center justify-center">
        <div class="bg-[#15161b] w-full max-w-md rounded-t-2xl sm:rounded-2xl p-5 border-t border-gray-700 sm:border shadow-2xl">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-white" id="modalTitle">æ–°å¢ç´€éŒ„</h2>
                <button onclick="closeModal()" class="text-gray-400 text-2xl">&times;</button>
            </div>

            <input type="hidden" id="editIndex" value="-1"> <div class="space-y-3">
                <div>
                    <label class="label-text">æ—¥æœŸ</label>
                    <input id="inputDate" type="date" class="input-dark" />
                </div>
                
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="label-text">ç•¶æ—¥ç‡Ÿæ¥­é¡ ($)</label>
                        <input id="inputIncome" type="number" inputmode="numeric" class="input-dark" />
                    </div>
                    <div>
                        <label class="label-text">ç¸½å–®æ•¸</label>
                        <input id="inputOrders" type="number" inputmode="numeric" class="input-dark" />
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="label-text">å¯¦éš›é‡Œç¨‹ (KM)</label>
                        <input id="inputDist" type="number" step="0.1" inputmode="decimal" class="input-dark" />
                    </div>
                    <div>
                        <label class="label-text">å·¥ä½œæ™‚æ•¸</label>
                        <div class="flex gap-2">
                            <input id="inputHr" type="number" placeholder="æ™‚" class="input-dark" />
                            <input id="inputMin" type="number" placeholder="åˆ†" class="input-dark" />
                        </div>
                    </div>
                </div>

                <div class="text-xs text-gray-500 mt-2 p-2 bg-gray-800 rounded">
                    è¨ˆç®—åŸºæº–ï¼šæ²¹åƒ¹ $<span id="modalOilPrice">--</span> | æ²¹è€— <span id="modalFuelRate">--</span> | è€—æ $<span id="modalMaint">--</span>
                </div>

                <div class="flex gap-3 mt-4">
                    <button onclick="saveRecord()" class="btn-primary bg-indigo-600 text-white">å„²å­˜ç´€éŒ„</button>
                    <button id="btnDelete" onclick="deleteCurrentRecord()" class="btn-primary bg-red-900 text-red-200 hidden">åˆªé™¤</button>
                </div>
            </div>
        </div>
    </div>

<script>
// === å…¨åŸŸè®Šæ•¸ ===
const workerAPI = "https://ubereat-oil-proxy.leo3026772.workers.dev/";
let globalOilPrice = 30.0; // é è¨­
let currentFilter = 'day'; // day, week, month, year, custom
let chartsInstances = {}; // å„²å­˜åœ–è¡¨å¯¦ä¾‹

// === åˆå§‹åŒ– ===
window.onload = async () => {
    // è¨­å®šæ—¥æœŸè¼¸å…¥æ¡†é è¨­ç‚ºä»Šå¤©
    document.getElementById('inputDate').valueAsDate = new Date();
    
    // è¼‰å…¥è¨­å®š
    loadSettings();
    
    // å˜—è©¦æŠ“æ²¹åƒ¹
    await fetchOilPrice();
    
    // è¼‰å…¥ä¸¦æ¸²æŸ“
    refreshDashboard();
};

// === æ ¸å¿ƒåŠŸèƒ½ï¼šè³‡æ–™å­˜å– ===
function getHistory() {
    return JSON.parse(localStorage.getItem('uber_history_v5') || '[]');
}

function saveToHistory(data) {
    localStorage.setItem('uber_history_v5', JSON.stringify(data));
}

function getSettings() {
    return {
        fuelRate: parseFloat(localStorage.getItem('fuelRate') || 12),
        maintCost: parseFloat(localStorage.getItem('maintCost') || 1.5),
        oilType: localStorage.getItem('oilType') || '95'
    };
}

// === è¨­å®šç›¸é—œ ===
function loadSettings() {
    const s = getSettings();
    document.getElementById('settingFuelRate').value = s.fuelRate;
    document.getElementById('settingMaint').value = s.maintCost;
    document.getElementById('oilType').value = s.oilType;
    
    // æ›´æ–° Modal è£¡çš„æç¤º
    document.getElementById('modalFuelRate').innerText = s.fuelRate;
    document.getElementById('modalMaint').innerText = s.maintCost;
}

function saveSettings() {
    localStorage.setItem('fuelRate', document.getElementById('settingFuelRate').value);
    localStorage.setItem('maintCost', document.getElementById('settingMaint').value);
    toggleSettings(); // é—œé–‰é¢æ¿
    loadSettings();
    refreshDashboard(); // é‡æ–°è¨ˆç®—æ‰€æœ‰æ•¸æ“š
    alert('è¨­å®šå·²æ›´æ–°ä¸¦å¥—ç”¨è‡³è¨ˆç®—å…¬å¼');
}

function toggleSettings() {
    const p = document.getElementById('settingsPanel');
    p.style.display = p.style.display === 'block' ? 'none' : 'block';
}

// === æ²¹åƒ¹ API ===
async function fetchOilPrice() {
    try {
        const type = document.getElementById('oilType').value;
        const res = await fetch(workerAPI);
        const data = await res.json();
        if (data[type]) {
            globalOilPrice = data[type];
            document.getElementById('currentOilPrice').value = globalOilPrice;
            document.getElementById('modalOilPrice').innerText = globalOilPrice;
        }
    } catch (e) {
        console.error("æ²¹åƒ¹æŠ“å–å¤±æ•—", e);
        document.getElementById('currentOilPrice').value = globalOilPrice + " (é è¨­)";
        document.getElementById('modalOilPrice').innerText = globalOilPrice;
    }
}

// === è¨˜éŒ„ç®¡ç† (CRUD) ===
function openModal(editIdx = -1) {
    const modal = document.getElementById('inputModal');
    const idxField = document.getElementById('editIndex');
    const btnDel = document.getElementById('btnDelete');
    const title = document.getElementById('modalTitle');

    modal.classList.remove('hidden');
    idxField.value = editIdx;

    if (editIdx >= 0) {
        // ç·¨è¼¯æ¨¡å¼
        const list = getHistory();
        // æ³¨æ„ï¼šé€™è£¡çš„ editIdx æ˜¯éæ¿¾å¾Œçš„ index é‚„æ˜¯åŸå§‹ index?
        // ç‚ºäº†å®‰å…¨ï¼Œæˆ‘å€‘åœ¨ renderList æ™‚æœƒå‚³éåŸå§‹ index
        const r = list[editIdx]; 
        
        document.getElementById('inputDate').value = r.date;
        document.getElementById('inputIncome').value = r.income;
        document.getElementById('inputOrders').value = r.orders || 0;
        document.getElementById('inputDist').value = r.km;
        
        // æ™‚é–“è½‰æ›
        const totalMin = Math.round(r.hours * 60);
        document.getElementById('inputHr').value = Math.floor(totalMin / 60);
        document.getElementById('inputMin').value = totalMin % 60;

        title.innerText = "ç·¨è¼¯ç´€éŒ„";
        btnDel.classList.remove('hidden');
    } else {
        // æ–°å¢æ¨¡å¼
        document.getElementById('inputDate').valueAsDate = new Date();
        document.getElementById('inputIncome').value = '';
        document.getElementById('inputOrders').value = '';
        document.getElementById('inputDist').value = '';
        document.getElementById('inputHr').value = '';
        document.getElementById('inputMin').value = '';
        
        title.innerText = "æ–°å¢ç´€éŒ„";
        btnDel.classList.add('hidden');
    }
}

function closeModal() {
    document.getElementById('inputModal').classList.add('hidden');
}

function saveRecord() {
    const date = document.getElementById('inputDate').value;
    if (!date) return alert('è«‹é¸æ“‡æ—¥æœŸ');

    const income = parseFloat(document.getElementById('inputIncome').value) || 0;
    const orders = parseFloat(document.getElementById('inputOrders').value) || 0;
    const km = parseFloat(document.getElementById('inputDist').value) || 0;
    const hr = parseFloat(document.getElementById('inputHr').value) || 0;
    const min = parseFloat(document.getElementById('inputMin').value) || 0;
    
    // æ™‚é–“è½‰å°æ•¸é»å°æ™‚
    const totalHours = hr + (min / 60);

    // å–å¾—ç•¶å‰è¨­å®šåƒæ•¸ snapshot (ç´€éŒ„ç•¶ä¸‹æˆæœ¬çµæ§‹)
    const settings = getSettings();

    const record = {
        id: Date.now(), // å”¯ä¸€ID
        date: date,
        income: income,
        orders: orders,
        km: km,
        hours: totalHours,
        // å„²å­˜ç•¶æ™‚çš„æˆæœ¬åƒæ•¸ï¼Œè®“æ­·å²è¨ˆç®—æ›´ç²¾æº–
        oilPrice: globalOilPrice,
        fuelRate: settings.fuelRate,
        maintCost: settings.maintCost
    };

    const list = getHistory();
    const editIdx = parseInt(document.getElementById('editIndex').value);

    if (editIdx >= 0) {
        // æ›´æ–°
        list[editIdx] = record;
    } else {
        // æ–°å¢
        list.push(record);
    }

    // æ’åºï¼šæ—¥æœŸæ–°åˆ°èˆŠ
    list.sort((a, b) => new Date(b.date) - new Date(a.date));

    saveToHistory(list);
    closeModal();
    refreshDashboard();
}

function deleteCurrentRecord() {
    const idx = parseInt(document.getElementById('editIndex').value);
    if (confirm('ç¢ºå®šè¦åˆªé™¤é€™ç­†ç´€éŒ„å—ï¼Ÿ')) {
        const list = getHistory();
        list.splice(idx, 1);
        saveToHistory(list);
        closeModal();
        refreshDashboard();
    }
}

// === ç¯©é¸é‚è¼¯ ===
function setFilter(type, btn) {
    currentFilter = type;
    
    // UI æ›´æ–°
    document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');

    // è‡ªè¨‚å€é–“é¡¯ç¤º
    const customRange = document.getElementById('customDateRange');
    if (type === 'custom') {
        customRange.style.display = 'flex';
    } else {
        customRange.style.display = 'none';
        refreshDashboard();
    }
}

function getFilteredData() {
    const list = getHistory();
    const now = new Date();
    let filtered = [];

    const startOfDay = (d) => new Date(d.getFullYear(), d.getMonth(), d.getDate());
    
    // è¼”åŠ©ï¼šå–å¾—æœ¬é€±ç¬¬ä¸€å¤© (é€±ä¸€)
    const getMonday = (d) => {
        const day = d.getDay(), diff = d.getDate() - day + (day == 0 ? -6 : 1); 
        return new Date(d.setDate(diff));
    };

    switch (currentFilter) {
        case 'day':
            const todayStr = now.toISOString().split('T')[0];
            filtered = list.filter(r => r.date === todayStr);
            break;
        case 'week':
            const monday = getMonday(new Date());
            monday.setHours(0,0,0,0);
            filtered = list.filter(r => new Date(r.date) >= monday);
            break;
        case 'month':
            const firstDay = new Date(now.getFullYear(), now.getMonth(), 1);
            filtered = list.filter(r => new Date(r.date) >= firstDay);
            break;
        case 'year':
            const firstDayYear = new Date(now.getFullYear(), 0, 1);
            filtered = list.filter(r => new Date(r.date) >= firstDayYear);
            break;
        case 'custom':
            const s = document.getElementById('startDate').value;
            const e = document.getElementById('endDate').value;
            if(s && e) {
                filtered = list.filter(r => r.date >= s && r.date <= e);
            } else {
                filtered = list; // æœªé¸å®Œå‰‡é¡¯ç¤ºå…¨éƒ¨
            }
            break;
        default:
            filtered = list;
    }
    return filtered;
}

// === å„€è¡¨æ¿æ ¸å¿ƒè¨ˆç®— ===
function refreshDashboard() {
    const data = getFilteredData();
    
    let totalIncome = 0;
    let totalKm = 0;
    let totalOrders = 0;
    let totalHours = 0;
    let totalCost = 0;

    // æ¸²æŸ“åˆ—è¡¨å­—ä¸² HTML
    let listHtml = '';
    const allHistory = getHistory(); // ç”¨ä¾†æ‰¾åŸå§‹ index

    data.forEach(r => {
        // è¨ˆç®—å–®ç­†æˆæœ¬
        // æ²¹éŒ¢ = (å…¬é‡Œ / æ²¹è€—) * æ²¹åƒ¹
        const fuelCost = (r.km / r.fuelRate) * r.oilPrice;
        // è€—æ = å…¬é‡Œ * è€—æå–®åƒ¹
        const maintCost = r.km * r.maintCost;
        const thisCost = fuelCost + maintCost;
        const thisNet = r.income - thisCost;

        totalIncome += r.income;
        totalKm += r.km;
        totalOrders += r.orders;
        totalHours += r.hours;
        totalCost += thisCost;

        // å°‹æ‰¾åŸå§‹ index ä»¥ä¾¿ç·¨è¼¯
        // é€™è£¡ç°¡å–®ç”¨ ID æˆ–åƒç…§æ¯”å°ï¼Œé€™é‚Šç”¨ç°¡å–®è¿´åœˆæ‰¾ index
        const originalIdx = allHistory.findIndex(item => item.id === r.id);

        // åˆ—è¡¨é …ç›®
        listHtml += `
            <div class="bg-[#1f2128] border border-gray-800 p-3 rounded-xl flex justify-between items-center" onclick="openModal(${originalIdx})">
                <div>
                    <div class="text-gray-400 text-xs mb-1">ğŸ“… ${r.date}</div>
                    <div class="font-bold text-white">$${r.income} <span class="text-xs font-normal text-gray-500">(${r.orders}å–®)</span></div>
                </div>
                <div class="text-right">
                    <div class="text-purple-400 text-sm font-bold">æ·¨åˆ© $${Math.round(thisNet)}</div>
                    <div class="text-gray-500 text-xs">${r.km}km / ${r.hours.toFixed(1)}hr</div>
                </div>
            </div>
        `;
    });

    document.getElementById('historyList').innerHTML = listHtml || '<div class="text-center text-gray-600 py-4">ç„¡è³‡æ–™</div>';

    // è¨ˆç®—è¡ç”Ÿæ•¸æ“š
    const netProfit = totalIncome - totalCost;
    const nominalHourly = totalHours > 0 ? (totalIncome / totalHours) : 0;
    const realHourly = totalHours > 0 ? (netProfit / totalHours) : 0;
    const perOrderProfit = totalOrders > 0 ? (netProfit / totalOrders) : 0;

    // è½‰æ›æ™‚é–“é¡¯ç¤º (å°æ™‚ åˆ†é˜)
    const dispHr = Math.floor(totalHours);
    const dispMin = Math.round((totalHours - dispHr) * 60);

    // æ›´æ–° DOM
    document.getElementById('dashTotalIncome').innerText = Math.round(totalIncome);
    document.getElementById('dashDistance').innerText = Math.round(totalKm);
    document.getElementById('dashOrders').innerText = totalOrders;
    document.getElementById('dashHours').innerText = dispHr;
    document.getElementById('dashMinutes').innerText = dispMin;
    
    document.getElementById('dashNominalHourly').innerText = '$' + Math.round(nominalHourly);
    document.getElementById('dashRealHourly').innerText = '$' + Math.round(realHourly);
    
    document.getElementById('dashNetProfit').innerText = Math.round(netProfit);
    document.getElementById('dashTotalCost').innerText = '-$' + Math.round(totalCost);
    document.getElementById('dashPerOrder').innerText = '$' + Math.round(perOrderProfit);

    // è‹¥åœ–è¡¨å€æ˜¯é–‹è‘—çš„ï¼Œå°±æ›´æ–°åœ–è¡¨
    if(document.getElementById('chartsPanel').style.display === 'block') {
        updateCharts(data);
    }
}

// === åœ–è¡¨åŠŸèƒ½ ===
function toggleCharts() {
    const p = document.getElementById('chartsPanel');
    const isHidden = p.style.display === 'none' || p.style.display === '';
    p.style.display = isHidden ? 'block' : 'none';
    
    if (isHidden) {
        updateCharts(getFilteredData());
        // æ»¾å‹•åˆ°åœ–è¡¨
        p.scrollIntoView({ behavior: 'smooth' });
    }
}

function updateCharts(data) {
    // è³‡æ–™æ•´ç†ï¼šæŒ‰æ—¥æœŸæ’åº (èˆŠ -> æ–°) çµ¦åœ–è¡¨ç”¨
    const sortedData = [...data].sort((a, b) => new Date(a.date) - new Date(b.date));
    const labels = sortedData.map(r => r.date.slice(5)); // å– MM-DD
    const incomes = sortedData.map(r => r.income);
    
    // è¨ˆç®—æ·¨åˆ©é™£åˆ—
    const profits = sortedData.map(r => {
        const cost = (r.km/r.fuelRate)*r.oilPrice + (r.km*r.maintCost);
        return Math.round(r.income - cost);
    });

    // ç¸½æˆæœ¬çµæ§‹
    let sumFuel = 0;
    let sumMaint = 0;
    let sumNet = 0;
    data.forEach(r => {
        const f = (r.km/r.fuelRate)*r.oilPrice;
        const m = r.km*r.maintCost;
        sumFuel += f;
        sumMaint += m;
        sumNet += (r.income - f - m);
    });

    // 1. æ”¶å…¥ Bar Chart
    drawChart('chartIncome', 'bar', {
        labels: labels,
        datasets: [{
            label: 'ç‡Ÿæ¥­é¡',
            data: incomes,
            backgroundColor: '#6366f1',
            borderRadius: 5
        }]
    });

    // 2. æ·¨åˆ© Line Chart
    drawChart('chartProfit', 'line', {
        labels: labels,
        datasets: [{
            label: 'å¯¦éš›æ·¨åˆ©',
            data: profits,
            borderColor: '#a855f7',
            backgroundColor: 'rgba(168, 85, 247, 0.2)',
            fill: true,
            tension: 0.4
        }]
    });

    // 3. æˆæœ¬ Pie Chart
    drawChart('chartCost', 'doughnut', {
        labels: ['æ·¨åˆ©', 'æ²¹éŒ¢', 'è€—æ'],
        datasets: [{
            data: [Math.round(sumNet), Math.round(sumFuel), Math.round(sumMaint)],
            backgroundColor: ['#10b981', '#ef4444', '#f59e0b'],
            borderWidth: 0
        }]
    });
}

function drawChart(canvasId, type, dataConfig) {
    const ctx = document.getElementById(canvasId).getContext('2d');
    
    // å¦‚æœå·²æœ‰èˆŠåœ–è¡¨ï¼Œå…ˆéŠ·æ¯€
    if (chartsInstances[canvasId]) {
        chartsInstances[canvasId].destroy();
    }

    chartsInstances[canvasId] = new Chart(ctx, {
        type: type,
        data: dataConfig,
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { labels: { color: '#9ca3af' } }
            },
            scales: type !== 'doughnut' ? {
                x: { ticks: { color: '#6b7280' }, grid: { color: '#374151' } },
                y: { ticks: { color: '#6b7280' }, grid: { color: '#374151' } }
            } : {}
        }
    });
}

</script>
</body>
</html>
