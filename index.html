<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
<title>UberEat Salary Calculator V1.2.17 (米棕暖調版)</title>

<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#211B17"> <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/732/732200.png">

<meta property="og:title" content="UberEat 外送薪資計算器 V1.2.17 (米棕暖調版)" />
<meta property="og:description" content="專為 UberEat 外送員打造，採用統一的米棕色系 UI 設計，優化了介面佈局與色彩風格。" />
<meta property="og:type" content="website" />
<meta property="og:image" content="https://placehold.co/1200x630/A07F6A/E8D9CE?text=UberEat+V1.2.17" />

<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
    /* * 全面米棕色系調整 (基色 #D0B29A)
     * 主要顏色定義:
     * - 背景: #211B17 (深紅棕)
     * - 卡片/輸入框: #332A25 (略淺紅棕)
     * - 主色/強調色: #A07F6A (米棕色)
     * - 文字/淨利: #E8D9CE (暖白色)
     * - 成本: #7F4F42 (深紅棕)
     */
    
    /* === 全局設定 (深色暖調風格) === */
    body { 
        background-color: #211B17; /* 深紅棕色 (取代極黑) */
        color: #E8D9CE; /* 暖白色 (取代亮灰) */
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; 
        padding-bottom: 120px; 
        padding-top: env(safe-area-inset-top); 
    }
    
    /* === 顏色覆蓋 (確保 Tailwind 預設顏色符合新色系) === */
    .text-white, .text-gray-800, .text-gray-100 { color: #E8D9CE !important; } /* 高光文字 */
    .text-gray-400 { color: #A07F6A !important; } /* 標籤和低調文字 */
    .text-gray-500 { color: #6D5C53 !important; } /* 次要文字 */
    
    /* === 卡片樣式 (圓潤、柔和的深色卡片) === */
    .card {
        background-color: #332A25; /* 略淺的紅棕色 (取代深灰) */
        border: 1px solid #443B33; /* 略深的紅棕邊框 */
        border-radius: 1.5rem; 
        padding: 1.5rem; 
        margin-bottom: 1rem;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2); 
        position: relative;
    }
    .card-glow { 
        border-color: #A07F6A; /* 主色邊框 */
        box-shadow: 0 0 10px rgba(160, 127, 106, 0.4); 
    } 

    /* === 輸入框 (統一的 #4F4F4F 變體) === */
    .input-field {
        background-color: #443B33; /* 輸入框背景更深，增加對比 */
        border: 1px solid #6D5C53;
        color: #E8D9CE !important; /* **【覆蓋】文字顏色使用暖白色** */
        border-radius: 0.8rem; 
        padding: 0.8rem;
        width: 100%;
        font-size: 1rem;
        font-weight: 500; 
        transition: 0.2s;
    }
    .input-field:focus { 
        outline: none; 
        border-color: #A07F6A; /* 主色焦點色 */
        background-color: #4C4037; 
    }
    
    /* 營業額 (強調色調整) */
    #inputIncome {
        color: #F0A38C !important; /* 暖橘色 (營收強調色) */
        font-weight: bold;
    }

    /* === 按鈕 (統一風格) === */
    .btn { width: 100%; padding: 0.8rem; border-radius: 0.8rem; font-weight: 600; transition: 0.2s; display: flex; justify-content: center; align-items: center;}
    .btn-primary { 
        background-color: #A07F6A; /* 主按鈕使用米棕色 */
        color: white; 
    } 
    .btn-primary:active { 
        background-color: #8D6B58; 
        transform: scale(0.98); 
    }
    .btn-danger { 
        background-color: #7F4F42; /* 深紅棕色 (成本/危險) */
        color: #E8D9CE; 
        border: 1px solid #7F4F42; 
        font-weight: normal; 
    }
    .btn-ghost { 
        background-color: transparent; 
        border: 1px solid #6D5C53; 
        color: #A07F6A; /* 主色文字 */
    }
    
    /* 圖表切換按鈕 */
    .chart-toggle-btn { background: #443B33; color: #E8D9CE; border: 1px solid #6D5C53; }
    .chart-toggle-btn.active { background: #A07F6A; color: white; border-color: #A07F6A; } 

    /* === 儀表板與歷史數字顏色定義 (米棕色系) === */
    .text-amber-soft { color: #F0A38C !important; } /* 營收 - 暖橘色 */
    .text-green-400, .text-green-500, .text-green-300 { color: #E8D9CE !important; } /* 淨利 - 暖白色 (高光) */
    .text-red-400, .text-red-500, .text-red-300 { color: #7F4F42 !important; } /* 成本 - 深紅棕色 */
    .text-blue-500, .text-blue-400 { color: #A07F6A !important; } /* 雲端/自訂義標籤使用主色 */

    /* === 篩選 Tab (統一風格) === */
    .tab-btn {
        padding: 0.5rem 1rem; border-radius: 2rem; font-size: 0.9rem; 
        color: #E8D9CE; 
        background: #332A25; 
        border: 1px solid #6D5C53; 
        white-space: nowrap;
    }
    /* 活躍 Tab */
    .tab-btn.active { 
        background-color: #E8D9CE; 
        color: #332A25; /* 深色文字 */
        font-weight: bold; 
        border-color: #E8D9CE;
    }
    /* 圖表按鈕 */
    .tab-btn.border-green-500.text-green-400 { 
        border-color: #A07F6A !important; 
        color: #A07F6A !important; 
    }

    /* === 歷史列表 (卡片背景，深色分隔線) === */
    .history-item {
        background-color: #332A25; 
        border-bottom: 1px solid #443B33; 
        /* ... 保持內邊距與過渡動畫 ... */
        padding-top: 1.25rem; 
        padding-bottom: 0rem; 
        padding-left: 1rem;
        padding-right: 1rem;
        transition: background 0.2s;
    }
    .history-main-area:active { background-color: #443B33; } 
    .stat-label-small { font-size: 0.7rem; color: #A07F6A; text-transform: uppercase; } /* 標籤使用主色 */
    .history-toggle-icon { color: #E8D9CE; } /* 圖示使用暖白色 */
    .history-sub-stats {
        color: #E8D9CE;
        border-top: 1px solid #443B33; 
    }
    
    /* 儀表板分隔線 */
    .border-t.border-white\/10 { border-top-color: #443B33 !important; }

    /* 移除頂部 Logo 左側的顏色條 */
    .w-1\.5 { display: none !important; }

</style>
</head>
<body class="max-w-md mx-auto p-3">

    <div class="flex justify-between items-center mb-4 px-1 pt-2">
        <div class="flex items-center gap-2">
            <div class="w-1.5 h-6 bg-[#A07F6A] rounded-full"></div> 
            <div>
                <h1 class="text-lg font-bold text-white leading-tight">UberEat 外送薪資計算器</h1>
                <div class="text-[10px] text-gray-500">V1.2.17 米棕暖調版</div>
            </div>
        </div>
        <div class="flex gap-2">
            <button onclick="toggleAuthPanel()" class="p-2 bg-[#332A25] rounded-full text-gray-400 border border-[#6D5C53] text-xs active:bg-[#443B33]">
                <span class="text-sm">☁️</span> <span id="authStatusText">未登入</span>
            </button>
            <button onclick="toggleSettings()" class="p-2 bg-[#332A25] rounded-full text-gray-400 border border-[#6D5C53] text-xs active:bg-[#443B33]">
                <span class="text-sm">⚙️</span> 設定
            </button>
        </div>
    </div>

    <div id="authPanel" class="hidden mb-4 card">
        <h3 class="text-blue-500 font-bold mb-3 text-sm uppercase">雲端驗證</h3>
        <div id="authContent">
            <div id="authForm" class="grid grid-cols-1 gap-3 mb-3">
                <div>
                    <label class="stat-label mb-1">Email</label>
                    <input id="authEmail" type="email" class="input-field" placeholder="your@email.com" />
                </div>
                <div>
                    <label class="stat-label mb-1">密碼</label>
                    <input id="authPassword" type="password" class="input-field" placeholder="密碼 (至少6位)" />
                </div>
                <button onclick="registerUser()" class="btn btn-primary text-sm">註冊 (新帳號)</button>
                <button onclick="loginUser()" class="btn btn-ghost text-sm border-blue-600 text-blue-400">登入 (已有帳號)</button>
                <button onclick="resetPassword()" class="text-xs text-gray-500 hover:text-gray-400 mt-2">忘記密碼？</button>
            </div>
            
            <div id="userInfo" class="hidden">
                <p class="text-white mb-3">歡迎，<span id="userEmailDisplay" class="font-semibold text-amber-soft"></span></p>
                <button onclick="logoutUser()" class="btn btn-danger text-sm">登出並清除本機狀態</button>
            </div>
        </div>
    </div>

    <div id="settingsPanel" class="hidden mb-4 card">
        <h3 class="text-green-500 font-bold mb-3 text-sm uppercase">全域參數</h3>
        <div class="grid grid-cols-2 gap-3 mb-3">
            <div>
                <label class="stat-label mb-1">油品</label>
                <select id="oilType" class="input-field" onchange="fetchOilPrice()">
                    <option value="92">92 無鉛</option>
                    <option value="95">95 無鉛</option>
                    <option value="98">98 無鉛</option>
                    <option value="diesel">柴油</option>
                </select>
            </div>
            <div>
                <label class="stat-label mb-1">目前油價</label>
                <div id="oilPriceDisplay" class="input-field text-amber-soft font-bold">讀取中...</div>
            </div>
        </div>
        <div class="grid grid-cols-2 gap-3 mb-3">
            <div>
                <label class="stat-label mb-1">油耗 (km/L)</label>
                <input id="settingFuelRate" type="number" class="input-field" />
            </div>
            <div>
                <label class="stat-label mb-1">耗材 ($/km)</label>
                <input id="settingMaint" type="number" step="0.1" class="input-field" />
            </div>
        </div>
        <button onclick="saveSettings()" class="btn btn-primary text-sm">儲存設定</button>
    </div>

    <div class="card mb-4 p-5" id="editorCard">
        <div class="flex justify-between items-center border-b border-[#443B33] pb-2 cursor-pointer" onclick="toggleEditor()">
            <h3 class="font-bold text-lg text-white leading-tight" id="editorTitle">
                新增紀錄
            </h3>
            <span id="editorToggleIcon" class="text-xl text-gray-400">▼</span>
        </div>
        
        <div id="editorContent" class="collapsible-content">
            <input type="hidden" id="editId" value="">
            <input type="hidden" id="recordOilPrice" value=""> 
            
            <div class="flex justify-end items-center mb-3">
                 <span id="editorOilHint" class="text-xs text-gray-500 hidden">鎖定油價: --</span>
            </div>

            <div class="flex flex-col gap-3 mb-4">
                <div>
                    <label class="stat-label mb-1">日期</label>
                    <input id="inputDate" type="date" class="input-field cursor-pointer text-sm" onclick="this.showPicker()" />
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="stat-label mb-1">營業額</label>
                        <input id="inputIncome" type="number" inputmode="numeric" class="input-field text-amber-soft font-bold text-lg" placeholder="$0" />
                    </div>
                    <div>
                        <label class="stat-label mb-1">單數</label>
                        <input id="inputOrders" type="number" inputmode="numeric" class="input-field" placeholder="0" />
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-2 gap-3 mb-4">
                <div>
                    <label class="stat-label mb-1">里程</label>
                    <input id="inputDist" type="number" step="0.1" inputmode="decimal" class="input-field" placeholder="KM" />
                </div>
                <div>
                    <label class="stat-label mb-1">工時</label>
                    <div class="flex gap-1">
                        <input id="inputHr" type="number" class="input-field text-center px-1" placeholder="時" />
                        <input id="inputMin" type="number" class="input-field text-center px-1" placeholder="分" />
                    </div>
                </div>
            </div>

            <div class="flex gap-2">
                <button onclick="saveRecord()" class="btn btn-primary" id="btnSave">儲存</button>
                <button onclick="deleteCurrentRecord()" class="btn btn-danger hidden" id="btnDelete">刪除</button>
                <button onclick="resetEditor()" class="btn btn-ghost hidden" id="btnCancel">取消</button>
            </div>
        </div>
    </div>

    <div class="card mb-4 p-5" id="dashboardCard">
        <div class="flex justify-between items-center cursor-pointer" onclick="toggleDashboard()">
            <h3 class="font-bold text-lg text-white leading-tight">
                區間總營收儀表板
            </h3>
            <span id="dashboardToggleIcon" class="text-xl text-gray-400">▼</span>
        </div>
        
        <div id="dashboardContent" class="collapsible-content">
            <div class="grid grid-cols-3 gap-2">

                <div class="flex flex-col items-center text-center">
                    <label class="stat-label text-gray-400">區間總營收</label>
                    <div class="text-3xl font-bold text-amber-soft mt-1 tracking-tight">$<span id="dashTotalIncome">0</span></div>
                </div>
                <div class="flex flex-col items-center text-center"> 
                    <label class="stat-label text-red-400">總成本</label>
                    <div class="text-3xl font-bold text-red-400 mt-1 tracking-tight">$<span id="dashTotalCost">0</span></div> 
                </div>
                <div class="flex flex-col items-center text-center">
                    <label class="stat-label text-green-400">總淨利</label>
                    <div class="text-3xl font-bold text-green-400 mt-1 tracking-tight">$<span id="dashNetProfit">0</span></div>
                </div>

                <div class="col-span-3 border-t border-white/10 pt-4 mt-4"></div>

                <div class="flex flex-col items-center text-center">
                    <label class="stat-label text-red-400">油耗成本</label>
                    <div class="text-lg font-bold text-red-400 mt-1">$<span id="dashOilCost">0</span></div>
                </div>
                <div class="flex flex-col items-center text-center">
                    <label class="stat-label text-red-400">耗材成本</label>
                    <div class="text-lg font-bold text-red-400 mt-1">$<span id="dashMaintCost">0</span></div>
                </div>
                <div class="flex flex-col items-center text-center">
                    <label class="stat-label text-gray-400 text-xs">總單/總時</label>
                    <div class="text-xl font-bold text-white mt-1 leading-tight">
                        <span id="dashOrders">0</span>單 / <span id="dashHours">0</span>h<span id="dashMinutes">0</span>m
                    </div>
                </div>
                
                <div class="col-span-3 border-t border-white/10 pt-4 mt-4 grid grid-cols-2 gap-4">
                    <div class="flex flex-col items-center text-center">
                        <label class="stat-label text-amber-soft">未扣成本實薪</label>
                        <div class="text-2xl font-bold text-amber-soft my-1 tracking-tight">$<span id="dashGrossHourly">0</span></div>
                    </div>
                    <div class="flex flex-col items-center text-center">
                        <label class="stat-label text-green-400">已扣成本實薪</label>
                        <div class="text-2xl font-bold text-green-400 my-1 tracking-tight">$<span id="dashNetHourly">0</span></div>
                    </div>
                </div>

                <div class="col-span-3 border-t border-white/10 pt-4 mt-4 grid grid-cols-2 gap-4">
                    <div class="flex flex-col items-center text-center">
                        <label class="stat-label text-amber-soft">每單平均營收</label>
                        <div class="text-xl font-bold text-amber-soft my-1 tracking-tight">$<span id="dashGrossPerOrder">0</span></div>
                    </div>
                    <div class="flex flex-col items-center text-center">
                        <label class="stat-label text-green-400">每單平均淨利</label>
                        <div class="text-xl font-bold text-green-400 my-1 tracking-tight">$<span id="dashNetPerOrder">0</span></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="tab-scroll-container mb-3">
        <div class="tab-scroll-content">
            <button class="tab-btn active" onclick="setFilter('day', this)">今日</button>
            <button class="tab-btn" onclick="setFilter('week', this)">本週</button>
            <button class="tab-btn" onclick="setFilter('month', this)">本月</button>
            <button class="tab-btn" onclick="setFilter('year', this)">本年</button>
            <button class="tab-btn" onclick="setFilter('all', this)">全部</button>
            <button class="tab-btn" onclick="setFilter('custom', this)">自定義</button> 
            <button class="tab-btn border-green-500 text-green-400" onclick="toggleCharts()">圖表分析</button>
        </div>
    </div>
    
    <div id="customDateFilter" class="card p-3 mb-4 hidden">
        <h3 class="text-xs font-bold text-blue-400 mb-2 uppercase">自定義區間篩選</h3>
        <div class="flex gap-2 items-center">
            <input type="date" id="filterStart" class="input-field text-sm py-1" onchange="applyCustomFilter()" />
            <span class="text-gray-500">至</span>
            <input type="date" id="filterEnd" class="input-field text-sm py-1" onchange="applyCustomFilter()" />
        </div>
    </div>

    <div id="chartsPanel" class="hidden card mb-4">
        <div class="flex justify-between items-center mb-3">
            <h4 class="text-sm font-bold text-white">數據分析中心</h4>
            <div class="flex bg-[#443B33] rounded-lg p-1">
                <button onclick="switchChartType('bar')" id="btnChartBar" class="chart-toggle-btn active px-3 py-1 rounded text-xs">趨勢圖</button>
                <button onclick="switchChartType('pie')" id="btnChartPie" class="chart-toggle-btn px-3 py-1 rounded text-xs">圓餅圖</button>
            </div>
        </div>

        <div class="bg-[#211B17] p-2 rounded-lg mb-3">
            <div class="flex gap-2 mb-2">
                <input type="date" id="chartStart" class="input-field text-xs py-1" onchange="updateChart()" />
                <span class="text-gray-500 self-center">~</span>
                <input type="date" id="chartEnd" class="input-field text-xs py-1" onchange="updateChart()" />
            </div>
            <div class="flex items-center gap-2">
                <label class="text-xs text-gray-500">分組:</label>
                <select id="chartGroupBy" class="input-field text-xs py-1" onchange="updateChart()">
                    <option value="day">依日期 (日)</option>
                    <option value="month">依月份 (月)</option>
                    <option value="year">依年份 (年)</option>
                </select>
            </div>
        </div>

        <div style="position: relative; height: 300px; width: 100%;">
            <canvas id="mainChart" class="bg-[#332A25] rounded-lg p-2"></canvas>
        </div>
    </div>

    <div class="mb-8">
        <h3 class="text-xs font-bold text-gray-500 mb-2 uppercase pl-1">區間明細</h3>
        <div id="historyList" class="rounded-xl overflow-hidden"></div>
    </div>

    <div class="footer-credit text-center text-xs py-4 border-t border-[#443B33]">
        <div class="text-[#6D5C53]">UberEat 外送薪資計算器 V1.2.17 (米棕暖調版)</div>
        <div class="mt-1 text-[#6D5C53]">Developed by Ray © 2025</div>
    </div>

<script>
// === Firebase 配置與初始化 (保持不變) ===
const firebaseConfig = {
    apiKey: "AIzaSyAqiTFbvsIkUVUrBmwaR28448EFMg4FO-w", // 您的 Key
    authDomain: "uber-driver-tracker.firebaseapp.com",
    projectId: "uber-driver-tracker", 
    storageBucket: "uber-driver-tracker.appspot.com",
    messagingSenderId: "333010467554",
    appId: "1:333010467554:web:86f6a5067253fa433878b2"
};

let db; 
let firebaseUnsubscribe = null; 

if (typeof firebase !== 'undefined' && firebaseConfig.apiKey) {
    firebase.initializeApp(firebaseConfig);
    db = firebase.firestore();
    console.log("Firebase 初始化成功。");
} else {
    console.error("Firebase SDK 載入失敗或配置錯誤。雲端同步功能將不會啟用。");
}


// === 變數與初始化 (保持不變) ===
const workerAPI = "https://ubereat-oil-proxy.leo3026772.workers.dev/";
let globalOilPrice = 30.0;
let currentFilter = 'day';
let chartInstance = null;
let chartType = 'bar'; 

window.onload = async () => {
    loadCollapseStates(); 
    resetEditor();
    loadSettings();
    
    const today = getLocalDateString();
    
    document.getElementById('filterStart').value = today;
    document.getElementById('filterEnd').value = today;

    const now = new Date();
    document.getElementById('chartStart').value = new Date(now.getFullYear(), 0, 1).toISOString().slice(0,10);
    document.getElementById('chartEnd').value = today;

    if (typeof firebase !== 'undefined' && firebaseConfig.apiKey) {
        firebase.auth().onAuthStateChanged(user => {
            if (user) {
                document.getElementById('authStatusText').innerText = "已登入"; 
                document.getElementById('userEmailDisplay').innerText = user.email;
                document.getElementById('authForm').classList.add('hidden');
                document.getElementById('userInfo').classList.remove('hidden');
                setupRealtimeListener(user);
            } else {
                document.getElementById('authStatusText').innerText = "未登入"; 
                document.getElementById('authForm').classList.remove('hidden');
                document.getElementById('userInfo').classList.add('hidden');
                
                if (firebaseUnsubscribe) {
                    firebaseUnsubscribe();
                    firebaseUnsubscribe = null;
                }
                refreshDashboard(); 
            }
        });
    } else {
        refreshDashboard();
    }
    
    await fetchOilPrice();
};

function getLocalDateString() {
    const offset = new Date().getTimezoneOffset() * 60000;
    return new Date(Date.now() - offset).toISOString().split('T')[0];
}

// === 收合/展開相關函數 (保持不變) ===
function togglePanel(panelId, iconId, storageKey) {
    const content = document.getElementById(panelId + 'Content');
    const icon = document.getElementById(iconId);
    
    if (content.classList.contains('collapsible-content')) {
        if (content.classList.contains('is-collapsed')) {
            content.classList.remove('is-collapsed');
            icon.innerText = '▼'; 
            localStorage.removeItem(storageKey); 
        } else {
            content.classList.add('is-collapsed');
            icon.innerText = '▶'; 
            localStorage.setItem(storageKey, 'true');
        }
    } else {
        // 處理非動畫收合區塊 (如 Auth/Settings)
        content.classList.toggle('hidden');
    }
}

function toggleEditor() {
    togglePanel('editor', 'editorToggleIcon', 'editorCollapsed');
}

function toggleDashboard() {
    togglePanel('dashboard', 'dashboardToggleIcon', 'dashboardCollapsed');
}

function loadCollapseStates() {
    const editorContent = document.getElementById('editorContent');
    const editorIcon = document.getElementById('editorToggleIcon');
    if (localStorage.getItem('editorCollapsed') === 'true') {
        editorContent.classList.add('is-collapsed');
        editorIcon.innerText = '▶'; 
    } else {
        editorContent.classList.remove('is-collapsed');
        editorIcon.innerText = '▼'; 
    }

    const dashboardContent = document.getElementById('dashboardContent');
    const dashboardIcon = document.getElementById('dashboardToggleIcon');
    if (localStorage.getItem('dashboardCollapsed') === 'true') {
        dashboardContent.classList.add('is-collapsed');
        dashboardIcon.innerText = '▶'; 
    } else {
        dashboardContent.classList.remove('is-collapsed');
        dashboardIcon.innerText = '▼'; 
    }
}

function toggleHistoryDetails(id) {
    const content = document.getElementById(`detail-${id}`);
    const icon = document.getElementById(`icon-detail-${id}`);

    if (content.classList.contains('hidden')) {
        content.classList.remove('hidden');
        icon.innerText = '▼'; 
    } else {
        content.classList.add('hidden');
        icon.innerText = '▶'; 
    }
}


// === Firebase 相關函數 (保持不變) ===
function setupRealtimeListener(user) {
    if (!user || !db) return;
    
    if (firebaseUnsubscribe) {
        firebaseUnsubscribe();
        firebaseUnsubscribe = null;
    }

    const userRef = db.collection('records').doc(user.uid);

    firebaseUnsubscribe = userRef.onSnapshot((doc) => {
        if (doc.exists) {
            const cloudList = doc.data().data || [];
            
            const currentLocalList = getHistory();
            
            if (JSON.stringify(cloudList) !== JSON.stringify(currentLocalList)) {
                console.log(`[Realtime Sync] 偵測到雲端資料更新，共 ${cloudList.length} 筆。`);
                
                saveToHistory(cloudList); 
                refreshDashboard(); 
                
            } else {
                console.log('[Realtime Sync] 雲端資料與本地一致，刷新儀表板確保一致性。');
                refreshDashboard();
            }
        } else {
            const localList = getHistory();
            if (localList.length > 0) {
                console.log("雲端文件不存在，但偵測到本地紀錄，執行單次上傳。");
                uploadHistory(localList, user);
            } else {
                console.log("雲端與本地均無紀錄。");
                refreshDashboard();
            }
        }
    }, (error) => {
        console.error("[Realtime Listener Error]", error);
        alert(`實時同步發生錯誤: ${error.message}，請嘗試重新整理。`);
        refreshDashboard(); 
    });
}


function toggleAuthPanel() { 
    document.getElementById('authPanel').classList.toggle('hidden'); 
}

function registerUser() {
    const email = document.getElementById('authEmail').value;
    const password = document.getElementById('authPassword').value;
    if (email.length < 5 || password.length < 6) {
        return alert("Email 或密碼格式不正確 (密碼需至少6位)");
    }
    if (!db) return alert("Firebase 資料庫未初始化，請檢查配置。");
    
    firebase.auth().createUserWithEmailAndPassword(email, password)
        .then((userCredential) => {
            console.log("註冊成功，已自動登入:", userCredential.user.email);
            document.getElementById('authPanel').classList.add('hidden');
        })
        .catch((error) => {
            console.error("註冊失敗:", error.message);
            alert(`註冊失敗: ${error.message}`);
        });
}

function loginUser() {
    const email = document.getElementById('authEmail').value;
    const password = document.getElementById('authPassword').value;
    if (!db) return alert("Firebase 資料庫未初始化，請檢查配置。");

    firebase.auth().signInWithEmailAndPassword(email, password)
        .then((userCredential) => {
            console.log("登入成功:", userCredential.user.email);
            document.getElementById('authPanel').classList.add('hidden');
        })
        .catch((error) => {
            console.error("登入失敗:", error.message);
            alert(`登入失敗: ${error.message}`);
        });
}

function logoutUser() {
    if (!db) return alert("Firebase 資料庫未初始化，請檢查配置。");
    
    if (firebaseUnsubscribe) {
        firebaseUnsubscribe();
        firebaseUnsubscribe = null;
    }
    
    firebase.auth().signOut()
        .then(() => {
            console.log("登出成功");
            localStorage.removeItem('uber_ray_v1');
            document.getElementById('authPanel').classList.add('hidden'); 
            alert("登出成功，本機紀錄已清除。下次登入將自動同步雲端資料。");
        })
        .catch((error) => {
            console.error("登出失敗:", error.message);
            alert(`登出失敗: ${error.message}`);
        });
}

function resetPassword() {
    const email = document.getElementById('authEmail').value;
    if (!email) return alert("請先輸入您的 Email！");
    if (!db) return alert("Firebase 資料庫未初始化，請檢查配置。");
    
    firebase.auth().sendPasswordResetEmail(email)
        .then(() => {
            alert("密碼重設郵件已寄出，請檢查您的信箱！");
        })
        .catch((error) => {
            console.error("密碼重設失敗:", error.message);
            alert(`密碼重設失敗: ${error.message}`);
        });
}

async function uploadHistory(data, user) {
    user = user || firebase.auth().currentUser;
    if (!user || !db) {
        console.warn("未登入使用者或資料庫未初始化，無法執行雲端上傳。");
        return;
    }
    
    try {
        await db.collection('records').doc(user.uid).set({
            data: data,
            lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
        });
        console.log(`雲端上傳成功，共 ${data.length} 筆紀錄。`);
    } catch (e) {
        console.error("雲端資料上傳失敗:", e);
    }
}


// === 設定處理 (保持不變) ===
function loadSettings() {
    document.getElementById('settingFuelRate').value = localStorage.getItem('fuelRate') || 12;
    document.getElementById('settingMaint').value = localStorage.getItem('maintCost') || 1.5;
    document.getElementById('oilType').value = localStorage.getItem('oilType') || '95';
}
function saveSettings() {
    localStorage.setItem('fuelRate', document.getElementById('settingFuelRate').value);
    localStorage.setItem('maintCost', document.getElementById('settingMaint').value);
    localStorage.setItem('oilType', document.getElementById('oilType').value);
    document.getElementById('settingsPanel').classList.add('hidden');
    refreshDashboard();
}
function toggleSettings() { document.getElementById('settingsPanel').classList.toggle('hidden'); }

// === 油價獲取 (保持不變) ===
async function fetchOilPrice() {
    try {
        const type = document.getElementById('oilType').value;
        const res = await fetch(workerAPI);
        const data = await res.json();
        if(data[type]) {
            globalOilPrice = parseFloat(data[type]);
            document.getElementById('oilPriceDisplay').innerText = `$${globalOilPrice}`;
        } else {
            document.getElementById('oilPriceDisplay').innerText = `$${globalOilPrice} (預設/API錯誤)`;
        }
    } catch(e) { 
        document.getElementById('oilPriceDisplay').innerText = `$${globalOilPrice} (預設/網路錯誤)`;
    }
}

// === 歷史資料 CRUD ===
function getHistory() { try { return JSON.parse(localStorage.getItem('uber_ray_v1') || '[]'); } catch { return []; } }
function saveToHistory(data) { localStorage.setItem('uber_ray_v1', JSON.stringify(data)); }

function saveRecord() {
    const date = document.getElementById('inputDate').value;
    const income = parseFloat(document.getElementById('inputIncome').value);
    const orders = parseFloat(document.getElementById('inputOrders').value);
    const km = parseFloat(document.getElementById('inputDist').value);
    const hr = parseFloat(document.getElementById('inputHr').value) || 0;
    const min = parseFloat(document.getElementById('inputMin').value) || 0;
    const editId = document.getElementById('editId').value;
    const lockedOil = document.getElementById('recordOilPrice').value;

    if(!date) return console.error('請選日期');
    if(isNaN(income) || isNaN(km)) return console.error('請填寫金額與里程');

    const finalOil = (editId && lockedOil) ? parseFloat(lockedOil) : globalOilPrice;
    const rec = {
        id: editId ? parseInt(editId) : Date.now(),
        date: date, income: income, orders: orders||0, km: km, hours: hr+(min/60),
        oilPrice: finalOil,
        fuelRate: parseFloat(document.getElementById('settingFuelRate').value),
        maintCost: parseFloat(document.getElementById('settingMaint').value)
    };

    const list = getHistory();
    if(editId) {
        const idx = list.findIndex(r => r.id == editId);
        if(idx!==-1) list[idx] = rec;
    } else {
        list.push(rec);
        if(date === getLocalDateString()) { currentFilter = 'day'; updateTabs(); }
    }
    list.sort((a,b) => new Date(b.date)-new Date(a.date));
    saveToHistory(list);
    
    uploadHistory(list);

    resetEditor();
}

function loadRecordToEditor(id) {
    const r = getHistory().find(i => i.id === id);
    if(!r) return;
    
    // 展開編輯器
    document.getElementById('editorContent').classList.remove('is-collapsed');
    document.getElementById('editorToggleIcon').innerText = '▼'; 
    localStorage.removeItem('editorCollapsed');
    
    document.getElementById('editId').value = r.id;
    document.getElementById('recordOilPrice').value = r.oilPrice || globalOilPrice;
    document.getElementById('inputDate').value = r.date;
    document.getElementById('inputIncome').value = r.income;
    document.getElementById('inputOrders').value = r.orders;
    document.getElementById('inputDist').value = r.km;
    const h = Math.floor(r.hours);
    document.getElementById('inputHr').value = h;
    document.getElementById('inputMin').value = Math.round((r.hours-h)*60);

    const hint = document.getElementById('editorOilHint');
    hint.classList.remove('hidden');
    hint.innerText = `鎖定油價: $${r.oilPrice||globalOilPrice}`;
    
    // 標題移除 Emoji
    document.getElementById('editorTitle').innerText = "編輯紀錄"; 
    document.getElementById('editorCard').classList.add('card-glow');
    document.getElementById('btnSave').innerText = "確認修改";
    document.getElementById('btnDelete').classList.remove('hidden');
    document.getElementById('btnCancel').classList.remove('hidden');
    document.getElementById('editorCard').scrollIntoView({behavior:'smooth'});
}

function deleteCurrentRecord() {
    console.warn('執行刪除操作。'); 
    
    const id = document.getElementById('editId').value;
    if (!id) return;
    
    const list = getHistory();
    const originalLength = list.length;
    
    const newList = list.filter(r => r.id != id);
    if(newList.length === originalLength) {
        console.error(`刪除失敗：找不到 ID 為 ${id} 的紀錄。`);
        return;
    }

    saveToHistory(newList);
    uploadHistory(newList);
    
    resetEditor();
}

function resetEditor() {
    document.getElementById('editId').value = "";
    document.getElementById('recordOilPrice').value = "";
    document.getElementById('inputDate').value = getLocalDateString();
    document.getElementById('inputIncome').value = "";
    document.getElementById('inputOrders').value = "";
    document.getElementById('inputDist').value = "";
    document.getElementById('inputHr').value = "";
    document.getElementById('inputMin').value = "";
    // 標題移除 Emoji
    document.getElementById('editorTitle').innerText = "新增紀錄"; 
    document.getElementById('editorOilHint').classList.add('hidden');
    document.getElementById('editorCard').classList.remove('card-glow');
    document.getElementById('btnSave').innerText = "儲存";
    document.getElementById('btnDelete').classList.add('hidden');
    document.getElementById('btnCancel').classList.add('hidden');
}

// === 篩選與儀表板更新 (保持不變) ===
function updateTabs(btn) {
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    if(btn) btn.classList.add('active');
    else {
        const buttons = document.querySelectorAll('.tab-scroll-content .tab-btn');
        const map = {'day':0, 'week':1, 'month':2, 'year':3, 'all':4, 'custom':5};
        buttons[map[currentFilter]]?.classList.add('active');
    }
}

function applyCustomFilter() {
    if (currentFilter === 'custom') {
        const start = document.getElementById('filterStart').value;
        const end = document.getElementById('filterEnd').value;
        if (start && end) {
            refreshDashboard();
        }
    }
}

function setFilter(type, btn) {
    currentFilter = type;
    updateTabs(btn);
    const customPanel = document.getElementById('customDateFilter');
    
    if (type === 'custom') {
        customPanel.classList.remove('hidden');
        applyCustomFilter(); 
    } else {
        customPanel.classList.add('hidden');
        refreshDashboard();
    }
}


function getFilteredData() {
    const list = getHistory();
    const todayStr = getLocalDateString();
    
    if(currentFilter==='day') return list.filter(r=>r.date===todayStr);

    if(currentFilter==='week') {
        const d = new Date();
        const dayOfWeek = (d.getDay() + 6) % 7; 
        
        const startDate = new Date(d);
        startDate.setDate(d.getDate() - dayOfWeek); 
        
        const startDateStr = startDate.toISOString().split('T')[0];
        return list.filter(r => r.date >= startDateStr);
    }
    
    if(currentFilter==='month') return list.filter(r=>r.date.startsWith(todayStr.slice(0,7)));
    if(currentFilter==='year') return list.filter(r=>r.date.startsWith(todayStr.slice(0,4)));
    if(currentFilter==='all') return list;

    if(currentFilter==='custom') {
        const start = document.getElementById('filterStart').value;
        const end = document.getElementById('filterEnd').value;
        return list.filter(r => r.date >= start && r.date <= end);
    }
    
    return list; 
}

function calculateRecordStats(record) {
    const { income, orders, km, hours, oilPrice, fuelRate, maintCost } = record;
    
    // 1. 成本計算
    const oilCost = (km / fuelRate) * oilPrice;
    const maintenanceCost = km * maintCost;
    const totalCost = oilCost + maintenanceCost;
    
    // 2. 淨利計算
    const netProfit = income - totalCost;

    // 3. 時薪計算
    const grossHourly = hours > 0 ? income / hours : 0;
    const netHourly = hours > 0 ? netProfit / hours : 0;

    // 4. 單價計算
    const grossPerOrder = orders > 0 ? income / orders : 0;
    const netPerOrder = orders > 0 ? netProfit / orders : 0;


    return {
        ...record,
        oilCost: oilCost,
        maintenanceCost: maintenanceCost,
        totalCost: totalCost,
        netProfit: netProfit,
        grossHourly: grossHourly,
        netHourly: netHourly,
        grossPerOrder: grossPerOrder,
        netPerOrder: netPerOrder
    };
}

function refreshDashboard() {
    const filtered = getFilteredData().map(calculateRecordStats);
    
    // 總計數據
    const totals = filtered.reduce((acc, r) => {
        acc.totalIncome += r.income;
        acc.totalCost += r.totalCost;
        acc.netProfit += r.netProfit;
        acc.totalOilCost += r.oilCost;
        acc.totalMaintCost += r.maintenanceCost;
        acc.totalOrders += r.orders;
        acc.totalHours += r.hours;
        return acc;
    }, {
        totalIncome: 0,
        totalCost: 0,
        netProfit: 0,
        totalOilCost: 0,
        totalMaintCost: 0,
        totalOrders: 0,
        totalHours: 0
    });
    
    // 計算平均時薪與單價
    const totalGrossHourly = totals.totalHours > 0 ? totals.totalIncome / totals.totalHours : 0;
    const totalNetHourly = totals.totalHours > 0 ? totals.netProfit / totals.totalHours : 0;
    const totalGrossPerOrder = totals.totalOrders > 0 ? totals.totalIncome / totals.totalOrders : 0;
    const totalNetPerOrder = totals.totalOrders > 0 ? totals.netProfit / totals.totalOrders : 0;

    // 更新儀表板
    document.getElementById('dashTotalIncome').innerText = formatCurrency(totals.totalIncome);
    document.getElementById('dashTotalCost').innerText = formatCurrency(totals.totalCost);
    document.getElementById('dashNetProfit').innerText = formatCurrency(totals.netProfit);
    document.getElementById('dashOilCost').innerText = formatCurrency(totals.totalOilCost);
    document.getElementById('dashMaintCost').innerText = formatCurrency(totals.totalMaintCost);
    document.getElementById('dashOrders').innerText = totals.totalOrders.toFixed(0);
    document.getElementById('dashHours').innerText = Math.floor(totals.totalHours);
    document.getElementById('dashMinutes').innerText = Math.round((totals.totalHours - Math.floor(totals.totalHours)) * 60);
    document.getElementById('dashGrossHourly').innerText = formatCurrency(totalGrossHourly);
    document.getElementById('dashNetHourly').innerText = formatCurrency(totalNetHourly);
    document.getElementById('dashGrossPerOrder').innerText = formatCurrency(totalGrossPerOrder);
    document.getElementById('dashNetPerOrder').innerText = formatCurrency(totalNetPerOrder);

    // V1.2.17: 更新歷史列表結構
    const listHtml = filtered.map(r => `
        <div class="history-item">
            <div class="history-header-wrapper">
                <div class="history-main-area" onclick="loadRecordToEditor(${r.id})">
                    <div class="history-top-row">
                        <div class="history-stat-group w-1/3">
                            <div class="text-sm font-semibold text-white">${r.date.slice(5)}</div>
                            <div class="history-main-value text-amber-soft">$${formatCurrency(r.income)}</div>
                            <div class="stat-label-small text-amber-soft">總營收</div>
                        </div>
                        
                        <div class="history-stat-group center w-1/3">
                            <div class="text-sm font-semibold text-red-300">成本</div>
                            <div class="history-main-value text-red-400">$${formatCurrency(r.totalCost)}</div>
                            <div class="stat-label-small text-red-500">油耗 + 耗材</div>
                        </div>

                        <div class="history-stat-group right w-1/3">
                            <div class="text-sm font-semibold text-green-300">淨利</div>
                            <div class="history-main-value text-green-400">$${formatCurrency(r.netProfit)}</div>
                            <div class="stat-label-small text-green-500">實賺</div>
                        </div>
                    </div>
                </div>
                <span id="icon-detail-${r.id}" class="history-toggle-icon" onclick="event.stopPropagation(); toggleHistoryDetails(${r.id});">▶</span>
            </div>

            <div id="detail-${r.id}" class="history-sub-stats hidden">
                <div class="flex flex-col gap-1 w-full">
                    <div class="flex justify-between items-center">
                        <span class="stat-label-small text-gray-400">單數/里程</span>
                        <span class="text-white">${r.orders} 單 / ${r.km.toFixed(1)} KM</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="stat-label-small text-gray-400">工時</span>
                        <span class="text-white">${formatDuration(r.hours)}</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="stat-label-small text-red-500">油/耗材成本</span>
                        <span class="text-red-400">$${formatCurrency(r.oilCost)} / $${formatCurrency(r.maintenanceCost)}</span>
                    </div>
                </div>
                
                <div class="w-full performance-summary flex flex-col gap-1">
                     <div class="flex justify-between items-center">
                        <span class="stat-label-small text-green-500">已扣成本時薪</span>
                        <span class="text-green-400 font-bold">$${formatCurrency(r.netHourly)}</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="stat-label-small text-amber-soft">每單平均營收</span>
                        <span class="text-amber-soft">$${formatCurrency(r.grossPerOrder)}</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="stat-label-small text-green-500">每單平均淨利</span>
                        <span class="text-green-400 font-bold">$${formatCurrency(r.netPerOrder)}</span>
                    </div>
                </div>
            </div>
        </div>
    `).join('');
    
    document.getElementById('historyList').innerHTML = listHtml || `
        <div class="p-5 text-center text-gray-500 text-sm">
            --- 此區間暫無紀錄 ---
        </div>
    `;
    
    if (!document.getElementById('chartsPanel').classList.contains('hidden')) {
        updateChart();
    }
}

// === 輔助函數 (Utility Functions - 保持不變) ===
function formatCurrency(num) {
    if (isNaN(num)) return '0';
    const isNegative = num < 0;
    const formatted = Math.abs(num).toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ",");
    return isNegative ? `-${formatted}` : formatted;
}

function formatDuration(totalHours) {
    const hours = Math.floor(totalHours);
    const minutes = Math.round((totalHours - hours) * 60);
    let str = '';
    if (hours > 0) str += `${hours}h`;
    if (minutes > 0) str += `${minutes}m`;
    if (hours === 0 && minutes === 0) return '0m';
    return str.trim();
}

// === 圖表相關函數 (Charts - 更新顏色) ===

function toggleCharts() {
    const panel = document.getElementById('chartsPanel');
    panel.classList.toggle('hidden');
    if (!panel.classList.contains('hidden')) {
        updateChart();
    } else {
        destroyChart();
    }
}

function switchChartType(type) {
    chartType = type;
    document.getElementById('btnChartBar').classList.remove('active');
    document.getElementById('btnChartPie').classList.remove('active');
    document.getElementById(`btnChart${type.charAt(0).toUpperCase() + type.slice(1)}`).classList.add('active');
    updateChart();
}

function destroyChart() {
    if (chartInstance) {
        chartInstance.destroy();
        chartInstance = null;
    }
}

function updateChart() {
    destroyChart();
    
    const start = document.getElementById('chartStart').value;
    const end = document.getElementById('chartEnd').value;
    const groupBy = document.getElementById('chartGroupBy').value;

    if (!start || !end) return;

    const allData = getHistory().map(calculateRecordStats);
    const chartData = allData.filter(r => r.date >= start && r.date <= end);
    
    if (chartData.length === 0) {
        const ctx = document.getElementById('mainChart').getContext('2d');
        if (ctx) ctx.clearRect(0, 0, 300, 300);
        return;
    }

    let groupedData = {};

    if (groupBy === 'day') {
        chartData.forEach(r => {
            const label = r.date.slice(5); 
            if (!groupedData[label]) { groupedData[label] = { income: 0, netProfit: 0, cost: 0, orders: 0 }; }
            groupedData[label].income += r.income;
            groupedData[label].netProfit += r.netProfit;
            groupedData[label].cost += r.totalCost;
            groupedData[label].orders += r.orders;
        });
    } else if (groupBy === 'month') {
        chartData.forEach(r => {
            const label = r.date.slice(0, 7); 
            if (!groupedData[label]) { groupedData[label] = { income: 0, netProfit: 0, cost: 0, orders: 0 }; }
            groupedData[label].income += r.income;
            groupedData[label].netProfit += r.netProfit;
            groupedData[label].cost += r.totalCost;
            groupedData[label].orders += r.orders;
        });
    } else if (groupBy === 'year') {
        chartData.forEach(r => {
            const label = r.date.slice(0, 4); 
            if (!groupedData[label]) { groupedData[label] = { income: 0, netProfit: 0, cost: 0, orders: 0 }; }
            groupedData[label].income += r.income;
            groupedData[label].netProfit += r.netProfit;
            groupedData[label].cost += r.totalCost;
            groupedData[label].orders += r.orders;
        });
    }

    const labels = Object.keys(groupedData).sort();

    const ctx = document.getElementById('mainChart').getContext('2d');

    if (chartType === 'bar') {
        chartInstance = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [
                    {
                        label: '淨利潤',
                        data: labels.map(l => groupedData[l].netProfit),
                        backgroundColor: '#E8D9CE', /* 淨利使用暖白色 */
                        borderRadius: 4,
                    },
                    {
                        label: '總成本',
                        data: labels.map(l => groupedData[l].cost),
                        backgroundColor: '#7F4F42', /* 成本使用深紅棕色 */
                        borderRadius: 4,
                    },
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: {
                        stacked: true,
                        grid: { display: false, color: '#332A25' }, /* 網格線顏色調整 */
                        ticks: { color: '#E8D9CE' } /* 座標軸文字顏色調整 */
                    },
                    y: {
                        stacked: true,
                        beginAtZero: true,
                        grid: { color: '#443B33' }, /* 網格線顏色調整 */
                        ticks: { color: '#E8D9CE' } /* 座標軸文字顏色調整 */
                    }
                },
                plugins: {
                    legend: {
                        labels: { color: '#E8D9CE' } /* 圖例文字顏色調整 */
                    },
                    tooltip: {
                        callbacks: {
                            label: (context) => {
                                let label = context.dataset.label || '';
                                if (label) { label += ': '; }
                                if (context.parsed.y !== null) { label += `$${context.parsed.y.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ",")}`; }
                                return label;
                            }
                        }
                    }
                }
            }
        });
    } else if (chartType === 'pie') {
        const totalOilCost = chartData.reduce((sum, r) => sum + r.oilCost, 0);
        const totalMaintCost = chartData.reduce((sum, r) => sum + r.maintenanceCost, 0);
        const totalNetProfit = chartData.reduce((sum, r) => sum + r.netProfit, 0);
        
        chartInstance = new Chart(ctx, {
            type: 'pie',
            data: {
                labels: ['總淨利', '總油耗成本', '總耗材成本'],
                datasets: [{
                    // 顏色更新: 淨利(#E8D9CE), 油耗(#A07F6A), 耗材(#7F4F42)
                    data: [totalNetProfit, totalOilCost, totalMaintCost],
                    backgroundColor: ['#E8D9CE', '#A07F6A', '#7F4F42'], 
                    hoverOffset: 4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'top',
                        labels: { color: '#E8D9CE' } /* 圖例文字顏色調整 */
                    },
                    tooltip: {
                        callbacks: {
                            label: (context) => {
                                const total = context.chart.data.datasets[0].data.reduce((a, b) => a + b, 0);
                                const value = context.raw;
                                const percentage = ((value / total) * 100).toFixed(1) + '%';
                                return `${context.label}: $${value.toFixed(0)} (${percentage})`;
                            }
                        }
                    }
                }
            }
        });
    }
}
</script>
</body>
</html>
