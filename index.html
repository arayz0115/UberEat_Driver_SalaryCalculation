<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Uber Driver è¨ˆç®—å™¨ï¼ˆæ·±ç°å„ªåŒ–ç‰ˆï¼‰</title>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tailwindcss@3.4.4/base.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tailwindcss@3.4.4/components.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tailwindcss@3.4.4/utilities.min.css">
<style>
body { @apply bg-gray-900 text-gray-100; }
.card { @apply bg-gray-800 shadow-xl rounded-2xl p-5 mb-6 border border-gray-700; }
input, select { @apply w-full bg-gray-700 border border-gray-600 text-gray-100 p-2 rounded-lg; }
.btn-main { @apply bg-blue-600 text-white rounded-lg px-4 py-2 hover:bg-blue-700 transition w-full font-semibold; }
.btn-sub { @apply bg-gray-600 text-white rounded-lg px-3 py-1 hover:bg-gray-500 transition text-sm; }
.title { @apply text-xl font-semibold mb-3 text-blue-300; }
</style>
</head>
<body class="p-4">
<h1 class="text-3xl font-bold text-center mb-6 text-blue-400">Uber Driver è¨ˆç®—å™¨</h1>

<div id="oilPriceDisplayMain" class="text-center text-blue-300 font-semibold mb-4">è®€å–ä¸­...</div>

<!-- æˆæœ¬è¨­å®š -->
<div class="card">
<h2 class="title">æˆæœ¬è¨­å®š</h2>
<label>æ²¹å“ç¨®é¡</label>
<select id="fuelType" class="mb-3">
<option value="92">92 ç„¡é‰›</option>
<option value="95">95 ç„¡é‰›</option>
<option value="98">98 ç„¡é‰›</option>
<option value="diesel">æŸ´æ²¹</option>
</select>
<label>æ²¹è€— (km/L)</label>
<input id="fuelRate" class="mb-3" />
<label>æ¯å…¬é‡Œè€—ææˆæœ¬ ($/km)</label>
<input id="maintCost" class="mb-3" />
<button class="btn-main mt-2" onclick="saveSettings()">å„²å­˜è¨­å®š</button>
</div>

<!-- ç•¶æ—¥è¼¸å…¥ -->
<div class="card">
<h2 class="title">ç•¶æ—¥æ•¸æ“šè¼¸å…¥</h2>
<label>æ—¥æœŸ</label>
<input id="recordDate" type="date" class="mb-3" />
<label>ç‡Ÿæ¥­é¡</label>
<input id="dayIncome" class="mb-3" />
<label>å¯¦éš›å…¬é‡Œæ•¸</label>
<input id="dayDistance" class="mb-3" />
<label>å·¥ä½œæ™‚æ•¸</label>
<input id="workHours" class="mb-3" />
<button class="btn-main" onclick="saveRecord()">å„²å­˜ç´€éŒ„</button>
</div>

<!-- ç•¶æ—¥è¨ˆç®— -->
<div class="card">
<h2 class="title">æ”¶ç›Šåˆ†æ</h2>
<div id="previewResult" class="text-gray-300">å°šç„¡è³‡æ–™</div>
</div>

<!-- åœ“é¤…åœ– -->
<div class="card">
<h2 class="title">æˆæœ¬æ¯”ä¾‹åœ–</h2>
<canvas id="pieChart" height="150"></canvas>
</div>

<!-- æ­·å²ç´€éŒ„ -->
<div class="card">
<h2 class="title">æ­·å²ç´€éŒ„</h2>
<div id="historyList" class="space-y-3"></div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
const workerAPI = "https://ubereat-oil-proxy.leo3026772.workers.dev";
let oilPrices = {92:27.1,95:28.6,98:30.6,diesel:25.5};
let globalOilPrice = 27.1;

async function fetchOilPrice() {
    try {
        const res = await fetch(workerAPI);
        const data = await res.json();
        oilPrices = data;
        const f = document.getElementById('fuelType').value;
        globalOilPrice = oilPrices[f];
        document.getElementById('oilPriceDisplayMain').textContent = `${f}ï¼š$${globalOilPrice}/L`;
    } catch (err) {
        document.getElementById('oilPriceDisplayMain').textContent = `æ²¹åƒ¹è®€å–å¤±æ•—ï¼Œä½¿ç”¨é è¨­`;
    }
}

function saveSettings() {
    const fuelRate = document.getElementById('fuelRate').value;
    const maint = document.getElementById('maintCost').value;
    const fuelType = document.getElementById('fuelType').value;
    localStorage.setItem('fuelRate', fuelRate);
    localStorage.setItem('maintCost', maint);
    localStorage.setItem('fuelType', fuelType);
    alert('è¨­å®šå·²å„²å­˜');
    fetchOilPrice();
}

function loadSettings() {
    document.getElementById('fuelRate').value = localStorage.getItem('fuelRate') || 40;
    document.getElementById('maintCost').value = localStorage.getItem('maintCost') || 0.6;
    document.getElementById('fuelType').value = localStorage.getItem('fuelType') || "92";
}

function saveRecord() {
    const record = {
        date: recordDate.value,
        income: +dayIncome.value,
        km: +dayDistance.value,
        hours: +workHours.value,
        fuelType: fuelType.value,
        oilPrice: oilPrices[fuelType.value]
    };

    const all = JSON.parse(localStorage.getItem('history') || '[]');
    all.push(record);
    localStorage.setItem('history', JSON.stringify(all));
    loadHistory();
}

let pieChart;
function updateChart(oilCost, maintCost, net) {
    if (pieChart) pieChart.destroy();
    pieChart = new Chart(document.getElementById('pieChart'), {
        type: 'pie',
        data: {
            labels: ['æ²¹è²»', 'è€—æ', 'ç´”æ”¶ç›Š'],
            datasets: [{ data: [oilCost, maintCost, net] }]
        }
    });
}

function loadHistory() {
    const list = document.getElementById('historyList');
    list.innerHTML = "";
    const all = JSON.parse(localStorage.getItem('history') || '[]');

    all.forEach((r, idx) => {
        const oilCost = (r.km / (localStorage.getItem('fuelRate')||40)) * r.oilPrice;
        const maint = r.km * (localStorage.getItem('maintCost')||0.6);
        const net = r.income - oilCost - maint;

        const div = document.createElement('div');
        div.className = "border border-gray-700 p-3 rounded-lg bg-gray-700";
        div.innerHTML = `
            <div>ğŸ“… ${r.date}</div>
            <div>ç‡Ÿæ¥­é¡ï¼š$${r.income}</div>
            <div>å…¬é‡Œæ•¸ï¼š${r.km} km</div>
            <div>æ²¹å“ï¼š${r.fuelType}ï¼ˆ$${r.oilPrice}ï¼‰</div>
            <div>ç´”æ”¶ç›Šï¼š$${net.toFixed(0)}</div>
            <div class='flex space-x-2 mt-2'>
                <button class='btn-sub' onclick='editRecord(${idx})'>ç·¨è¼¯</button>
                <button class='btn-sub' onclick='deleteRecord(${idx})'>åˆªé™¤</button>
            </div>`;
        list.appendChild(div);
    });
}

function editRecord(i) {
    const all = JSON.parse(localStorage.getItem('history') || '[]');
    const r = all[i];
    recordDate.value = r.date;
    dayIncome.value = r.income;
    dayDistance.value = r.km;
    workHours.value = r.hours;
    fuelType.value = r.fuelType;
    alert('å·²è¼‰å…¥ï¼Œå¯é‡æ–°å„²å­˜è¦†è“‹');
}

function deleteRecord(i) {
    const all = JSON.parse(localStorage.getItem('history') || '[]');
    all.splice(i,1);
    localStorage.setItem('history', JSON.stringify(all));
    loadHistory();
}

window.onload = () => {
    loadSettings();
    fetchOil
