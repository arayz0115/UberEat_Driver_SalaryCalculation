<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
<title>Uber Driver è¨˜å¸³ V5.2 (ä¿®æ­£ç‰ˆ)</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
    /* === å…¨å±€æ·±è‰²ä¸»é¡Œ === */
    body { background-color: #0a0a0a; color: #e5e5e5; font-family: -apple-system, BlinkMacSystemFont, Roboto, sans-serif; padding-bottom: 80px; }
    
    /* === å¡ç‰‡èˆ‡å€å¡Š === */
    .dashboard-card {
        background-color: #15161b;
        border: 1px solid #262936;
        border-radius: 1rem;
        padding: 1rem;
        box-shadow: 0 4px 6px rgba(0,0,0,0.2);
        margin-bottom: 0.75rem;
    }

    /* === è¼¸å…¥æ¡†å„ªåŒ– === */
    .input-dark {
        background-color: #1f2128;
        border: 1px solid #333645;
        color: #fff;
        border-radius: 0.5rem;
        padding: 0.6rem;
        width: 100%;
        font-size: 1rem;
    }
    .input-dark:focus { outline: none; border-color: #6366f1; }

    /* === é‡è¦ï¼šä¿®æ­£æ—¥æœŸåœ–ç¤ºé¡è‰² === */
    input[type="date"] {
        color-scheme: dark; /* è®“ç€è¦½å™¨è‡ªå‹•é©æ‡‰æ·±è‰²æ¨¡å¼ */
    }
    /* å¼·åˆ¶ Chrome/Safari çš„æ—¥æ›† icon è®Šç™½ */
    input[type="date"]::-webkit-calendar-picker-indicator {
        filter: invert(1);
        cursor: pointer;
        opacity: 0.8;
    }

    /* === æŒ‰éˆ• === */
    .btn-action {
        width: 100%; padding: 0.75rem; border-radius: 0.5rem; font-weight: 600; transition: 0.2s;
    }
    .btn-save { background-color: #6366f1; color: white; } /* é›è— */
    .btn-save:active { background-color: #4f46e5; }
    .btn-cancel { background-color: #374151; color: #d1d5db; }

    .filter-btn {
        background-color: #1f2128; color: #9ca3af;
        padding: 0.4rem 0.8rem; border-radius: 0.5rem; font-size: 0.85rem;
        border: 1px solid #333; white-space: nowrap;
    }
    .filter-btn.active { background-color: #3730a3; color: #fff; border-color: #6366f1; }

    /* === æŠ˜ç–Šå€å¡Šæ¨£å¼ === */
    .accordion-header {
        background-color: #1f2128;
        padding: 0.8rem 1rem;
        border-radius: 0.75rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
        cursor: pointer;
        border: 1px solid #333;
        margin-bottom: 0.5rem;
        transition: background 0.2s;
    }
    .accordion-header:active { background-color: #2d3748; }
    .accordion-content {
        overflow: hidden;
        transition: max-height 0.3s ease-out;
        max-height: 0; /* é è¨­éš±è— */
    }
    .accordion-content.open {
        max-height: 1000px; /* è¶³å¤ å¤§çš„é«˜åº¦ä»¥é¡¯ç¤ºå…§å®¹ */
        margin-bottom: 1rem;
    }

    /* === æ–‡å­— === */
    .label-text { color: #9ca3af; font-size: 0.8rem; margin-bottom: 0.25rem; display: block; }
    .highlight-purple { color: #c084fc; }
    .highlight-green { color: #34d399; }
</style>
</head>
<body class="p-3 max-w-md mx-auto">

    <div class="flex justify-between items-center mb-4 px-1">
        <h1 class="text-lg font-bold text-gray-100 tracking-wide">Uber é›²ç«¯ç‰ˆ V5.2</h1>
        <button onclick="toggleAccordion('settingsPanel')" class="text-gray-400 p-2 bg-[#1f2128] rounded-lg text-sm border border-[#333]">âš™ï¸ è¨­å®š</button>
    </div>

    <div id="settingsPanel" class="accordion-content px-1">
        <div class="dashboard-card border-yellow-600/30">
            <h3 class="text-yellow-500 font-bold mb-3 text-sm">åƒæ•¸è¨­å®š</h3>
            <div class="grid grid-cols-2 gap-3 mb-3">
                <div>
                    <label class="label-text">æ²¹å“</label>
                    <select id="oilType" class="input-dark" onchange="fetchOilPrice()">
                        <option value="92">92 ç„¡é‰›</option>
                        <option value="95">95 ç„¡é‰›</option>
                        <option value="98">98 ç„¡é‰›</option>
                        <option value="diesel">æŸ´æ²¹</option>
                    </select>
                </div>
                <div>
                    <label class="label-text">å³æ™‚æ²¹åƒ¹</label>
                    <div class="input-dark text-yellow-400" id="oilPriceDisplay">--</div>
                </div>
            </div>
            <div class="grid grid-cols-2 gap-3 mb-3">
                <div>
                    <label class="label-text">æ²¹è€— (km/L)</label>
                    <input id="settingFuelRate" type="number" class="input-dark" />
                </div>
                <div>
                    <label class="label-text">è€—æ ($/km)</label>
                    <input id="settingMaint" type="number" step="0.1" class="input-dark" />
                </div>
            </div>
            <button onclick="saveSettings()" class="bg-gray-700 text-white w-full py-2 rounded text-sm">å„²å­˜è¨­å®š</button>
        </div>
    </div>

    <div class="mb-4">
        <div class="dashboard-card bg-gradient-to-br from-[#1e1b2e] to-[#15161b] border-purple-900/50">
            <label class="label-text text-gray-400">å€é–“ç¸½ç‡Ÿæ”¶</label>
            <div class="flex items-baseline gap-1 mt-1">
                <span class="text-2xl text-gray-500">$</span>
                <span id="dashTotalIncome" class="text-4xl font-bold text-white tracking-wider">0</span>
            </div>
            <div class="flex justify-between mt-4 pt-3 border-t border-gray-800">
                <div>
                    <label class="label-text">æ·¨åˆ©</label>
                    <div id="dashNetProfit" class="text-xl font-bold text-green-400">$0</div>
                </div>
                <div class="text-right">
                    <label class="label-text">çœŸå¯¦æ™‚è–ª</label>
                    <div id="dashRealHourly" class="text-xl font-bold text-purple-400">$0</div>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-3 gap-2">
            <div class="dashboard-card flex flex-col justify-center items-center py-3">
                <span class="text-xs text-gray-500">é‡Œç¨‹</span>
                <span id="dashDistance" class="text-lg font-bold text-gray-200">0</span>
            </div>
            <div class="dashboard-card flex flex-col justify-center items-center py-3">
                <span class="text-xs text-gray-500">å–®æ•¸</span>
                <span id="dashOrders" class="text-lg font-bold text-gray-200">0</span>
            </div>
            <div class="dashboard-card flex flex-col justify-center items-center py-3">
                <span class="text-xs text-gray-500">æ™‚æ•¸</span>
                <span class="text-lg font-bold text-gray-200"><span id="dashHours">0</span>.<span id="dashMinutes" class="text-sm">0</span>h</span>
            </div>
        </div>
    </div>

    <div id="inputHeader" onclick="toggleAccordion('inputContent')" class="accordion-header">
        <span class="font-bold text-indigo-400 flex items-center gap-2">
            <span class="bg-indigo-900/50 p-1 rounded text-xs">âœï¸</span> 
            <span id="inputTitle">æ–°å¢ä»Šæ—¥ç´€éŒ„</span>
        </span>
        <span class="text-gray-500 text-xl">â–¼</span>
    </div>
    
    <div id="inputContent" class="accordion-content">
        <div class="dashboard-card border-indigo-500/30">
            <input type="hidden" id="editId" value=""> <div class="mb-3">
                <label class="label-text">æ—¥æœŸ (é»æ“Šé¸å–)</label>
                <input id="inputDate" type="date" class="input-dark" />
            </div>

            <div class="grid grid-cols-2 gap-3 mb-3">
                <div>
                    <label class="label-text">ç‡Ÿæ¥­é¡ ($)</label>
                    <input id="inputIncome" type="number" inputmode="numeric" class="input-dark text-yellow-300 font-bold" placeholder="0" />
                </div>
                <div>
                    <label class="label-text">ç¸½å–®æ•¸</label>
                    <input id="inputOrders" type="number" inputmode="numeric" class="input-dark" placeholder="0" />
                </div>
            </div>

            <div class="grid grid-cols-2 gap-3 mb-3">
                <div>
                    <label class="label-text">é‡Œç¨‹ (KM)</label>
                    <input id="inputDist" type="number" step="0.1" inputmode="decimal" class="input-dark" placeholder="0" />
                </div>
                <div>
                    <label class="label-text">å·¥æ™‚ (æ™‚ / åˆ†)</label>
                    <div class="flex gap-2">
                        <input id="inputHr" type="number" placeholder="æ™‚" class="input-dark" />
                        <input id="inputMin" type="number" placeholder="åˆ†" class="input-dark" />
                    </div>
                </div>
            </div>

            <div class="flex gap-2 mt-4">
                <button onclick="saveRecord()" class="btn-action btn-save" id="btnSave">å„²å­˜ç´€éŒ„</button>
                <button onclick="cancelEdit()" class="btn-action btn-cancel hidden" id="btnCancel">å–æ¶ˆç·¨è¼¯</button>
            </div>
        </div>
    </div>

    <div class="flex gap-2 overflow-x-auto pb-2 mb-2 mt-2 no-scrollbar px-1">
        <button class="filter-btn active" onclick="setFilter('day', this)">ä»Šæ—¥</button>
        <button class="filter-btn" onclick="setFilter('week', this)">æœ¬é€±</button>
        <button class="filter-btn" onclick="setFilter('month', this)">æœ¬æœˆ</button>
        <button class="filter-btn" onclick="setFilter('all', this)">å…¨éƒ¨</button>
    </div>
    <div id="customDateRange" class="hidden gap-2 mb-3 px-1">
        <input type="date" id="startDate" class="input-dark py-1" />
        <input type="date" id="endDate" class="input-dark py-1" />
        <button onclick="setFilter('custom', null)" class="bg-indigo-600 px-3 rounded text-white text-xs">GO</button>
    </div>

    <div onclick="toggleAccordion('chartsContent', true)" class="accordion-header mt-4">
        <span class="font-bold text-gray-300 flex items-center gap-2">
            <span class="bg-gray-800 p-1 rounded text-xs">ğŸ“ˆ</span> åœ–è¡¨åˆ†æ
        </span>
        <span class="text-gray-500 text-xl">â–¼</span>
    </div>
    <div id="chartsContent" class="accordion-content">
        <div class="dashboard-card">
            <h4 class="text-xs text-gray-500 mb-2">ç‡Ÿæ”¶ vs æ·¨åˆ©</h4>
            <canvas id="mainChart" height="200"></canvas>
        </div>
        <div class="dashboard-card">
            <h4 class="text-xs text-gray-500 mb-2">æˆæœ¬çµæ§‹</h4>
            <div class="h-40 flex justify-center">
                <canvas id="pieChart"></canvas>
            </div>
        </div>
    </div>

    <div class="mt-4 px-1">
        <h3 class="text-sm font-bold text-gray-400 mb-2 pl-1 border-l-2 border-indigo-500">æ­·å²æ˜ç´° (é»æ“Šç·¨è¼¯)</h3>
        <div id="historyList" class="space-y-2 pb-20"></div>
    </div>

<script>
// === å…¨åŸŸè®Šæ•¸ ===
const workerAPI = "https://ubereat-oil-proxy.leo3026772.workers.dev/";
let globalOilPrice = 30.0;
let currentFilter = 'day';
let chartInstance = null;
let pieInstance = null;

// === 1. åˆå§‹åŒ– ===
window.onload = async () => {
    // è¨­å®šæ—¥æœŸæ¬„ä½é è¨­ç‚ºã€Œç•¶åœ°æ™‚é–“ä»Šå¤©ã€
    resetInputDate();
    
    loadSettings();
    refreshDashboard(); // å…ˆè¼‰å…¥ä»‹é¢
    await fetchOilPrice(); // å†æ›´æ–°æ²¹åƒ¹
    refreshDashboard(); // æ²¹åƒ¹æ›´æ–°å¾Œå†ç®—ä¸€æ¬¡
};

// ä¿®æ­£æ™‚å€å•é¡Œï¼šå–å¾—ç•¶åœ° YYYY-MM-DD
function getLocalDateString() {
    const now = new Date();
    // é€éåç§»é‡èª¿æ•´ï¼Œç¢ºä¿æ‹¿åˆ°çš„æ˜¯å°ç£æ™‚é–“çš„æ—¥æœŸå­—ä¸²
    const offset = now.getTimezoneOffset() * 60000;
    const localDate = new Date(now.getTime() - offset);
    return localDate.toISOString().split('T')[0];
}

function resetInputDate() {
    document.getElementById('inputDate').value = getLocalDateString();
}

// === 2. æ ¸å¿ƒé‚è¼¯ ===
function getHistory() {
    try {
        return JSON.parse(localStorage.getItem('uber_history_v5') || '[]');
    } catch (e) { return []; }
}

function saveToHistory(data) {
    localStorage.setItem('uber_history_v5', JSON.stringify(data));
}

function loadSettings() {
    const rate = localStorage.getItem('fuelRate') || 12;
    const maint = localStorage.getItem('maintCost') || 1.5;
    const type = localStorage.getItem('oilType') || '95';

    document.getElementById('settingFuelRate').value = rate;
    document.getElementById('settingMaint').value = maint;
    document.getElementById('oilType').value = type;
}

function saveSettings() {
    localStorage.setItem('fuelRate', document.getElementById('settingFuelRate').value);
    localStorage.setItem('maintCost', document.getElementById('settingMaint').value);
    
    // æ”¶èµ·è¨­å®šé¢æ¿
    document.getElementById('settingsPanel').classList.remove('open');
    
    refreshDashboard();
    alert('è¨­å®šå·²å„²å­˜ï¼Œæ­·å²æ•¸æ“šå°‡ä¾ç•¶ä¸‹æ²¹åƒ¹é‡æ–°è¨ˆç®—ã€‚');
}

async function fetchOilPrice() {
    try {
        const type = document.getElementById('oilType').value;
        const res = await fetch(workerAPI);
        const data = await res.json();
        if (data[type]) {
            globalOilPrice = data[type];
            document.getElementById('oilPriceDisplay').innerText = `$${globalOilPrice}`;
        }
    } catch (e) {
        document.getElementById('oilPriceDisplay').innerText = `$${globalOilPrice} (é è¨­)`;
    }
}

// === 3. ä»‹é¢äº’å‹• (æŠ˜ç–Šèˆ‡å±•é–‹) ===
function toggleAccordion(id, isChart = false) {
    const el = document.getElementById(id);
    const isOpen = el.classList.contains('open');
    
    if (isOpen) {
        el.classList.remove('open');
    } else {
        el.classList.add('open');
        // å¦‚æœæ˜¯åœ–è¡¨å€ï¼Œå±•é–‹æ™‚æ‰ç¹ªè£½ï¼Œç¯€çœè³‡æº
        if (isChart) drawCharts(getFilteredData());
    }
}

function openInputPanel() {
    const el = document.getElementById('inputContent');
    if (!el.classList.contains('open')) el.classList.add('open');
    // æ»¾å‹•åˆ°è¼¸å…¥å€
    document.getElementById('inputHeader').scrollIntoView({ behavior: 'smooth' });
}

// === 4. CRUD (æ–°å¢/ç·¨è¼¯/åˆªé™¤) ===
function saveRecord() {
    // å–å¾—æ¬„ä½å€¼
    const date = document.getElementById('inputDate').value;
    const income = parseFloat(document.getElementById('inputIncome').value);
    const orders = parseFloat(document.getElementById('inputOrders').value);
    const km = parseFloat(document.getElementById('inputDist').value);
    const hr = parseFloat(document.getElementById('inputHr').value) || 0;
    const min = parseFloat(document.getElementById('inputMin').value) || 0;

    // é©—è­‰
    if (!date) return alert('è«‹é¸æ“‡æ—¥æœŸ');
    if (isNaN(income) || isNaN(km)) return alert('è«‹è¼¸å…¥æœ‰æ•ˆçš„é‡‘é¡èˆ‡é‡Œç¨‹');

    const totalHours = hr + (min / 60);
    const editId = document.getElementById('editId').value;
    const list = getHistory();

    const record = {
        id: editId ? parseInt(editId) : Date.now(), // å¦‚æœæœ‰ ID å°±æ˜¯ç·¨è¼¯ï¼Œæ²’æœ‰å°±æ˜¯æ–°å¢
        date: date,
        income: income,
        orders: orders || 0,
        km: km,
        hours: totalHours,
        // å„²å­˜ç•¶ä¸‹çš„æˆæœ¬åƒæ•¸
        oilPrice: globalOilPrice,
        fuelRate: parseFloat(document.getElementById('settingFuelRate').value),
        maintCost: parseFloat(document.getElementById('settingMaint').value)
    };

    if (editId) {
        // ç·¨è¼¯æ¨¡å¼ï¼šæ‰¾åˆ°èˆŠçš„ä¸¦å–ä»£
        const index = list.findIndex(r => r.id == editId);
        if (index !== -1) list[index] = record;
        alert('ä¿®æ”¹æˆåŠŸï¼');
    } else {
        // æ–°å¢æ¨¡å¼
        list.push(record);
        // é€™è£¡åšå€‹å°å„ªåŒ–ï¼šå¦‚æœç›®å‰ç¯©é¸ä¸æ˜¯ã€Œä»Šæ—¥ã€æˆ–ã€Œå…¨éƒ¨ã€ï¼Œå¯èƒ½çœ‹ä¸åˆ°å‰›åŠ çš„è³‡æ–™
        // æ‰€ä»¥æ–°å¢å¾Œï¼Œæˆ‘å€‘å¼·åˆ¶åˆ‡æ›åˆ°ã€Œä»Šæ—¥ã€ä¸¦æŠŠæ—¥æœŸè¨­ç‚ºå‰›è¼¸å…¥çš„æ—¥æœŸï¼Œç¢ºä¿ä½¿ç”¨è€…çœ‹å¾—åˆ°
        const today = getLocalDateString();
        if (date === today) {
            currentFilter = 'day'; 
        } else {
            currentFilter = 'all'; // å¦‚æœåŠ çš„æ˜¯ä»¥å‰çš„æ—¥æœŸï¼Œåˆ‡åˆ°å…¨éƒ¨æ¯”è¼ƒä¿éšª
        }
        updateFilterBtns(); // æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
        alert('æ–°å¢æˆåŠŸï¼');
    }

    // å„²å­˜ä¸¦é‡æ•´
    // æ’åº (æ–° -> èˆŠ)
    list.sort((a, b) => new Date(b.date) - new Date(a.date));
    saveToHistory(list);
    
    cancelEdit(); // æ¸…ç©ºæ¬„ä½ä¸¦æ¢å¾©ç‹€æ…‹
    refreshDashboard();
}

function editRecord(id) {
    const list = getHistory();
    const r = list.find(item => item.id === id);
    if (!r) return;

    // å¡«å…¥è³‡æ–™
    document.getElementById('editId').value = r.id;
    document.getElementById('inputDate').value = r.date;
    document.getElementById('inputIncome').value = r.income;
    document.getElementById('inputOrders').value = r.orders;
    document.getElementById('inputDist').value = r.km;
    
    const h = Math.floor(r.hours);
    const m = Math.round((r.hours - h) * 60);
    document.getElementById('inputHr').value = h;
    document.getElementById('inputMin').value = m;

    // æ”¹è®Š UI ç‹€æ…‹
    document.getElementById('inputTitle').innerText = "ç·¨è¼¯æ¨¡å¼";
    document.getElementById('inputTitle').classList.add('text-yellow-400');
    document.getElementById('btnSave').innerText = "ç¢ºèªä¿®æ”¹";
    document.getElementById('btnCancel').classList.remove('hidden');

    openInputPanel();
}

function cancelEdit() {
    // æ¸…ç©º
    document.getElementById('editId').value = "";
    document.getElementById('inputIncome').value = "";
    document.getElementById('inputOrders').value = "";
    document.getElementById('inputDist').value = "";
    document.getElementById('inputHr').value = "";
    document.getElementById('inputMin').value = "";
    resetInputDate();

    // æ¢å¾© UI
    document.getElementById('inputTitle').innerText = "æ–°å¢ä»Šæ—¥ç´€éŒ„";
    document.getElementById('inputTitle').classList.remove('text-yellow-400');
    document.getElementById('btnSave').innerText = "å„²å­˜ç´€éŒ„";
    document.getElementById('btnCancel').classList.add('hidden');
}

function deleteRecord(id) {
    if(!confirm('ç¢ºå®šåˆªé™¤æ­¤ç´€éŒ„ï¼Ÿ')) return;
    const list = getHistory();
    const newList = list.filter(r => r.id !== id);
    saveToHistory(newList);
    
    // å¦‚æœæ­£åœ¨ç·¨è¼¯é€™ç­†ï¼Œå–æ¶ˆç·¨è¼¯ç‹€æ…‹
    if(document.getElementById('editId').value == id) {
        cancelEdit();
    }
    
    refreshDashboard();
}

// === 5. ç¯©é¸èˆ‡é¡¯ç¤º ===
function setFilter(type, btn) {
    currentFilter = type;
    updateFilterBtns(btn);
    refreshDashboard();
}

function updateFilterBtns(targetBtn) {
    document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
    if (targetBtn) {
        targetBtn.classList.add('active');
    } else {
        // å¦‚æœæ˜¯è‡ªå‹•åˆ‡æ›ï¼Œæ‰‹å‹•æ‰¾å°æ‡‰æŒ‰éˆ•äº®èµ·
        const map = {'day':0, 'week':1, 'month':2, 'all':3};
        const btns = document.querySelectorAll('.filter-btn');
        if(btns[map[currentFilter]]) btns[map[currentFilter]].classList.add('active');
    }
}

function getFilteredData() {
    const list = getHistory();
    const today = getLocalDateString();
    const now = new Date();

    if (currentFilter === 'day') {
        return list.filter(r => r.date === today);
    }
    if (currentFilter === 'week') {
        // ç°¡å–®è¨ˆç®—æœ¬é€±ï¼šå¾€å‰æ¨ 7 å¤©å…§å³å¯ï¼Œæˆ–æ˜¯æ‰¾æœ¬é€±ä¸€
        // é€™è£¡ç”¨ç°¡å–®çš„ã€Œéå»7å¤©ã€é‚è¼¯æ¯”è¼ƒç›´è¦ºï¼Œæˆ–è€…åš´è¬¹çš„é€±ä¸€é‚è¼¯
        const oneWeekAgo = new Date();
        oneWeekAgo.setDate(oneWeekAgo.getDate() - 7);
        return list.filter(r => new Date(r.date) >= oneWeekAgo);
    }
    if (currentFilter === 'month') {
        const thisMonth = today.slice(0, 7); // YYYY-MM
        return list.filter(r => r.date.startsWith(thisMonth));
    }
    return list; // 'all'
}

function refreshDashboard() {
    const data = getFilteredData();
    const listDiv = document.getElementById('historyList');
    
    let tIncome = 0, tKm = 0, tOrders = 0, tHours = 0, tNet = 0;
    let html = '';

    if (data.length === 0) {
        html = `<div class="text-center text-gray-600 py-6">æ­¤å€é–“ç„¡è³‡æ–™ï¼Œè«‹æ–°å¢ç´€éŒ„</div>`;
    } else {
        data.forEach(r => {
            // è¨ˆç®—å–®ç­†æˆæœ¬
            // å„ªå…ˆä½¿ç”¨ç´€éŒ„ç•¶ä¸‹çš„æ²¹åƒ¹/æ²¹è€—ï¼Œå¦‚æœæ²’æœ‰(èˆŠè³‡æ–™)å‰‡ç”¨å…¨åŸŸè¨­å®š
            const price = r.oilPrice || globalOilPrice;
            const rate = r.fuelRate || parseFloat(document.getElementById('settingFuelRate').value);
            const maint = r.maintCost !== undefined ? r.maintCost : parseFloat(document.getElementById('settingMaint').value);

            const cost = (r.km / rate) * price + (r.km * maint);
            const net = r.income - cost;

            tIncome += r.income;
            tKm += r.km;
            tOrders += r.orders;
            tHours += r.hours;
            tNet += net;

            html += `
                <div class="bg-[#1f2128] p-3 rounded-lg border border-gray-800 flex justify-between items-center relative overflow-hidden" onclick="editRecord(${r.id})">
                    <div class="z-10">
                        <div class="text-xs text-gray-500 mb-1 flex items-center gap-2">
                            <span>ğŸ“… ${r.date}</span>
                            ${r.date === getLocalDateString() ? '<span class="text-green-500 bg-green-900/30 px-1 rounded text-[10px]">TODAY</span>' : ''}
                        </div>
                        <div class="text-white font-bold text-lg">$${r.income} <span class="text-sm font-normal text-gray-500">(${r.orders}å–®)</span></div>
                    </div>
                    <div class="text-right z-10">
                        <div class="text-indigo-400 font-bold text-sm">æ·¨ $${Math.round(net)}</div>
                        <div class="text-gray-500 text-xs">${r.km}km / ${r.hours.toFixed(1)}hr</div>
                    </div>
                    <button onclick="event.stopPropagation(); deleteRecord(${r.id})" class="absolute right-0 top-0 bottom-0 w-12 bg-red-900/20 hover:bg-red-900/50 text-red-500 flex items-center justify-center opacity-0 hover:opacity-100 transition-opacity">
                        âœ•
                    </button>
                </div>
            `;
        });
    }

    listDiv.innerHTML = html;

    // æ›´æ–°å„€è¡¨æ¿
    document.getElementById('dashTotalIncome').innerText = Math.round(tIncome);
    document.getElementById('dashNetProfit').innerText = `$${Math.round(tNet)}`;
    
    const realHourly = tHours > 0 ? Math.round(tNet / tHours) : 0;
    document.getElementById('dashRealHourly').innerText = `$${realHourly}`;
    
    document.getElementById('dashDistance').innerText = Math.round(tKm);
    document.getElementById('dashOrders').innerText = tOrders;
    
    const showH = Math.floor(tHours);
    const showM = Math.round((tHours - showH) * 60);
    document.getElementById('dashHours').innerText = showH;
    document.getElementById('dashMinutes').innerText = showM;

    // å¦‚æœåœ–è¡¨å€æ˜¯é–‹è‘—çš„ï¼Œé †ä¾¿æ›´æ–°åœ–è¡¨
    if (document.getElementById('chartsContent').classList.contains('open')) {
        drawCharts(data);
    }
}

// === 6. åœ–è¡¨ç¹ªè£½ ===
function drawCharts(data) {
    // æº–å‚™è³‡æ–™ (æ’åºèˆŠåˆ°æ–°)
    const sorted = [...data].sort((a, b) => new Date(a.date) - new Date(b.date));
    const labels = sorted.map(r => r.date.slice(5)); // MM-DD
    const incomes = sorted.map(r => r.income);
    const nets = sorted.map(r => {
        const price = r.oilPrice || globalOilPrice;
        const rate = r.fuelRate || 12;
        const maint = r.maintCost || 1.5;
        return r.income - ((r.km/rate)*price + r.km*maint);
    });

    // 1. æ··åˆåœ– (Bar + Line)
    const ctx1 = document.getElementById('mainChart').getContext('2d');
    if (chartInstance) chartInstance.destroy();
    
    chartInstance = new Chart(ctx1, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [
                {
                    label: 'ç‡Ÿæ”¶',
                    data: incomes,
                    backgroundColor: '#6366f1',
                    borderRadius: 4,
                    order: 2
                },
                {
                    type: 'line',
                    label: 'æ·¨åˆ©',
                    data: nets,
                    borderColor: '#34d399',
                    borderWidth: 2,
                    tension: 0.4,
                    order: 1
                }
            ]
        },
        options: {
            responsive: true,
            plugins: { legend: { labels: { color: '#9ca3af' } } },
            scales: {
                x: { ticks: { color: '#6b7280' }, grid: { color: '#374151' } },
                y: { ticks: { color: '#6b7280' }, grid: { color: '#374151' } }
            }
        }
    });

    // 2. åœ“é¤…åœ– (æˆæœ¬çµæ§‹)
    let totalInc = 0, totalNet = 0;
    data.forEach(r => { totalInc += r.income; });
    nets.forEach(n => { totalNet += n; });
    const totalCost = totalInc - totalNet;

    const ctx2 = document.getElementById('pieChart').getContext('2d');
    if (pieInstance) pieInstance.destroy();

    pieInstance = new Chart(ctx2, {
        type: 'doughnut',
        data: {
            labels: ['æ·¨åˆ©', 'æˆæœ¬'],
            datasets: [{
                data: [Math.round(totalNet), Math.round(totalCost)],
                backgroundColor: ['#34d399', '#ef4444'],
                borderWidth: 0
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { position: 'right', labels: { color: '#9ca3af' } } }
        }
    });
}
</script>
</body>
</html>
