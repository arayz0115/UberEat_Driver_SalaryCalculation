<!DOCTYPE html>
<html lang="zh-tw">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Uber Driver 夥伴收入計算器</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .container { max-width: 1000px; }
        .net-profit { color: #10b981; } /* 綠色 */
        .cost-val { color: #f87171; } /* 紅色 */
        .input-group label { font-weight: 600; color: #4b5563; }
        .report-section { background-color: #ffffff; border-radius: 0.5rem; padding: 1.5rem; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1); }
        #loading-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255, 255, 255, 0.95); z-index: 1000;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            text-align: center;
        }
        .spinner { border: 4px solid rgba(0, 0, 0, 0.1); border-top: 4px solid #3b82f6; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .hidden { display: none !important; }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <div id="loading-overlay">
        <div class="spinner"></div>
        <p id="loading-text" class="mt-4 text-lg text-gray-600">連線雲端資料庫與油價中...</p>
        <p id="user-info" class="mt-2 text-sm text-gray-500"></p>
        <p id="message-area-load" class="mt-4 text-red-600 font-medium"></p>
    </div>
    
    <div id="app-content" class="container mx-auto p-4 sm:p-8 pt-10 hidden">
        <header class="mb-8">
            <h1 class="text-3xl font-bold text-center text-blue-700">Uber Driver 收入與成本計算器</h1>
            <p class="text-center text-gray-600 mt-2">即時追蹤您的盈虧與時薪。</p>
        </header>

        <div id="message-area" class="fixed top-4 right-4 z-50"></div>

        <main class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            
            <div class="lg:col-span-2 report-section">
                <h2 class="text-xl font-semibold mb-6 border-b pb-2 text-blue-600">今日收入與里程輸入</h2>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    
                    <div class="input-group">
                        <label for="income" class="block mb-2">平台總收入 ($)</label>
                        <input type="number" id="income" value="0" min="0" step="10" 
                               class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 text-lg" 
                               oninput="liveCalculate()" placeholder="e.g., 3500">
                    </div>
                    
                    <div class="input-group">
                        <label for="mileage" class="block mb-2">總里程 (km)</label>
                        <input type="number" id="mileage" value="0" min="0" step="1" 
                               class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 text-lg" 
                               oninput="liveCalculate()" placeholder="e.g., 180">
                    </div>
                    
                    <div class="input-group">
                        <label for="hours" class="block mb-2">上線時數 (小時)</label>
                        <input type="number" id="hours" value="0" min="0" step="1" 
                               class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 text-lg" 
                               oninput="liveCalculate()" placeholder="e.g., 8">
                    </div>
                    
                    <div class="input-group">
                        <label for="minutes" class="block mb-2">上線時數 (分鐘)</label>
                        <input type="number" id="minutes" value="0" min="0" step="5" max="59"
                               class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 text-lg" 
                               oninput="liveCalculate()" placeholder="e.g., 30">
                    </div>
                    
                </div>
                
                <div class="mt-8">
                    <h3 class="text-xl font-semibold mb-4 text-green-600">即時盈虧分析</h3>
                    <div class="space-y-3">
                        <div class="flex justify-between items-center text-lg border-b pb-2">
                            <span>平台總收入:</span>
                            <span id="liveGrossIncome" class="font-bold text-blue-600">$0.0</span>
                        </div>
                        <div class="flex justify-between items-center text-lg">
                            <span>預估油資成本 (根據 <span id="oilPriceDisplay" class="font-medium text-red-500"></span>):</span>
                            <span id="liveGasCost" class="font-bold cost-val">$0.0</span>
                        </div>
                        <div class="flex justify-between items-center text-lg">
                            <span>預估維護成本 (<span id="maintCostDisplay" class="font-medium text-red-500"></span>):</span>
                            <span id="liveMaintCost" class="font-bold cost-val">$0.0</span>
                        </div>
                        <div class="flex justify-between items-center text-xl font-bold pt-2 border-t mt-4">
                            <span>總成本:</span>
                            <span id="liveTotalCost" class="text-red-700">$0.0</span>
                        </div>
                        <div class="flex justify-between items-center text-2xl font-extrabold pt-2">
                            <span>淨利潤:</span>
                            <span id="liveNetProfit" class="net-profit">$0.0</span>
                        </div>
                    </div>
                </div>

                <div class="mt-8 p-4 bg-yellow-50 rounded-lg">
                    <h3 class="text-xl font-semibold mb-3 text-yellow-700">時薪指標</h3>
                    <div class="grid grid-cols-2 gap-4">
                        <div class="text-center">
                            <p class="text-sm text-gray-500">毛時薪 (不計成本)</p>
                            <span id="liveGrossHourly" class="text-2xl font-extrabold text-blue-600">$0.0/hr</span>
                        </div>
                        <div class="text-center">
                            <p class="text-sm text-gray-500">淨時薪 (計入成本)</p>
                            <span id="liveNetHourly" class="text-2xl font-extrabold net-profit">$0.0/hr</span>
                        </div>
                    </div>
                </div>

            </div>
            
            <div class="report-section flex flex-col space-y-8">
                
                <div>
                    <h2 class="text-xl font-semibold mb-4 text-blue-600">個人化成本參數</h2>
                    
                    <div class="space-y-4">
                        <div class="input-group">
                            <label for="fuelEfficiencyInput" class="block mb-2">平均油耗 (km/L):</label>
                            <input type="number" id="fuelEfficiencyInput" min="1" step="0.1" 
                                   class="w-full p-2 border border-gray-300 rounded-lg">
                            <p id="fuelEfficiencyDisplay" class="text-sm text-gray-500 mt-1"></p>
                        </div>
                        
                        <div class="input-group">
                            <label for="maintCostInput" class="block mb-2">每公里維護成本 ($/km):</label>
                            <input type="number" id="maintCostInput" min="0" step="0.01" 
                                   class="w-full p-2 border border-gray-300 rounded-lg">
                        </div>

                        <button onclick="saveConfig()" 
                                class="w-full bg-green-500 text-white p-2 rounded-lg hover:bg-green-600 transition duration-150">
                            儲存配置到雲端
                        </button>
                    </div>
                </div>

                <div class="border-t pt-6">
                    <h2 class="text-xl font-semibold mb-4 text-blue-600">油價資訊 (92 無鉛)</h2>
                    <p class="text-gray-700 mb-4">目前的油價將用於計算您的燃油成本。</p>
                    <button id="fetchOilPriceButton" onclick="fetchOilPrice()" 
                            class="w-full bg-yellow-500 text-white p-2 rounded-lg hover:bg-yellow-600 transition duration-150">
                        點擊獲取今日油價
                    </button>
                </div>

                <div class="border-t pt-6 flex-grow">
                    <h2 class="text-xl font-semibold mb-4 text-blue-600">成本比例圓餅圖</h2>
                    <div class="relative h-64">
                        <canvas id="costChart"></canvas>
                    </div>
                </div>

            </div>
        </main>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>

    <script src="https://www.gstatic.com/firebasejs/9.1.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.0/firebase-firestore-compat.js"></script>

    <script>
        // --- 核心常數 (預設值) ---
        const DEFAULT_FUEL_EFFICIENCY_KML = 42;
        const DEFAULT_MAINT_COST_PER_KM = 0.60;
        // ⚠️ 注意: 請務必替換此處的 YOUR_GEMINI_API_KEY
        const GEMINI_API_KEY = "YOUR_GEMINI_API_KEY"; 

        // 1. Firebase 專案配置 (請從您的 Firebase Console 取得)
        const FIREBASE_CONFIG = {
            apiKey: "AIzaSyAQiTfbvsIKUVuRBmwaR28448EFMg4F0-w", // 請檢查此 Key 是否正確
            authDomain: "uber-driver-tracker.firebaseapp.com",
            projectId: "uber-driver-tracker",
            storageBucket: "uber-driver-tracker.firebasestorage.app",
            messagingSenderId: "665088105970",
            appId: "1:665088105970:web:d2c73e4e43ee4cf9545f6b"
        };
        const appId = FIREBASE_CONFIG.appId;

        // App 核心狀態變數
        let db = null;
        let auth = null;
        let userId = null;
        let isAuthReady = false;
        let currentOilPrice = 30.0; // 預設值，如果 API 獲取失敗則使用此值
        let chartInstance = null; // 圓餅圖實例
        let userConfig = {
            fuelEfficiency: DEFAULT_FUEL_EFFICIENCY_KML,
            maintCostPerKm: DEFAULT_MAINT_COST_PER_KM
        };

        // 工具函數
        const configDocPath = (uid) => `artifacts/${appId}/users/${uid}/config/costs`;

        /** 顯示應用程式訊息 (成功/錯誤) */
        function showMessage(text, type = 'info') {
            const area = document.getElementById('message-area');
            const color = type === 'success' ? 'bg-green-100 border-green-400 text-green-700'
                        : type === 'error' ? 'bg-red-100 border-red-400 text-red-700'
                        : 'bg-blue-100 border-blue-400 text-blue-700';
            
            const alertDiv = document.createElement('div');
            alertDiv.className = `p-3 mb-2 border ${color} rounded-lg shadow-md`;
            alertDiv.textContent = text;
            area.appendChild(alertDiv);
            
            setTimeout(() => {
                alertDiv.remove();
            }, 5000);
        }

        // --- Firebase 初始化與認證 (使用 -compat 模式) ---
        function initFirebase() {
            try {
                // 1. 初始化 Firebase App
                const app = firebase.initializeApp(FIREBASE_CONFIG);
                
                // 2. 初始化 db 和 auth 變數 (使用 -compat 全域存取方法)
                db = app.firestore();
                auth = app.auth();
                window.db = db; // 為了讓外部函數也能存取
                
                // 3. 監聽認證狀態
                auth.onAuthStateChanged(async (user) => {
                    if (user) {
                        // 已經登入 (或匿名登入成功)
                        userId = user.uid;
                        isAuthReady = true;
                        
                        // 隱藏載入畫面並顯示主要內容
                        document.getElementById('loading-overlay').classList.add('hidden');
                        document.getElementById('app-content').classList.remove('hidden');
                        document.getElementById('user-info').textContent = `ID: ${userId}`;
                        window.userId = userId;

                        // 載入用戶配置和油價
                        await loadConfig();
                        await fetchOilPrice(true); 
                        initApp(); // 啟動應用程式核心邏輯
                        
                    } else if (!isAuthReady) {
                        // 尚未登入，執行匿名登入
                        console.log("嘗試匿名登入...");
                        await auth.signInAnonymously(); 
                        // 登入成功後，會再次觸發 onAuthStateChanged
                    }
                });

            } catch (error) {
                console.error("Firebase 初始化失敗:", error);
                document.getElementById('loading-text').textContent = "雲端初始化失敗，請檢查設定。";
                document.getElementById('message-area-load').textContent = "錯誤: " + error.message;
            }
        }
        
        // --- 應用程式啟動 (在 Firebase 登入後呼叫) ---
        window.initApp = function() {
            // 註冊 Chart.js 插件
            Chart.register(ChartDataLabels);
            
            // 綁定輸入框事件
            document.getElementById('income').addEventListener('input', liveCalculate);
            document.getElementById('mileage').addEventListener('input', liveCalculate);
            document.getElementById('hours').addEventListener('input', liveCalculate);
            document.getElementById('minutes').addEventListener('input', liveCalculate);
            
            // 確保首次計算和繪圖
            liveCalculate();
            updateChart(); 
        }


        // --- 設定檔讀寫 ---
        async function loadConfig() {
            if (!db || !userId) return;

            // 監聽配置檔變動
            db.doc(configDocPath(userId)).onSnapshot((docSnap) => {
                if (docSnap.exists) {
                    const data = docSnap.data();
                    userConfig.fuelEfficiency = data.fuelEfficiency || DEFAULT_FUEL_EFFICIENCY_KML;
                    userConfig.maintCostPerKm = data.maintCostPerKm || DEFAULT_MAINT_COST_PER_KM;
                }
                updateConfigUI();
                liveCalculate();
                updateChart();
            }, (error) => {
                console.error("載入配置失敗:", error);
                // 即使失敗也要更新 UI 和計算，確保應用程式不會崩潰
                updateConfigUI();
                liveCalculate();
                updateChart();
            });
        }

        window.saveConfig = async function() {
            if (!db || !userId) {
                showMessage("雲端尚未連線或認證失敗。", 'error');
                return;
            }
            
            const fuel = parseFloat(document.getElementById('fuelEfficiencyInput').value);
            const maint = parseFloat(document.getElementById('maintCostInput').value);

            if (isNaN(fuel) || isNaN(maint) || fuel <= 0 || maint < 0) {
                showMessage("請輸入有效的參數值。", 'error');
                updateConfigUI();
                return;
            }

            userConfig.fuelEfficiency = fuel;
            userConfig.maintCostPerKm = maint;

            try {
                await db.doc(configDocPath(userId)).set(userConfig, { merge: true });
                showMessage("設定已儲存到雲端！", 'success');
            } catch (e) {
                console.error("儲存配置失敗:", e);
                showMessage("儲存設定到雲端失敗", 'error');
            }
        }

        function updateConfigUI() {
            document.getElementById('fuelEfficiencyInput').value = userConfig.fuelEfficiency;
            document.getElementById('maintCostInput').value = userConfig.maintCostPerKm;
            document.getElementById('fuelEfficiencyDisplay').textContent = `${userConfig.fuelEfficiency} km/L`;
            document.getElementById('maintCostDisplay').textContent = `$${userConfig.maintCostPerKm.toFixed(2)}/km`;
        }
        
        // --- 即時計算功能 ---
        window.liveCalculate = function() {
            // 讀取輸入值
            const income = parseFloat(document.getElementById('income').value) || 0;
            const km = parseFloat(document.getElementById('mileage').value) || 0;
            const hours = parseFloat(document.getElementById('hours').value) || 0;
            const minutes = parseFloat(document.getElementById('minutes').value) || 0;
            const totalHours = hours + (minutes / 60);

            const fuelEff = userConfig.fuelEfficiency || DEFAULT_FUEL_EFFICIENCY_KML;
            const maintCostPerKm = userConfig.maintCostPerKm || DEFAULT_MAINT_COST_PER_KM;

            // 成本計算
            const gasCost = (km / fuelEff) * currentOilPrice;
            const maintCost = km * maintCostPerKm;
            const totalCost = gasCost + maintCost;
            const netProfit = income - totalCost;

            // 時薪計算
            let grossHourlyRate = 0;
            let netHourlyRate = 0;
            if (totalHours > 0) {
                grossHourlyRate = income / totalHours;
                netHourlyRate = netProfit / totalHours;
            }

            // 更新 UI 數值
            document.getElementById('liveGrossIncome').textContent = `$${income.toFixed(1)}`;
            document.getElementById('liveGasCost').textContent = `$${gasCost.toFixed(1)}`;
            document.getElementById('liveMaintCost').textContent = `$${maintCost.toFixed(1)}`;
            document.getElementById('liveNetProfit').textContent = `$${netProfit.toFixed(1)}`;
            document.getElementById('liveTotalCost').textContent = `$${totalCost.toFixed(1)}`;

            // 時薪顯示
            document.getElementById('liveGrossHourly').textContent = `$${grossHourlyRate.toFixed(1)}/hr`;
            document.getElementById('liveNetHourly').textContent = `$${netHourlyRate.toFixed(1)}/hr`;

            // 調整淨利顏色
            document.getElementById('liveNetProfit').classList.toggle('net-profit', netProfit >= 0);
            document.getElementById('liveNetProfit').classList.toggle('cost-val', netProfit < 0);
            document.getElementById('liveNetHourly').classList.toggle('net-profit', netHourlyRate >= 0);
            document.getElementById('liveNetHourly').classList.toggle('cost-val', netHourlyRate < 0);
            
            // 更新圓餅圖
            updateChart(gasCost, maintCost, netProfit);
        }

        // --- 圓餅圖繪製 ---
        function updateChart(gasCost = 0, maintCost = 0, netProfit = 0) {
            const data = {
                labels: ['油資成本', '維護成本', '淨利潤'],
                datasets: [{
                    data: [Math.max(0, gasCost), Math.max(0, maintCost), Math.max(0, netProfit)], // 負值設為 0，避免圓餅圖出錯
                    backgroundColor: ['#f87171', '#fbbf24', '#10b981'], // 紅、黃、綠
                    hoverOffset: 4
                }]
            };

            const config = {
                type: 'doughnut',
                data: data,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom' },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.label || '';
                                    if (label) { label += ': '; }
                                    if (context.parsed !== null) { label += '$' + context.parsed.toFixed(1); }
                                    return label;
                                }
                            }
                        },
                        datalabels: {
                            color: '#fff',
                            formatter: (value, context) => {
                                if (value <= 0) return '';
                                // 僅顯示非零數據的百分比
                                const total = context.chart.data.datasets[0].data.reduce((sum, val) => sum + val, 0);
                                const percentage = (value / total * 100).toFixed(1) + '%';
                                return percentage;
                            }
                        }
                    },
                    // 如果淨利為負，我們仍希望顯示成本比例
                    cutout: '70%', 
                },
                plugins: [ChartDataLabels]
            };

            const ctx = document.getElementById('costChart').getContext('2d');

            if (chartInstance) {
                chartInstance.data = data;
                chartInstance.update();
            } else {
                chartInstance = new Chart(ctx, config);
            }
        }


        // --- 動態油價獲取 (使用 Google Search) ---
        window.fetchOilPrice = async function(isInitial = false) {
            const button = document.getElementById('fetchOilPriceButton');
            const display = document.getElementById('oilPriceDisplay');
            
            if (GEMINI_API_KEY === "YOUR_GEMINI_API_KEY") {
                // 如果 API Key 遺失，使用預設值
                display.textContent = `$${currentOilPrice.toFixed(2)}/L (API Key 遺失)`;
                if (!isInitial) showMessage("❌ Gemini API Key 遺失，請修正程式碼。", 'error');
                liveCalculate();
                return;
            }

            button.disabled = true;
            display.textContent = '獲取中...';

            const userQuery = "台灣中油 92 無鉛汽油 今日每公升價格，只需要給我數字，不要任何文字、符號或單位。";
            const apiKey = GEMINI_API_KEY; 
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${apiKey}`; // 推薦使用 gemini-2.5-flash

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                tools: [{ "google_search": {} }],
            };
            
            try {
                // 這裡我們省略了重試邏輯，直接嘗試一次呼叫
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) throw new Error(`API 呼叫失敗: ${response.statusText}`);

                const result = await response.json();
                
                const text = result.candidates?.[0]?.content?.parts?.[0]?.text || '';
                
                // 強化解析：提取文本中所有數字和小數點，組成一個數字
                const priceMatch = text.match(/[\d.]+/g);
                const price = priceMatch ? parseFloat(priceMatch.join('')) : NaN;
                
                if (!isNaN(price) && price > 0) {
                    currentOilPrice = price;
                    display.textContent = `$${currentOilPrice.toFixed(2)}/L`;
                    if (!isInitial) showMessage("油價獲取成功！", 'success');
                } else {
                    throw new Error("無法從 API 回應中解析出有效的油價。");
                }
            } catch (e) {
                console.error("獲取油價失敗:", e);
                if (!isInitial) showMessage(`獲取油價失敗: ${e.message}`, 'error');
                display.textContent = `$${currentOilPrice.toFixed(2)}/L (使用預設或上次值)`;
            } finally {
                button.disabled = false;
                liveCalculate();
            }
        }
        
        // --- 應用程式入口點 ---
        document.addEventListener('DOMContentLoaded', () => {
            initFirebase();
            // 在 loading-overlay 隱藏後，initApp() 和 fetchOilPrice(true) 會被呼叫
        });

    </script>
</body>
</html>
