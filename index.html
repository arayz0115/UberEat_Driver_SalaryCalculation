<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
<title>UberEat Salary Calculator V1.2.16 (Icon Fixed)</title>

<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#050505">
<link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/732/732200.png">

<meta property="og:title" content="UberEat å¤–é€è–ªè³‡è¨ˆç®—å™¨ V1.2.16 (åœ–ç¤ºä¿®æ­£)" />
<meta property="og:description" content="å°ˆç‚º UberEat å¤–é€å“¡æ‰“é€ ï¼Œç²¾æº–è¨ˆç®—æ¯ä¸€è¶Ÿçš„è–ªè³‡ã€æ²¹è€—èˆ‡è€—ææ·¨åˆ©ï¼Œä¿®æ­£äº†åˆ—è¡¨åœ–ç¤ºé¢¨æ ¼ã€‚" />
<meta property="og:type" content="website" />
<meta property="og:image" content="https://placehold.co/1200x630/059669/ffffff?text=UberEat+V1.2.16" />

<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
    /* === å…¨å±€è¨­å®š === */
    body { 
        background-color: #050505; 
        color: #e5e5e5; 
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; 
        padding-bottom: 120px; /* åº•éƒ¨ç•™ç©ºé–“çµ¦ç‰ˆæ¬Š */
        padding-top: env(safe-area-inset-top); /* é¿é–‹ç€æµ· */
    }
    
    /* === å¡ç‰‡æ¨£å¼ === */
    .card {
        background-color: #111216;
        border: 1px solid #2a2d36;
        border-radius: 1rem;
        padding: 1rem;
        margin-bottom: 0.8rem;
        position: relative;
    }
    .card-glow { border-color: #10b981; box-shadow: 0 0 10px rgba(16, 185, 129, 0.1); } /* æ”¹ç‚º UberEat ç¶ è‰²ç³» */

    /* === è¼¸å…¥æ¡† === */
    .input-field {
        background-color: #1a1c23;
        border: 1px solid #333;
        color: #fff;
        border-radius: 0.6rem;
        padding: 0.7rem;
        width: 100%;
        font-size: 1rem;
        transition: 0.2s;
    }
    .input-field:focus { outline: none; border-color: #10b981; background-color: #202229; }

    /* === æ—¥æœŸé¸æ“‡å™¨ (å„ªåŒ–æ‰‹æ©Ÿé¡¯ç¤ºï¼Œç¢ºä¿æ—¥æœŸä¸è¢«è£åˆ‡) === */
    input[type="date"] { position: relative; font-size: 0.95rem; }
    input[type="date"]::-webkit-calendar-picker-indicator {
        position: absolute; top: 0; left: 0; right: 0; bottom: 0; width: 100%; height: 100%;
        color: transparent; background: transparent; cursor: pointer;
    }

    /* === æŒ‰éˆ• === */
    .btn { width: 100%; padding: 0.8rem; border-radius: 0.6rem; font-weight: 600; display: flex; justify-content: center; align-items: center; transition: 0.2s; }
    .btn-primary { background-color: #059669; color: white; } /* UberEat ç¶  */
    .btn-primary:active { background-color: #047857; transform: scale(0.98); }
    .btn-danger { background-color: #7f1d1d; color: #fca5a5; border: 1px solid #991b1b; }
    .btn-ghost { background-color: transparent; border: 1px solid #333; color: #9ca3af; }
    
    .chart-toggle-btn { background: #2a2d36; color: #9ca3af; border: 1px solid #333; }
    .chart-toggle-btn.active { background: #059669; color: white; border-color: #059669; }

    /* === ç¯©é¸ Tab (ä¿®æ­£æ»‘å‹•å•é¡Œ) === */
    .tab-scroll-container {
        width: 100%;
        overflow-x: auto;
        padding-bottom: 0.5rem;
        scrollbar-width: none; 
        -ms-overflow-style: none;
    }
    .tab-scroll-container::-webkit-scrollbar { display: none; }

    .tab-scroll-content {
        display: flex;
        gap: 0.6rem;
        padding-right: 1.5rem; 
        min-width: max-content; 
    }

    .tab-btn {
        padding: 0.5rem 1rem; border-radius: 2rem; font-size: 0.9rem; color: #9ca3af; background: #1a1c23; border: 1px solid #333; white-space: nowrap;
    }
    .tab-btn.active { background-color: #d1fae5; color: #065f46; font-weight: bold; border-color: #fff; }

    /* === æ­·å²åˆ—è¡¨ V1.2.17 åœ–ç¤ºæ¨£å¼ä¿®æ­£ (æ­¤å€ç‚ºé‡é»ä¿®æ”¹) === */
    .history-item {
        background-color: #111216; 
        border-bottom: 1px solid #222; 
        padding-top: 1.25rem; 
        padding-bottom: 0rem; 
        padding-left: 1rem;
        padding-right: 1rem;
        transition: background 0.2s;
        display: flex;
        flex-direction: column; 
    }
    
    .history-header-wrapper {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        width: 100%;
    }

    /* æ­·å²ç´€éŒ„ä¸»è¦é¡¯ç¤ºå€åŸŸ (ç”¨æ–¼é»æ“Šè§¸ç™¼) */
    .history-main-area {
        display: flex;
        width: calc(100% - 30px); /* ç•™å‡ºåœ–ç¤ºçš„ç©ºé–“ */
        padding-bottom: 1.25rem; 
        cursor: pointer;
        transition: background 0.2s;
    }
    .history-main-area:active { background-color: #1c1e24; } 

    /* V1.2.17: ç¨ç«‹çš„æ”¶åˆ/å±•é–‹åœ–ç¤ºå€åŸŸ - é¡è‰²æ”¹ç‚ºç°è‰²ï¼Œå¾®èª¿ padding-top å¯¦ç¾å‚ç›´ç½®ä¸­å°é½Š */
    .history-toggle-icon {
        width: 30px; 
        height: 100%;
        padding-top: 1px; /* èª¿æ•´å°é½Š */
        color: #9ca3af; /* çµ±ä¸€ç‚ºç°è‰² */
        cursor: pointer;
        z-index: 10;
        font-size: 1rem;
        transition: transform 0.2s;
        text-align: right;
        flex-shrink: 0;
    }
    
    .history-stat-group {
        display: flex;
        flex-direction: column;
        align-items: flex-start; 
        text-align: left;
    }
    .history-stat-group.center {
        align-items: center; 
        text-align: center;
    }
    .history-stat-group.right {
        align-items: flex-end;
        text-align: right;
    }

    /* ç¢ºä¿é—œéµæ•¸å­—é ‚éƒ¨å°é½Š */
    .history-main-value {
        font-size: 1.5rem; 
        font-weight: bold;
        line-height: 1.1;
        margin-top: 2px;
    }
    .stat-label-small {
        font-size: 0.7rem; 
        color: #6b7280; 
        margin-top: 2px;
        line-height: 1.2;
    }
    
    /* === æ­·å²åˆ—è¡¨åº•éƒ¨è©³ç´°å€å¡Š (é è¨­éš±è—) === */
    .history-sub-stats {
        width: 100%;
        padding-top: 0.75rem; 
        padding-bottom: 1.25rem; 
        font-size: 0.8rem;
        color: #9ca3af;
        margin-top: 0.75rem; 
        border-top: 1px solid #222; 
    }
    
    .history-sub-stats.hidden {
        display: none;
    }

    .history-sub-stats .performance-summary {
        margin-top: 0.75rem;
        padding-top: 0.75rem;
        border-top: 1px solid #222; 
    }


    /* === å­—é«”èˆ‡æ¨™ç±¤ === */
    .stat-label { font-size: 0.75rem; color: #6b7280; text-transform: uppercase; letter-spacing: 0.05em; }
    .text-amber-soft { color: #fcd34d; }

    /* ç·¨è¼¯å™¨å’Œå„€è¡¨æ¿åœ–ç¤ºé¡è‰²çµ±ä¸€ */
    #editorToggleIcon, #dashboardToggleIcon {
        color: #9ca3af; /* çµ±ä¸€ç‚ºç°è‰² */
    }
    
    /* === ç‰ˆæ¬Š Footer === */
    .footer-credit {
        text-align: center;
        margin-top: 2rem;
        padding-top: 1rem;
        border-top: 1px solid #222;
        color: #525252;
        font-size: 0.75rem;
        letter-spacing: 1px;
    }
</style>
</head>
<body class="max-w-md mx-auto p-3">

    <div class="flex justify-between items-center mb-4 px-1 pt-2">
        <div class="flex items-center gap-2">
            <div class="w-1.5 h-6 bg-green-500 rounded-full"></div>
            <div>
                <h1 class="text-lg font-bold text-white leading-tight">UberEat å¤–é€è–ªè³‡è¨ˆç®—å™¨</h1>
                <div class="text-[10px] text-gray-500">V1.2.16 History Icon Fixed</div>
            </div>
        </div>
        <div class="flex gap-2">
            <button onclick="toggleAuthPanel()" class="p-2 bg-[#1a1c23] rounded-full text-gray-400 border border-[#333] text-xs active:bg-gray-800">
                â˜ï¸ <span id="authStatusText">æœªç™»å…¥</span>
            </button>
            <button onclick="toggleSettings()" class="p-2 bg-[#1a1c23] rounded-full text-gray-400 border border-[#333] text-xs active:bg-gray-800">
                âš™ï¸ è¨­å®š
            </button>
        </div>
    </div>

    <div id="authPanel" class="hidden mb-4 card border-blue-500/50">
        <h3 class="text-blue-500 font-bold mb-3 text-sm uppercase">Firebase é›²ç«¯é©—è­‰</h3>
        <div id="authContent">
            <div id="authForm" class="grid grid-cols-1 gap-3 mb-3">
                <div>
                    <label class="stat-label mb-1">Email</label>
                    <input id="authEmail" type="email" class="input-field" placeholder="your@email.com" />
                </div>
                <div>
                    <label class="stat-label mb-1">å¯†ç¢¼</label>
                    <input id="authPassword" type="password" class="input-field" placeholder="å¯†ç¢¼ (è‡³å°‘6ä½)" />
                </div>
                <button onclick="registerUser()" class="btn btn-primary text-sm">è¨»å†Š (æ–°å¸³è™Ÿ)</button>
                <button onclick="loginUser()" class="btn btn-ghost text-sm border-blue-600 text-blue-400">ç™»å…¥ (å·²æœ‰å¸³è™Ÿ)</button>
                <button onclick="resetPassword()" class="text-xs text-gray-500 hover:text-gray-400 mt-2">å¿˜è¨˜å¯†ç¢¼ï¼Ÿ</button>
            </div>
            
            <div id="userInfo" class="hidden">
                <p class="text-white mb-3">æ­¡è¿ï¼Œ<span id="userEmailDisplay" class="font-semibold text-amber-soft"></span></p>
                <button onclick="logoutUser()" class="btn btn-danger text-sm">ç™»å‡ºä¸¦æ¸…é™¤æœ¬æ©Ÿç‹€æ…‹</button>
            </div>
        </div>
    </div>

    <div id="settingsPanel" class="hidden mb-4 card border-green-900/50">
        <h3 class="text-green-500 font-bold mb-3 text-sm uppercase">å…¨åŸŸåƒæ•¸</h3>
        <div class="grid grid-cols-2 gap-3 mb-3">
            <div>
                <label class="stat-label mb-1">æ²¹å“</label>
                <select id="oilType" class="input-field" onchange="fetchOilPrice()">
                    <option value="92">92 ç„¡é‰›</option>
                    <option value="95">95 ç„¡é‰›</option>
                    <option value="98">98 ç„¡é‰›</option>
                    <option value="diesel">æŸ´æ²¹</option>
                </select>
            </div>
            <div>
                <label class="stat-label mb-1">ç›®å‰æ²¹åƒ¹</label>
                <div id="oilPriceDisplay" class="input-field text-yellow-500 font-bold">è®€å–ä¸­...</div>
            </div>
        </div>
        <div class="grid grid-cols-2 gap-3 mb-3">
            <div>
                <label class="stat-label mb-1">æ²¹è€— (km/L)</label>
                <input id="settingFuelRate" type="number" class="input-field" />
            </div>
            <div>
                <label class="stat-label mb-1">è€—æ ($/km)</label>
                <input id="settingMaint" type="number" step="0.1" class="input-field" />
            </div>
        </div>
        <button onclick="saveSettings()" class="btn btn-primary text-sm">å„²å­˜è¨­å®š</button>
    </div>

    <div class="card card-glow mb-4 p-5" id="editorCard">
        <div class="flex justify-between items-center border-b border-gray-800 pb-2 cursor-pointer" onclick="toggleEditor()">
            <h3 class="font-bold text-white flex items-center gap-2 text-base">
                <span id="editorTitle">ğŸ“ æ–°å¢ç´€éŒ„</span>
            </h3>
            <span id="editorToggleIcon" class="text-xl">â–¼</span>
        </div>
        
        <div id="editorContent" class="pt-4">
            <input type="hidden" id="editId" value="">
            <input type="hidden" id="recordOilPrice" value=""> 
            
            <div class="flex justify-end items-center mb-3">
                 <span id="editorOilHint" class="text-xs text-gray-500 hidden">é–å®šæ²¹åƒ¹: --</span>
            </div>

            <div class="flex flex-col gap-3 mb-4">
                <div>
                    <label class="stat-label mb-1">æ—¥æœŸ</label>
                    <input id="inputDate" type="date" class="input-field cursor-pointer text-sm" onclick="this.showPicker()" />
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="stat-label mb-1">ç‡Ÿæ¥­é¡</label>
                        <input id="inputIncome" type="number" inputmode="numeric" class="input-field text-amber-soft font-bold text-lg" placeholder="$0" />
                    </div>
                    <div>
                        <label class="stat-label mb-1">å–®æ•¸</label>
                        <input id="inputOrders" type="number" inputmode="numeric" class="input-field" placeholder="0" />
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-2 gap-3 mb-4">
                <div>
                    <label class="stat-label mb-1">é‡Œç¨‹</label>
                    <input id="inputDist" type="number" step="0.1" inputmode="decimal" class="input-field" placeholder="KM" />
                </div>
                <div>
                    <label class="stat-label mb-1">å·¥æ™‚</label>
                    <div class="flex gap-1">
                        <input id="inputHr" type="number" class="input-field text-center px-1" placeholder="æ™‚" />
                        <input id="inputMin" type="number" class="input-field text-center px-1" placeholder="åˆ†" />
                    </div>
                </div>
            </div>

            <div class="flex gap-2">
                <button onclick="saveRecord()" class="btn btn-primary" id="btnSave">å„²å­˜</button>
                <button onclick="deleteCurrentRecord()" class="btn btn-danger hidden" id="btnDelete">åˆªé™¤</button>
                <button onclick="resetEditor()" class="btn btn-ghost hidden" id="btnCancel">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <div class="card bg-gradient-to-br from-[#111216] to-[#064e3b20] border-green-500/30 p-5 mb-4" id="dashboardCard">
        <div class="flex justify-between items-center cursor-pointer" onclick="toggleDashboard()">
            <h3 class="font-bold text-white flex items-center gap-2 text-sm uppercase">
                <div class="w-1.5 h-4 bg-green-500 rounded-full"></div>
                å€é–“ç¸½ç‡Ÿæ”¶å„€è¡¨æ¿
            </h3>
            <span id="dashboardToggleIcon" class="text-xl">â–¼</span>
        </div>
        
        <div id="dashboardContent" class="pt-4">
            <div class="grid grid-cols-3 gap-2">

                <div class="flex flex-col items-center text-center">
                    <label class="stat-label text-gray-400">å€é–“ç¸½ç‡Ÿæ”¶</label>
                    <div class="text-3xl font-bold text-amber-soft mt-1 tracking-tight">$<span id="dashTotalIncome">0</span></div>
                </div>
                <div class="flex flex-col items-center text-center"> 
                    <label class="stat-label text-red-400">ç¸½æˆæœ¬</label>
                    <div class="text-3xl font-bold text-red-400 mt-1 tracking-tight">$<span id="dashTotalCost">0</span></div> 
                </div>
                <div class="flex flex-col items-center text-center">
                    <label class="stat-label text-green-400">ç¸½æ·¨åˆ©</label>
                    <div class="text-3xl font-bold text-green-400 mt-1 tracking-tight">$<span id="dashNetProfit">0</span></div>
                </div>


                <div class="col-span-3 border-t border-white/10 pt-4 mt-4"></div>

                <div class="flex flex-col items-center text-center">
                    <label class="stat-label text-red-400">æ²¹è€—æˆæœ¬</label>
                    <div class="text-lg font-bold text-red-400 mt-1">$<span id="dashOilCost">0</span></div>
                </div>
                <div class="flex flex-col items-center text-center">
                    <label class="stat-label text-red-400">è€—ææˆæœ¬</label>
                    <div class="text-lg font-bold text-red-400 mt-1">$<span id="dashMaintCost">0</span></div>
                </div>
                <div class="flex flex-col items-center text-center">
                    <label class="stat-label text-gray-400">ç¸½å–®æ•¸ / ç¸½å·¥æ™‚</label>
                    <div class="text-lg font-bold text-white mt-1">
                        <span id="dashOrders">0</span>å–® | 
                        <span id="dashHours">0</span><span class="text-xs text-gray-500">h</span> <span id="dashMinutes">0</span><span class="text-xs text-gray-500">m</span>
                    </div>
                </div>
                
                
                <div class="col-span-3 border-t border-white/10 pt-4 mt-4 grid grid-cols-2 gap-4">
                    <div class="flex flex-col items-center text-center">
                        <label class="stat-label text-amber-soft">æœªæ‰£æˆæœ¬å¯¦è–ª</label>
                        <div class="text-2xl font-bold text-amber-soft my-1 tracking-tight">$<span id="dashGrossHourly">0</span></div>
                    </div>
                    <div class="flex flex-col items-center text-center">
                        <label class="stat-label text-green-400">å·²æ‰£æˆæœ¬å¯¦è–ª</label>
                        <div class="text-2xl font-bold text-green-400 my-1 tracking-tight">$<span id="dashNetHourly">0</span></div>
                    </div>
                </div>

                <div class="col-span-3 border-t border-white/10 pt-4 mt-4 grid grid-cols-2 gap-4">
                    <div class="flex flex-col items-center text-center">
                        <label class="stat-label text-amber-soft">æ¯å–®å¹³å‡ç‡Ÿæ”¶</label>
                        <div class="text-xl font-bold text-amber-soft my-1 tracking-tight">$<span id="dashGrossPerOrder">0</span></div>
                    </div>
                    <div class="flex flex-col items-center text-center">
                        <label class="stat-label text-green-400">æ¯å–®å¹³å‡æ·¨åˆ©</label>
                        <div class="text-xl font-bold text-green-400 my-1 tracking-tight">$<span id="dashNetPerOrder">0</span></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="tab-scroll-container mb-3">
        <div class="tab-scroll-content">
            <button class="tab-btn active" onclick="setFilter('day', this)">ä»Šæ—¥</button>
            <button class="tab-btn" onclick="setFilter('week', this)">æœ¬é€±</button>
            <button class="tab-btn" onclick="setFilter('month', this)">æœ¬æœˆ</button>
            <button class="tab-btn" onclick="setFilter('year', this)">æœ¬å¹´</button>
            <button class="tab-btn" onclick="setFilter('all', this)">å…¨éƒ¨</button>
            <button class="tab-btn" onclick="setFilter('custom', this)">è‡ªå®šç¾©</button> 
            <button class="tab-btn border-green-500 text-green-400" onclick="toggleCharts()">ğŸ“ˆ é€²éšåœ–è¡¨åˆ†æ</button>
        </div>
    </div>
    
    <div id="customDateFilter" class="card p-3 mb-4 hidden border-blue-500/30">
        <h3 class="text-xs font-bold text-blue-400 mb-2 uppercase">è‡ªå®šç¾©å€é–“ç¯©é¸</h3>
        <div class="flex gap-2 items-center">
            <input type="date" id="filterStart" class="input-field text-sm py-1" onchange="applyCustomFilter()" />
            <span class="text-gray-500">è‡³</span>
            <input type="date" id="filterEnd" class="input-field text-sm py-1" onchange="applyCustomFilter()" />
        </div>
    </div>

    <div id="chartsPanel" class="hidden card mb-4 border border-green-500/30">
        <div class="flex justify-between items-center mb-3">
            <h4 class="text-sm font-bold text-white">ğŸ“Š æ•¸æ“šåˆ†æä¸­å¿ƒ</h4>
            <div class="flex bg-[#1a1c23] rounded-lg p-1">
                <button onclick="switchChartType('bar')" id="btnChartBar" class="chart-toggle-btn active px-3 py-1 rounded text-xs">è¶¨å‹¢åœ–</button>
                <button onclick="switchChartType('pie')" id="btnChartPie" class="chart-toggle-btn px-3 py-1 rounded text-xs">åœ“é¤…åœ–</button>
            </div>
        </div>

        <div class="bg-[#1a1c23] p-2 rounded-lg mb-3">
            <div class="flex gap-2 mb-2">
                <input type="date" id="chartStart" class="input-field text-xs py-1" onchange="updateChart()" />
                <span class="text-gray-500 self-center">~</span>
                <input type="date" id="chartEnd" class="input-field text-xs py-1" onchange="updateChart()" />
            </div>
            <div class="flex items-center gap-2">
                <label class="text-xs text-gray-500">åˆ†çµ„:</label>
                <select id="chartGroupBy" class="input-field text-xs py-1" onchange="updateChart()">
                    <option value="day">ä¾æ—¥æœŸ (æ—¥)</option>
                    <option value="month">ä¾æœˆä»½ (æœˆ)</option>
                    <option value="year">ä¾å¹´ä»½ (å¹´)</option>
                </select>
            </div>
        </div>

        <div style="position: relative; height: 300px; width: 100%;">
            <canvas id="mainChart"></canvas>
        </div>
    </div>

    <div class="mb-8">
        <h3 class="text-xs font-bold text-gray-500 mb-2 uppercase pl-1">å€é–“æ˜ç´°</h3>
        <div id="historyList" class="rounded-xl overflow-hidden border border-[#2a2d36]"></div>
    </div>

    <div class="footer-credit">
        <div>UberEat å¤–é€è–ªè³‡è¨ˆç®—å™¨ V1.2.16 (History Icon Fixed)</div>
        <div class="mt-1">Developed by Ray Â© 2025</div>
        <div class="mt-1 text-xs text-gray-600">All Rights Reserved.</div>
    </div>

<script>
// === Firebase é…ç½®èˆ‡åˆå§‹åŒ– (V1.2.7/V1.2.16 çµæ§‹) ===
const firebaseConfig = {
    apiKey: "AIzaSyAqiTFbvsIkUVUrBmwaR28448EFMg4FO-w", // æ‚¨çš„ Key
    authDomain: "uber-driver-tracker.firebaseapp.com",
    projectId: "uber-driver-tracker", 
    storageBucket: "uber-driver-tracker.appspot.com",
    messagingSenderId: "333010467554",
    appId: "1:333010467554:web:86f6a5067253fa433878b2"
};

let db; 
let firebaseUnsubscribe = null; 

if (typeof firebase !== 'undefined' && firebaseConfig.apiKey) {
    firebase.initializeApp(firebaseConfig);
    db = firebase.firestore();
}


// === è®Šæ•¸èˆ‡åˆå§‹åŒ– ===
const workerAPI = "https://ubereat-oil-proxy.leo3026772.workers.dev/";
let globalOilPrice = 30.0;
let currentFilter = 'day';
let chartInstance = null;
let chartType = 'bar'; 
let records = []; 

window.onload = async () => {
    loadCollapseStates(); 
    resetEditor();
    loadSettings();
    
    const today = getLocalDateString();
    
    // åˆå§‹åŒ–æ—¥æœŸç¯„åœ
    document.getElementById('filterStart').value = today;
    document.getElementById('filterEnd').value = today;

    const now = new Date();
    document.getElementById('chartStart').value = new Date(now.getFullYear(), 0, 1).toISOString().slice(0,10);
    document.getElementById('chartEnd').value = today;

    if (typeof firebase !== 'undefined' && firebaseConfig.apiKey) {
        firebase.auth().onAuthStateChanged(user => {
            if (user) {
                document.getElementById('authStatusText').innerText = "å·²ç™»å…¥"; 
                document.getElementById('userEmailDisplay').innerText = user.email;
                document.getElementById('authForm').classList.add('hidden');
                document.getElementById('userInfo').classList.remove('hidden');
                setupRealtimeListener(user); // å•Ÿç”¨å¯¦æ™‚ç›£è½
            } else {
                document.getElementById('authStatusText').innerText = "æœªç™»å…¥"; 
                document.getElementById('authForm').classList.remove('hidden');
                document.getElementById('userInfo').classList.add('hidden');
                if (firebaseUnsubscribe) {
                    firebaseUnsubscribe();
                    firebaseUnsubscribe = null;
                }
                refreshDashboard(); // ç™»å‡ºå¾Œï¼Œé¡¯ç¤ºæœ¬åœ°è³‡æ–™
            }
        });
    } else {
        refreshDashboard();
    }
    
    await fetchOilPrice(); // ç²å–ç•¶å‰æ²¹åƒ¹
    refreshDashboard();
    updateChart(); // åˆå§‹åŒ–åœ–è¡¨
}; 

// === é€šç”¨å·¥å…·å‡½å¼ ===
function getLocalDateString(date = new Date()) {
    return new Date(date.getTime() - (date.getTimezoneOffset() * 60000)).toISOString().split('T')[0];
}

function getWeekStart(date) {
    const d = new Date(date);
    const day = d.getDay();
    const diff = d.getDate() - day + (day === 0 ? -6 : 1); // èª¿æ•´ç‚ºé€±ä¸€ç‚ºèµ·å§‹æ—¥
    return new Date(d.setDate(diff));
}

function toggleElement(id) {
    document.getElementById(id).classList.toggle('hidden');
}

// å±•é–‹/æ”¶åˆç‹€æ…‹æœ¬åœ°å„²å­˜
let collapseStates = JSON.parse(localStorage.getItem('collapseStates') || '{}');

function saveCollapseStates() {
    localStorage.setItem('collapseStates', JSON.stringify(collapseStates));
}

function loadCollapseStates() {
    // è¼‰å…¥å„€è¡¨æ¿å’Œç·¨è¼¯å™¨ç‹€æ…‹
    if (collapseStates.editor === false) toggleEditor(false, true);
    if (collapseStates.dashboard === false) toggleDashboard(false, true);
    if (collapseStates.settings === true) toggleSettings(true, true);
    if (collapseStates.auth === true) toggleAuthPanel(true, true);
    if (collapseStates.charts === true) toggleCharts(true, true);
}


// === UI åˆ‡æ›å‡½å¼ ===

function toggleEditor(force, initialLoad = false) {
    const editorContent = document.getElementById('editorContent');
    const editorIcon = document.getElementById('editorToggleIcon');
    const isHidden = editorContent.classList.contains('hidden');

    const shouldOpen = (force !== undefined) ? force : isHidden;

    if (shouldOpen) {
        editorContent.classList.remove('hidden');
        editorIcon.innerText = 'â–¼';
        collapseStates.editor = true;
    } else {
        editorContent.classList.add('hidden');
        editorIcon.innerText = 'â–²';
        collapseStates.editor = false;
    }
    if (!initialLoad) saveCollapseStates();
}

function toggleDashboard(force, initialLoad = false) {
    const dashboardContent = document.getElementById('dashboardContent');
    const dashboardIcon = document.getElementById('dashboardToggleIcon');
    const isHidden = dashboardContent.classList.contains('hidden');
    
    const shouldOpen = (force !== undefined) ? force : isHidden;

    if (shouldOpen) {
        dashboardContent.classList.remove('hidden');
        dashboardIcon.innerText = 'â–¼';
        collapseStates.dashboard = true;
    } else {
        dashboardContent.classList.add('hidden');
        dashboardIcon.innerText = 'â–²';
        collapseStates.dashboard = false;
    }
    if (!initialLoad) saveCollapseStates();
}

function toggleSettings(force, initialLoad = false) {
    const settingsPanel = document.getElementById('settingsPanel');
    const isHidden = settingsPanel.classList.contains('hidden');

    const shouldOpen = (force !== undefined) ? force : isHidden;

    if (shouldOpen) {
        settingsPanel.classList.remove('hidden');
        collapseStates.settings = true;
    } else {
        settingsPanel.classList.add('hidden');
        collapseStates.settings = false;
    }
    if (!initialLoad) saveCollapseStates();
}

function toggleAuthPanel(force, initialLoad = false) {
    const authPanel = document.getElementById('authPanel');
    const isHidden = authPanel.classList.contains('hidden');
    
    const shouldOpen = (force !== undefined) ? force : isHidden;

    if (shouldOpen) {
        authPanel.classList.remove('hidden');
        collapseStates.auth = true;
    } else {
        authPanel.classList.add('hidden');
        collapseStates.auth = false;
    }
    if (!initialLoad) saveCollapseStates();
}

function toggleCharts(force, initialLoad = false) {
    const chartsPanel = document.getElementById('chartsPanel');
    const isHidden = chartsPanel.classList.contains('hidden');
    
    const shouldOpen = (force !== undefined) ? force : isHidden;

    if (shouldOpen) {
        chartsPanel.classList.remove('hidden');
        collapseStates.charts = true;
        updateChart(); // å±•é–‹æ™‚æ›´æ–°åœ–è¡¨
    } else {
        chartsPanel.classList.add('hidden');
        collapseStates.charts = false;
    }
    if (!initialLoad) saveCollapseStates();
}


// æ­·å²æ˜ç´°æ”¶åˆ/å±•é–‹ (æ­¤å‡½å¼å·²ä¿®æ­£åœ–ç¤ºé¸æ“‡å™¨)
let historyCollapseStates = {}; // å„²å­˜æ˜ç´°çš„å±•é–‹ç‹€æ…‹

function toggleHistoryDetails(id, element) {
    const subStats = document.getElementById('sub-stats-' + id);
    // V1.2.16/17: ä¿®æ­£åœ–ç¤ºé¸æ“‡å™¨
    // é€éé»æ“Šçš„ history-item å…ƒç´ ï¼Œæ‰¾åˆ°å…¶å­å…ƒç´ ä¸­çš„ history-toggle-icon
    const icon = element.querySelector('.history-toggle-icon'); 

    if (subStats.classList.contains('hidden')) {
        subStats.classList.remove('hidden');
        icon.style.transform = 'rotate(180deg)';
        historyCollapseStates[id] = true;
    } else {
        subStats.classList.add('hidden');
        icon.style.transform = 'rotate(0deg)';
        historyCollapseStates[id] = false;
    }
}


// === è¨­ç½®èˆ‡æ²¹åƒ¹ç›¸é—œå‡½å¼ (V1.2.16 é‚è¼¯) ===

function loadSettings() {
    const settings = JSON.parse(localStorage.getItem('uberEatSettings')) || {
        fuelRate: 35,
        maintCost: 3.5,
        oilType: '95'
    };
    
    document.getElementById('settingFuelRate').value = settings.fuelRate;
    document.getElementById('settingMaint').value = settings.maintCost;
    document.getElementById('oilType').value = settings.oilType;
}

function saveSettings() {
    const settings = {
        fuelRate: parseFloat(document.getElementById('settingFuelRate').value),
        maintCost: parseFloat(document.getElementById('settingMaint').value),
        oilType: document.getElementById('oilType').value
    };
    
    if (isNaN(settings.fuelRate) || settings.fuelRate <= 0) {
        alert("æ²¹è€— (km/L) å¿…é ˆæ˜¯æœ‰æ•ˆçš„æ­£æ•¸ï¼");
        return;
    }
    if (isNaN(settings.maintCost) || settings.maintCost < 0) {
        alert("è€—æ ($/km) å¿…é ˆæ˜¯æœ‰æ•ˆçš„æ­£æ•¸æˆ–é›¶ï¼");
        return;
    }

    localStorage.setItem('uberEatSettings', JSON.stringify(settings));
    alert("è¨­å®šå·²å„²å­˜ï¼");
    refreshDashboard(); 
}

async function fetchOilPrice() {
    const oilType = document.getElementById('oilType').value;
    const oilDisplay = document.getElementById('oilPriceDisplay');
    oilDisplay.innerHTML = 'è®€å–ä¸­...';
    
    try {
        const response = await fetch(workerAPI + '?oilType=' + oilType);
        if (!response.ok) throw new Error('Network response was not ok');
        
        const data = await response.json();
        const price = data.price; 
        
        if (price) {
            globalOilPrice = parseFloat(price);
            oilDisplay.innerHTML = `$${globalOilPrice.toFixed(2)}`;
            localStorage.setItem('globalOilPrice', globalOilPrice.toFixed(2));
        } else {
            throw new Error('API returned no price data');
        }
    } catch (error) {
        console.error("ç²å–æ²¹åƒ¹å¤±æ•—ï¼Œä½¿ç”¨ä¸Šæ¬¡ç´€éŒ„å€¼æˆ–é è¨­å€¼ã€‚", error);
        
        const storedPrice = localStorage.getItem('globalOilPrice');
        if (storedPrice) {
            globalOilPrice = parseFloat(storedPrice);
            oilDisplay.innerHTML = `$${globalOilPrice.toFixed(2)} (æœ¬åœ°å‚™ç”¨)`;
        } else {
            globalOilPrice = 30.0;
            oilDisplay.innerHTML = `$30.00 (é è¨­å€¼)`;
        }
    }
    document.getElementById('recordOilPrice').value = globalOilPrice.toFixed(2);
}


// === è³‡æ–™è™•ç†èˆ‡è¨ˆç®—å‡½å¼ (V1.2.16 é‚è¼¯ - æœªæ›´å‹•) ===

function calculateCosts(dist, oilPrice, fuelRate, maintCost) {
    if (dist <= 0) return { oilCost: 0, maintenanceCost: 0, totalCost: 0 };
    
    const oilCost = (dist / fuelRate) * oilPrice;
    const maintenanceCost = dist * maintCost;
    const totalCost = oilCost + maintenanceCost;
    
    return {
        oilCost: parseFloat(oilCost.toFixed(2)),
        maintenanceCost: parseFloat(maintenanceCost.toFixed(2)),
        totalCost: parseFloat(totalCost.toFixed(2))
    };
}

function createRecordObject(id = null) {
    const income = parseFloat(document.getElementById('inputIncome').value) || 0;
    const orders = parseInt(document.getElementById('inputOrders').value) || 0;
    const dist = parseFloat(document.getElementById('inputDist').value) || 0;
    const hr = parseInt(document.getElementById('inputHr').value) || 0;
    const min = parseInt(document.getElementById('inputMin').value) || 0;
    const date = document.getElementById('inputDate').value;
    const fuelRate = parseFloat(document.getElementById('settingFuelRate').value);
    const maintCost = parseFloat(document.getElementById('settingMaint').value);
    const recordOilPrice = parseFloat(document.getElementById('recordOilPrice').value);
    const totalMinutes = hr * 60 + min;
    const totalHours = totalMinutes / 60;

    const costs = calculateCosts(dist, recordOilPrice, fuelRate, maintCost);
    const netProfit = income - costs.totalCost;
    
    return {
        id: id || Date.now().toString(),
        date: date,
        income: income,
        orders: orders,
        distance: dist,
        hours: totalHours,
        totalMinutes: totalMinutes,
        oilPrice: recordOilPrice,
        fuelRate: fuelRate,
        maintCost: maintCost,
        oilCost: costs.oilCost,
        maintenanceCost: costs.maintenanceCost,
        totalCost: costs.totalCost,
        netProfit: parseFloat(netProfit.toFixed(2)),
    };
}


// === ç·¨è¼¯å™¨å‡½å¼ (V1.2.16 é‚è¼¯) ===

function resetEditor() {
    document.getElementById('editId').value = '';
    document.getElementById('editorTitle').innerText = 'ğŸ“ æ–°å¢ç´€éŒ„';
    document.getElementById('inputDate').value = getLocalDateString();
    document.getElementById('inputIncome').value = '';
    document.getElementById('inputOrders').value = '';
    document.getElementById('inputDist').value = '';
    document.getElementById('inputHr').value = '';
    document.getElementById('inputMin').value = '';
    document.getElementById('btnDelete').classList.add('hidden');
    document.getElementById('btnCancel').classList.add('hidden');
    document.getElementById('editorOilHint').classList.add('hidden');
    
    document.getElementById('recordOilPrice').value = globalOilPrice.toFixed(2);
}

function loadRecordToEditor(id) {
    const record = records.find(r => r.id === id);
    if (!record) return;

    toggleEditor(true); // å±•é–‹ç·¨è¼¯å™¨
    
    document.getElementById('editId').value = record.id;
    document.getElementById('editorTitle').innerText = `âœï¸ ç·¨è¼¯ ${record.date}`;
    document.getElementById('inputDate').value = record.date;
    document.getElementById('inputIncome').value = record.income;
    document.getElementById('inputOrders').value = record.orders;
    document.getElementById('inputDist').value = record.distance;
    
    const hr = Math.floor(record.totalMinutes / 60);
    const min = record.totalMinutes % 60;
    document.getElementById('inputHr').value = hr;
    document.getElementById('inputMin').value = min;

    document.getElementById('recordOilPrice').value = record.oilPrice;
    document.getElementById('editorOilHint').innerText = `é–å®šæ²¹åƒ¹: $${record.oilPrice.toFixed(2)}`;
    document.getElementById('editorOilHint').classList.remove('hidden');

    document.getElementById('btnDelete').classList.remove('hidden');
    document.getElementById('btnCancel').classList.remove('hidden');
    document.getElementById('btnSave').scrollIntoView({ behavior: 'smooth', block: 'center' });
}

function saveRecord() {
    const id = document.getElementById('editId').value;
    const newRecord = createRecordObject(id);
    
    if (newRecord.income <= 0 || newRecord.orders <= 0) {
        alert("è«‹è¼¸å…¥æœ‰æ•ˆçš„ç‡Ÿæ¥­é¡å’Œå–®æ•¸ï¼");
        return;
    }
    if (newRecord.distance <= 0) {
        alert("è«‹è¼¸å…¥æœ‰æ•ˆçš„é‡Œç¨‹ï¼");
        return;
    }
    if (newRecord.totalMinutes <= 0) {
        alert("è«‹è¼¸å…¥æœ‰æ•ˆçš„å·¥æ™‚ï¼");
        return;
    }

    if (id) {
        // ç·¨è¼¯æ¨¡å¼
        const index = records.findIndex(r => r.id === id);
        if (index !== -1) {
            records[index] = newRecord;
        }
    } else {
        // æ–°å¢æ¨¡å¼
        records.push(newRecord);
    }
    
    saveRecordsToLocal();
    saveRecordsToCloud();
    resetEditor();
    refreshDashboard();
    toggleEditor(false); // å„²å­˜å¾Œæ”¶èµ·ç·¨è¼¯å™¨
}

function deleteCurrentRecord() {
    const id = document.getElementById('editId').value;
    if (!id) return;
    
    if (confirm("ç¢ºå®šè¦åˆªé™¤é€™ç­†ç´€éŒ„å—ï¼Ÿ")) {
        // åˆªé™¤æœ¬åœ°
        records = records.filter(r => r.id !== id);
        saveRecordsToLocal();
        
        // åˆªé™¤é›²ç«¯ (å¦‚æœå·²ç™»å…¥)
        if (firebase.auth().currentUser) {
            // V1.2.16 åˆªé™¤é‚è¼¯
            db.collection("users").doc(firebase.auth().currentUser.uid).collection("records").doc(id).delete().then(() => {
                console.log("é›²ç«¯ç´€éŒ„åˆªé™¤æˆåŠŸ");
            }).catch((error) => {
                console.error("é›²ç«¯ç´€éŒ„åˆªé™¤å¤±æ•—:", error);
            });
        }

        resetEditor();
        refreshDashboard();
        toggleEditor(false);
    }
}


// === è³‡æ–™å„²å­˜èˆ‡è¼‰å…¥ (æœ¬åœ°/é›²ç«¯) (V1.2.16 é‚è¼¯) ===

function saveRecordsToLocal() {
    // æ’åºç´€éŒ„ (æ—¥æœŸç”±è¿‘åˆ°é )
    records.sort((a, b) => new Date(b.date) - new Date(a.date));
    localStorage.setItem('uberEatRecords', JSON.stringify(records));
}

function saveRecordsToCloud() {
    const user = firebase.auth().currentUser;
    if (!user) return; // æœªç™»å…¥å‰‡ä¸åŸ·è¡Œé›²ç«¯å¯«å…¥

    // V1.2.16 å¯«å…¥é‚è¼¯ï¼šä¾è³´å¯¦æ™‚ç›£è½è™•ç†å¤§éƒ¨åˆ†åŒæ­¥ï¼Œä½†æ–°å¢/ç·¨è¼¯æ™‚ä¸»å‹•å¯«å…¥
    const id = document.getElementById('editId').value;
    if (id) {
        const recordToSave = records.find(r => r.id === id);
        if (recordToSave) {
            db.collection("users").doc(user.uid).collection("records").doc(id).set(recordToSave)
            .then(() => console.log("é›²ç«¯ç´€éŒ„æ›´æ–°æˆåŠŸ:", recordToSave.id))
            .catch(error => console.error("é›²ç«¯æ›´æ–°å¤±æ•—:", error));
        }
    } else {
        const latestRecord = records[0]; 
        if(latestRecord && !latestRecord.synced) { 
             db.collection("users").doc(user.uid).collection("records").doc(latestRecord.id).set({...latestRecord, synced: true})
            .then(() => console.log("é›²ç«¯ç´€éŒ„æ–°å¢æˆåŠŸ:", latestRecord.id))
            .catch(error => console.error("é›²ç«¯æ–°å¢å¤±æ•—:", error));
        }
    }
}

// å¯¦æ™‚ç›£è½ (æ ¸å¿ƒåŒæ­¥é‚è¼¯)
function setupRealtimeListener(user) {
    if (firebaseUnsubscribe) {
        firebaseUnsubscribe(); // å–æ¶ˆèˆŠçš„ç›£è½
    }
    
    // ç›£è½è©²ç”¨æˆ¶çš„æ‰€æœ‰ç´€éŒ„
    firebaseUnsubscribe = db.collection("users").doc(user.uid).collection("records")
        .orderBy("date", "desc") // ç¢ºä¿æ’åº
        .onSnapshot(snapshot => {
            records = []; // æ¸…ç©ºç¾æœ‰ç´€éŒ„
            snapshot.forEach(doc => {
                records.push(doc.data());
            });
            
            // å°‡é›²ç«¯è³‡æ–™åŒæ­¥è‡³æœ¬åœ°å„²å­˜
            saveRecordsToLocal(); 
            
            // æ›´æ–°å„€è¡¨æ¿å’Œåˆ—è¡¨
            refreshDashboard();
            
        }, error => {
            console.error("å¯¦æ™‚ç›£è½éŒ¯èª¤:", error);
            refreshDashboard(); 
        });
}

function loadRecordsFromLocal() {
    const storedRecords = localStorage.getItem('uberEatRecords');
    if (storedRecords) {
        records = JSON.parse(storedRecords);
    } else {
        records = [];
    }
}


// === å„€è¡¨æ¿èˆ‡åˆ—è¡¨åˆ·æ–°å‡½å¼ (V1.2.16 é‚è¼¯) ===

function filterRecords(data) {
    let startDate, endDate;
    const today = new Date(getLocalDateString()); 
    today.setHours(0, 0, 0, 0);

    const isCustom = currentFilter === 'custom';
    
    if (isCustom) {
        const start = document.getElementById('filterStart').value;
        const end = document.getElementById('filterEnd').value;
        
        if (!start || !end) return [];

        startDate = new Date(start);
        endDate = new Date(end);
        endDate.setHours(23, 59, 59, 999); 
        
    } else if (currentFilter === 'day') {
        startDate = new Date(today);
        endDate = new Date(today);
        endDate.setHours(23, 59, 59, 999);
        
    } else if (currentFilter === 'week') {
        startDate = getWeekStart(today);
        endDate = new Date(startDate);
        endDate.setDate(endDate.getDate() + 6);
        endDate.setHours(23, 59, 59, 999);

    } else if (currentFilter === 'month') {
        startDate = new Date(today.getFullYear(), today.getMonth(), 1);
        endDate = new Date(today.getFullYear(), today.getMonth() + 1, 0);
        endDate.setHours(23, 59, 59, 999);

    } else if (currentFilter === 'year') {
        startDate = new Date(today.getFullYear(), 0, 1);
        endDate = new Date(today.getFullYear(), 11, 31);
        endDate.setHours(23, 59, 59, 999);

    } else { // 'all'
        return data; 
    }
    
    const filtered = data.filter(record => {
        const recordDate = new Date(record.date);
        recordDate.setHours(0, 0, 0, 0); 
        
        return recordDate >= startDate && recordDate <= endDate;
    });

    return filtered;
}

function setFilter(filterType, element = null) {
    currentFilter = filterType;
    
    document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
    
    if (element) {
        element.classList.add('active');
    } else {
        document.querySelector(`.tab-scroll-content button[onclick="setFilter('${filterType}', this)"]`)?.classList.add('active');
    }
    
    if (filterType === 'custom') {
        document.getElementById('customDateFilter').classList.remove('hidden');
    } else {
        document.getElementById('customDateFilter').classList.add('hidden');
    }
    
    refreshDashboard();
}

function applyCustomFilter() {
    setFilter('custom', document.querySelector('.tab-scroll-content button[onclick="setFilter(\'custom\', this)"]'));
}

function refreshDashboard() {
    loadRecordsFromLocal();
    const filteredRecords = filterRecords(records);

    // å½™ç¸½æ•¸æ“š
    const totalIncome = filteredRecords.reduce((sum, r) => sum + r.income, 0);
    const totalOrders = filteredRecords.reduce((sum, r) => sum + r.orders, 0);
    const totalDist = filteredRecords.reduce((sum, r) => sum + r.distance, 0);
    const totalOilCost = filteredRecords.reduce((sum, r) => sum + r.oilCost, 0);
    const totalMaintCost = filteredRecords.reduce((sum, r) => sum + r.maintenanceCost, 0);
    const totalMinutes = filteredRecords.reduce((sum, r) => sum + r.totalMinutes, 0);
    
    const totalCost = totalOilCost + totalMaintCost;
    const netProfit = totalIncome - totalCost;
    const totalHours = totalMinutes / 60;
    
    // è¨ˆç®—å¹³å‡å€¼
    const avgGrossHourly = totalHours > 0 ? (totalIncome / totalHours) : 0;
    const avgNetHourly = totalHours > 0 ? (netProfit / totalHours) : 0;
    const avgGrossPerOrder = totalOrders > 0 ? (totalIncome / totalOrders) : 0;
    const avgNetPerOrder = totalOrders > 0 ? (netProfit / totalOrders) : 0;

    // æ›´æ–°å„€è¡¨æ¿ UI
    document.getElementById('dashTotalIncome').innerText = totalIncome.toFixed(0);
    document.getElementById('dashTotalCost').innerText = totalCost.toFixed(0);
    document.getElementById('dashNetProfit').innerText = netProfit.toFixed(0);
    document.getElementById('dashOilCost').innerText = totalOilCost.toFixed(0);
    document.getElementById('dashMaintCost').innerText = totalMaintCost.toFixed(0);
    document.getElementById('dashOrders').innerText = totalOrders;
    document.getElementById('dashHours').innerText = Math.floor(totalHours);
    document.getElementById('dashMinutes').innerText = Math.round((totalHours % 1) * 60);
    document.getElementById('dashGrossHourly').innerText = avgGrossHourly.toFixed(0);
    document.getElementById('dashNetHourly').innerText = avgNetHourly.toFixed(0);
    document.getElementById('dashGrossPerOrder').innerText = avgGrossPerOrder.toFixed(0);
    document.getElementById('dashNetPerOrder').innerText = avgNetPerOrder.toFixed(0);

    // åˆ·æ–°æ­·å²åˆ—è¡¨
    renderHistoryList(filteredRecords);
    
    // åˆ·æ–°åœ–è¡¨ (å¦‚æœå·²å±•é–‹)
    if (!document.getElementById('chartsPanel').classList.contains('hidden')) {
        updateChart();
    }
}

function renderHistoryList(data) {
    const list = document.getElementById('historyList');
    list.innerHTML = ''; 

    if (data.length === 0) {
        list.innerHTML = '<div class="text-center py-6 text-gray-500">æ­¤å€é–“æš«ç„¡ç´€éŒ„ã€‚</div>';
        return;
    }

    data.forEach(record => {
        const netHourly = record.totalMinutes > 0 ? (record.netProfit / (record.totalMinutes / 60)) : 0;
        const netPerOrder = record.orders > 0 ? (record.netProfit / record.orders) : 0;
        
        // åˆ¤æ–·æ·¨åˆ©é¡è‰²
        const netProfitColor = record.netProfit >= 0 ? 'text-green-400' : 'text-red-400';
        
        const isExpanded = historyCollapseStates[record.id] === true;
        const subStatsClass = isExpanded ? '' : 'hidden';
        const iconRotate = isExpanded ? 'transform: rotate(180deg);' : 'transform: rotate(0deg);';
        
        // V1.2.16 (Icon Fixed): ä¿®æ­£åˆ—è¡¨ HTML çµæ§‹ï¼Œå°‡åœ–ç¤ºå–®ç¨æ”¾ç½®ï¼Œä¸¦èª¿æ•´é»æ“Šå€åŸŸ
        const itemHtml = `
            <div class="history-item" onclick="toggleHistoryDetails('${record.id}', this)">
                
                <div class="history-header-wrapper">
                    <div class="history-main-area" onclick="loadRecordToEditor('${record.id}')">
                        <div class="grid grid-cols-3 gap-3 w-full">
                            
                            <div class="history-stat-group">
                                <span class="stat-label-small text-gray-400">${record.date.substring(5).replace('-', '/')}</span>
                                <div class="history-main-value text-gray-200">
                                    ${record.orders} <span class="text-xs font-normal text-gray-400">å–®</span>
                                </div>
                            </div>
                            
                            <div class="history-stat-group center">
                                <span class="stat-label-small text-gray-400">ç¸½ç‡Ÿæ”¶</span>
                                <div class="history-main-value text-amber-soft">
                                    $${record.income.toFixed(0)}
                                </div>
                            </div>

                            <div class="history-stat-group right">
                                <span class="stat-label-small text-gray-400">æ·¨åˆ©</span>
                                <div class="history-main-value ${netProfitColor}">
                                    $${record.netProfit.toFixed(0)}
                                </div>
                            </div>

                        </div>
                    </div>
                    
                    <div class="history-toggle-icon" style="${iconRotate}">â–¼</div>
                </div>

                <div id="sub-stats-${record.id}" class="history-sub-stats ${subStatsClass}">
                    <div class="grid grid-cols-3 gap-3 text-center">
                        <div>
                            <div class="text-xs text-gray-400">å¯¦ç™¼æ·¨æ™‚è–ª</div>
                            <div class="text-base font-bold text-green-400">$${netHourly.toFixed(0)}</div>
                        </div>
                        <div>
                            <div class="text-xs text-gray-400">å¹³å‡æ·¨å–®åˆ©</div>
                            <div class="text-base font-bold text-green-400">$${netPerOrder.toFixed(0)}</div>
                        </div>
                        <div>
                            <div class="text-xs text-gray-400">ç¸½æˆæœ¬</div>
                            <div class="text-base font-bold text-red-400">$${record.totalCost.toFixed(0)}</div>
                        </div>
                    </div>

                    <div class="performance-summary">
                        <div class="grid grid-cols-2 gap-2 text-xs">
                            <div class="flex justify-between">
                                <span>é‡Œç¨‹ (km):</span>
                                <span class="font-bold">${record.distance.toFixed(1)}</span>
                            </div>
                            <div class="flex justify-between">
                                <span>å·¥æ™‚ (h:m):</span>
                                <span class="font-bold">${Math.floor(record.totalMinutes / 60)}h ${record.totalMinutes % 60}m</span>
                            </div>
                            <div class="flex justify-between">
                                <span>æ²¹è€—æˆæœ¬:</span>
                                <span class="font-bold text-red-400">$${record.oilCost.toFixed(0)}</span>
                            </div>
                            <div class="flex justify-between">
                                <span>è€—ææˆæœ¬:</span>
                                <span class="font-bold text-red-400">$${record.maintenanceCost.toFixed(0)}</span>
                            </div>
                            <div class="col-span-2 text-right text-gray-500 mt-2">
                                <span> (æ²¹åƒ¹: $${record.oilPrice.toFixed(2)}, æ²¹è€—: ${record.fuelRate}km/L, è€—æ: $${record.maintCost.toFixed(1)}/km)</span>
                            </div>
                        </div>
                    </div>

                </div>
            </div>
        `;
        list.insertAdjacentHTML('beforeend', itemHtml);
    });
}


// === åœ–è¡¨ç›¸é—œå‡½å¼ (V1.2.16 é‚è¼¯ - æœªæ›´å‹•) ===

function switchChartType(type) {
    chartType = type;
    document.getElementById('btnChartBar').classList.remove('active');
    document.getElementById('btnChartPie').classList.remove('active');
    document.getElementById('chartGroupBy').closest('div').style.display = (type === 'bar' ? 'flex' : 'none');
    
    if (type === 'bar') {
        document.getElementById('btnChartBar').classList.add('active');
    } else {
        document.getElementById('btnChartPie').classList.add('active');
    }
    updateChart();
}

function updateChart() {
    if (chartInstance) {
        chartInstance.destroy(); // éŠ·æ¯€èˆŠåœ–è¡¨
    }
    
    const chartStart = document.getElementById('chartStart').value;
    const chartEnd = document.getElementById('chartEnd').value;
    const groupBy = document.getElementById('chartGroupBy').value;
    const ctx = document.getElementById('mainChart').getContext('2d');
    
    // æ ¹æ“šåœ–è¡¨æ—¥æœŸç¯„åœéæ¿¾æ•¸æ“š (ç¨ç«‹æ–¼å„€è¡¨æ¿ç¯©é¸)
    const chartStartDate = new Date(chartStart);
    const chartEndDate = new Date(chartEnd);
    chartEndDate.setHours(23, 59, 59, 999);
    
    const chartData = records.filter(record => {
        const recordDate = new Date(record.date);
        recordDate.setHours(0, 0, 0, 0); // ç¢ºä¿æ—¥æœŸåŸºæº–ä¸€è‡´
        return recordDate >= chartStartDate && recordDate <= chartEndDate;
    });

    if (chartData.length === 0) {
        ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
        return; 
    }

    if (chartType === 'bar') {
        renderBarChart(ctx, chartData, groupBy);
    } else {
        renderPieChart(ctx, chartData);
    }
}

function renderBarChart(ctx, chartData, groupBy) {
    // æ•¸æ“šåˆ†çµ„
    const groupedData = {};

    chartData.forEach(record => {
        let key;
        const date = new Date(record.date);

        if (groupBy === 'month') {
            key = `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}`;
        } else if (groupBy === 'year') {
            key = date.getFullYear().toString();
        } else { // 'day'
            key = record.date;
        }

        if (!groupedData[key]) {
            groupedData[key] = {
                income: 0,
                netProfit: 0,
                totalCost: 0,
            };
        }
        groupedData[key].income += record.income;
        groupedData[key].netProfit += record.netProfit;
        groupedData[key].totalCost += record.totalCost;
    });

    // æº–å‚™åœ–è¡¨æ•¸æ“š
    const sortedKeys = Object.keys(groupedData).sort();
    const labels = sortedKeys;
    const netProfits = sortedKeys.map(key => groupedData[key].netProfit.toFixed(0));
    const totalCosts = sortedKeys.map(key => groupedData[key].totalCost.toFixed(0));

    chartInstance = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [
                {
                    label: 'æ·¨åˆ©æ½¤',
                    data: netProfits,
                    backgroundColor: '#10b981', // ç¶ è‰²
                    borderColor: '#059669',
                    borderWidth: 1,
                    yAxisID: 'y'
                },
                {
                    label: 'ç¸½æˆæœ¬',
                    data: totalCosts,
                    backgroundColor: '#ef4444', // ç´…è‰²
                    borderColor: '#dc2626',
                    borderWidth: 1,
                    yAxisID: 'y'
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    labels: { color: '#e5e5e5' }
                }
            },
            scales: {
                x: {
                    stacked: true,
                    ticks: { color: '#9ca3af' },
                    grid: { color: 'rgba(51,51,51,0.5)' }
                },
                y: {
                    stacked: false,
                    ticks: { color: '#9ca3af' },
                    grid: { color: 'rgba(51,51,51,0.5)' }
                }
            }
        }
    });
}

function renderPieChart(ctx, chartData) {
    // å½™ç¸½ç¸½æ·¨åˆ©ã€ç¸½æ²¹è€—æˆæœ¬ã€ç¸½è€—ææˆæœ¬
    const totalOilCost = chartData.reduce((sum, r) => sum + r.oilCost, 0);
    const totalMaintCost = chartData.reduce((sum, r) => sum + r.maintenanceCost, 0);
    const totalNetProfit = chartData.reduce((sum, r) => sum + r.netProfit, 0);
    
    // V1.2.16 é‚è¼¯: ç›´æ¥ä½¿ç”¨åŸå§‹æ·¨åˆ© (å…è¨±è² å€¼åœ¨åœ–è¡¨ä¸­é¡¯ç¤º)
    
    chartInstance = new Chart(ctx, {
        type: 'pie',
        data: {
            labels: ['ç¸½æ·¨åˆ©', 'ç¸½æ²¹è€—æˆæœ¬', 'ç¸½è€—ææˆæœ¬'],
            datasets: [{
                data: [totalNetProfit, totalOilCost, totalMaintCost],
                backgroundColor: ['#10b981', '#fcd34d', '#ef4444'],
                hoverOffset: 4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'top',
                    labels: { color: '#e5e5e5' }
                },
                tooltip: {
                    callbacks: {
                        label: (context) => {
                            // V1.2.16 åŸå§‹ tooltip é‚è¼¯
                            const dataSet = context.dataset.data;
                            const total = dataSet.reduce((a, b) => a + b, 0);
                            const value = context.raw;
                            // ä¿®æ­£ï¼šå¦‚æœç¸½å’Œç‚º0ï¼Œé¿å… NaN
                            const percentage = total === 0 ? '0.0%' : ((value / total) * 100).toFixed(1) + '%';
                            
                            return `${context.label}: $${value.toFixed(0)} (${percentage})`;
                        }
                    }
                }
            }
        }
    });
}


// === Firebase é©—è­‰å‡½å¼ (V1.2.16 é‚è¼¯) ===

async function registerUser() {
    const email = document.getElementById('authEmail').value;
    const password = document.getElementById('authPassword').value;
    
    if (!email || password.length < 6) {
        alert("Email æˆ–å¯†ç¢¼æ ¼å¼ä¸æ­£ç¢º (å¯†ç¢¼éœ€è‡³å°‘6ä½)ã€‚");
        return;
    }
    
    try {
        const userCredential = await firebase.auth().createUserWithEmailAndPassword(email, password);
        await syncLocalToCloud(userCredential.user.uid);
        alert("è¨»å†ŠæˆåŠŸï¼è³‡æ–™å·²åŒæ­¥ã€‚");
    } catch (error) {
        alert("è¨»å†Šå¤±æ•—: " + error.message);
    }
}

async function loginUser() {
    const email = document.getElementById('authEmail').value;
    const password = document.getElementById('authPassword').value;
    
    if (!email || password.length < 6) {
        alert("Email æˆ–å¯†ç¢¼æ ¼å¼ä¸æ­£ç¢º (å¯†ç¢¼éœ€è‡³å°‘6ä½)ã€‚");
        return;
    }
    
    try {
        await firebase.auth().signInWithEmailAndPassword(email, password);
        alert("ç™»å…¥æˆåŠŸï¼é›²ç«¯è³‡æ–™å°‡è‡ªå‹•åŒæ­¥ã€‚");
    } catch (error) {
        alert("ç™»å…¥å¤±æ•—: " + error.message);
    }
}

async function logoutUser() {
    if (confirm("ç¢ºå®šè¦ç™»å‡ºä¸¦æ¸…é™¤æœ¬æ©Ÿæ‰€æœ‰ç´€éŒ„å—ï¼Ÿ(æ¸…é™¤å¾Œå°‡åªé¡¯ç¤ºé›²ç«¯è³‡æ–™)")) {
        localStorage.removeItem('uberEatRecords');
        records = [];
        
        try {
            await firebase.auth().signOut();
            alert("ç™»å‡ºæˆåŠŸï¼Œæœ¬æ©Ÿç´€éŒ„å·²æ¸…é™¤ã€‚");
        } catch (error) {
            alert("ç™»å‡ºå¤±æ•—: " + error.message);
        }
    }
}

async function resetPassword() {
    const email = document.getElementById('authEmail').value;
    if (!email) {
        alert("è«‹è¼¸å…¥æ‚¨è¨»å†Šçš„ Emailï¼");
        return;
    }
    
    try {
        await firebase.auth().sendPasswordResetEmail(email);
        alert(`å¯†ç¢¼é‡è¨­éƒµä»¶å·²ç™¼é€è‡³ ${email}ï¼Œè«‹æª¢æŸ¥æ‚¨çš„ä¿¡ç®±ã€‚`);
    } catch (error) {
        alert("å¯†ç¢¼é‡è¨­å¤±æ•—: " + error.message);
    }
}

// é¦–æ¬¡è¨»å†Š/ç™»å…¥æ™‚ï¼Œå°‡æœ¬åœ°è³‡æ–™æ¨é€åˆ°é›²ç«¯ (åƒ…åŸ·è¡Œä¸€æ¬¡)
async function syncLocalToCloud(uid) {
    if (records.length === 0) return;

    const batch = db.batch();
    const userRef = db.collection("users").doc(uid).collection("records");
    let count = 0;
    
    records.forEach(record => {
        if (count >= 499) return; 
        const docRef = userRef.doc(record.id);
        batch.set(docRef, record);
        count++;
    });

    try {
        await batch.commit();
        console.log(`æˆåŠŸå°‡ ${count} ç­†æœ¬åœ°ç´€éŒ„åŒæ­¥åˆ°é›²ç«¯ã€‚`);
    } catch (error) {
        console.error("åŒæ­¥æœ¬åœ°æ•¸æ“šåˆ°é›²ç«¯å¤±æ•—:", error);
    }
}
</script>
</body>
</html>
