<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
<title>UberEat å¤–é€è–ªè³‡è¨ˆç®—å™¨ V1.0</title>

<!-- === App åŒ–å°ˆç”¨ Meta è¨­å®š === -->
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#050505">
<link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/732/732200.png">

<!-- === Open Graph (OG) Meta Tag for LINE/Social Sharing === -->
<!-- ä¿®æ­£åˆ†äº«æ™‚çš„æ¨™é¡Œå’Œèªªæ˜ -->
<meta property="og:title" content="UberEat å¤–é€è–ªè³‡è¨ˆç®—å™¨ V1.0" />
<meta property="og:description" content="Developed by Ray Â© 2025 - å°ˆç‚º UberEat å¤–é€å“¡è¨­è¨ˆçš„è–ªè³‡ã€æˆæœ¬ã€æ·¨åˆ©è¨ˆç®—èˆ‡åœ–è¡¨åˆ†æå·¥å…·ã€‚" />
<meta property="og:type" content="website" />
<meta property="og:image" content="https://placehold.co/1200x630/059669/ffffff?text=UberEat+V1.0" />

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
    /* === å…¨å±€è¨­å®š === */
    body { 
        background-color: #050505; 
        color: #e5e5e5; 
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; 
        padding-bottom: 120px; /* åº•éƒ¨ç•™ç©ºé–“çµ¦ç‰ˆæ¬Š */
        padding-top: env(safe-area-inset-top); /* é¿é–‹ç€æµ· */
    }
    
    /* === å¡ç‰‡æ¨£å¼ === */
    .card {
        background-color: #111216;
        border: 1px solid #2a2d36;
        border-radius: 1rem;
        padding: 1rem;
        margin-bottom: 0.8rem;
        position: relative;
    }
    .card-glow { border-color: #10b981; box-shadow: 0 0 10px rgba(16, 185, 129, 0.1); } /* æ”¹ç‚º UberEat ç¶ è‰²ç³» */

    /* === è¼¸å…¥æ¡† === */
    .input-field {
        background-color: #1a1c23;
        border: 1px solid #333;
        color: #fff;
        border-radius: 0.6rem;
        padding: 0.7rem;
        width: 100%;
        font-size: 1rem;
        transition: 0.2s;
    }
    .input-field:focus { outline: none; border-color: #10b981; background-color: #202229; }

    /* === æ—¥æœŸé¸æ“‡å™¨ === */
    input[type="date"] { position: relative; }
    input[type="date"]::-webkit-calendar-picker-indicator {
        position: absolute; top: 0; left: 0; right: 0; bottom: 0; width: 100%; height: 100%;
        color: transparent; background: transparent; cursor: pointer;
    }

    /* === æŒ‰éˆ• === */
    .btn { width: 100%; padding: 0.8rem; border-radius: 0.6rem; font-weight: 600; display: flex; justify-content: center; align-items: center; transition: 0.2s; }
    .btn-primary { background-color: #059669; color: white; } /* UberEat ç¶  */
    .btn-primary:active { background-color: #047857; transform: scale(0.98); }
    .btn-danger { background-color: #7f1d1d; color: #fca5a5; border: 1px solid #991b1b; }
    .btn-ghost { background-color: transparent; border: 1px solid #333; color: #9ca3af; }
    
    .chart-toggle-btn { background: #2a2d36; color: #9ca3af; border: 1px solid #333; }
    .chart-toggle-btn.active { background: #059669; color: white; border-color: #059669; }

    /* === ç¯©é¸ Tab (ä¿®æ­£æ»‘å‹•å•é¡Œ) === */
    .tab-scroll-container {
        width: 100%;
        overflow-x: auto;
        padding-bottom: 0.5rem;
        /* éš±è—æ»¾å‹•æ¢ */
        scrollbar-width: none; 
        -ms-overflow-style: none;
    }
    .tab-scroll-container::-webkit-scrollbar { display: none; }

    .tab-scroll-content {
        display: flex;
        gap: 0.6rem;
        padding-right: 1.5rem; /* é—œéµï¼šå³å´ç•™ç™½ï¼Œé¿å…æŒ‰éˆ•è²¼é‚Š */
        min-width: max-content; /* ç¢ºä¿å…§å®¹æ’é–‹ */
    }

    .tab-btn {
        padding: 0.5rem 1rem; border-radius: 2rem; font-size: 0.9rem; color: #9ca3af; background: #1a1c23; border: 1px solid #333; white-space: nowrap;
    }
    .tab-btn.active { background-color: #d1fae5; color: #065f46; font-weight: bold; border-color: #fff; }

    /* === æ­·å²åˆ—è¡¨ === */
    .history-item {
        background-color: #111216; border-bottom: 1px solid #222; padding: 1rem;
        display: flex; justify-content: space-between; align-items: center;
        cursor: pointer; transition: background 0.2s;
    }
    .history-item:active { background-color: #1c1e24; }

    /* === å­—é«”èˆ‡æ¨™ç±¤ === */
    .stat-label { font-size: 0.75rem; color: #6b7280; text-transform: uppercase; letter-spacing: 0.05em; }
    .text-amber-soft { color: #fcd34d; }
    
    /* === ç‰ˆæ¬Š Footer === */
    .footer-credit {
        text-align: center;
        margin-top: 2rem;
        padding-top: 1rem;
        border-top: 1px solid #222;
        color: #525252;
        font-size: 0.75rem;
        letter-spacing: 1px;
    }
</style>
</head>
<body class="max-w-md mx-auto p-3">

    <!-- æ¨™é¡Œ -->
    <div class="flex justify-between items-center mb-4 px-1 pt-2">
        <div class="flex items-center gap-2">
            <div class="w-1.5 h-6 bg-green-500 rounded-full"></div>
            <div>
                <h1 class="text-lg font-bold text-white leading-tight">UberEat å¤–é€è–ªè³‡è¨ˆç®—å™¨</h1>
                <div class="text-[10px] text-gray-500">V1.0 Stable</div>
            </div>
        </div>
        <button onclick="toggleSettings()" class="p-2 bg-[#1a1c23] rounded-full text-gray-400 border border-[#333] text-xs active:bg-gray-800">
            âš™ï¸ è¨­å®š
        </button>
    </div>

    <!-- è¨­å®šé¢æ¿ -->
    <div id="settingsPanel" class="hidden mb-4 card border-green-900/50">
        <h3 class="text-green-500 font-bold mb-3 text-sm uppercase">å…¨åŸŸåƒæ•¸</h3>
        <div class="grid grid-cols-2 gap-3 mb-3">
            <div>
                <label class="stat-label mb-1">æ²¹å“</label>
                <select id="oilType" class="input-field" onchange="fetchOilPrice()">
                    <option value="92">92 ç„¡é‰›</option>
                    <option value="95">95 ç„¡é‰›</option>
                    <option value="98">98 ç„¡é‰›</option>
                    <option value="diesel">æŸ´æ²¹</option>
                </select>
            </div>
            <div>
                <label class="stat-label mb-1">ç›®å‰æ²¹åƒ¹</label>
                <div id="oilPriceDisplay" class="input-field text-yellow-500 font-bold">è®€å–ä¸­...</div>
            </div>
        </div>
        <div class="grid grid-cols-2 gap-3 mb-3">
            <div>
                <label class="stat-label mb-1">æ²¹è€— (km/L)</label>
                <input id="settingFuelRate" type="number" class="input-field" />
            </div>
            <div>
                <label class="stat-label mb-1">è€—æ ($/km)</label>
                <input id="settingMaint" type="number" step="0.1" class="input-field" />
            </div>
        </div>
        <button onclick="saveSettings()" class="btn btn-primary text-sm">å„²å­˜è¨­å®š</button>
    </div>

    <!-- 1. å„€è¡¨æ¿ (Dashboard) -->
    <div class="card bg-gradient-to-br from-[#111216] to-[#064e3b20] border-green-500/30 p-5 mb-4">
        <div class="flex justify-between items-start mb-4">
            <div>
                <label class="stat-label text-gray-400">å€é–“ç¸½ç‡Ÿæ”¶</label>
                <div class="text-4xl font-bold text-amber-soft mt-1 tracking-tight">$<span id="dashTotalIncome">0</span></div>
            </div>
            <div class="text-right">
                <label class="stat-label text-green-400">æ·¨åˆ©</label>
                <div class="text-2xl font-bold text-green-400 mt-1">$<span id="dashNetProfit">0</span></div>
            </div>
        </div>
        <div class="grid grid-cols-3 gap-2 border-t border-white/10 pt-4 text-center">
            <div>
                <label class="stat-label">æ™‚è–ª</label>
                <div class="text-lg font-bold text-gray-300">$<span id="dashRealHourly">0</span></div>
            </div>
            <div>
                <label class="stat-label">ç¸½å–®æ•¸</label>
                <div class="text-lg font-bold text-white"><span id="dashOrders">0</span></div>
            </div>
            <div>
                <label class="stat-label">ç¸½å·¥æ™‚</label>
                <div class="text-lg font-bold text-white"><span id="dashHours">0</span><span class="text-xs text-gray-500">h</span> <span id="dashMinutes">0</span><span class="text-xs text-gray-500">m</span></div>
            </div>
        </div>
    </div>

    <!-- 2. ç·¨è¼¯æ§åˆ¶å° -->
    <div class="card card-glow mb-4" id="editorCard">
        <div class="flex justify-between items-center mb-3 pb-2 border-b border-gray-800">
            <h3 class="font-bold text-white flex items-center gap-2 text-sm">
                <span id="editorTitle">ğŸ“ æ–°å¢ç´€éŒ„</span>
            </h3>
            <span id="editorOilHint" class="text-xs text-gray-500 hidden">é–å®šæ²¹åƒ¹: --</span>
        </div>
        <input type="hidden" id="editId" value="">
        <input type="hidden" id="recordOilPrice" value=""> 

        <div class="grid grid-cols-3 gap-2 mb-3">
            <div class="col-span-1">
                <label class="stat-label mb-1">æ—¥æœŸ</label>
                <input id="inputDate" type="date" class="input-field cursor-pointer" onclick="this.showPicker()" />
            </div>
            <div class="col-span-2">
                <label class="stat-label mb-1">ç‡Ÿæ¥­é¡</label>
                <input id="inputIncome" type="number" inputmode="numeric" class="input-field text-amber-soft font-bold text-lg" placeholder="$0" />
            </div>
        </div>

        <div class="grid grid-cols-3 gap-2 mb-4">
            <div>
                <label class="stat-label mb-1">å–®æ•¸</label>
                <input id="inputOrders" type="number" inputmode="numeric" class="input-field" placeholder="0" />
            </div>
            <div>
                <label class="stat-label mb-1">é‡Œç¨‹</label>
                <input id="inputDist" type="number" step="0.1" inputmode="decimal" class="input-field" placeholder="KM" />
            </div>
            <div>
                <label class="stat-label mb-1">å·¥æ™‚</label>
                <div class="flex gap-1">
                    <input id="inputHr" type="number" class="input-field text-center px-1" placeholder="æ™‚" />
                    <input id="inputMin" type="number" class="input-field text-center px-1" placeholder="åˆ†" />
                </div>
            </div>
        </div>

        <div class="flex gap-2">
            <button onclick="saveRecord()" class="btn btn-primary" id="btnSave">å„²å­˜</button>
            <button onclick="deleteCurrentRecord()" class="btn btn-danger hidden" id="btnDelete">åˆªé™¤</button>
            <button onclick="resetEditor()" class="btn btn-ghost hidden" id="btnCancel">å–æ¶ˆ</button>
        </div>
    </div>

    <!-- 3. ç¯©é¸ Tab (ä¿®æ­£è¶…å‡ºå•é¡Œ) -->
    <div class="tab-scroll-container mb-3">
        <div class="tab-scroll-content">
            <button class="tab-btn active" onclick="setFilter('day', this)">ä»Šæ—¥</button>
            <button class="tab-btn" onclick="setFilter('week', this)">æœ¬é€±</button>
            <button class="tab-btn" onclick="setFilter('month', this)">æœ¬æœˆ</button>
            <button class="tab-btn" onclick="setFilter('year', this)">æœ¬å¹´</button>
            <button class="tab-btn" onclick="setFilter('all', this)">å…¨éƒ¨</button>
            <button class="tab-btn border-green-500 text-green-400" onclick="toggleCharts()">ğŸ“ˆ é€²éšåœ–è¡¨åˆ†æ</button>
        </div>
    </div>

    <!-- 4. é€²éšåœ–è¡¨å€ -->
    <div id="chartsPanel" class="hidden card mb-4 border border-green-500/30">
        <div class="flex justify-between items-center mb-3">
            <h4 class="text-sm font-bold text-white">ğŸ“Š æ•¸æ“šåˆ†æä¸­å¿ƒ</h4>
            <div class="flex bg-[#1a1c23] rounded-lg p-1">
                <button onclick="switchChartType('bar')" id="btnChartBar" class="chart-toggle-btn active px-3 py-1 rounded text-xs">è¶¨å‹¢åœ–</button>
                <button onclick="switchChartType('pie')" id="btnChartPie" class="chart-toggle-btn px-3 py-1 rounded text-xs">åœ“é¤…åœ–</button>
            </div>
        </div>

        <!-- é€²éšæ§åˆ¶å™¨ -->
        <div class="bg-[#1a1c23] p-2 rounded-lg mb-3">
            <div class="flex gap-2 mb-2">
                <input type="date" id="chartStart" class="input-field text-xs py-1" onchange="updateChart()" />
                <span class="text-gray-500 self-center">~</span>
                <input type="date" id="chartEnd" class="input-field text-xs py-1" onchange="updateChart()" />
            </div>
            <div class="flex items-center gap-2">
                <label class="text-xs text-gray-500">åˆ†çµ„:</label>
                <select id="chartGroupBy" class="input-field text-xs py-1" onchange="updateChart()">
                    <option value="day">ä¾æ—¥æœŸ (æ—¥)</option>
                    <option value="month">ä¾æœˆä»½ (æœˆ)</option>
                    <option value="year">ä¾å¹´ä»½ (å¹´)</option>
                </select>
            </div>
        </div>

        <!-- åœ–è¡¨å®¹å™¨ (å›ºå®šé«˜åº¦) -->
        <div style="position: relative; height: 300px; width: 100%;">
            <canvas id="mainChart"></canvas>
        </div>
    </div>

    <!-- 5. æ­·å²åˆ—è¡¨ -->
    <div class="mb-8">
        <h3 class="text-xs font-bold text-gray-500 mb-2 uppercase pl-1">å€é–“æ˜ç´°</h3>
        <div id="historyList" class="rounded-xl overflow-hidden border border-[#2a2d36]"></div>
    </div>

    <!-- 6. ç‰ˆæ¬Š Footer -->
    <div class="footer-credit">
        <div>UberEat å¤–é€è–ªè³‡è¨ˆç®—å™¨ V1.0</div>
        <div class="mt-1">Developed by Ray Â© 2025</div>
        <div class="mt-1 text-xs text-gray-600">All Rights Reserved.</div>
    </div>

<script>
// === è®Šæ•¸èˆ‡åˆå§‹åŒ– ===
const workerAPI = "https://ubereat-oil-proxy.leo3026772.workers.dev/";
let globalOilPrice = 30.0;
let currentFilter = 'day';
let chartInstance = null;
let chartType = 'bar'; 

window.onload = async () => {
    resetEditor();
    loadSettings();
    const now = new Date();
    document.getElementById('chartStart').value = new Date(now.getFullYear(), 0, 1).toISOString().slice(0,10);
    document.getElementById('chartEnd').value = getLocalDateString();
    refreshDashboard();
    await fetchOilPrice();
};

function getLocalDateString() {
    const offset = new Date().getTimezoneOffset() * 60000;
    return new Date(Date.now() - offset).toISOString().split('T')[0];
}

// === è¨­å®šè™•ç† ===
function loadSettings() {
    document.getElementById('settingFuelRate').value = localStorage.getItem('fuelRate') || 12;
    document.getElementById('settingMaint').value = localStorage.getItem('maintCost') || 1.5;
    document.getElementById('oilType').value = localStorage.getItem('oilType') || '95';
}
function saveSettings() {
    localStorage.setItem('fuelRate', document.getElementById('settingFuelRate').value);
    localStorage.setItem('maintCost', document.getElementById('settingMaint').value);
    localStorage.setItem('oilType', document.getElementById('oilType').value);
    document.getElementById('settingsPanel').classList.add('hidden');
    refreshDashboard();
}
function toggleSettings() { document.getElementById('settingsPanel').classList.toggle('hidden'); }

// === æ²¹åƒ¹ç²å– (ä½¿ç”¨ä»£ç† API) ===
async function fetchOilPrice() {
    try {
        const type = document.getElementById('oilType').value;
        // ä½¿ç”¨ try-catch ç¢ºä¿å³ä½¿ API å¤±æ•—ä¹Ÿèƒ½ä½¿ç”¨é è¨­å€¼
        const res = await fetch(workerAPI);
        const data = await res.json();
        if(data[type]) {
            globalOilPrice = parseFloat(data[type]);
            document.getElementById('oilPriceDisplay').innerText = `$${globalOilPrice}`;
        } else {
            document.getElementById('oilPriceDisplay').innerText = `$${globalOilPrice} (é è¨­/APIéŒ¯èª¤)`;
        }
    } catch(e) { 
        document.getElementById('oilPriceDisplay').innerText = `$${globalOilPrice} (é è¨­/ç¶²è·¯éŒ¯èª¤)`;
    }
}

// === æ­·å²è³‡æ–™ CRUD ===
function getHistory() { try { return JSON.parse(localStorage.getItem('uber_ray_v1') || '[]'); } catch { return []; } }
function saveToHistory(data) { localStorage.setItem('uber_ray_v1', JSON.stringify(data)); }

function saveRecord() {
    const date = document.getElementById('inputDate').value;
    const income = parseFloat(document.getElementById('inputIncome').value);
    const orders = parseFloat(document.getElementById('inputOrders').value);
    const km = parseFloat(document.getElementById('inputDist').value);
    const hr = parseFloat(document.getElementById('inputHr').value) || 0;
    const min = parseFloat(document.getElementById('inputMin').value) || 0;
    const editId = document.getElementById('editId').value;
    const lockedOil = document.getElementById('recordOilPrice').value;

    if(!date) return alert('è«‹é¸æ—¥æœŸ');
    if(isNaN(income) || isNaN(km)) return alert('è«‹å¡«å¯«é‡‘é¡èˆ‡é‡Œç¨‹');

    const finalOil = (editId && lockedOil) ? parseFloat(lockedOil) : globalOilPrice;
    const rec = {
        id: editId ? parseInt(editId) : Date.now(),
        date: date, income: income, orders: orders||0, km: km, hours: hr+(min/60),
        oilPrice: finalOil,
        fuelRate: parseFloat(document.getElementById('settingFuelRate').value),
        maintCost: parseFloat(document.getElementById('settingMaint').value)
    };

    const list = getHistory();
    if(editId) {
        const idx = list.findIndex(r => r.id == editId);
        if(idx!==-1) list[idx] = rec;
    } else {
        list.push(rec);
        if(date === getLocalDateString()) { currentFilter = 'day'; updateTabs(); }
    }
    list.sort((a,b) => new Date(b.date)-new Date(a.date));
    saveToHistory(list);
    resetEditor();
    refreshDashboard();
}

function loadRecordToEditor(id) {
    const r = getHistory().find(i => i.id === id);
    if(!r) return;
    document.getElementById('editId').value = r.id;
    document.getElementById('recordOilPrice').value = r.oilPrice || globalOilPrice;
    document.getElementById('inputDate').value = r.date;
    document.getElementById('inputIncome').value = r.income;
    document.getElementById('inputOrders').value = r.orders;
    document.getElementById('inputDist').value = r.km;
    const h = Math.floor(r.hours);
    document.getElementById('inputHr').value = h;
    document.getElementById('inputMin').value = Math.round((r.hours-h)*60);

    const hint = document.getElementById('editorOilHint');
    hint.classList.remove('hidden');
    hint.innerText = `é–å®šæ²¹åƒ¹: $${r.oilPrice||globalOilPrice}`;
    
    document.getElementById('editorTitle').innerText = "âœï¸ ç·¨è¼¯ç´€éŒ„";
    document.getElementById('editorCard').classList.add('card-glow');
    document.getElementById('btnSave').innerText = "ç¢ºèªä¿®æ”¹";
    document.getElementById('btnDelete').classList.remove('hidden');
    document.getElementById('btnCancel').classList.remove('hidden');
    document.getElementById('editorCard').scrollIntoView({behavior:'smooth'});
}

function deleteCurrentRecord() {
    if(!confirm('åˆªé™¤æ­¤ç´€éŒ„?')) return; // é›–ç„¶ Canvas ä¸æ”¯æ´ confirmï¼Œä½†å…ˆä¿ç•™
    const id = document.getElementById('editId').value;
    saveToHistory(getHistory().filter(r => r.id != id));
    resetEditor();
    refreshDashboard();
}

function resetEditor() {
    document.getElementById('editId').value = "";
    document.getElementById('recordOilPrice').value = "";
    document.getElementById('inputDate').value = getLocalDateString();
    document.getElementById('inputIncome').value = "";
    document.getElementById('inputOrders').value = "";
    document.getElementById('inputDist').value = "";
    document.getElementById('inputHr').value = "";
    document.getElementById('inputMin').value = "";
    document.getElementById('editorTitle').innerText = "ğŸ“ æ–°å¢ç´€éŒ„";
    document.getElementById('editorOilHint').classList.add('hidden');
    document.getElementById('editorCard').classList.remove('card-glow');
    document.getElementById('btnSave').innerText = "å„²å­˜";
    document.getElementById('btnDelete').classList.add('hidden');
    document.getElementById('btnCancel').classList.add('hidden');
}

// === ç¯©é¸èˆ‡å„€è¡¨æ¿æ›´æ–° ===
function setFilter(type, btn) {
    currentFilter = type;
    updateTabs(btn);
    refreshDashboard();
}
function updateTabs(btn) {
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    if(btn) btn.classList.add('active');
    else {
        const map = {'day':0, 'week':1, 'month':2, 'year':3, 'all':4};
        document.querySelectorAll('.tab-btn')[map[currentFilter]]?.classList.add('active');
    }
}

function getFilteredData() {
    const list = getHistory();
    const today = getLocalDateString();
    if(currentFilter==='day') return list.filter(r=>r.date===today);
    if(currentFilter==='week') {
        const d = new Date(); d.setDate(d.getDate()-7);
        return list.filter(r=>r.date >= d.toISOString().split('T')[0]);
    }
    if(currentFilter==='month') return list.filter(r=>r.date.startsWith(today.slice(0,7)));
    if(currentFilter==='year') return list.filter(r=>r.date.startsWith(today.slice(0,4)));
    return list;
}

function refreshDashboard() {
    const data = getFilteredData();
    const listDiv = document.getElementById('historyList');
    let tInc=0, tNet=0, tOrders=0, tHr=0;
    let html = '';

    if(data.length===0) html = `<div class="text-center text-gray-600 py-8 text-sm">ç„¡è³‡æ–™</div>`;
    else {
        data.forEach(r => {
            const p = r.oilPrice!==undefined?r.oilPrice:globalOilPrice;
            const rate = r.fuelRate||12;
            const maint = r.maintCost!==undefined?r.maintCost:1.5;
            const cost = (r.km/rate)*p + (r.km*maint);
            const net = r.income - cost;
            tInc+=r.income; tNet+=net; tOrders+=r.orders; tHr+=r.hours;

            html += `
            <div class="history-item" onclick="loadRecordToEditor(${r.id})">
                <div>
                    <div class="text-gray-500 text-xs mb-1">${r.date}</div>
                    <div class="text-amber-soft font-bold text-lg">$${Math.round(r.income)}</div>
                </div>
                <div class="text-right">
                    <div class="text-green-400 font-bold text-sm">æ·¨ $${Math.round(net)}</div>
                    <div class="text-gray-600 text-xs mt-1">${r.km}km / ${r.orders}å–®</div>
                </div>
            </div>`;
        });
    }
    listDiv.innerHTML = html;
    document.getElementById('dashTotalIncome').innerText = Math.round(tInc).toLocaleString();
    document.getElementById('dashNetProfit').innerText = Math.round(tNet).toLocaleString();
    document.getElementById('dashOrders').innerText = tOrders;
    document.getElementById('dashRealHourly').innerText = tHr>0?Math.round(tNet/tHr):0;
    const h = Math.floor(tHr);
    document.getElementById('dashHours').innerText = h;
    document.getElementById('dashMinutes').innerText = Math.round((tHr-h)*60);
    
    if(!document.getElementById('chartsPanel').classList.contains('hidden')) updateChart(); 
}

// === åœ–è¡¨åŠŸèƒ½ ===
function toggleCharts() {
    const p = document.getElementById('chartsPanel');
    p.classList.toggle('hidden');
    if(!p.classList.contains('hidden')) {
        p.scrollIntoView({behavior:'smooth'});
        updateChart();
    }
}

function switchChartType(type) {
    chartType = type;
    document.getElementById('btnChartBar').classList.toggle('active', type==='bar');
    document.getElementById('btnChartPie').classList.toggle('active', type==='pie');
    updateChart();
}

function updateChart() {
    const start = document.getElementById('chartStart').value;
    const end = document.getElementById('chartEnd').value;
    const groupBy = document.getElementById('chartGroupBy').value;
    const allList = getHistory();
    const filtered = allList.filter(r => r.date >= start && r.date <= end);
    
    const groups = {};
    let totalIncome = 0, totalNet = 0, totalCost = 0;

    filtered.forEach(r => {
        let key;
        if(groupBy === 'year') key = r.date.slice(0, 4);
        else if(groupBy === 'month') key = r.date.slice(0, 7);
        else key = r.date; 

        if(!groups[key]) groups[key] = { inc:0, net:0 };
        const p = r.oilPrice!==undefined?r.oilPrice:globalOilPrice;
        const cost = (r.km/(r.fuelRate||12))*p + (r.km*(r.maintCost||1.5));
        const net = r.income - cost;
        groups[key].inc += r.income;
        groups[key].net += net;
        totalIncome += r.income;
        totalNet += net;
        totalCost += cost;
    });

    const keys = Object.keys(groups).sort();
    const dataInc = keys.map(k => groups[k].inc);
    const dataNet = keys.map(k => groups[k].net);

    const ctx = document.getElementById('mainChart').getContext('2d');
    if (chartInstance) chartInstance.destroy();

    if (chartType === 'bar') {
        chartInstance = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: keys,
                datasets: [
                    { label: 'ç‡Ÿæ”¶', data: dataInc, backgroundColor: '#fbbf24', borderRadius: 4 }, 
                    { label: 'æ·¨åˆ©', data: dataNet, backgroundColor: '#10b981', borderRadius: 4 } 
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { labels: { color: '#9ca3af' } } },
                scales: {
                    x: { ticks: { color: '#6b7280' }, grid: { color: '#333' } },
                    y: { ticks: { color: '#6b7280' }, grid: { color: '#333' } }
                }
            }
        });
    } else {
        chartInstance = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: ['å¯¦éš›æ·¨åˆ©', 'ç¸½æˆæœ¬'],
                datasets: [{
                    data: [Math.round(totalNet), Math.round(totalCost)],
                    backgroundColor: ['#10b981', '#ef4444'],
                    borderWidth: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { 
                    legend: { position: 'right', labels: { color: '#fff' } },
                    title: { display: true, text: `å€é–“ç¸½ç‡Ÿæ”¶: $${Math.round(totalIncome).toLocaleString()}`, color:'#fff' }
                }
            }
        });
    }
}
</script>
</body>
</html>
