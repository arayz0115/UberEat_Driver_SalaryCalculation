<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
<title>UberEat å¤–é€è–ªè³‡è¨ˆç®—å™¨ V1.2.7 - é›²ç«¯åŒæ­¥</title>

<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#050505">
<link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/732/732200.png">

<meta property="og:title" content="UberEat å¤–é€è–ªè³‡è¨ˆç®—å™¨ V1.2.7" />
<meta property="og:description" content="å°ˆç‚º UberEat å¤–é€å“¡æ‰“é€ ï¼Œç²¾æº–è¨ˆç®—æ¯ä¸€è¶Ÿçš„è–ªè³‡ã€æ²¹è€—èˆ‡è€—ææ·¨åˆ©ï¼Œæ”¯æ´é›²ç«¯åŒæ­¥èˆ‡æ¯å–®å¹³å‡æ”¶ç›Šåˆ†æï¼Œå„ªåŒ–è·‘å–®æ•ˆç‡ã€‚" />
<meta property="og:type" content="website" />
<meta property="og:image" content="https://placehold.co/1200x630/059669/ffffff?text=UberEat+V1.2.7" />

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

<style>
    /* === å…¨å±€è¨­å®š === */
    body { 
        background-color: #050505; 
        color: #e5e5e5; 
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; 
        padding-bottom: 120px; /* åº•éƒ¨ç•™ç©ºé–“çµ¦ç‰ˆæ¬Š */
        padding-top: env(safe-area-inset-top); /* é¿é–‹ç€æµ· */
    }
    
    /* === å¡ç‰‡æ¨£å¼ === */
    .card {
        background-color: #111216;
        border: 1px solid #2a2d36;
        border-radius: 1rem;
        padding: 1rem;
        margin-bottom: 0.8rem;
        position: relative;
    }
    .card-glow { border-color: #10b981; box-shadow: 0 0 10px rgba(16, 185, 129, 0.1); } /* æ”¹ç‚º UberEat ç¶ è‰²ç³» */

    /* === è¼¸å…¥æ¡† === */
    .input-field {
        background-color: #1a1c23;
        border: 1px solid #333;
        color: #fff;
        border-radius: 0.6rem;
        padding: 0.7rem;
        width: 100%;
        font-size: 1rem;
        transition: 0.2s;
    }
    .input-field:focus { outline: none; border-color: #10b981; background-color: #202229; }

    /* === æ—¥æœŸé¸æ“‡å™¨ (å„ªåŒ–æ‰‹æ©Ÿé¡¯ç¤ºï¼Œç¢ºä¿æ—¥æœŸä¸è¢«è£åˆ‡) === */
    input[type="date"] { position: relative; font-size: 0.95rem; }
    input[type="date"]::-webkit-calendar-picker-indicator {
        position: absolute; top: 0; left: 0; right: 0; bottom: 0; width: 100%; height: 100%;
        color: transparent; background: transparent; cursor: pointer;
    }

    /* === æŒ‰éˆ• === */
    .btn { width: 100%; padding: 0.8rem; border-radius: 0.6rem; font-weight: 600; display: flex; justify-content: center; align-items: center; transition: 0.2s; }
    .btn-primary { background-color: #059669; color: white; } /* UberEat ç¶  */
    .btn-primary:active { background-color: #047857; transform: scale(0.98); }
    .btn-danger { background-color: #7f1d1d; color: #fca5a5; border: 1px solid #991b1b; }
    .btn-ghost { background-color: transparent; border: 1px solid #333; color: #9ca3af; }
    
    .chart-toggle-btn { background: #2a2d36; color: #9ca3af; border: 1px solid #333; }
    .chart-toggle-btn.active { background: #059669; color: white; border-color: #059669; }

    /* === ç¯©é¸ Tab (ä¿®æ­£æ»‘å‹•å•é¡Œ) === */
    .tab-scroll-container {
        width: 100%;
        overflow-x: auto;
        padding-bottom: 0.5rem;
        scrollbar-width: none; 
        -ms-overflow-style: none;
    }
    .tab-scroll-container::-webkit-scrollbar { display: none; }

    .tab-scroll-content {
        display: flex;
        gap: 0.6rem;
        padding-right: 1.5rem; 
        min-width: max-content; 
    }

    .tab-btn {
        padding: 0.5rem 1rem; border-radius: 2rem; font-size: 0.9rem; color: #9ca3af; background: #1a1c23; border: 1px solid #333; white-space: nowrap;
    }
    .tab-btn.active { background-color: #d1fae5; color: #065f46; font-weight: bold; border-color: #fff; }

    /* === æ­·å²åˆ—è¡¨ V1.2.6 æ¨£å¼ (å°é½Šå„ªåŒ–) === */
    .history-item {
        background-color: #111216; 
        border-bottom: 1px solid #222; 
        padding: 1.25rem 1rem; 
        cursor: pointer; 
        transition: background 0.2s;
        display: flex;
        flex-direction: column; 
    }
    .history-item:active { background-color: #1c1e24; }
    
    .history-top-row {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        width: 100%;
        margin-bottom: 0.5rem; 
    }
    
    .history-stat-group {
        display: flex;
        flex-direction: column;
        /* V1.2.6: æ‰€æœ‰æ¬„ä½é è¨­é å·¦å°é½Š */
        align-items: flex-start;
        text-align: left;
    }
    .history-stat-group.center {
        /* V1.2.6: æˆæœ¬ç½®ä¸­ */
        align-items: center;
        text-align: center;
    }
    .history-stat-group.right {
        /* V1.2.6: æ·¨åˆ©é å³ */
        align-items: flex-end;
        text-align: right;
    }

    /* ç¢ºä¿é—œéµæ•¸å­—é ‚éƒ¨å°é½Š */
    .history-main-value {
        font-size: 1.5rem; 
        font-weight: bold;
        line-height: 1.1;
        margin-top: 2px;
    }
    .stat-label-small {
        font-size: 0.7rem; 
        color: #6b7280; 
        margin-top: 2px;
        line-height: 1.2;
    }
    /* === FIX: ç§»é™¤ history-sub-stats çš„ flex å±¬æ€§ï¼Œè®“å…¶å­å…ƒç´  (å…©å€‹ w-full çš„ div) å‚ç›´å †ç–Šï¼Œä¿®æ­£æ’ç‰ˆç‚¸é–‹çš„å•é¡Œã€‚ === */
    .history-sub-stats {
        width: 100%;
        /* display: flex; ç§»é™¤ */
        /* justify-content: space-between; ç§»é™¤ */
        padding-top: 0.75rem;
        border-top: 1px solid #222;
        font-size: 0.8rem;
        color: #9ca3af;
    }


    /* === å­—é«”èˆ‡æ¨™ç±¤ === */
    .stat-label { font-size: 0.75rem; color: #6b7280; text-transform: uppercase; letter-spacing: 0.05em; }
    .text-amber-soft { color: #fcd34d; }
    
    /* === ç‰ˆæ¬Š Footer === */
    .footer-credit {
        text-align: center;
        margin-top: 2rem;
        padding-top: 1rem;
        border-top: 1px solid #222;
        color: #525252;
        font-size: 0.75rem;
        letter-spacing: 1px;
    }
</style>
</head>
<body class="max-w-md mx-auto p-3">

    <div class="flex justify-between items-center mb-4 px-1 pt-2">
        <div class="flex items-center gap-2">
            <div class="w-1.5 h-6 bg-green-500 rounded-full"></div>
            <div>
                <h1 class="text-lg font-bold text-white leading-tight">UberEat å¤–é€è–ªè³‡è¨ˆç®—å™¨</h1>
                <div class="text-[10px] text-gray-500">V1.2.7 Cloud Sync for Cross-Platform</div>
            </div>
        </div>
        <button onclick="toggleSettings()" class="p-2 bg-[#1a1c23] rounded-full text-gray-400 border border-[#333] text-xs active:bg-gray-800">
            âš™ï¸ è¨­å®š
        </button>
    </div>
    
    <div class="card mb-4 border-blue-500/30">
        <div class="flex justify-between items-center mb-3">
            <h3 class="font-bold text-white text-sm">â˜ï¸ é›²ç«¯åŒæ­¥è¨­å®š (EMAIL/å¯†ç¢¼)</h3>
        </div>
        <div class="space-y-3 mb-4">
            <input id="inputEmail" type="email" class="input-field" placeholder="è«‹è¼¸å…¥ Email" />
            <input id="inputPassword" type="password" class="input-field" placeholder="è«‹è¼¸å…¥å¯†ç¢¼ (è‡³å°‘6ä½æ•¸)" />
            <div class="grid grid-cols-2 gap-3">
                <button onclick="registerUser()" class="btn btn-primary bg-blue-600 hover:bg-blue-700" id="btnRegister">è¨»å†Šæ–°å¸³è™Ÿ</button>
                <button onclick="loginUser()" class="btn btn-primary bg-gray-600 hover:bg-gray-700" id="btnLogin">ç™»å…¥ç¾æœ‰å¸³è™Ÿ</button>
            </div>
            <button onclick="logoutUser()" class="btn btn-danger hidden" id="btnLogout">ç™»å‡º</button>
        </div>
        <div id="authStateDisplay" class="text-sm pt-2 border-t border-gray-800">
            <span class="text-gray-500">ç•¶å‰ç‹€æ…‹: </span>
            <span id="authStatusText" class="text-yellow-400">æœªç™»å…¥ (è«‹å…ˆè¨»å†Šæˆ–ç™»å…¥)</span>
        </div>
    </div>

    <div id="settingsPanel" class="hidden mb-4 card border-green-900/50">
        <h3 class="text-green-500 font-bold mb-3 text-sm uppercase">å…¨åŸŸåƒæ•¸</h3>
        <div class="grid grid-cols-2 gap-3 mb-3">
            <div>
                <label class="stat-label mb-1">æ²¹å“</label>
                <select id="oilType" class="input-field" onchange="fetchOilPrice()">
                    <option value="92">92 ç„¡é‰›</option>
                    <option value="95">95 ç„¡é‰›</option>
                    <option value="98">98 ç„¡é‰›</option>
                    <option value="diesel">æŸ´æ²¹</option>
                </select>
            </div>
            <div>
                <label class="stat-label mb-1">ç›®å‰æ²¹åƒ¹</label>
                <div id="oilPriceDisplay" class="input-field text-yellow-500 font-bold">è®€å–ä¸­...</div>
            </div>
        </div>
        <div class="grid grid-cols-2 gap-3 mb-3">
            <div>
                <label class="stat-label mb-1">æ²¹è€— (km/L)</label>
                <input id="settingFuelRate" type="number" class="input-field" />
            </div>
            <div>
                <label class="stat-label mb-1">è€—æ ($/km)</label>
                <input id="settingMaint" type="number" step="0.1" class="input-field" />
            </div>
        </div>
        <button onclick="saveSettings()" class="btn btn-primary text-sm">å„²å­˜è¨­å®š</button>
    </div>

    <div class="card bg-gradient-to-br from-[#111216] to-[#064e3b20] border-green-500/30 p-5 mb-4">
        
        <div class="grid grid-cols-3 gap-2">

            <div class="flex flex-col items-start pb-4">
                <label class="stat-label text-gray-400">å€é–“ç¸½ç‡Ÿæ”¶</label>
                <div class="text-3xl font-bold text-amber-soft mt-1 tracking-tight">$<span id="dashTotalIncome">0</span></div>
            </div>
            <div class="flex flex-col items-start pb-4"> 
                <label class="stat-label text-red-400">ç¸½æˆæœ¬</label>
                <div class="text-3xl font-bold text-red-400 mt-1 tracking-tight">$<span id="dashTotalCost">0</span></div> 
            </div>
            <div class="flex flex-col items-start pb-4">
                <label class="stat-label text-green-400">ç¸½æ·¨åˆ©</label>
                <div class="text-3xl font-bold text-green-400 mt-1 tracking-tight">$<span id="dashNetProfit">0</span></div>
            </div>


            <div class="col-span-3 border-t border-white/10 pt-4"></div>

            <div class="flex flex-col items-start pt-2">
                <label class="stat-label text-red-400">æ²¹è€—æˆæœ¬</label>
                <div class="text-lg font-bold text-red-400 mt-1">$<span id="dashOilCost">0</span></div>
            </div>
            <div class="flex flex-col items-start pt-2">
                <label class="stat-label text-red-400">è€—ææˆæœ¬</label>
                <div class="text-lg font-bold text-red-400 mt-1">$<span id="dashMaintCost">0</span></div>
            </div>
            <div class="flex flex-col items-start pt-2">
                <label class="stat-label text-gray-400">ç¸½å–®æ•¸ / ç¸½å·¥æ™‚</label>
                <div class="text-lg font-bold text-white mt-1">
                    <span id="dashOrders">0</span>å–® | 
                    <span id="dashHours">0</span><span class="text-xs text-gray-500">h</span> <span id="dashMinutes">0</span><span class="text-xs text-gray-500">m</span>
                </div>
            </div>
            
            
            <div class="col-span-3 border-t border-white/10 pt-4 grid grid-cols-2 gap-4">
                <div class="flex flex-col items-start">
                    <label class="stat-label text-amber-soft">æœªæ‰£æˆæœ¬å¯¦è–ª</label>
                    <div class="text-2xl font-bold text-amber-soft mt-1 tracking-tight">$<span id="dashGrossHourly">0</span></div>
                </div>
                <div class="flex flex-col items-start">
                    <label class="stat-label text-green-400">å·²æ‰£æˆæœ¬å¯¦è–ª</label>
                    <div class="text-2xl font-bold text-green-400 mt-1 tracking-tight">$<span id="dashNetHourly">0</span></div>
                </div>
            </div>

            <div class="col-span-3 border-t border-white/10 pt-4 grid grid-cols-2 gap-4">
                <div class="flex flex-col items-start">
                    <label class="stat-label text-amber-soft">æ¯å–®å¹³å‡ç‡Ÿæ”¶</label>
                    <div class="text-xl font-bold text-amber-soft mt-1 tracking-tight">$<span id="dashGrossPerOrder">0</span></div>
                </div>
                <div class="flex flex-col items-start">
                    <label class="stat-label text-green-400">æ¯å–®å¹³å‡æ·¨åˆ©</label>
                    <div class="text-xl font-bold text-green-400 mt-1 tracking-tight">$<span id="dashNetPerOrder">0</span></div>
                </div>
            </div>


        </div>
    </div>
    
    <div class="card card-glow mb-4" id="editorCard">
        <div class="flex justify-between items-center mb-3 pb-2 border-b border-gray-800">
            <h3 class="font-bold text-white flex items-center gap-2 text-sm">
                <span id="editorTitle">ğŸ“ æ–°å¢ç´€éŒ„</span>
            </h3>
            <span id="editorOilHint" class="text-xs text-gray-500 hidden">é–å®šæ²¹åƒ¹: --</span>
        </div>
        <input type="hidden" id="editId" value="">
        <input type="hidden" id="recordOilPrice" value=""> 

        <div class="flex flex-col gap-3 mb-4">
            <div>
                <label class="stat-label mb-1">æ—¥æœŸ</label>
                <input id="inputDate" type="date" class="input-field cursor-pointer text-sm" onclick="this.showPicker()" />
            </div>
            <div class="grid grid-cols-2 gap-3">
                <div>
                    <label class="stat-label mb-1">ç‡Ÿæ¥­é¡</label>
                    <input id="inputIncome" type="number" inputmode="numeric" class="input-field text-amber-soft font-bold text-lg" placeholder="$0" />
                </div>
                <div>
                    <label class="stat-label mb-1">å–®æ•¸</label>
                    <input id="inputOrders" type="number" inputmode="numeric" class="input-field" placeholder="0" />
                </div>
            </div>
        </div>

        <div class="grid grid-cols-2 gap-3 mb-4">
            <div>
                <label class="stat-label mb-1">é‡Œç¨‹</label>
                <input id="inputDist" type="number" step="0.1" inputmode="decimal" class="input-field" placeholder="KM" />
            </div>
            <div>
                <label class="stat-label mb-1">å·¥æ™‚</label>
                <div class="flex gap-1">
                    <input id="inputHr" type="number" class="input-field text-center px-1" placeholder="æ™‚" />
                    <input id="inputMin" type="number" class="input-field text-center px-1" placeholder="åˆ†" />
                </div>
            </div>
        </div>

        <div class="flex gap-2">
            <button onclick="saveRecord()" class="btn btn-primary" id="btnSave">å„²å­˜</button>
            <button onclick="deleteCurrentRecord()" class="btn btn-danger hidden" id="btnDelete">åˆªé™¤</button>
            <button onclick="resetEditor()" class="btn btn-ghost hidden" id="btnCancel">å–æ¶ˆ</button>
        </div>
    </div>

    <div class="tab-scroll-container mb-3">
        <div class="tab-scroll-content">
            <button class="tab-btn active" onclick="setFilter('day', this)">ä»Šæ—¥</button>
            <button class="tab-btn" onclick="setFilter('week', this)">æœ¬é€±</button>
            <button class="tab-btn" onclick="setFilter('month', this)">æœ¬æœˆ</button>
            <button class="tab-btn" onclick="setFilter('year', this)">æœ¬å¹´</button>
            <button class="tab-btn" onclick="setFilter('all', this)">å…¨éƒ¨</button>
            <button class="tab-btn" onclick="setFilter('custom', this)">è‡ªå®šç¾©</button> 
            <button class="tab-btn border-green-500 text-green-400" onclick="toggleCharts()">ğŸ“ˆ é€²éšåœ–è¡¨åˆ†æ</button>
        </div>
    </div>
    
    <div id="customDateFilter" class="card p-3 mb-4 hidden border-blue-500/30">
        <h3 class="text-xs font-bold text-blue-400 mb-2 uppercase">è‡ªå®šç¾©å€é–“ç¯©é¸</h3>
        <div class="flex gap-2 items-center">
            <input type="date" id="filterStart" class="input-field text-sm py-1" onchange="applyCustomFilter()" />
            <span class="text-gray-500">è‡³</span>
            <input type="date" id="filterEnd" class="input-field text-sm py-1" onchange="applyCustomFilter()" />
        </div>
    </div>

    <div id="chartsPanel" class="hidden card mb-4 border border-green-500/30">
        <div class="flex justify-between items-center mb-3">
            <h4 class="text-sm font-bold text-white">ğŸ“Š æ•¸æ“šåˆ†æä¸­å¿ƒ</h4>
            <div class="flex bg-[#1a1c23] rounded-lg p-1">
                <button onclick="switchChartType('bar')" id="btnChartBar" class="chart-toggle-btn active px-3 py-1 rounded text-xs">è¶¨å‹¢åœ–</button>
                <button onclick="switchChartType('pie')" id="btnChartPie" class="chart-toggle-btn px-3 py-1 rounded text-xs">åœ“é¤…åœ–</button>
            </div>
        </div>

        <div class="bg-[#1a1c23] p-2 rounded-lg mb-3">
            <div class="flex gap-2 mb-2">
                <input type="date" id="chartStart" class="input-field text-xs py-1" onchange="updateChart()" />
                <span class="text-gray-500 self-center">~</span>
                <input type="date" id="chartEnd" class="input-field text-xs py-1" onchange="updateChart()" />
            </div>
            <div class="flex items-center gap-2">
                <label class="text-xs text-gray-500">åˆ†çµ„:</label>
                <select id="chartGroupBy" class="input-field text-xs py-1" onchange="updateChart()">
                    <option value="day">ä¾æ—¥æœŸ (æ—¥)</option>
                    <option value="month">ä¾æœˆä»½ (æœˆ)</option>
                    <option value="year">ä¾å¹´ä»½ (å¹´)</option>
                </select>
            </div>
        </div>

        <div style="position: relative; height: 300px; width: 100%;">
            <canvas id="mainChart"></canvas>
        </div>
    </div>

    <div class="mb-8">
        <h3 class="text-xs font-bold text-gray-500 mb-2 uppercase pl-1">å€é–“æ˜ç´°</h3>
        <div id="historyList" class="rounded-xl overflow-hidden border border-[#2a2d36]"></div>
    </div>

    <div class="footer-credit">
        <div>UberEat å¤–é€è–ªè³‡è¨ˆç®—å™¨ V1.2.7</div>
        <div class="mt-1">Developed by Ray Â© 2025</div>
        <div class="mt-1 text-xs text-gray-600">All Rights Reserved.</div>
    </div>

<script>
// ==========================================================
// === Firebase è¨­å®š (è«‹æ›¿æ›ç‚ºæ‚¨çš„é‡‘é‘°ï¼) ===
// ==========================================================
const firebaseConfig = {
    apiKey: "YOUR_API_KEY",
    authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
    projectId: "YOUR_PROJECT_ID",
    storageBucket: "YOUR_PROJECT_ID.appspot.com",
    messagingSenderId: "YOUR_SENDER_ID",
    appId: "YOUR_APP_ID"
};

// ==========================================================
// === è®Šæ•¸èˆ‡åˆå§‹åŒ– (æ•´åˆ Firebase) ===
// ==========================================================
const workerAPI = "https://ubereat-oil-proxy.leo3026772.workers.dev/";
let globalOilPrice = 30.0;
let currentFilter = 'day';
let chartInstance = null;
let chartType = 'bar'; 

let firebaseApp;
let auth;
let db;
let currentUser = null; // è¿½è¹¤ç•¶å‰ç™»å…¥ç”¨æˆ¶

function setupFirebase() {
    try {
        if (!firebase.apps.length) {
            firebaseApp = firebase.initializeApp(firebaseConfig);
        } else {
            firebaseApp = firebase.app();
        }
        auth = firebase.auth();
        db = firebase.firestore();
        console.log("Firebase æœå‹™å·²åˆå§‹åŒ–ã€‚");
    } catch (error) {
        console.error("Firebase åˆå§‹åŒ–å¤±æ•—ï¼š", error);
        alert("éŒ¯èª¤ï¼šFirebase åˆå§‹åŒ–å¤±æ•—ï¼Œè«‹æª¢æŸ¥æ‚¨çš„ firebaseConfig æ˜¯å¦æ­£ç¢ºã€‚");
    }
}

// === ç‹€æ…‹ç›£è½èˆ‡ UI æ›´æ–° ===
function updateAuthState(user) {
    currentUser = user;
    const authStatusText = document.getElementById('authStatusText');
    const btnLogout = document.getElementById('btnLogout');
    const authInputs = [document.getElementById('inputEmail'), document.getElementById('inputPassword')];
    const authBtns = [document.getElementById('btnRegister'), document.getElementById('btnLogin')];

    if (user) {
        authStatusText.innerHTML = `å·²ç™»å…¥ (Email: ${user.email} | UID: ${user.uid.slice(0, 8)}...)`;
        authStatusText.classList.remove('text-yellow-400', 'text-red-400');
        authStatusText.classList.add('text-green-400');
        btnLogout.classList.remove('hidden');
        authBtns.forEach(btn => btn.classList.add('hidden'));
        authInputs.forEach(input => input.setAttribute('disabled', 'true'));
        // ç™»å…¥å¾Œï¼Œå¾é›²ç«¯è¼‰å…¥è³‡æ–™
        fetchHistoryFromFirebase();
    } else {
        authStatusText.innerText = "æœªç™»å…¥ (è«‹å…ˆè¨»å†Šæˆ–ç™»å…¥)";
        authStatusText.classList.remove('text-green-400', 'text-red-400');
        authStatusText.classList.add('text-yellow-400');
        btnLogout.classList.add('hidden');
        authBtns.forEach(btn => btn.classList.remove('hidden'));
        authInputs.forEach(input => input.removeAttribute('disabled'));
        // ç™»å‡ºå¾Œï¼Œæ¸…ç©ºé¡¯ç¤ºçš„è³‡æ–™ï¼Œä¸¦å˜—è©¦è¼‰å…¥æœ¬åœ°è³‡æ–™ (ä½œç‚ºæœ¬æ©Ÿæ­·å²ç´€éŒ„)
        refreshDashboard(true); 
    }
}

// === èº«ä»½é©—è­‰å‡½å¼ (Authentication) ===
function getAuthCredentials() {
    const email = document.getElementById('inputEmail').value.trim();
    const password = document.getElementById('inputPassword').value.trim();
    if (!email || password.length < 6) {
        alert("è«‹è¼¸å…¥æœ‰æ•ˆçš„ Emailï¼Œä¸”å¯†ç¢¼è‡³å°‘éœ€ç‚º 6 ä½æ•¸ã€‚");
        return null;
    }
    return { email, password };
}

async function registerUser() {
    const credentials = getAuthCredentials();
    if (!credentials) return;
    try {
        await auth.createUserWithEmailAndPassword(credentials.email, credentials.password);
        alert("è¨»å†ŠæˆåŠŸï¼å·²è‡ªå‹•ç™»å…¥ã€‚");
    } catch (error) {
        let msg = "è¨»å†Šå¤±æ•—ï¼š";
        if (error.code === 'auth/email-already-in-use') msg += "æ­¤ Email å·²è¢«è¨»å†Šã€‚è«‹ç›´æ¥ç™»å…¥æˆ–ä½¿ç”¨å…¶ä»– Emailã€‚";
        else if (error.code === 'auth/weak-password') msg += "å¯†ç¢¼å¼·åº¦ä¸è¶³ï¼Œè«‹ä½¿ç”¨æ›´è¤‡é›œçš„å¯†ç¢¼ã€‚";
        else msg += error.message;
        alert(msg);
    }
}

async function loginUser() {
    const credentials = getAuthCredentials();
    if (!credentials) return;
    try {
        await auth.signInWithEmailAndPassword(credentials.email, credentials.password);
        alert("ç™»å…¥æˆåŠŸï¼æ­£åœ¨è¼‰å…¥æ‚¨çš„ç´€éŒ„ã€‚");
    } catch (error) {
        let msg = "ç™»å…¥å¤±æ•—ï¼š";
        if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password') msg += "Email æˆ–å¯†ç¢¼éŒ¯èª¤ã€‚";
        else msg += error.message;
        alert(msg);
    }
}

function logoutUser() {
    if (confirm("ç¢ºå®šè¦ç™»å‡ºå—ï¼Ÿ")) {
        auth.signOut().then(() => {
            alert("å·²ç™»å‡ºã€‚");
            // ç™»å‡ºå¾Œï¼ŒupdateAuthState æœƒè¢«è§¸ç™¼
        }).catch((error) => {
            alert("ç™»å‡ºå¤±æ•—ï¼š" + error.message);
        });
    }
}

// === Firestore è³‡æ–™è™•ç† ===

// æ›¿æ›åŸä¾†çš„ getHistory()
async function fetchHistoryFromFirebase() {
    if (!currentUser) return; // æœªç™»å…¥å‰‡ä¸åŸ·è¡Œ
    
    // 1. å…ˆå˜—è©¦å¾æœ¬åœ°è¼‰å…¥èˆŠè³‡æ–™ (å¦‚æœæœ‰çš„è©±)
    let history = getHistoryLocal(); 

    // 2. å¾ Firestore è¼‰å…¥è³‡æ–™
    try {
        const docRef = db.collection('uberRecords').doc(currentUser.uid);
        const doc = await docRef.get();
        
        if (doc.exists) {
            const cloudRecords = doc.data().records || [];
            
            // 3. è™•ç†æœ¬åœ°è³‡æ–™ï¼šå¦‚æœæœ¬åœ°æœ‰è³‡æ–™ï¼Œä½†é›²ç«¯æ²’æœ‰ï¼Œå‰‡å°‡æœ¬åœ°è³‡æ–™ä¸Šå‚³
            if (cloudRecords.length === 0 && history.length > 0) {
                console.log("é›²ç«¯ç„¡è³‡æ–™ï¼Œæ­£åœ¨ä¸Šå‚³æœ¬åœ°ç´€éŒ„...");
                // ç›´æ¥å„²å­˜æœ¬åœ°ç´€éŒ„åˆ°é›²ç«¯
                await saveToFirebase(history);
                // ä¸Šå‚³å®Œæˆå¾Œï¼Œæ¸…é™¤æœ¬åœ°ç´€éŒ„
                localStorage.removeItem('uber_ray_v1');
                history = history; // ä½¿ç”¨å‰›å‰›ä¸Šå‚³çš„è³‡æ–™
            } else {
                // 4. ä½¿ç”¨é›²ç«¯è³‡æ–™
                history = cloudRecords;
            }
        } else if (history.length > 0) {
             // é›²ç«¯ç„¡æ­¤ç”¨æˆ¶æ–‡ä»¶ï¼Œä½†æœ¬åœ°æœ‰è³‡æ–™ï¼Œå‰‡ä¸Šå‚³
            console.log("é›²ç«¯ç„¡ç”¨æˆ¶æ–‡ä»¶ï¼Œæ­£åœ¨ä¸Šå‚³æœ¬åœ°ç´€éŒ„...");
            await saveToFirebase(history);
            localStorage.removeItem('uber_ray_v1');
        } else {
            // é›²ç«¯å’Œæœ¬åœ°éƒ½æ²’è³‡æ–™
            history = [];
        }
        
        // 5. å°‡æ’åºå¾Œçš„æ­·å²ç´€éŒ„å„²å­˜åˆ°ä¸€å€‹å…¨åŸŸè®Šæ•¸æˆ–ç›´æ¥ä½¿ç”¨
        allHistory = history.sort((a,b) => new Date(b.date)-new Date(a.date));
        refreshDashboard();
        
    } catch (error) {
        console.error("å¾ Firebase è¼‰å…¥ç´€éŒ„å¤±æ•—ï¼š", error);
        alert("éŒ¯èª¤ï¼šç„¡æ³•å¾é›²ç«¯è¼‰å…¥ç´€éŒ„ã€‚è«‹æª¢æŸ¥ç¶²è·¯é€£ç·šæˆ– Firebase è¦å‰‡ã€‚");
        // å¦‚æœé›²ç«¯è¼‰å…¥å¤±æ•—ï¼Œä»ç„¶å˜—è©¦ä½¿ç”¨æœ¬åœ°è³‡æ–™
        allHistory = history.sort((a,b) => new Date(b.date)-new Date(a.date));
        refreshDashboard();
    }
}

// æ›¿æ›åŸä¾†çš„ saveToHistory()
async function saveToFirebase(records) {
    if (!currentUser) {
        // æœªç™»å…¥æ™‚ï¼Œå„²å­˜åˆ°æœ¬åœ°
        saveToHistoryLocal(records);
        return;
    }

    try {
        const docRef = db.collection('uberRecords').doc(currentUser.uid);
        await docRef.set({ records: records.map(r => ({...r, id: r.id.toString()})) }, { merge: false });
        // æˆåŠŸå„²å­˜å¾Œï¼Œæ›´æ–°å…¨åŸŸæ­·å²ç´€éŒ„
        allHistory = records.sort((a,b) => new Date(b.date)-new Date(a.date));
        refreshDashboard();
        console.log("ç´€éŒ„å·²åŒæ­¥è‡³é›²ç«¯ã€‚");
    } catch (error) {
        console.error("åŒæ­¥ç´€éŒ„åˆ° Firebase å¤±æ•—ï¼š", error);
        alert("éŒ¯èª¤ï¼šç´€éŒ„ç„¡æ³•åŒæ­¥åˆ°é›²ç«¯ã€‚è«‹æª¢æŸ¥ç¶²è·¯é€£ç·šã€‚");
        // å¦‚æœé›²ç«¯å„²å­˜å¤±æ•—ï¼Œä»å„²å­˜åˆ°æœ¬åœ°
        saveToHistoryLocal(records);
        allHistory = records.sort((a,b) => new Date(b.date)-new Date(a.date));
        refreshDashboard();
    }
}

// ç‚ºäº†è™•ç†æœ¬åœ°è³‡æ–™åˆ°é›²ç«¯è³‡æ–™çš„éæ¸¡ï¼Œä¿ç•™æœ¬åœ°å„²å­˜çš„è¼”åŠ©å‡½æ•¸
function getHistoryLocal() { try { return JSON.parse(localStorage.getItem('uber_ray_v1') || '[]'); } catch { return []; } }
function saveToHistoryLocal(data) { localStorage.setItem('uber_ray_v1', JSON.stringify(data)); }

let allHistory = []; // å…¨åŸŸæ­·å²ç´€éŒ„è®Šæ•¸

// === ç¨‹å¼å•Ÿå‹•é» ===
window.onload = async () => {
    // 1. åˆå§‹åŒ– Firebase
    setupFirebase();
    
    // 2. ç›£è½èº«ä»½é©—è­‰ç‹€æ…‹è®ŠåŒ–
    auth.onAuthStateChanged(user => {
        updateAuthState(user);
    });

    // 3. è¼‰å…¥è¨­å®šå’Œæ²¹åƒ¹
    loadSettings();
    await fetchOilPrice();

    // 4. åˆå§‹åŒ–ç·¨è¼¯å™¨å’Œç¯©é¸å™¨
    resetEditor();
    const today = getLocalDateString();
    
    document.getElementById('filterStart').value = today;
    document.getElementById('filterEnd').value = today;

    const now = new Date();
    document.getElementById('chartStart').value = new Date(now.getFullYear(), 0, 1).toISOString().slice(0,10);
    document.getElementById('chartEnd').value = today;

    // ç¬¬ä¸€æ¬¡å•Ÿå‹•æ™‚ï¼Œå¦‚æœæœªç™»å…¥ï¼Œå…ˆè¼‰å…¥æœ¬åœ°è³‡æ–™ä¸¦é¡¯ç¤º
    if (!currentUser) {
        allHistory = getHistoryLocal().sort((a,b) => new Date(b.date)-new Date(a.date));
        refreshDashboard();
    }
};


function getLocalDateString() {
    const offset = new Date().getTimezoneOffset() * 60000;
    return new Date(Date.now() - offset).toISOString().split('T')[0];
}

// === è¨­å®šè™•ç† (ä¿æŒæœ¬åœ°å„²å­˜) ===
function loadSettings() {
    document.getElementById('settingFuelRate').value = localStorage.getItem('fuelRate') || 12;
    document.getElementById('settingMaint').value = localStorage.getItem('maintCost') || 1.5;
    document.getElementById('oilType').value = localStorage.getItem('oilType') || '95';
}
function saveSettings() {
    localStorage.setItem('fuelRate', document.getElementById('settingFuelRate').value);
    localStorage.setItem('maintCost', document.getElementById('settingMaint').value);
    localStorage.setItem('oilType', document.getElementById('oilType').value);
    document.getElementById('settingsPanel').classList.add('hidden');
    refreshDashboard();
}
function toggleSettings() { document.getElementById('settingsPanel').classList.toggle('hidden'); }

// === æ²¹åƒ¹ç²å– (ä½¿ç”¨ä»£ç† API) ===
async function fetchOilPrice() {
    try {
        const type = document.getElementById('oilType').value;
        // ä½¿ç”¨ try-catch ç¢ºä¿å³ä½¿ API å¤±æ•—ä¹Ÿèƒ½ä½¿ç”¨é è¨­å€¼
        const res = await fetch(workerAPI);
        const data = await res.json();
        if(data[type]) {
            globalOilPrice = parseFloat(data[type]);
            document.getElementById('oilPriceDisplay').innerText = `$${globalOilPrice}`;
        } else {
            document.getElementById('oilPriceDisplay').innerText = `$${globalOilPrice} (é è¨­/APIéŒ¯èª¤)`;
        }
    } catch(e) { 
        document.getElementById('oilPriceDisplay').innerText = `$${globalOilPrice} (é è¨­/ç¶²è·¯éŒ¯èª¤)`;
    }
}

// === æ­·å²è³‡æ–™ CRUD (æ›´æ–°ç‚ºä½¿ç”¨ allHistory ä¸¦å‘¼å« saveToFirebase) ===

// getHistory() ç¾åœ¨ç›´æ¥è¿”å›å…¨åŸŸè®Šæ•¸ allHistory
function getHistory() { return allHistory; }

// saveRecord é‚è¼¯æ›´æ–°
function saveRecord() {
    const date = document.getElementById('inputDate').value;
    const income = parseFloat(document.getElementById('inputIncome').value);
    const orders = parseFloat(document.getElementById('inputOrders').value);
    const km = parseFloat(document.getElementById('inputDist').value);
    const hr = parseFloat(document.getElementById('inputHr').value) || 0;
    const min = parseFloat(document.getElementById('inputMin').value) || 0;
    const editId = document.getElementById('editId').value;
    const lockedOil = document.getElementById('recordOilPrice').value;

    if(!date) return console.error('è«‹é¸æ—¥æœŸ'); // ç”¨ console.error æ›¿ä»£ alert
    if(isNaN(income) || isNaN(km)) return console.error('è«‹å¡«å¯«é‡‘é¡èˆ‡é‡Œç¨‹'); // ç”¨ console.error æ›¿ä»£ alert

    const finalOil = (editId && lockedOil) ? parseFloat(lockedOil) : globalOilPrice;
    
    // ç¢ºä¿ ID æ˜¯å­—ä¸² (Firestore éµå€¼è¦æ±‚) æˆ–æ•¸å­— (ç”¨æ–¼åˆ¤æ–·æ˜¯å¦ç‚ºç·¨è¼¯)
    const rec = {
        // æ–°ç´€éŒ„ä½¿ç”¨ Date.now()ï¼Œç·¨è¼¯ç´€éŒ„ä¿æŒåŸ ID (å­—ä¸²æˆ–æ•¸å­—)
        id: editId ? (isNaN(parseInt(editId)) ? editId : parseInt(editId)) : Date.now(), 
        date: date, income: income, orders: orders||0, km: km, hours: hr+(min/60),
        oilPrice: finalOil,
        fuelRate: parseFloat(document.getElementById('settingFuelRate').value),
        maintCost: parseFloat(document.getElementById('settingMaint').value)
    };

    let list = getHistory();
    if(editId) {
        // ç¢ºä¿ç·¨è¼¯æ™‚èƒ½æ­£ç¢ºæ¯”å° ID (ç„¡è«–å­—ä¸²æˆ–æ•¸å­—)
        const idx = list.findIndex(r => r.id.toString() === editId.toString());
        if(idx!==-1) list[idx] = rec;
    } else {
        list.push(rec);
        // å¦‚æœæ˜¯æ–°å¢ä»Šæ—¥ç´€éŒ„ï¼Œè‡ªå‹•åˆ‡æ›åˆ°ä»Šæ—¥ç¯©é¸
        if(date === getLocalDateString()) { currentFilter = 'day'; updateTabs(); }
    }
    
    // å°‡ç´€éŒ„å„²å­˜ä¸¦åŒæ­¥ (æœƒè‡ªå‹•å‘¼å« refreshDashboard)
    saveToFirebase(list); 
    resetEditor();
}

function loadRecordToEditor(id) {
    const r = getHistory().find(i => i.id.toString() === id.toString());
    if(!r) return;
    
    // ç¢ºä¿ ID è½‰æ›ç‚ºå­—ä¸²å­˜å…¥ç·¨è¼¯å™¨ (å›  Date.now() æ˜¯æ•¸å­—ï¼ŒFirestore ID æ˜¯å­—ä¸²)
    document.getElementById('editId').value = r.id.toString(); 
    document.getElementById('recordOilPrice').value = r.oilPrice || globalOilPrice;
    document.getElementById('inputDate').value = r.date;
    document.getElementById('inputIncome').value = r.income;
    document.getElementById('inputOrders').value = r.orders;
    document.getElementById('inputDist').value = r.km;
    const h = Math.floor(r.hours);
    document.getElementById('inputHr').value = h;
    document.getElementById('inputMin').value = Math.round((r.hours-h)*60);

    const hint = document.getElementById('editorOilHint');
    hint.classList.remove('hidden');
    hint.innerText = `é–å®šæ²¹åƒ¹: $${r.oilPrice||globalOilPrice}`;
    
    document.getElementById('editorTitle').innerText = "âœï¸ ç·¨è¼¯ç´€éŒ„";
    document.getElementById('editorCard').classList.add('card-glow');
    document.getElementById('btnSave').innerText = "ç¢ºèªä¿®æ”¹";
    document.getElementById('btnDelete').classList.remove('hidden');
    document.getElementById('btnCancel').classList.remove('hidden');
    document.getElementById('editorCard').scrollIntoView({behavior:'smooth'});
}

function deleteCurrentRecord() {
    console.warn('åŸ·è¡Œåˆªé™¤æ“ä½œã€‚æ³¨æ„ï¼šåœ¨ç·¨è¼¯å™¨ä¸­é»æ“Šåˆªé™¤æŒ‰éˆ•æœƒç«‹å³åŸ·è¡Œï¼Œç„¡äºŒæ¬¡ç¢ºèªè¦–çª—ã€‚'); 
    
    const id = document.getElementById('editId').value;
    if (!id) return; // ç¢ºä¿æœ‰IDæ‰åˆªé™¤
    
    let list = getHistory();
    const originalLength = list.length;
    
    const newList = list.filter(r => r.id.toString() !== id.toString()); // ç¢ºä¿ ID æ¯”è¼ƒæ­£ç¢º

    if(newList.length === originalLength) {
        console.error(`åˆªé™¤å¤±æ•—ï¼šæ‰¾ä¸åˆ° ID ç‚º ${id} çš„ç´€éŒ„ã€‚`);
        return;
    }

    // å°‡æ–°åˆ—è¡¨å„²å­˜ä¸¦åŒæ­¥ (æœƒè‡ªå‹•å‘¼å« refreshDashboard)
    saveToFirebase(newList); 
    resetEditor();
}

function resetEditor() {
    document.getElementById('editId').value = "";
    document.getElementById('recordOilPrice').value = "";
    document.getElementById('inputDate').value = getLocalDateString();
    document.getElementById('inputIncome').value = "";
    document.getElementById('inputOrders').value = "";
    document.getElementById('inputDist').value = "";
    document.getElementById('inputHr').value = "";
    document.getElementById('inputMin').value = "";
    document.getElementById('editorTitle').innerText = "ğŸ“ æ–°å¢ç´€éŒ„";
    document.getElementById('editorOilHint').classList.add('hidden');
    document.getElementById('editorCard').classList.remove('card-glow');
    document.getElementById('btnSave').innerText = "å„²å­˜";
    document.getElementById('btnDelete').classList.add('hidden');
    document.getElementById('btnCancel').classList.add('hidden');
}

// === ç¯©é¸èˆ‡å„€è¡¨æ¿æ›´æ–° (ä¿æŒä¸è®Šï¼Œåªè®€å– allHistory) ===
function updateTabs(btn) {
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    if(btn) btn.classList.add('active');
    else {
        // ç¢ºä¿é‡æ–°è¼‰å…¥æ™‚ï¼Œèƒ½æ­£ç¢ºæ¿€æ´»ç›®å‰çš„ filter æŒ‰éˆ•
        const buttons = document.querySelectorAll('.tab-scroll-content .tab-btn');
        const map = {'day':0, 'week':1, 'month':2, 'year':3, 'all':4, 'custom':5};
        buttons[map[currentFilter]]?.classList.add('active');
    }
}

function applyCustomFilter() {
    // åªæœ‰åœ¨ 'custom' æ¨¡å¼ä¸‹ï¼Œæ”¹è®Šæ—¥æœŸæ‰è§¸ç™¼æ›´æ–°
    if (currentFilter === 'custom') {
        const start = document.getElementById('filterStart').value;
        const end = document.getElementById('filterEnd').value;
        if (start && end) {
            refreshDashboard();
        }
    }
}

function setFilter(type, btn) {
    currentFilter = type;
    updateTabs(btn);
    const customPanel = document.getElementById('customDateFilter');
    
    // é¡¯ç¤º/éš±è—è‡ªå®šç¾©å€é–“è¼¸å…¥æ¡†
    if (type === 'custom') {
        customPanel.classList.remove('hidden');
        applyCustomFilter(); 
    } else {
        customPanel.classList.add('hidden');
        refreshDashboard();
    }
}


function getFilteredData() {
    const list = getHistory(); // ç¾åœ¨æ˜¯ allHistory
    const todayStr = getLocalDateString();
    
    if(currentFilter==='day') return list.filter(r=>r.date===todayStr);

    if(currentFilter==='week') {
        const d = new Date();
        // (d.getDay() + 6) % 7: 0=é€±ä¸€, 1=é€±äºŒ, ..., 6=é€±æ—¥
        const dayOfWeek = (d.getDay() + 6) % 7; 
        
        const startDate = new Date(d);
        startDate.setDate(d.getDate() - dayOfWeek); // å›åˆ°æœ¬é€±ä¸€
        
        // ç¢ºä¿åªæ¯”å° YYYY-MM-DD
        const startDateStr = startDate.toISOString().split('T')[0];

        // ç¯©é¸å¾æœ¬é€±ä¸€åˆ°ä»Šå¤©(æˆ–ç¯©é¸å€é–“å…§çš„æ‰€æœ‰æ—¥æœŸ)çš„ç´€éŒ„
        return list.filter(r => r.date >= startDateStr);
    }
    
    if(currentFilter==='month') return list.filter(r=>r.date.startsWith(todayStr.slice(0,7)));
    if(currentFilter==='year') return list.filter(r=>r.date.startsWith(todayStr.slice(0,4)));
    if(currentFilter==='all') return list;

    if(currentFilter==='custom') {
        const start = document.getElementById('filterStart').value;
        const end = document.getElementById('filterEnd').value;
        return list.filter(r => r.date >= start && r.date <= end);
    }
    
    return list; // Default to return all if filter type is unknown/unhandled
}

function calculateRecordStats(record) {
    const { income, orders, km, hours, oilPrice, fuelRate, maintCost } = record;
    
    // 1. æˆæœ¬è¨ˆç®—
    const oilCost = (km / fuelRate) * oilPrice;
    const maintenanceCost = km * maintCost;
    const totalCost = oilCost + maintenanceCost;
    
    // 2. æ·¨åˆ©è¨ˆç®—
    const netProfit = income - totalCost;

    // 3. æ™‚è–ªè¨ˆç®—
    const grossHourly = hours > 0 ? income / hours : 0;
    const netHourly = hours > 0 ? netProfit / hours : 0;

    // 4. å–®åƒ¹è¨ˆç®— (V1.2.3 æ–°å¢)
    const grossPerOrder = orders > 0 ? income / orders : 0;
    const netPerOrder = orders > 0 ? netProfit / orders : 0;


    return {
        ...record,
        oilCost: oilCost,
        maintenanceCost: maintenanceCost,
        totalCost: totalCost,
        netProfit: netProfit,
        grossHourly: grossHourly,
        netHourly: netHourly,
        grossPerOrder: grossPerOrder, // V1.2.3
        netPerOrder: netPerOrder      // V1.2.3
    };
}

function refreshDashboard(skipFilter=false) {
    // skipFilter = true æ™‚ (ä¾‹å¦‚ç™»å‡º)ï¼Œç›´æ¥ä½¿ç”¨ allHistoryï¼Œé¿å…éæ¿¾å™¨éŒ¯èª¤
    const rawData = skipFilter ? allHistory : getFilteredData();
    const filtered = rawData.map(calculateRecordStats);
    
    // ç¸½è¨ˆæ•¸æ“š
    const totals = filtered.reduce((acc, r) => {
        acc.totalIncome += r.income;
        acc.totalCost += r.totalCost;
        acc.netProfit += r.netProfit;
        acc.totalOilCost += r.oilCost;
        acc.totalMaintCost += r.maintenanceCost;
        acc.totalOrders += r.orders;
        acc.totalHours += r.hours;
        return acc;
    }, {
        totalIncome: 0,
        totalCost: 0,
        netProfit: 0,
        totalOilCost: 0,
        totalMaintCost: 0,
        totalOrders: 0,
        totalHours: 0
    });
    
    // è¨ˆç®—å¹³å‡æ™‚è–ªèˆ‡å–®åƒ¹
    const totalGrossHourly = totals.totalHours > 0 ? totals.totalIncome / totals.totalHours : 0;
    const totalNetHourly = totals.totalHours > 0 ? totals.netProfit / totals.totalHours : 0;
    const totalGrossPerOrder = totals.totalOrders > 0 ? totals.totalIncome / totals.totalOrders : 0; // V1.2.3
    const totalNetPerOrder = totals.totalOrders > 0 ? totals.netProfit / totals.totalOrders : 0;     // V1.2.3


    // æ›´æ–°å„€è¡¨æ¿
    document.getElementById('dashTotalIncome').innerText = formatCurrency(totals.totalIncome);
    document.getElementById('dashTotalCost').innerText = formatCurrency(totals.totalCost);
    document.getElementById('dashNetProfit').innerText = formatCurrency(totals.netProfit);
    document.getElementById('dashOilCost').innerText = formatCurrency(totals.totalOilCost);
    document.getElementById('dashMaintCost').innerText = formatCurrency(totals.totalMaintCost);
    document.getElementById('dashOrders').innerText = totals.totalOrders.toFixed(0);
    document.getElementById('dashHours').innerText = Math.floor(totals.totalHours);
    document.getElementById('dashMinutes').innerText = Math.round((totals.totalHours - Math.floor(totals.totalHours)) * 60);
    document.getElementById('dashGrossHourly').innerText = formatCurrency(totalGrossHourly);
    document.getElementById('dashNetHourly').innerText = formatCurrency(totalNetHourly);
    document.getElementById('dashGrossPerOrder').innerText = formatCurrency(totalGrossPerOrder); // V1.2.3
    document.getElementById('dashNetPerOrder').innerText = formatCurrency(totalNetPerOrder);     // V1.2.3

    // æ›´æ–°æ­·å²åˆ—è¡¨ - V1.2.6 æ¨£å¼èª¿æ•´ (å…¨å·¦å°é½Šï¼Œåªæœ‰æ·¨åˆ©é å³)
    const listHtml = filtered.map(r => `
        <div class="history-item" onclick="loadRecordToEditor('${r.id}')">
            <div class="history-top-row">
                <div class="history-stat-group w-1/3">
                    <div class="text-sm font-semibold text-white">${r.date.slice(5)}</div>
                    <div class="history-main-value text-amber-soft">$${formatCurrency(r.income)}</div>
                    <div class="stat-label-small text-amber-soft">ç¸½ç‡Ÿæ”¶</div>
                </div>
                
                <div class="history-stat-group w-1/3">
                    <div class="text-sm font-semibold text-red-300">æˆæœ¬</div>
                    <div class="history-main-value text-red-400">$${formatCurrency(r.totalCost)}</div>
                    <div class="stat-label-small text-red-500">æ²¹è€— + è€—æ</div>
                </div>

                <div class="history-stat-group right w-1/3">
                    <div class="text-sm font-semibold text-green-300">æ·¨åˆ©</div>
                    <div class="history-main-value text-green-400">$${formatCurrency(r.netProfit)}</div>
                    <div class="stat-label-small text-green-500">å¯¦è³º</div>
                </div>
            </div>

            <div class="history-sub-stats">
                <div class="flex flex-col gap-1 w-full">
                    <div class="flex justify-between items-center">
                        <span class="stat-label-small text-gray-400">å–®æ•¸/é‡Œç¨‹</span>
                        <span class="text-white">${r.orders} å–® / ${r.km.toFixed(1)} KM</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="stat-label-small text-gray-400">å·¥æ™‚</span>
                        <span class="text-white">${formatDuration(r.hours)}</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="stat-label-small text-red-500">æ²¹/è€—ææˆæœ¬</span>
                        <span class="text-red-400">$${formatCurrency(r.oilCost)} / $${formatCurrency(r.maintenanceCost)}</span>
                    </div>
                </div>
                
                <div class="w-full mt-3 pt-3 border-t border-gray-800 flex flex-col gap-1">
                     <div class="flex justify-between items-center">
                        <span class="stat-label-small text-green-500">å·²æ‰£æˆæœ¬æ™‚è–ª</span>
                        <span class="text-green-400 font-bold">$${formatCurrency(r.netHourly)}</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="stat-label-small text-amber-soft">æ¯å–®å¹³å‡ç‡Ÿæ”¶</span>
                        <span class="text-amber-soft">$${formatCurrency(r.grossPerOrder)}</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="stat-label-small text-green-500">æ¯å–®å¹³å‡æ·¨åˆ©</span>
                        <span class="text-green-400 font-bold">$${formatCurrency(r.netPerOrder)}</span>
                    </div>
                </div>
            </div>
        </div>
    `).join('');
    
    document.getElementById('historyList').innerHTML = listHtml || `
        <div class="p-5 text-center text-gray-500 text-sm">
            --- æ­¤å€é–“æš«ç„¡ç´€éŒ„ ---
        </div>
    `;
    
    // æ›´æ–°åœ–è¡¨ (å¦‚æœå·²é–‹å•Ÿ)
    if (!document.getElementById('chartsPanel').classList.contains('hidden')) {
        updateChart();
    }
}

// === è¼”åŠ©å‡½æ•¸ (Utility Functions) ===

function formatCurrency(num) {
    if (isNaN(num)) return '0';
    // è² æ•¸å–çµ•å°å€¼å¾Œæ ¼å¼åŒ–ï¼Œå†åŠ å›è² è™Ÿ
    const isNegative = num < 0;
    const formatted = Math.abs(num).toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ",");
    return isNegative ? `-${formatted}` : formatted;
}

function formatDuration(totalHours) {
    const hours = Math.floor(totalHours);
    const minutes = Math.round((totalHours - hours) * 60);
    let str = '';
    if (hours > 0) str += `${hours}h`;
    if (minutes > 0) str += `${minutes}m`;
    if (hours === 0 && minutes === 0) return '0m';
    return str.trim();
}

// === åœ–è¡¨ç›¸é—œå‡½æ•¸ (Charts) ===

function toggleCharts() {
    const panel = document.getElementById('chartsPanel');
    panel.classList.toggle('hidden');
    if (!panel.classList.contains('hidden')) {
        updateChart();
    } else {
        destroyChart();
    }
}

function switchChartType(type) {
    chartType = type;
    document.getElementById('btnChartBar').classList.remove('active');
    document.getElementById('btnChartPie').classList.remove('active');
    document.getElementById(`btnChart${type.charAt(0).toUpperCase() + type.slice(1)}`).classList.add('active');
    updateChart();
}

function destroyChart() {
    if (chartInstance) {
        chartInstance.destroy();
        chartInstance = null;
    }
}

function updateChart() {
    destroyChart();
    
    const start = document.getElementById('chartStart').value;
    const end = document.getElementById('chartEnd').value;
    const groupBy = document.getElementById('chartGroupBy').value;

    if (!start || !end) return;

    // ç¯©é¸åœ–è¡¨å€é–“æ•¸æ“š
    // ç›´æ¥å¾ allHistory å–å¾—æ‰€æœ‰ç´€éŒ„ï¼Œç„¶å¾Œè¨ˆç®—çµ±è¨ˆæ•¸æ“š
    const allData = getHistory().map(calculateRecordStats);
    const chartData = allData.filter(r => r.date >= start && r.date <= end);
    
    if (chartData.length === 0) {
        // æ¸…é™¤ Canvas ä¸Šçš„æ®˜ç•™åœ–å½¢
        const ctx = document.getElementById('mainChart').getContext('2d');
        if (ctx) ctx.clearRect(0, 0, 300, 300);
        return;
    }

    let groupedData = {};

    if (groupBy === 'day') {
        chartData.forEach(r => {
            const label = r.date.slice(5); // M-D
            if (!groupedData[label]) { groupedData[label] = { income: 0, netProfit: 0, cost: 0, orders: 0 }; }
            groupedData[label].income += r.income;
            groupedData[label].netProfit += r.netProfit;
            groupedData[label].cost += r.totalCost;
            groupedData[label].orders += r.orders;
        });
    } else if (groupBy === 'month') {
        chartData.forEach(r => {
            const label = r.date.slice(0, 7); // YYYY-MM
            if (!groupedData[label]) { groupedData[label] = { income: 0, netProfit: 0, cost: 0, orders: 0 }; }
            groupedData[label].income += r.income;
            groupedData[label].netProfit += r.netProfit;
            groupedData[label].cost += r.totalCost;
            groupedData[label].orders += r.orders;
        });
    } else if (groupBy === 'year') {
        chartData.forEach(r => {
            const label = r.date.slice(0, 4); // YYYY
            if (!groupedData[label]) { groupedData[label] = { income: 0, netProfit: 0, cost: 0, orders: 0 }; }
            groupedData[label].income += r.income;
            groupedData[label].netProfit += r.netProfit;
            groupedData[label].cost += r.totalCost;
            groupedData[label].orders += r.orders;
        });
    }

    const labels = Object.keys(groupedData).sort();

    const ctx = document.getElementById('mainChart').getContext('2d');

    if (chartType === 'bar') {
        chartInstance = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [
                    {
                        label: 'æ·¨åˆ©æ½¤',
                        data: labels.map(l => groupedData[l].netProfit),
                        backgroundColor: '#10b981', // ç¶ è‰²
                        borderRadius: 4,
                    },
                    {
                        label: 'ç¸½æˆæœ¬',
                        data: labels.map(l => groupedData[l].cost),
                        backgroundColor: '#ef4444', // ç´…è‰²
                        borderRadius: 4,
                    },
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: {
                        stacked: true,
                        grid: { display: false, color: '#333' },
                        ticks: { color: '#9ca3af' }
                    },
                    y: {
                        stacked: true,
                        beginAtZero: true,
                        grid: { color: '#333' },
                        ticks: { color: '#9ca3af' }
                    }
                },
                plugins: {
                    legend: {
                        labels: { color: '#e5e5e5' }
                    },
                    tooltip: {
                        callbacks: {
                            label: (context) => {
                                let label = context.dataset.label || '';
                                if (label) { label += ': '; }
                                if (context.parsed.y !== null) { label += `$${context.parsed.y.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ",")}`; }
                                return label;
                            }
                        }
                    }
                }
            }
        });
    } else if (chartType === 'pie') {
        const totalOilCost = chartData.reduce((sum, r) => sum + r.oilCost, 0);
        const totalMaintCost = chartData.reduce((sum, r) => sum + r.maintenanceCost, 0);
        const totalNetProfit = chartData.reduce((sum, r) => sum + r.netProfit, 0);
        
        chartInstance = new Chart(ctx, {
            type: 'pie',
            data: {
                labels: ['ç¸½æ·¨åˆ©', 'ç¸½æ²¹è€—æˆæœ¬', 'ç¸½è€—ææˆæœ¬'],
                datasets: [{
                    data: [totalNetProfit, totalOilCost, totalMaintCost],
                    backgroundColor: ['#10b981', '#fcd34d', '#ef4444'],
                    hoverOffset: 4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'top',
                        labels: { color: '#e5e5e5' }
                    },
                    tooltip: {
                        callbacks: {
                            label: (context) => {
                                const total = context.chart.data.datasets[0].data.reduce((a, b) => a + b, 0);
                                const value = context.raw;
                                const percentage = ((value / total) * 100).toFixed(1) + '%';
                                return `${context.label}: $${value.toFixed(0)} (${percentage})`;
                            }
                        }
                    }
                }
            }
        });
    }
}
</script>
</body>
</html>
