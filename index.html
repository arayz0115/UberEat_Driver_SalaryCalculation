<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
<title>UBE 薪資計算統計 V1.2.16 (Beige UI)</title>

<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#F5F1EB">
<link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/732/732200.png">

<meta property="og:title" content="UBE 薪資計算統計 V1.2.16 (Beige UI)" />
<meta property="og:description" content="專為外送員打造的薪資記帳統計，UI 改為 Beige 色系、收合改順暢過渡，保留原有功能與數據邏輯。" />
<meta property="og:type" content="website" />
<meta property="og:image" content="https://placehold.co/1200x630/f5f1eb/2b2b2b?text=UBE+V1.2.16" />

<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
    /* === 全局 Beige 主題設定 === */
    :root{
        --beige-bg: #F5F1EB;
        --beige-card: #FBF7F2;
        --beige-accent: #B1864B; /* 主色 (Beige-ish) */
        --muted: #7a6f5b;
        --text: #2b2b2b;
        --subtle-border: #E2DCCA;
        --danger: #9b2b2b;
    }

    body {
        background-color: var(--beige-bg);
        color: var(--text);
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        padding-bottom: 120px; /* 底部留空間給版權 */
        padding-top: env(safe-area-inset-top);
    }
    
    /* 卡片 */
    .card {
        background-color: var(--beige-card);
        border: 1px solid var(--subtle-border);
        border-radius: 1rem;
        padding: 1rem;
        margin-bottom: 0.8rem;
        position: relative;
        color: var(--text);
    }
    .card-glow { border-color: rgba(177,134,75,0.6); box-shadow: 0 6px 24px rgba(177,134,75,0.08); }

    /* 輸入 */
    .input-field {
        background-color: #fff;
        border: 1px solid var(--subtle-border);
        color: var(--text);
        border-radius: 0.6rem;
        padding: 0.7rem;
        width: 100%;
        font-size: 1rem;
        transition: 0.18s;
    }
    .input-field:focus { outline: none; border-color: var(--beige-accent); box-shadow: 0 2px 8px rgba(177,134,75,0.06); }

    /* 按鈕 */
    .btn { width: 100%; padding: 0.8rem; border-radius: 0.6rem; font-weight: 600; display: flex; justify-content: center; align-items: center; transition: 0.16s; }
    .btn-primary { background-color: var(--beige-accent); color: white; }
    .btn-primary:active { transform: scale(0.99); }
    .btn-danger { background-color: var(--danger); color: #fee2e2; border: 1px solid rgba(155,43,43,0.9); }
    .btn-ghost { background-color: transparent; border: 1px solid var(--subtle-border); color: var(--muted); }

    .chart-toggle-btn { background: transparent; color: var(--muted); border: 1px solid var(--subtle-border); }
    .chart-toggle-btn.active { background: var(--beige-accent); color: white; border-color: var(--beige-accent); }

    /* 篩選 Tab */
    .tab-scroll-container { width: 100%; overflow-x: auto; padding-bottom: 0.5rem; scrollbar-width: none; -ms-overflow-style: none; }
    .tab-scroll-container::-webkit-scrollbar { display: none; }
    .tab-scroll-content { display:flex; gap:0.6rem; padding-right:1.5rem; min-width:max-content; }
    .tab-btn { padding:0.5rem 1rem; border-radius:2rem; font-size:0.9rem; color:var(--muted); background: transparent; border:1px solid var(--subtle-border); white-space:nowrap; }
    .tab-btn.active { background: #fff; color: var(--text); font-weight:600; border-color: rgba(0,0,0,0.06); }

    /* 歷史列表 */
    .history-item { background-color: transparent; border-bottom: 1px solid rgba(0,0,0,0.04); padding-top: 1rem; padding-bottom: 0rem; padding-left: 1rem; padding-right: 1rem; transition: background 0.18s; display:flex; flex-direction:column; }
    .history-header-wrapper { display:flex; justify-content:space-between; align-items:flex-start; width:100%; }
    .history-main-area { display:flex; width: calc(100% - 30px); padding-bottom:1.25rem; cursor:pointer; transition: background 0.12s; }
    .history-top-row { display:flex; justify-content:space-between; align-items:flex-start; width:100%; }
    .history-toggle-icon { width:30px; height:100%; padding-top:5px; color: var(--muted); cursor:pointer; z-index:10; font-size:1rem; transition: transform 0.18s; text-align:right; flex-shrink:0; }
    .history-stat-group { display:flex; flex-direction:column; align-items:flex-start; text-align:left; }
    .history-stat-group.center { align-items:center; text-align:center; }
    .history-stat-group.right { align-items:flex-end; text-align:right; }
    .history-main-value { font-size:1.25rem; font-weight:700; line-height:1.1; margin-top:2px; }
    .stat-label-small { font-size:0.72rem; color: var(--muted); margin-top:2px; line-height:1.2; }

    /* 平滑的收合/展開 (使用 max-height 過渡) */
    .collapsible { max-height: 0; overflow: hidden; opacity: 0; transition: max-height 320ms cubic-bezier(.2,.8,.2,1), opacity 220ms ease; }
    .collapsible.open { max-height: 1600px; opacity: 1; }

    .history-sub-stats { width:100%; padding-top:0.75rem; padding-bottom:1.25rem; font-size:0.82rem; color:var(--muted); margin-top:0.75rem; border-top:1px solid rgba(0,0,0,0.04); }
    .history-sub-stats .performance-summary { margin-top:0.75rem; padding-top:0.75rem; border-top:1px solid rgba(0,0,0,0.04); }

    .stat-label { font-size:0.75rem; color: var(--muted); text-transform: uppercase; letter-spacing:0.05em; }

    /* dashboard 的總單數/總工時 防止換行 */
    .no-wrap { display:flex; gap:6px; align-items:center; white-space:nowrap; }

    /* footer */
    .footer-credit { text-align:center; margin-top:2rem; padding-top:1rem; border-top:1px solid rgba(0,0,0,0.04); color:var(--muted); font-size:0.78rem; letter-spacing:0.8px; }

    /* small responsive tweaks */
    @media (max-width:420px){ .history-main-value { font-size:1.05rem; } }
</style>
</head>
<body class="max-w-md mx-auto p-3">

    <div class="flex justify-between items-center mb-4 px-1 pt-2">
        <div class="flex items-center gap-2">
            <div class="w-1.5 h-6 bg-[var(--beige-accent)] rounded-full"></div>
            <div>
                <h1 class="text-lg font-bold text-[var(--text)] leading-tight">UBE 薪資計算統計</h1>
                <div class="text-[10px] text-[var(--muted)]">V1.2.16 — Beige UI</div>
            </div>
        </div>
        <div class="flex gap-2">
            <button onclick="toggleAuthPanel()" class="p-2 bg-white rounded-full text-[var(--muted)] border border-[var(--subtle-border)] text-xs active:opacity-90">
                <span id="authStatusText">未登入</span>
            </button>
            <button onclick="toggleSettings()" class="p-2 bg-white rounded-full text-[var(--muted)] border border-[var(--subtle-border)] text-xs active:opacity-90">
                設定
            </button>
        </div>
    </div>

    <div id="authPanel" class="hidden mb-4 card">
        <h3 class="text-[var(--beige-accent)] font-bold mb-3 text-sm uppercase">Firebase 雲端驗證</h3>
        <div id="authContent">
            <div id="authForm" class="grid grid-cols-1 gap-3 mb-3">
                <div>
                    <label class="stat-label mb-1">Email</label>
                    <input id="authEmail" type="email" class="input-field" placeholder="your@email.com" />
                </div>
                <div>
                    <label class="stat-label mb-1">密碼</label>
                    <input id="authPassword" type="password" class="input-field" placeholder="密碼 (至少6位)" />
                </div>
                <button onclick="registerUser()" class="btn btn-primary text-sm">註冊 (新帳號)</button>
                <button onclick="loginUser()" class="btn btn-ghost text-sm border-[var(--beige-accent)] text-[var(--beige-accent)]">登入 (已有帳號)</button>
                <button onclick="resetPassword()" class="text-xs text-[var(--muted)] hover:text-[var(--text)] mt-2">忘記密碼？</button>
            </div>
            
            <div id="userInfo" class="hidden">
                <p class="text-[var(--text)] mb-3">歡迎，<span id="userEmailDisplay" class="font-semibold text-[var(--beige-accent)]"></span></p>
                <button onclick="logoutUser()" class="btn btn-danger text-sm">登出並清除本機狀態</button>
            </div>
        </div>
    </div>

    <div id="settingsPanel" class="hidden mb-4 card">
        <h3 class="text-[var(--beige-accent)] font-bold mb-3 text-sm uppercase">全域參數</h3>
        <div class="grid grid-cols-2 gap-3 mb-3">
            <div>
                <label class="stat-label mb-1">油品</label>
                <select id="oilType" class="input-field" onchange="fetchOilPrice()">
                    <option value="92">92 無鉛</option>
                    <option value="95">95 無鉛</option>
                    <option value="98">98 無鉛</option>
                    <option value="diesel">柴油</option>
                </select>
            </div>
            <div>
                <label class="stat-label mb-1">目前油價</label>
                <div id="oilPriceDisplay" class="input-field text-[var(--beige-accent)] font-bold">讀取中...</div>
            </div>
        </div>
        <div class="grid grid-cols-2 gap-3 mb-3">
            <div>
                <label class="stat-label mb-1">油耗 (km/L)</label>
                <input id="settingFuelRate" type="number" class="input-field" />
            </div>
            <div>
                <label class="stat-label mb-1">耗材 ($/km)</label>
                <input id="settingMaint" type="number" step="0.1" class="input-field" />
            </div>
        </div>
        <button onclick="saveSettings()" class="btn btn-primary text-sm">儲存設定</button>
    </div>

    <div class="card card-glow mb-4 p-5" id="editorCard">
        <div class="flex justify-between items-center border-b border-[rgba(0,0,0,0.04)] pb-2 cursor-pointer" onclick="toggleEditor()">
            <h3 class="font-bold text-[var(--text)] flex items-center gap-2 text-base">新增紀錄</h3>
            <span id="editorToggleIcon" class="text-xl text-[var(--muted)]">▼</span>
        </div>
        
        <div id="editorContent" class="pt-4 collapsible open">
            <input type="hidden" id="editId" value="">
            <input type="hidden" id="recordOilPrice" value=""> 
            
            <div class="flex justify-end items-center mb-3">
                 <span id="editorOilHint" class="text-xs text-[var(--muted)] hidden">鎖定油價: --</span>
            </div>

            <div class="flex flex-col gap-3 mb-4">
                <div>
                    <label class="stat-label mb-1">日期</label>
                    <input id="inputDate" type="date" class="input-field cursor-pointer text-sm" onclick="this.showPicker()" />
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="stat-label mb-1">營業額</label>
                        <input id="inputIncome" type="number" inputmode="numeric" class="input-field font-bold text-lg" placeholder="$0" />
                    </div>
                    <div>
                        <label class="stat-label mb-1">單數</label>
                        <input id="inputOrders" type="number" inputmode="numeric" class="input-field" placeholder="0" />
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-2 gap-3 mb-4">
                <div>
                    <label class="stat-label mb-1">里程</label>
                    <input id="inputDist" type="number" step="0.1" inputmode="decimal" class="input-field" placeholder="KM" />
                </div>
                <div>
                    <label class="stat-label mb-1">工時</label>
                    <div class="flex gap-1">
                        <input id="inputHr" type="number" class="input-field text-center px-1" placeholder="時" />
                        <input id="inputMin" type="number" class="input-field text-center px-1" placeholder="分" />
                    </div>
                </div>
            </div>

            <div class="flex gap-2">
                <button onclick="saveRecord()" class="btn btn-primary" id="btnSave">儲存</button>
                <button onclick="deleteCurrentRecord()" class="btn btn-danger hidden" id="btnDelete">刪除</button>
                <button onclick="resetEditor()" class="btn btn-ghost hidden" id="btnCancel">取消</button>
            </div>
        </div>
    </div>

    <div class="card mb-4 p-5" id="dashboardCard">
        <div class="flex justify-between items-center cursor-pointer" onclick="toggleDashboard()">
            <h3 class="font-bold text-[var(--text)] flex items-center gap-2 text-sm uppercase">區間總營收儀表板</h3>
            <span id="dashboardToggleIcon" class="text-xl text-[var(--muted)]">▼</span>
        </div>
        
        <div id="dashboardContent" class="pt-4 collapsible open">
            <div class="grid grid-cols-3 gap-2">

                <div class="flex flex-col items-center text-center">
                    <label class="stat-label text-[var(--muted)]">區間總營收</label>
                    <div class="text-3xl font-bold text-[var(--beige-accent)] mt-1 tracking-tight">$<span id="dashTotalIncome">0</span></div>
                </div>
                <div class="flex flex-col items-center text-center"> 
                    <label class="stat-label text-[var(--danger)]">總成本</label>
                    <div class="text-3xl font-bold text-[var(--danger)] mt-1 tracking-tight">$<span id="dashTotalCost">0</span></div> 
                </div>
                <div class="flex flex-col items-center text-center">
                    <label class="stat-label text-green-400">總淨利</label>
                    <div class="text-3xl font-bold text-[var(--text)] mt-1 tracking-tight">$<span id="dashNetProfit">0</span></div>
                </div>

                <div class="col-span-3 border-t border-[rgba(0,0,0,0.04)] pt-4 mt-4"></div>

                <div class="flex flex-col items-center text-center">
                    <label class="stat-label text-[var(--danger)]">油耗成本</label>
                    <div class="text-lg font-bold text-[var(--danger)] mt-1">$<span id="dashOilCost">0</span></div>
                </div>
                <div class="flex flex-col items-center text-center">
                    <label class="stat-label text-[var(--danger)]">耗材成本</label>
                    <div class="text-lg font-bold text-[var(--danger)] mt-1">$<span id="dashMaintCost">0</span></div>
                </div>
                <div class="flex flex-col items-center text-center">
                    <label class="stat-label text-[var(--muted)]">總單數 / 總工時</label>
                    <div class="text-lg font-bold text-[var(--text)] mt-1 no-wrap">
                        <span id="dashOrders">0</span>單 |
                        <span id="dashHours">0</span>h <span id="dashMinutes">0</span>m
                    </div>
                </div>
                
                
                <div class="col-span-3 border-t border-[rgba(0,0,0,0.04)] pt-4 mt-4 grid grid-cols-2 gap-4">
                    <div class="flex flex-col items-center text-center">
                        <label class="stat-label text-[var(--beige-accent)]">未扣成本實薪</label>
                        <div class="text-2xl font-bold text-[var(--beige-accent)] my-1 tracking-tight">$<span id="dashGrossHourly">0</span></div>
                    </div>
                    <div class="flex flex-col items-center text-center">
                        <label class="stat-label text-[var(--text)]">已扣成本實薪</label>
                        <div class="text-2xl font-bold text-[var(--text)] my-1 tracking-tight">$<span id="dashNetHourly">0</span></div>
                    </div>
                </div>

                <div class="col-span-3 border-t border-[rgba(0,0,0,0.04)] pt-4 mt-4 grid grid-cols-2 gap-4">
                    <div class="flex flex-col items-center text-center">
                        <label class="stat-label text-[var(--beige-accent)]">每單平均營收</label>
                        <div class="text-xl font-bold text-[var(--beige-accent)] my-1 tracking-tight">$<span id="dashGrossPerOrder">0</span></div>
                    </div>
                    <div class="flex flex-col items-center text-center">
                        <label class="stat-label text-[var(--text)]">每單平均淨利</label>
                        <div class="text-xl font-bold text-[var(--text)] my-1 tracking-tight">$<span id="dashNetPerOrder">0</span></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="tab-scroll-container mb-3">
        <div class="tab-scroll-content">
            <button class="tab-btn active" onclick="setFilter('day', this)">今日</button>
            <button class="tab-btn" onclick="setFilter('week', this)">本週</button>
            <button class="tab-btn" onclick="setFilter('month', this)">本月</button>
            <button class="tab-btn" onclick="setFilter('year', this)">本年</button>
            <button class="tab-btn" onclick="setFilter('all', this)">全部</button>
            <button class="tab-btn" onclick="setFilter('custom', this)">自定義</button> 
            <button class="tab-btn border-[var(--beige-accent)] text-[var(--beige-accent)]" onclick="toggleCharts()">進階圖表分析</button>
        </div>
    </div>
    
    <div id="customDateFilter" class="card p-3 mb-4 hidden">
        <h3 class="text-xs font-bold text-[var(--beige-accent)] mb-2 uppercase">自定義區間篩選</h3>
        <div class="flex gap-2 items-center">
            <input type="date" id="filterStart" class="input-field text-sm py-1" onchange="applyCustomFilter()" />
            <span class="text-[var(--muted)]">至</span>
            <input type="date" id="filterEnd" class="input-field text-sm py-1" onchange="applyCustomFilter()" />
        </div>
    </div>

    <div id="chartsPanel" class="hidden card mb-4">
        <div class="flex justify-between items-center mb-3">
            <h4 class="text-sm font-bold text-[var(--text)]">數據分析中心</h4>
            <div class="flex bg-white rounded-lg p-1">
                <button onclick="switchChartType('bar')" id="btnChartBar" class="chart-toggle-btn active px-3 py-1 rounded text-xs">趨勢圖</button>
                <button onclick="switchChartType('pie')" id="btnChartPie" class="chart-toggle-btn px-3 py-1 rounded text-xs">圓餅圖</button>
            </div>
        </div>

        <div class="bg-white p-2 rounded-lg mb-3">
            <div class="flex gap-2 mb-2">
                <input type="date" id="chartStart" class="input-field text-xs py-1" onchange="updateChart()" />
                <span class="text-[var(--muted)] self-center">~</span>
                <input type="date" id="chartEnd" class="input-field text-xs py-1" onchange="updateChart()" />
            </div>
            <div class="flex items-center gap-2">
                <label class="text-xs text-[var(--muted)]">分組:</label>
                <select id="chartGroupBy" class="input-field text-xs py-1" onchange="updateChart()">
                    <option value="day">依日期 (日)</option>
                    <option value="month">依月份 (月)</option>
                    <option value="year">依年份 (年)</option>
                </select>
            </div>
        </div>

        <div style="position: relative; height: 300px; width: 100%;">
            <canvas id="mainChart"></canvas>
        </div>
    </div>

    <div class="mb-8">
        <h3 class="text-xs font-bold text-[var(--muted)] mb-2 uppercase pl-1">區間明細</h3>
        <div id="historyList" class="rounded-xl overflow-hidden border border-[var(--subtle-border)]"></div>
    </div>

    <div class="footer-credit">
        <div>© 2025 UBE薪資計算統計. Developed by Ray Wu. All Rights Reserved.</div>
    </div>

<script>
// Firebase config 保持不變
const firebaseConfig = {
    apiKey: "AIzaSyAqiTFbvsIkUVUrBmwaR28448EFMg4FO-w",
    authDomain: "uber-driver-tracker.firebaseapp.com",
    projectId: "uber-driver-tracker",
    storageBucket: "uber-driver-tracker.appspot.com",
    messagingSenderId: "333010467554",
    appId: "1:333010467554:web:86f6a5067253fa433878b2"
};

let db;
let firebaseUnsubscribe = null;

if (typeof firebase !== 'undefined' && firebaseConfig.apiKey) {
    firebase.initializeApp(firebaseConfig);
    db = firebase.firestore();
}

const workerAPI = "https://ubereat-oil-proxy.leo3026772.workers.dev/";
let globalOilPrice = 30.0;
let currentFilter = 'day';
let chartInstance = null;
let chartType = 'bar';

window.onload = async () => {
    // 載入收合狀態
    loadCollapseStates();
    resetEditor();
    loadSettings();

    const today = getLocalDateString();
    document.getElementById('filterStart').value = today;
    document.getElementById('filterEnd').value = today;

    const now = new Date();
    document.getElementById('chartStart').value = new Date(now.getFullYear(), 0, 1).toISOString().slice(0,10);
    document.getElementById('chartEnd').value = today;

    if (typeof firebase !== 'undefined' && firebaseConfig.apiKey) {
        firebase.auth().onAuthStateChanged(user => {
            if (user) {
                document.getElementById('authStatusText').innerText = "已登入";
                document.getElementById('userEmailDisplay').innerText = user.email;
                document.getElementById('authForm').classList.add('hidden');
                document.getElementById('userInfo').classList.remove('hidden');
                setupRealtimeListener(user);

            } else {
                document.getElementById('authStatusText').innerText = "未登入";
                document.getElementById('authForm').classList.remove('hidden');
                document.getElementById('userInfo').classList.add('hidden');
                if (firebaseUnsubscribe) { firebaseUnsubscribe(); firebaseUnsubscribe = null; }
                refreshDashboard();
            }
        });
    } else {
        refreshDashboard();
    }

    await fetchOilPrice();
};

function getLocalDateString() {
    const offset = new Date().getTimezoneOffset() * 60000;
    return new Date(Date.now() - offset).toISOString().split('T')[0];
}

// === 平滑收合/展開（使用 maxHeight 動畫） ===
function applyOpen(content, open){
    if(open){
        content.classList.add('open');
        // 設定 maxHeight 到 scrollHeight 以平滑展開
        content.style.maxHeight = content.scrollHeight + 'px';
        content.style.opacity = '1';
    } else {
        // 先把當前高度鎖定，接著再設為 0
        content.style.maxHeight = content.scrollHeight + 'px';
        requestAnimationFrame(() => {
            content.style.maxHeight = '0px';
            content.style.opacity = '0';
            content.classList.remove('open');
        });
    }
}

function togglePanel(panelId, iconId, storageKey) {
    const content = document.getElementById(panelId + 'Content');
    const icon = document.getElementById(iconId);
    if (!content) return;

    const isOpen = content.classList.contains('open');
    if (isOpen) {
        applyOpen(content, false);
        icon.innerText = '▶';
        localStorage.setItem(storageKey, 'true');
    } else {
        applyOpen(content, true);
        icon.innerText = '▼';
        localStorage.removeItem(storageKey);
    }
}

function toggleEditor() { togglePanel('editor', 'editorToggleIcon', 'editorCollapsed'); }
function toggleDashboard() { togglePanel('dashboard', 'dashboardToggleIcon', 'dashboardCollapsed'); }

function loadCollapseStates(){
    const editorContent = document.getElementById('editorContent');
    const dashboardContent = document.getElementById('dashboardContent');

    if (localStorage.getItem('editorCollapsed') === 'true'){
        editorContent.classList.remove('open');
        editorContent.style.maxHeight = '0px';
        editorContent.style.opacity = '0';
        document.getElementById('editorToggleIcon').innerText = '▶';
    } else {
        editorContent.classList.add('open');
        editorContent.style.maxHeight = editorContent.scrollHeight + 'px';
        editorContent.style.opacity = '1';
        document.getElementById('editorToggleIcon').innerText = '▼';
    }

    if (localStorage.getItem('dashboardCollapsed') === 'true'){
        dashboardContent.classList.remove('open');
        dashboardContent.style.maxHeight = '0px';
        dashboardContent.style.opacity = '0';
        document.getElementById('dashboardToggleIcon').innerText = '▶';
    } else {
        dashboardContent.classList.add('open');
        dashboardContent.style.maxHeight = dashboardContent.scrollHeight + 'px';
        dashboardContent.style.opacity = '1';
        document.getElementById('dashboardToggleIcon').innerText = '▼';
    }
}

function toggleHistoryDetails(id){
    const content = document.getElementById(`detail-${id}`);
    const icon = document.getElementById(`icon-detail-${id}`);
    if (!content) return;
    const open = content.classList.contains('open');
    if (open) {
        applyOpen(content, false);
        icon.innerText = '▶';
    } else {
        applyOpen(content, true);
        icon.innerText = '▼';
    }
}

// === Firebase realtime listener & auth (保持原有功能) ===
function setupRealtimeListener(user) {
    if (!user || !db) return;
    if (firebaseUnsubscribe) { firebaseUnsubscribe(); firebaseUnsubscribe = null; }
    const userRef = db.collection('records').doc(user.uid);
    firebaseUnsubscribe = userRef.onSnapshot((doc) => {
        if (doc.exists) {
            const cloudList = doc.data().data || [];
            const currentLocalList = getHistory();
            if (JSON.stringify(cloudList) !== JSON.stringify(currentLocalList)) {
                saveToHistory(cloudList);
                refreshDashboard();
            } else {
                refreshDashboard();
            }
        } else {
            const localList = getHistory();
            if (localList.length > 0) uploadHistory(localList, user);
            else refreshDashboard();
        }
    }, (error) => { console.error(error); alert(`實時同步發生錯誤: ${error.message}`); refreshDashboard(); });
}

function toggleAuthPanel(){ document.getElementById('authPanel').classList.toggle('hidden'); }
function registerUser(){ /* unchanged */
    const email = document.getElementById('authEmail').value;
    const password = document.getElementById('authPassword').value;
    if (email.length < 5 || password.length < 6) return alert("Email 或密碼格式不正確 (密碼需至少6位)");
    if (!db) return alert("Firebase 資料庫未初始化，請檢查配置。");
    firebase.auth().createUserWithEmailAndPassword(email, password)
        .then((userCredential) => { document.getElementById('authPanel').classList.add('hidden'); })
        .catch((error) => { alert(`註冊失敗: ${error.message}`); });
}
function loginUser(){ /* unchanged */
    const email = document.getElementById('authEmail').value;
    const password = document.getElementById('authPassword').value;
    if (!db) return alert("Firebase 資料庫未初始化，請檢查配置。");
    firebase.auth().signInWithEmailAndPassword(email, password)
        .then((userCredential) => { document.getElementById('authPanel').classList.add('hidden'); })
        .catch((error) => { alert(`登入失敗: ${error.message}`); });
}
function logoutUser(){ if (!db) return alert("Firebase 資料庫未初始化，請檢查配置。"); if (firebaseUnsubscribe){ firebaseUnsubscribe(); firebaseUnsubscribe = null; } firebase.auth().signOut().then(()=>{ localStorage.removeItem('uber_ray_v1'); document.getElementById('authPanel').classList.add('hidden'); alert('登出成功，本機紀錄已清除。下次登入將自動同步雲端資料。'); }).catch(e=>{ alert(`登出失敗: ${e.message}`); }); }
function resetPassword(){ const email = document.getElementById('authEmail').value; if(!email) return alert('請先輸入您的 Email！'); if(!db) return alert('Firebase 資料庫未初始化，請檢查配置。'); firebase.auth().sendPasswordResetEmail(email).then(()=>alert('密碼重設郵件已寄出，請檢查您的信箱！')).catch(e=>alert(`密碼重設失敗: ${e.message}`)); }

async function uploadHistory(data, user) { user = user || firebase.auth().currentUser; if (!user || !db) return; try{ await db.collection('records').doc(user.uid).set({ data: data, lastUpdated: firebase.firestore.FieldValue.serverTimestamp() }); }catch(e){ console.error(e); } }

// === 設定處理：將預設油耗改為 39、耗材改為 0.7（需求6） ===
function loadSettings(){
    document.getElementById('settingFuelRate').value = localStorage.getItem('fuelRate') || 39;
    document.getElementById('settingMaint').value = localStorage.getItem('maintCost') || 0.7;
    document.getElementById('oilType').value = localStorage.getItem('oilType') || '95';
}
function saveSettings(){ localStorage.setItem('fuelRate', document.getElementById('settingFuelRate').value); localStorage.setItem('maintCost', document.getElementById('settingMaint').value); localStorage.setItem('oilType', document.getElementById('oilType').value); document.getElementById('settingsPanel').classList.add('hidden'); refreshDashboard(); }
function toggleSettings(){ document.getElementById('settingsPanel').classList.toggle('hidden'); }

// fetchOilPrice 保持
async function fetchOilPrice(){ try{ const type = document.getElementById('oilType').value; const res = await fetch(workerAPI); const data = await res.json(); if (data[type]){ globalOilPrice = parseFloat(data[type]); document.getElementById('oilPriceDisplay').innerText = `$${globalOilPrice}`; } else { document.getElementById('oilPriceDisplay').innerText = `$${globalOilPrice} (預設/API錯誤)`; } }catch(e){ document.getElementById('oilPriceDisplay').innerText = `$${globalOilPrice} (預設/網路錯誤)`; } }

// === 歷史資料 CRUD（保持邏輯不變） ===
function getHistory(){ try{ return JSON.parse(localStorage.getItem('uber_ray_v1') || '[]'); }catch{ return []; } }
function saveToHistory(data){ localStorage.setItem('uber_ray_v1', JSON.stringify(data)); }

function saveRecord(){
    const date = document.getElementById('inputDate').value;
    const income = parseFloat(document.getElementById('inputIncome').value);
    const orders = parseFloat(document.getElementById('inputOrders').value);
    const km = parseFloat(document.getElementById('inputDist').value);
    const hr = parseFloat(document.getElementById('inputHr').value) || 0;
    const min = parseFloat(document.getElementById('inputMin').value) || 0;
    const editId = document.getElementById('editId').value;
    const lockedOil = document.getElementById('recordOilPrice').value;

    if(!date) return console.error('請選日期');
    if(isNaN(income) || isNaN(km)) return console.error('請填寫金額與里程');

    const finalOil = (editId && lockedOil) ? parseFloat(lockedOil) : globalOilPrice;
    const rec = {
        id: editId ? parseInt(editId) : Date.now(),
        date: date, income: income, orders: orders||0, km: km, hours: hr+(min/60),
        oilPrice: finalOil,
        fuelRate: parseFloat(document.getElementById('settingFuelRate').value),
        maintCost: parseFloat(document.getElementById('settingMaint').value)
    };

    const list = getHistory();
    if(editId){ const idx = list.findIndex(r=>r.id==editId); if(idx!==-1) list[idx]=rec; } else { list.push(rec); if (date === getLocalDateString()) { currentFilter = 'day'; updateTabs(); } }
    list.sort((a,b)=>new Date(b.date)-new Date(a.date));
    saveToHistory(list);
    uploadHistory(list);
    resetEditor();
}

function loadRecordToEditor(id){
    const r = getHistory().find(i=>i.id===id);
    if(!r) return;
    document.getElementById('editorContent').classList.add('open');
    document.getElementById('editorContent').style.maxHeight = document.getElementById('editorContent').scrollHeight+'px';
    document.getElementById('editorToggleIcon').innerText = '▼';
    localStorage.removeItem('editorCollapsed');

    document.getElementById('editId').value = r.id;
    document.getElementById('recordOilPrice').value = r.oilPrice || globalOilPrice;
    document.getElementById('inputDate').value = r.date;
    document.getElementById('inputIncome').value = r.income;
    document.getElementById('inputOrders').value = r.orders;
    document.getElementById('inputDist').value = r.km;
    const h = Math.floor(r.hours);
    document.getElementById('inputHr').value = h;
    document.getElementById('inputMin').value = Math.round((r.hours-h)*60);

    const hint = document.getElementById('editorOilHint');
    hint.classList.remove('hidden');
    hint.innerText = `鎖定油價: $${r.oilPrice||globalOilPrice}`;

    document.querySelector('#editorCard h3').innerText = '編輯紀錄';
    document.getElementById('editorCard').classList.add('card-glow');
    document.getElementById('btnSave').innerText = '確認修改';
    document.getElementById('btnDelete').classList.remove('hidden');
    document.getElementById('btnCancel').classList.remove('hidden');
    document.getElementById('editorCard').scrollIntoView({behavior:'smooth'});
}

function deleteCurrentRecord(){ console.warn('執行刪除操作。'); const id = document.getElementById('editId').value; if(!id) return; const list = getHistory(); const newList = list.filter(r=>r.id!=id); saveToHistory(newList); uploadHistory(newList); resetEditor(); }

function resetEditor(){ document.getElementById('editId').value = ''; document.getElementById('recordOilPrice').value = ''; document.getElementById('inputDate').value = getLocalDateString(); document.getElementById('inputIncome').value = ''; document.getElementById('inputOrders').value = ''; document.getElementById('inputDist').value = ''; document.getElementById('inputHr').value = ''; document.getElementById('inputMin').value = ''; document.querySelector('#editorCard h3').innerText = '新增紀錄'; document.getElementById('editorOilHint').classList.add('hidden'); document.getElementById('editorCard').classList.remove('card-glow'); document.getElementById('btnSave').innerText = '儲存'; document.getElementById('btnDelete').classList.add('hidden'); document.getElementById('btnCancel').classList.add('hidden'); }

// 篩選與儀表板更新
function updateTabs(btn){ document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active')); if(btn) btn.classList.add('active'); else { const buttons = document.querySelectorAll('.tab-scroll-content .tab-btn'); const map={'day':0,'week':1,'month':2,'year':3,'all':4,'custom':5}; buttons[map[currentFilter]]?.classList.add('active'); } }
function applyCustomFilter(){ if (currentFilter==='custom'){ const start=document.getElementById('filterStart').value; const end=document.getElementById('filterEnd').value; if(start && end) refreshDashboard(); } }
function setFilter(type, btn){ currentFilter=type; updateTabs(btn); const customPanel=document.getElementById('customDateFilter'); if(type==='custom'){ customPanel.classList.remove('hidden'); applyCustomFilter(); } else { customPanel.classList.add('hidden'); refreshDashboard(); } }

function getFilteredData(){ const list = getHistory(); const todayStr = getLocalDateString(); if(currentFilter==='day') return list.filter(r=>r.date===todayStr); if(currentFilter==='week'){ const d=new Date(); const dayOfWeek=(d.getDay()+6)%7; const startDate=new Date(d); startDate.setDate(d.getDate()-dayOfWeek); const startDateStr=startDate.toISOString().split('T')[0]; return list.filter(r=>r.date>=startDateStr); } if(currentFilter==='month') return list.filter(r=>r.date.startsWith(todayStr.slice(0,7))); if(currentFilter==='year') return list.filter(r=>r.date.startsWith(todayStr.slice(0,4))); if(currentFilter==='all') return list; if(currentFilter==='custom'){ const start=document.getElementById('filterStart').value; const end=document.getElementById('filterEnd').value; return list.filter(r=>r.date>=start && r.date<=end); } return list; }

function calculateRecordStats(record){ const { income, orders, km, hours, oilPrice, fuelRate, maintCost } = record; const oilCost = (km / fuelRate) * oilPrice; const maintenanceCost = km * maintCost; const totalCost = oilCost + maintenanceCost; const netProfit = income - totalCost; const grossHourly = hours > 0 ? income / hours : 0; const netHourly = hours > 0 ? netProfit / hours : 0; const grossPerOrder = orders > 0 ? income / orders : 0; const netPerOrder = orders > 0 ? netProfit / orders : 0; return { ...record, oilCost: oilCost, maintenanceCost: maintenanceCost, totalCost: totalCost, netProfit: netProfit, grossHourly: grossHourly, netHourly: netHourly, grossPerOrder: grossPerOrder, netPerOrder: netPerOrder }; }

function refreshDashboard(){ const filtered = getFilteredData().map(calculateRecordStats); const totals = filtered.reduce((acc,r)=>{ acc.totalIncome+=r.income; acc.totalCost+=r.totalCost; acc.netProfit+=r.netProfit; acc.totalOilCost+=r.oilCost; acc.totalMaintCost+=r.maintenanceCost; acc.totalOrders+=r.orders; acc.totalHours+=r.hours; return acc; }, { totalIncome:0, totalCost:0, netProfit:0, totalOilCost:0, totalMaintCost:0, totalOrders:0, totalHours:0 }); const totalMinutes = totals.totalHours*60; const totalGrossHourly = totals.totalHours>0? totals.totalIncome/totals.totalHours:0; const totalNetHourly = totals.totalHours>0? totals.netProfit/totals.totalHours:0; const totalGrossPerOrder = totals.totalOrders>0? totals.totalIncome/totals.totalOrders:0; const totalNetPerOrder = totals.totalOrders>0? totals.netProfit/totals.totalOrders:0; document.getElementById('dashTotalIncome').innerText = formatCurrency(totals.totalIncome); document.getElementById('dashTotalCost').innerText = formatCurrency(totals.totalCost); document.getElementById('dashNetProfit').innerText = formatCurrency(totals.netProfit); document.getElementById('dashOilCost').innerText = formatCurrency(totals.totalOilCost); document.getElementById('dashMaintCost').innerText = formatCurrency(totals.totalMaintCost); document.getElementById('dashOrders').innerText = totals.totalOrders.toFixed(0); document.getElementById('dashHours').innerText = Math.floor(totals.totalHours); document.getElementById('dashMinutes').innerText = Math.round((totals.totalHours-Math.floor(totals.totalHours))*60); document.getElementById('dashGrossHourly').innerText = formatCurrency(totalGrossHourly); document.getElementById('dashNetHourly').innerText = formatCurrency(totalNetHourly); document.getElementById('dashGrossPerOrder').innerText = formatCurrency(totalGrossPerOrder); document.getElementById('dashNetPerOrder').innerText = formatCurrency(totalNetPerOrder);

    const listHtml = filtered.map(r=>`
        <div class="history-item">
            <div class="history-header-wrapper">
                <div class="history-main-area" onclick="loadRecordToEditor(${r.id})">
                    <div class="history-top-row">
                        <div class="history-stat-group w-1/3">
                            <div class="text-sm font-semibold">${r.date.slice(5)}</div>
                            <div class="history-main-value">$${formatCurrency(r.income)}</div>
                            <div class="stat-label-small">總營收</div>
                        </div>
                        
                        <div class="history-stat-group center w-1/3">
                            <div class="text-sm font-semibold">成本</div>
                            <div class="history-main-value">$${formatCurrency(r.totalCost)}</div>
                            <div class="stat-label-small">油耗 + 耗材</div>
                        </div>

                        <div class="history-stat-group right w-1/3">
                            <div class="text-sm font-semibold">淨利</div>
                            <div class="history-main-value">$${formatCurrency(r.netProfit)}</div>
                            <div class="stat-label-small">實賺</div>
                        </div>
                    </div>
                </div>
                <span id="icon-detail-${r.id}" class="history-toggle-icon" onclick="event.stopPropagation(); toggleHistoryDetails(${r.id});">▶</span>
            </div>

            <div id="detail-${r.id}" class="history-sub-stats collapsible">
                <div class="flex flex-col gap-1 w-full">
                    <div class="flex justify-between items-center">
                        <span class="stat-label-small">單數/里程</span>
                        <span class="text-[var(--text)]">${r.orders} 單 / ${r.km.toFixed(1)} KM</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="stat-label-small">工時</span>
                        <span class="text-[var(--text)]">${formatDuration(r.hours)}</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="stat-label-small">油/耗材成本</span>
                        <span class="text-[var(--danger)]">$${formatCurrency(r.oilCost)} / $${formatCurrency(r.maintenanceCost)}</span>
                    </div>
                </div>
                
                <div class="w-full performance-summary flex flex-col gap-1">
                     <div class="flex justify-between items-center">
                        <span class="stat-label-small">已扣成本時薪</span>
                        <span class="text-[var(--text)] font-bold">$${formatCurrency(r.netHourly)}</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="stat-label-small">每單平均營收</span>
                        <span class="text-[var(--beige-accent)]">$${formatCurrency(r.grossPerOrder)}</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="stat-label-small">每單平均淨利</span>
                        <span class="text-[var(--text)] font-bold">$${formatCurrency(r.netPerOrder)}</span>
                    </div>
                </div>
            </div>
        </div>
    `).join('');

    document.getElementById('historyList').innerHTML = listHtml || `
        <div class="p-5 text-center text-[var(--muted)] text-sm">--- 此區間暫無紀錄 ---</div>
    `;
    if (!document.getElementById('chartsPanel').classList.contains('hidden')) updateChart();
}

function formatCurrency(num){ if(isNaN(num)) return '0'; const isNegative = num<0; const formatted = Math.abs(num).toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ","); return isNegative? `-${formatted}`:formatted; }
function formatDuration(totalHours){ const hours = Math.floor(totalHours); const minutes = Math.round((totalHours-hours)*60); let str=''; if(hours>0) str += `${hours}h`; if(minutes>0) str += `${minutes}m`; if(hours===0 && minutes===0) return '0m'; return str.trim(); }

// 圖表（小改色系為 beige 主色）
function toggleCharts(){ const panel=document.getElementById('chartsPanel'); panel.classList.toggle('hidden'); if(!panel.classList.contains('hidden')) updateChart(); else destroyChart(); }
function switchChartType(type){ chartType=type; document.getElementById('btnChartBar').classList.remove('active'); document.getElementById('btnChartPie').classList.remove('active'); document.getElementById(`btnChart${type.charAt(0).toUpperCase()+type.slice(1)}`).classList.add('active'); updateChart(); }
function destroyChart(){ if(chartInstance){ chartInstance.destroy(); chartInstance=null; } }

function updateChart(){ destroyChart(); const start=document.getElementById('chartStart').value; const end=document.getElementById('chartEnd').value; const groupBy=document.getElementById('chartGroupBy').value; if(!start||!end) return; const allData=getHistory().map(calculateRecordStats); const chartData=allData.filter(r=>r.date>=start && r.date<=end); if(chartData.length===0){ const ctx=document.getElementById('mainChart').getContext('2d'); if(ctx) ctx.clearRect(0,0,300,300); return; }
    let groupedData={};
    if(groupBy==='day'){ chartData.forEach(r=>{ const label=r.date.slice(5); if(!groupedData[label]) groupedData[label]={ income:0, netProfit:0, cost:0, orders:0 }; groupedData[label].income+=r.income; groupedData[label].netProfit+=r.netProfit; groupedData[label].cost+=r.totalCost; groupedData[label].orders+=r.orders; }); }
    else if(groupBy==='month'){ chartData.forEach(r=>{ const label=r.date.slice(0,7); if(!groupedData[label]) groupedData[label]={ income:0, netProfit:0, cost:0, orders:0 }; groupedData[label].income+=r.income; groupedData[label].netProfit+=r.netProfit; groupedData[label].cost+=r.totalCost; groupedData[label].orders+=r.orders; }); }
    else if(groupBy==='year'){ chartData.forEach(r=>{ const label=r.date.slice(0,4); if(!groupedData[label]) groupedData[label]={ income:0, netProfit:0, cost:0, orders:0 }; groupedData[label].income+=r.income; groupedData[label].netProfit+=r.netProfit; groupedData[label].cost+=r.totalCost; groupedData[label].orders+=r.orders; }); }
    const labels=Object.keys(groupedData).sort(); const ctx=document.getElementById('mainChart').getContext('2d');
    if(chartType==='bar'){
        chartInstance = new Chart(ctx, {
            type: 'bar',
            data: { labels: labels, datasets: [ { label: '淨利潤', data: labels.map(l=>groupedData[l].netProfit), backgroundColor: 'rgba(177,134,75,0.95)', borderRadius:4, }, { label: '總成本', data: labels.map(l=>groupedData[l].cost), backgroundColor: 'rgba(239,68,68,0.9)', borderRadius:4, } ] },
            options: { responsive:true, maintainAspectRatio:false, scales:{ x:{ stacked:true, grid:{ display:false, color:'#eee' }, ticks:{ color:'#7a6f5b' } }, y:{ stacked:true, beginAtZero:true, grid:{ color:'#eee' }, ticks:{ color:'#7a6f5b' } } }, plugins:{ legend:{ labels:{ color:'#2b2b2b' } }, tooltip:{ callbacks:{ label:(context)=>{ let label=context.dataset.label||''; if(label) label += ': '; if(context.parsed.y!==null) label += `$${context.parsed.y.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ',')}`; return label; } } } } }
        });
    } else if(chartType==='pie'){
        const totalOilCost = chartData.reduce((s,r)=>s+r.oilCost,0);
        const totalMaintCost = chartData.reduce((s,r)=>s+r.maintenanceCost,0);
        const totalNetProfit = chartData.reduce((s,r)=>s+r.netProfit,0);
        chartInstance = new Chart(ctx, { type:'pie', data:{ labels:['總淨利','總油耗成本','總耗材成本'], datasets:[{ data:[totalNetProfit,totalOilCost,totalMaintCost], backgroundColor:['rgba(177,134,75,0.95)','rgba(252,211,77,0.95)','rgba(239,68,68,0.9)'], hoverOffset:4 }] }, options:{ responsive:true, maintainAspectRatio:false, plugins:{ legend:{ position:'top', labels:{ color:'#2b2b2b' } }, tooltip:{ callbacks:{ label:(context)=>{ const total = context.chart.data.datasets[0].data.reduce((a,b)=>a+b,0); const value = context.raw; const percentage = ((value/total)*100).toFixed(1)+'%'; return `${context.label}: $${value.toFixed(0)} (${percentage})`; } } } } });
    }
}
</script>
</body>
</html>
