<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
<title>UBE Salary Calculator V3.0</title>

<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<meta name="theme-color" content="#F3F0EA">
<link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/732/732200.png">

<meta property="og:title" content="UBE Salary Calculator V3.0" />
<meta property="og:description" content="UBE å¤–é€è–ªè³‡è¨ˆç®—å™¨ V3.0ï¼ŒBeige é¢¨æ ¼ï¼Œå®Œæ•´æ•¸æ“šåˆ†æã€‚" />

<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
    /* === å…¨å±€ Beige è‰²ç³»è¨­å®š === */
    :root {
        --bg-color: #F3F0EA;      /* æ·ºç±³è‰²èƒŒæ™¯ */
        --card-bg: #FFFFFF;       /* ç´”ç™½å¡ç‰‡ */
        --text-main: #433E3F;     /* æ·±è¤ç°æ–‡å­— */
        --text-sub: #8C8788;      /* æ·ºç°æ–‡å­— */
        --accent-color: #6366F1;  /* é‡é»è‰² (ç´«/è—) */
        --success-color: #10B981; /* ç¶ è‰² (æ·¨åˆ©) */
        --danger-color: #EF4444;  /* ç´…è‰² (æˆæœ¬) */
        --warn-color: #F59E0B;    /* æ©˜é»ƒ (ç‡Ÿæ”¶/æœªæ‰£æˆæœ¬) */
        --input-bg: #F9F7F5;      /* è¼¸å…¥æ¡†èƒŒæ™¯ */
    }

    body { 
        background-color: var(--bg-color); 
        color: var(--text-main); 
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; 
        padding-bottom: 120px;
        padding-top: env(safe-area-inset-top);
        -webkit-font-smoothing: antialiased;
    }
    
    /* === å¡ç‰‡èˆ‡æ¨™é¡Œ === */
    .section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0 0.5rem 0.5rem 0.5rem;
        cursor: pointer;
    }
    .section-title {
        font-size: 0.85rem;
        font-weight: 700;
        color: var(--text-sub);
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }
    .toggle-icon {
        color: var(--text-sub);
        transition: transform 0.3s ease;
    }
    .toggle-icon.rotated {
        transform: rotate(-180deg);
    }

    .card {
        background-color: var(--card-bg);
        border: 1px solid white;
        border-radius: 1.25rem;
        padding: 1.25rem;
        margin-bottom: 1.5rem; /* å¢åŠ é–“è· */
        box-shadow: 0 4px 20px rgba(0,0,0,0.03);
        overflow: hidden; /* ç¢ºä¿å…§å®¹ä¸æº¢å‡º */
    }
    
    .card-highlight {
        border: 1px solid var(--accent-color);
        box-shadow: 0 4px 15px rgba(99, 102, 241, 0.15);
    }

    /* === æ”¶åˆå‹•ç•« === */
    .collapsible-content {
        max-height: 2000px; /* è¶³å¤ å¤§çš„é«˜åº¦ */
        opacity: 1;
        transition: max-height 0.4s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.3s ease-out, margin 0.3s ease;
        overflow: hidden;
    }
    .collapsible-content.collapsed {
        max-height: 0;
        opacity: 0;
        margin: 0;
        padding-top: 0;
        padding-bottom: 0;
        border: none;
    }

    /* === è¼¸å…¥æ¡† === */
    .input-field {
        background-color: var(--input-bg);
        border: 1px solid transparent;
        color: var(--text-main);
        border-radius: 0.75rem;
        padding: 0.8rem 1rem;
        width: 100%;
        font-size: 1rem;
        font-weight: 500;
        transition: 0.2s;
    }
    .input-field:focus { 
        outline: none; 
        background-color: #fff;
        border-color: var(--accent-color); 
        box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
    }

    /* === æŒ‰éˆ• === */
    .btn { 
        width: 100%; padding: 0.9rem; border-radius: 0.75rem; font-weight: 600; 
        display: flex; justify-content: center; align-items: center; transition: 0.2s; 
    }
    .btn-primary { background-color: var(--text-main); color: white; }
    .btn-primary:active { transform: scale(0.98); }
    .btn-danger { background-color: #FEF2F2; color: #DC2626; border: 1px solid #FEE2E2; }
    .btn-ghost { background-color: transparent; border: 1px solid #D1D5DB; color: #6B7280; }

    /* === ç¯©é¸ Tab === */
    .tab-scroll-container {
        width: 100%; overflow-x: auto; padding-bottom: 0.5rem; scrollbar-width: none; 
    }
    .tab-scroll-container::-webkit-scrollbar { display: none; }
    .tab-scroll-content { display: flex; gap: 0.5rem; padding: 0 0.5rem; }
    .tab-btn {
        padding: 0.5rem 1.2rem; border-radius: 99px; font-size: 0.9rem; color: var(--text-sub); 
        background: transparent; border: 1px solid transparent; white-space: nowrap; font-weight: 500; transition: 0.2s;
    }
    .tab-btn.active { 
        background-color: var(--text-main); color: #fff; box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    }

    /* === æ­·å²åˆ—è¡¨ === */
    .history-item {
        background-color: var(--card-bg);
        border-bottom: 1px solid var(--bg-color);
        padding: 1.2rem 1rem;
    }
    .history-item:last-child { border-bottom: none; }
    .history-main-area { cursor: pointer; }
    .history-toggle-icon { color: #D1D5DB; transition: transform 0.2s; cursor: pointer; padding: 5px; }

    /* === å„€è¡¨æ¿èˆ‡æ•¸æ“šæ–‡å­— === */
    .stat-label { font-size: 0.7rem; color: #9CA3AF; text-transform: uppercase; font-weight: 600; margin-bottom: 2px; }
    .stat-val-lg { font-size: 1.5rem; font-weight: 700; line-height: 1.1; }
    .stat-val-md { font-size: 1.1rem; font-weight: 700; }
    .stat-val-sm { font-size: 0.9rem; font-weight: 600; }

    .text-profit { color: var(--success-color); }
    .text-cost { color: var(--danger-color); }
    .text-income { color: var(--warn-color); }

    /* V1.2.16 é¢¨æ ¼çš„è©³ç´°æ•¸æ“š Grid */
    .detail-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 0.75rem;
        padding-top: 0.75rem;
    }
    .detail-row {
        display: flex;
        flex-direction: column;
        align-items: center;
        text-align: center;
    }
    
    .divider { border-top: 1px solid #F3F4F6; margin: 1rem 0; }
    
    .footer-credit { text-align: center; margin-top: 2rem; color: #A8A29E; font-size: 0.7rem; }
</style>
</head>
<body class="max-w-md mx-auto p-4">

    <div class="flex justify-between items-center mb-6 px-1 pt-2">
        <div>
            <h1 class="text-2xl font-bold text-[#433E3F] tracking-tight">UBE Salary Calculator</h1>
            <div class="text-xs text-gray-400 font-medium">V3.0 Stable</div>
        </div>
        <div class="flex gap-2">
            <button onclick="toggleAuthPanel()" class="w-9 h-9 flex items-center justify-center bg-white rounded-full shadow-sm border border-gray-100 text-gray-400 active:scale-95 transition">â˜ï¸</button>
            <button onclick="toggleSettings()" class="w-9 h-9 flex items-center justify-center bg-white rounded-full shadow-sm border border-gray-100 text-gray-400 active:scale-95 transition">âš™ï¸</button>
        </div>
    </div>

    <div id="authWrapper">
        <div class="section-header hidden" id="authHeader" onclick="togglePanel('auth')">
            <span class="section-title text-blue-500">Cloud Sync</span>
            <span class="toggle-icon" id="authIcon">â–¼</span>
        </div>
        <div id="authPanel" class="card hidden border-l-4 border-l-blue-500">
            <h3 class="text-blue-500 font-bold mb-3 text-sm uppercase">Firebase é›²ç«¯é©—è­‰</h3>
            <div id="authContent">
                <div id="authForm" class="grid grid-cols-1 gap-3 mb-3">
                    <input id="authEmail" type="email" class="input-field" placeholder="Email" />
                    <input id="authPassword" type="password" class="input-field" placeholder="Password" />
                    <button onclick="registerUser()" class="btn btn-primary text-sm">è¨»å†Šå¸³è™Ÿ</button>
                    <button onclick="loginUser()" class="btn btn-ghost text-sm">ç™»å…¥</button>
                    <button onclick="resetPassword()" class="text-xs text-center text-gray-400 mt-2">å¿˜è¨˜å¯†ç¢¼ï¼Ÿ</button>
                </div>
                <div id="userInfo" class="hidden text-center">
                    <p class="text-gray-600 mb-3 text-sm">å·²ç™»å…¥ï¼š<span id="userEmailDisplay" class="font-bold text-gray-800"></span></p>
                    <button onclick="logoutUser()" class="btn btn-danger text-sm">ç™»å‡º</button>
                </div>
            </div>
        </div>
    </div>

    <div id="settingsWrapper">
        <div class="section-header hidden" id="settingsHeader" onclick="togglePanel('settings')">
            <span class="section-title">Settings</span>
            <span class="toggle-icon" id="settingsIcon">â–¼</span>
        </div>
        <div id="settingsPanel" class="card hidden border-l-4 border-l-gray-500">
            <div class="grid grid-cols-2 gap-4 mb-4">
                <div>
                    <label class="stat-label block">æ²¹å“é¡å‹</label>
                    <select id="oilType" class="input-field" onchange="fetchOilPrice()">
                        <option value="92">92 ç„¡é‰›</option>
                        <option value="95">95 ç„¡é‰›</option>
                        <option value="98">98 ç„¡é‰›</option>
                        <option value="diesel">æŸ´æ²¹</option>
                    </select>
                </div>
                <div>
                    <label class="stat-label block">å³æ™‚æ²¹åƒ¹</label>
                    <div id="oilPriceDisplay" class="input-field bg-yellow-50 text-yellow-600 font-bold flex items-center">Loading...</div>
                </div>
                <div>
                    <label class="stat-label block">æ²¹è€— (km/L)</label>
                    <input id="settingFuelRate" type="number" class="input-field" />
                </div>
                <div>
                    <label class="stat-label block">è€—æ ($/km)</label>
                    <input id="settingMaint" type="number" step="0.1" class="input-field" />
                </div>
            </div>
            <button onclick="saveSettings()" class="btn btn-primary text-sm">å„²å­˜è¨­å®š</button>
        </div>
    </div>

    <div id="editorWrapper">
        <div class="section-header" onclick="togglePanel('editor')">
            <span class="section-title">Add Record</span>
            <span class="toggle-icon" id="editorIcon">â–¼</span>
        </div>
        
        <div id="editorPanel" class="card collapsible-content">
            <div id="editorContent">
                <input type="hidden" id="editId" value="">
                <input type="hidden" id="recordOilPrice" value=""> 
                
                <div class="flex justify-end items-center mb-2">
                     <span id="editorOilHint" class="text-xs text-yellow-600 bg-yellow-50 px-2 py-1 rounded hidden">Locked Oil: --</span>
                </div>

                <div class="flex flex-col gap-4 mb-4">
                    <div>
                        <label class="stat-label block">æ—¥æœŸ</label>
                        <input id="inputDate" type="date" class="input-field cursor-pointer" onclick="this.showPicker()" />
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="stat-label block">ç‡Ÿæ¥­é¡</label>
                            <input id="inputIncome" type="number" inputmode="numeric" class="input-field font-bold text-lg text-gray-800" placeholder="$0" />
                        </div>
                        <div>
                            <label class="stat-label block">å–®æ•¸</label>
                            <input id="inputOrders" type="number" inputmode="numeric" class="input-field" placeholder="0" />
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4 mb-6">
                    <div>
                        <label class="stat-label block">é‡Œç¨‹ (KM)</label>
                        <input id="inputDist" type="number" step="0.1" inputmode="decimal" class="input-field" placeholder="0.0" />
                    </div>
                    <div>
                        <label class="stat-label block">å·¥æ™‚</label>
                        <div class="flex gap-2">
                            <input id="inputHr" type="number" class="input-field text-center px-1" placeholder="H" />
                            <input id="inputMin" type="number" class="input-field text-center px-1" placeholder="M" />
                        </div>
                    </div>
                </div>

                <div class="flex gap-3">
                    <button onclick="saveRecord()" class="btn btn-primary shadow-lg shadow-gray-400/20" id="btnSave">Save Record</button>
                    <button onclick="deleteCurrentRecord()" class="btn btn-danger hidden" id="btnDelete">Delete</button>
                    <button onclick="resetEditor()" class="btn btn-ghost hidden" id="btnCancel">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <div id="dashboardWrapper">
        <div class="section-header" onclick="togglePanel('dashboard')">
            <span class="section-title">Dashboard</span>
            <span class="toggle-icon" id="dashboardIcon">â–¼</span>
        </div>

        <div id="dashboardPanel" class="card collapsible-content p-5">
            <div id="dashboardContent">
                <div class="grid grid-cols-3 gap-2 text-center mb-4">
                    <div class="flex flex-col items-center">
                        <span class="stat-label">ç¸½ç‡Ÿæ”¶</span>
                        <div class="stat-val-lg text-income tracking-tight">$<span id="dashTotalIncome">0</span></div>
                    </div>
                    <div class="flex flex-col items-center">
                        <span class="stat-label">ç¸½æˆæœ¬</span>
                        <div class="stat-val-lg text-cost tracking-tight">$<span id="dashTotalCost">0</span></div>
                    </div>
                    <div class="flex flex-col items-center">
                        <span class="stat-label">ç¸½æ·¨åˆ©</span>
                        <div class="stat-val-lg text-profit tracking-tight">$<span id="dashNetProfit">0</span></div>
                    </div>
                </div>

                <div class="divider"></div>

                <div class="grid grid-cols-3 gap-2 text-center mb-2">
                    <div class="flex flex-col items-center">
                        <span class="stat-label">æ²¹è€—æˆæœ¬</span>
                        <div class="stat-val-md text-cost">$<span id="dashOilCost">0</span></div>
                    </div>
                    <div class="flex flex-col items-center">
                        <span class="stat-label">è€—ææˆæœ¬</span>
                        <div class="stat-val-md text-cost">$<span id="dashMaintCost">0</span></div>
                    </div>
                    <div class="flex flex-col items-center">
                        <span class="stat-label">ç¸½å–®æ•¸ / å·¥æ™‚</span>
                        <div class="stat-val-sm text-gray-700 mt-1">
                            <span id="dashOrders">0</span>å–® | <span id="dashHours">0</span>h<span id="dashMinutes">0</span>
                        </div>
                    </div>
                </div>

                <div class="divider"></div>

                <div class="detail-grid">
                    <div class="detail-row">
                        <span class="stat-label text-income">æœªæ‰£æˆæœ¬æ™‚è–ª</span>
                        <div class="stat-val-md text-income">$<span id="dashGrossHourly">0</span></div>
                    </div>
                    <div class="detail-row">
                        <span class="stat-label text-profit">å·²æ‰£æˆæœ¬æ™‚è–ª (å¯¦è–ª)</span>
                        <div class="stat-val-md text-profit">$<span id="dashNetHourly">0</span></div>
                    </div>
                </div>

                <div class="divider"></div>

                <div class="detail-grid">
                    <div class="detail-row">
                        <span class="stat-label text-income">æ¯å–®å¹³å‡ç‡Ÿæ”¶</span>
                        <div class="stat-val-md text-income">$<span id="dashGrossPerOrder">0</span></div>
                    </div>
                    <div class="detail-row">
                        <span class="stat-label text-profit">æ¯å–®å¹³å‡æ·¨åˆ©</span>
                        <div class="stat-val-md text-profit">$<span id="dashNetPerOrder">0</span></div>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <div class="tab-scroll-container mb-4">
        <div class="tab-scroll-content">
            <button class="tab-btn active" onclick="setFilter('day', this)">Today</button>
            <button class="tab-btn" onclick="setFilter('week', this)">Week</button>
            <button class="tab-btn" onclick="setFilter('month', this)">Month</button>
            <button class="tab-btn" onclick="setFilter('year', this)">Year</button>
            <button class="tab-btn" onclick="setFilter('all', this)">All</button>
            <button class="tab-btn" onclick="setFilter('custom', this)">Custom</button> 
            <button class="tab-btn text-[#6366F1]" onclick="toggleCharts()">ğŸ“Š Analysis</button>
        </div>
    </div>
    
    <div id="customDateFilter" class="card p-4 mb-4 hidden">
        <h3 class="text-xs font-bold text-gray-400 mb-3 uppercase">Select Date Range</h3>
        <div class="flex gap-3 items-center">
            <input type="date" id="filterStart" class="input-field text-sm py-2" onchange="applyCustomFilter()" />
            <span class="text-gray-400">to</span>
            <input type="date" id="filterEnd" class="input-field text-sm py-2" onchange="applyCustomFilter()" />
        </div>
    </div>

    <div id="chartsWrapper">
        <div class="section-header hidden" id="chartsHeader" onclick="togglePanel('charts')">
            <span class="section-title">Analytics</span>
            <span class="toggle-icon" id="chartsIcon">â–¼</span>
        </div>
        <div id="chartsPanel" class="card hidden mb-4">
            <div class="flex justify-between items-center mb-4">
                <div class="flex bg-gray-100 rounded-lg p-1">
                    <button onclick="switchChartType('bar')" id="btnChartBar" class="px-3 py-1 text-xs rounded font-bold text-gray-500">Trends</button>
                    <button onclick="switchChartType('pie')" id="btnChartPie" class="px-3 py-1 text-xs rounded font-bold text-gray-500">Share</button>
                </div>
            </div>

            <div class="bg-gray-50 p-3 rounded-xl mb-4 border border-gray-100">
                <div class="flex gap-2 mb-2">
                    <input type="date" id="chartStart" class="input-field text-xs py-1" onchange="updateChart()" />
                    <span class="text-gray-400 self-center">~</span>
                    <input type="date" id="chartEnd" class="input-field text-xs py-1" onchange="updateChart()" />
                </div>
                <div class="flex items-center gap-2">
                    <label class="text-xs text-gray-500">Group By:</label>
                    <select id="chartGroupBy" class="input-field text-xs py-1" onchange="updateChart()">
                        <option value="day">Daily</option>
                        <option value="month">Monthly</option>
                        <option value="year">Yearly</option>
                    </select>
                </div>
            </div>

            <div style="position: relative; height: 300px; width: 100%;">
                <canvas id="mainChart"></canvas>
            </div>
        </div>
    </div>

    <div class="mb-10">
        <div class="section-header">
            <span class="section-title">History</span>
        </div>
        <div id="historyList" class="rounded-2xl overflow-hidden shadow-sm bg-white border border-gray-100"></div>
    </div>

    <div class="footer-credit">
        <div>UBE Salary Calculator V3.0</div>
        <div class="mt-1">Developed by Ray Â© 2025</div>
    </div>

<script>
// === Firebase é…ç½® (ä¿æŒåŸæœ‰è¨­å®š) ===
const firebaseConfig = {
    apiKey: "AIzaSyAqiTFbvsIkUVUrBmwaR28448EFMg4FO-w",
    authDomain: "uber-driver-tracker.firebaseapp.com",
    projectId: "uber-driver-tracker", 
    storageBucket: "uber-driver-tracker.appspot.com",
    messagingSenderId: "333010467554",
    appId: "1:333010467554:web:86f6a5067253fa433878b2"
};

let db; 
let firebaseUnsubscribe = null;

if (typeof firebase !== 'undefined' && firebaseConfig.apiKey) {
    firebase.initializeApp(firebaseConfig);
    db = firebase.firestore();
    console.log("Firebase åˆå§‹åŒ–æˆåŠŸã€‚");
} else {
    console.error("Firebase SDK è¼‰å…¥å¤±æ•—æˆ–é…ç½®éŒ¯èª¤ã€‚");
}

// === è®Šæ•¸èˆ‡åˆå§‹åŒ– ===
const workerAPI = "https://ubereat-oil-proxy.leo3026772.workers.dev/";
let globalOilPrice = 30.0;
let currentFilter = 'day';
let chartInstance = null;
let chartType = 'bar'; 

window.onload = async () => {
    loadCollapseStates(); 
    resetEditor();
    loadSettings();
    
    const today = getLocalDateString();
    document.getElementById('filterStart').value = today;
    document.getElementById('filterEnd').value = today;

    const now = new Date();
    document.getElementById('chartStart').value = new Date(now.getFullYear(), 0, 1).toISOString().slice(0,10);
    document.getElementById('chartEnd').value = today;

    if (typeof firebase !== 'undefined' && firebaseConfig.apiKey) {
        firebase.auth().onAuthStateChanged(user => {
            if (user) {
                document.getElementById('userEmailDisplay').innerText = user.email;
                document.getElementById('authPanel').classList.add('hidden');
                document.getElementById('userInfo').classList.remove('hidden');
                setupRealtimeListener(user);
            } else {
                document.getElementById('authPanel').classList.add('hidden');
                document.getElementById('userInfo').classList.add('hidden');
                if (firebaseUnsubscribe) {
                    firebaseUnsubscribe();
                    firebaseUnsubscribe = null;
                }
                refreshDashboard(); 
            }
        });
    } else {
        refreshDashboard();
    }
    await fetchOilPrice();
};

function getLocalDateString() {
    const offset = new Date().getTimezoneOffset() * 60000;
    return new Date(Date.now() - offset).toISOString().split('T')[0];
}

// === V3.0 å‹•ç•«æ”¶åˆ/å±•é–‹é‚è¼¯ ===
function togglePanel(name) {
    const panel = document.getElementById(name + 'Panel');
    const icon = document.getElementById(name + 'Icon');
    const header = document.getElementById(name + 'Header');
    
    // å¦‚æœæ˜¯ auth/settings/charts é€™ç¨®é è¨­éš±è—ä¸”ç„¡ collapse class çš„ï¼Œè¦åˆ‡æ› hidden
    if (name === 'auth' || name === 'settings' || name === 'charts') {
        panel.classList.toggle('hidden');
        if(icon) icon.classList.toggle('rotated');
        return;
    }

    // å°æ–¼æœ‰ collapsible-content class çš„å…ƒç´  (editor, dashboard)
    if (panel.classList.contains('collapsed')) {
        // å±•é–‹
        panel.classList.remove('collapsed');
        if(icon) icon.classList.remove('rotated');
        localStorage.removeItem(name + 'Collapsed');
    } else {
        // æ”¶åˆ
        panel.classList.add('collapsed');
        if(icon) icon.classList.add('rotated');
        localStorage.setItem(name + 'Collapsed', 'true');
    }
}

// è¼‰å…¥ç‹€æ…‹
function loadCollapseStates() {
    // é è¨­ Editor å±•é–‹
    if (localStorage.getItem('editorCollapsed') === 'true') {
        document.getElementById('editorPanel').classList.add('collapsed');
        document.getElementById('editorIcon').classList.add('rotated');
    }
    // é è¨­ Dashboard å±•é–‹
    if (localStorage.getItem('dashboardCollapsed') === 'true') {
        document.getElementById('dashboardPanel').classList.add('collapsed');
        document.getElementById('dashboardIcon').classList.add('rotated');
    }
}

function toggleHistoryDetails(id) {
    const content = document.getElementById(`detail-${id}`);
    const icon = document.getElementById(`icon-detail-${id}`);
    if (content.classList.contains('hidden')) {
        content.classList.remove('hidden');
        icon.style.transform = "rotate(90deg)";
    } else {
        content.classList.add('hidden');
        icon.style.transform = "rotate(0deg)";
    }
}

// === Firebase å¯¦æ™‚ç›£è½ ===
function setupRealtimeListener(user) {
    if (!user || !db) return;
    if (firebaseUnsubscribe) { firebaseUnsubscribe(); firebaseUnsubscribe = null; }
    const userRef = db.collection('records').doc(user.uid);
    firebaseUnsubscribe = userRef.onSnapshot((doc) => {
        if (doc.exists) {
            const cloudList = doc.data().data || [];
            const currentLocalList = getHistory();
            if (JSON.stringify(cloudList) !== JSON.stringify(currentLocalList)) {
                saveToHistory(cloudList); 
                refreshDashboard(); 
            } else {
                refreshDashboard();
            }
        } else {
            const localList = getHistory();
            if (localList.length > 0) uploadHistory(localList, user);
            else refreshDashboard();
        }
    }, (error) => {
        console.error("[Realtime Sync Error]", error);
        refreshDashboard(); 
    });
}

// === Auth Functions ===
function toggleAuthPanel() { 
    const p = document.getElementById('authPanel');
    const h = document.getElementById('authHeader');
    p.classList.toggle('hidden');
    h.classList.toggle('hidden');
}
function registerUser() {
    const email = document.getElementById('authEmail').value;
    const password = document.getElementById('authPassword').value;
    if (email.length < 5 || password.length < 6) return alert("æ ¼å¼éŒ¯èª¤");
    firebase.auth().createUserWithEmailAndPassword(email, password)
        .then(() => document.getElementById('authPanel').classList.add('hidden'))
        .catch(e => alert(e.message));
}
function loginUser() {
    const email = document.getElementById('authEmail').value;
    const password = document.getElementById('authPassword').value;
    firebase.auth().signInWithEmailAndPassword(email, password)
        .then(() => document.getElementById('authPanel').classList.add('hidden'))
        .catch(e => alert(e.message));
}
function logoutUser() {
    if (firebaseUnsubscribe) { firebaseUnsubscribe(); firebaseUnsubscribe = null; }
    firebase.auth().signOut().then(() => {
        localStorage.removeItem('uber_ray_v1');
        document.getElementById('authPanel').classList.add('hidden');
        alert("å·²ç™»å‡ºï¼Œæœ¬åœ°æ•¸æ“šå·²æ¸…é™¤ã€‚");
    });
}
function resetPassword() {
    const email = document.getElementById('authEmail').value;
    if (!email) return alert("è«‹è¼¸å…¥ Email");
    firebase.auth().sendPasswordResetEmail(email).then(() => alert("éƒµä»¶å·²ç™¼é€")).catch(e => alert(e.message));
}
async function uploadHistory(data, user) {
    user = user || firebase.auth().currentUser;
    if (!user || !db) return;
    try {
        await db.collection('records').doc(user.uid).set({
            data: data,
            lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
        });
    } catch (e) { console.error("Upload failed", e); }
}

// === è¨­å®šèˆ‡é è¨­å€¼ ===
function loadSettings() {
    // V3.0 é è¨­å€¼: æ²¹è€— 39, è€—æ 0.7
    document.getElementById('settingFuelRate').value = localStorage.getItem('fuelRate') || 39;
    document.getElementById('settingMaint').value = localStorage.getItem('maintCost') || 0.7;
    document.getElementById('oilType').value = localStorage.getItem('oilType') || '95';
}
function saveSettings() {
    localStorage.setItem('fuelRate', document.getElementById('settingFuelRate').value);
    localStorage.setItem('maintCost', document.getElementById('settingMaint').value);
    localStorage.setItem('oilType', document.getElementById('oilType').value);
    toggleSettings();
    refreshDashboard();
}
function toggleSettings() { 
    document.getElementById('settingsPanel').classList.toggle('hidden'); 
    document.getElementById('settingsHeader').classList.toggle('hidden');
}

async function fetchOilPrice() {
    try {
        const type = document.getElementById('oilType').value;
        const res = await fetch(workerAPI);
        const data = await res.json();
        if(data[type]) {
            globalOilPrice = parseFloat(data[type]);
            document.getElementById('oilPriceDisplay').innerText = `$${globalOilPrice}`;
        }
    } catch(e) { 
        document.getElementById('oilPriceDisplay').innerText = `$${globalOilPrice}`;
    }
}

// === CRUD ===
function getHistory() { try { return JSON.parse(localStorage.getItem('uber_ray_v1') || '[]'); } catch { return []; } }
function saveToHistory(data) { localStorage.setItem('uber_ray_v1', JSON.stringify(data)); }

function saveRecord() {
    const date = document.getElementById('inputDate').value;
    const income = parseFloat(document.getElementById('inputIncome').value);
    const orders = parseFloat(document.getElementById('inputOrders').value);
    const km = parseFloat(document.getElementById('inputDist').value);
    const hr = parseFloat(document.getElementById('inputHr').value) || 0;
    const min = parseFloat(document.getElementById('inputMin').value) || 0;
    const editId = document.getElementById('editId').value;
    const lockedOil = document.getElementById('recordOilPrice').value;

    if(!date) return alert('è«‹é¸æ—¥æœŸ');
    if(isNaN(income) || isNaN(km)) return alert('è«‹å¡«å¯«é‡‘é¡èˆ‡é‡Œç¨‹');

    const finalOil = (editId && lockedOil) ? parseFloat(lockedOil) : globalOilPrice;
    const rec = {
        id: editId ? parseInt(editId) : Date.now(),
        date: date, income: income, orders: orders||0, km: km, hours: hr+(min/60),
        oilPrice: finalOil,
        fuelRate: parseFloat(document.getElementById('settingFuelRate').value),
        maintCost: parseFloat(document.getElementById('settingMaint').value)
    };

    const list = getHistory();
    if(editId) {
        const idx = list.findIndex(r => r.id == editId);
        if(idx!==-1) list[idx] = rec;
    } else {
        list.push(rec);
        if(date === getLocalDateString()) { currentFilter = 'day'; updateTabs(); }
    }
    list.sort((a,b) => new Date(b.date)-new Date(a.date));
    saveToHistory(list);
    uploadHistory(list);
    resetEditor();
}

function loadRecordToEditor(id) {
    const r = getHistory().find(i => i.id === id);
    if(!r) return;
    
    // å±•é–‹ Editor
    const editor = document.getElementById('editorPanel');
    if(editor.classList.contains('collapsed')) togglePanel('editor');
    
    document.getElementById('editId').value = r.id;
    document.getElementById('recordOilPrice').value = r.oilPrice || globalOilPrice;
    document.getElementById('inputDate').value = r.date;
    document.getElementById('inputIncome').value = r.income;
    document.getElementById('inputOrders').value = r.orders;
    document.getElementById('inputDist').value = r.km;
    const h = Math.floor(r.hours);
    document.getElementById('inputHr').value = h;
    document.getElementById('inputMin').value = Math.round((r.hours-h)*60);

    const hint = document.getElementById('editorOilHint');
    hint.classList.remove('hidden');
    hint.innerText = `Locked Oil: $${r.oilPrice||globalOilPrice}`;
    
    document.getElementById('editorPanel').classList.add('card-highlight');
    document.getElementById('btnSave').innerText = "Update Record";
    document.getElementById('btnDelete').classList.remove('hidden');
    document.getElementById('btnCancel').classList.remove('hidden');
    document.getElementById('editorWrapper').scrollIntoView({behavior:'smooth'});
}

function deleteCurrentRecord() {
    const id = document.getElementById('editId').value;
    if (!id) return;
    const list = getHistory();
    const newList = list.filter(r => r.id != id);
    saveToHistory(newList);
    uploadHistory(newList);
    resetEditor();
}

function resetEditor() {
    document.getElementById('editId').value = "";
    document.getElementById('recordOilPrice').value = "";
    document.getElementById('inputDate').value = getLocalDateString();
    document.getElementById('inputIncome').value = "";
    document.getElementById('inputOrders').value = "";
    document.getElementById('inputDist').value = "";
    document.getElementById('inputHr').value = "";
    document.getElementById('inputMin').value = "";
    document.getElementById('editorOilHint').classList.add('hidden');
    document.getElementById('editorPanel').classList.remove('card-highlight');
    document.getElementById('btnSave').innerText = "Save Record";
    document.getElementById('btnDelete').classList.add('hidden');
    document.getElementById('btnCancel').classList.add('hidden');
}

// === ç¯©é¸èˆ‡è¨ˆç®— ===
function updateTabs(btn) {
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    if(btn) btn.classList.add('active');
    else {
        const map = {'day':0, 'week':1, 'month':2, 'year':3, 'all':4, 'custom':5};
        const buttons = document.querySelectorAll('.tab-scroll-content .tab-btn');
        if(buttons[map[currentFilter]]) buttons[map[currentFilter]].classList.add('active');
    }
}
function applyCustomFilter() { if (currentFilter === 'custom') refreshDashboard(); }
function setFilter(type, btn) {
    currentFilter = type;
    updateTabs(btn);
    const customPanel = document.getElementById('customDateFilter');
    if (type === 'custom') customPanel.classList.remove('hidden');
    else { customPanel.classList.add('hidden'); refreshDashboard(); }
}

function getFilteredData() {
    const list = getHistory();
    const todayStr = getLocalDateString();
    if(currentFilter==='day') return list.filter(r=>r.date===todayStr);
    if(currentFilter==='week') {
        const d = new Date();
        const dayOfWeek = (d.getDay() + 6) % 7; 
        const startDate = new Date(d);
        startDate.setDate(d.getDate() - dayOfWeek);
        return list.filter(r => r.date >= startDate.toISOString().split('T')[0]);
    }
    if(currentFilter==='month') return list.filter(r=>r.date.startsWith(todayStr.slice(0,7)));
    if(currentFilter==='year') return list.filter(r=>r.date.startsWith(todayStr.slice(0,4)));
    if(currentFilter==='all') return list;
    if(currentFilter==='custom') {
        const start = document.getElementById('filterStart').value;
        const end = document.getElementById('filterEnd').value;
        return list.filter(r => r.date >= start && r.date <= end);
    }
    return list;
}

function calculateRecordStats(record) {
    const { income, orders, km, hours, oilPrice, fuelRate, maintCost } = record;
    const oilCost = (km / fuelRate) * oilPrice;
    const maintenanceCost = km * maintCost;
    const totalCost = oilCost + maintenanceCost;
    const netProfit = income - totalCost;
    return {
        ...record, oilCost, maintenanceCost, totalCost, netProfit,
        grossHourly: hours > 0 ? income / hours : 0,
        netHourly: hours > 0 ? netProfit / hours : 0,
        grossPerOrder: orders > 0 ? income / orders : 0,
        netPerOrder: orders > 0 ? netProfit / orders : 0
    };
}

function refreshDashboard() {
    const filtered = getFilteredData().map(calculateRecordStats);
    const totals = filtered.reduce((acc, r) => {
        acc.totalIncome += r.income;
        acc.totalCost += r.totalCost;
        acc.netProfit += r.netProfit;
        acc.totalOilCost += r.oilCost;
        acc.totalMaintCost += r.maintenanceCost;
        acc.totalOrders += r.orders;
        acc.totalHours += r.hours;
        return acc;
    }, { totalIncome: 0, totalCost: 0, netProfit: 0, totalOilCost: 0, totalMaintCost: 0, totalOrders: 0, totalHours: 0 });

    const totalGrossHourly = totals.totalHours > 0 ? totals.totalIncome / totals.totalHours : 0;
    const totalNetHourly = totals.totalHours > 0 ? totals.netProfit / totals.totalHours : 0;
    const totalGrossPerOrder = totals.totalOrders > 0 ? totals.totalIncome / totals.totalOrders : 0;
    const totalNetPerOrder = totals.totalOrders > 0 ? totals.netProfit / totals.totalOrders : 0;

    // æ›´æ–°å„€è¡¨æ¿æ•¸æ“š (V1.2.16 å®Œæ•´æ•¸æ“šå›æ­¸)
    document.getElementById('dashTotalIncome').innerText = formatCurrency(totals.totalIncome);
    document.getElementById('dashTotalCost').innerText = formatCurrency(totals.totalCost);
    document.getElementById('dashNetProfit').innerText = formatCurrency(totals.netProfit);
    document.getElementById('dashOilCost').innerText = formatCurrency(totals.totalOilCost);
    document.getElementById('dashMaintCost').innerText = formatCurrency(totals.totalMaintCost);
    document.getElementById('dashOrders').innerText = totals.totalOrders.toFixed(0);
    document.getElementById('dashHours').innerText = Math.floor(totals.totalHours);
    document.getElementById('dashMinutes').innerText = Math.round((totals.totalHours - Math.floor(totals.totalHours)) * 60);
    document.getElementById('dashGrossHourly').innerText = formatCurrency(totalGrossHourly);
    document.getElementById('dashNetHourly').innerText = formatCurrency(totalNetHourly);
    document.getElementById('dashGrossPerOrder').innerText = formatCurrency(totalGrossPerOrder);
    document.getElementById('dashNetPerOrder').innerText = formatCurrency(totalNetPerOrder);

    // æ›´æ–°æ­·å²åˆ—è¡¨ (åŒ…å«è©³ç´°æ•¸æ“š)
    const listHtml = filtered.map(r => `
        <div class="history-item">
            <div class="history-main-area flex justify-between items-center" onclick="loadRecordToEditor(${r.id})">
                <div class="flex-1">
                    <div class="text-xs text-gray-400 font-semibold mb-1">${r.date}</div>
                    <div class="flex items-baseline gap-2">
                        <span class="stat-val-lg text-[#433E3F]">$${formatCurrency(r.income)}</span>
                        <span class="text-xs text-gray-500">ç‡Ÿæ”¶</span>
                    </div>
                </div>
                
                <div class="flex-1 text-center border-l border-r border-gray-100 mx-2 px-2">
                    <div class="text-xs text-gray-400 mb-1">æ·¨åˆ©</div>
                    <div class="text-lg font-bold text-profit">$${formatCurrency(r.netProfit)}</div>
                </div>

                <div class="flex-none flex items-center gap-2">
                    <div class="text-right">
                        <div class="text-xs text-cost">æˆæœ¬ $${formatCurrency(r.totalCost)}</div>
                        <div class="text-[10px] text-gray-400">${r.orders}å–® â€¢ ${r.km}km</div>
                    </div>
                    <span id="icon-detail-${r.id}" class="history-toggle-icon" onclick="event.stopPropagation(); toggleHistoryDetails(${r.id});">â–¶</span>
                </div>
            </div>

            <div id="detail-${r.id}" class="hidden mt-4 pt-4 border-t border-gray-50 text-sm">
                <div class="grid grid-cols-2 gap-y-2 gap-x-4">
                    <div class="flex justify-between">
                        <span class="text-gray-400">å·¥æ™‚</span>
                        <span class="text-gray-700 font-medium">${formatDuration(r.hours)}</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-400">æœªæ‰£æˆæœ¬æ™‚è–ª</span>
                        <span class="text-income font-bold">$${formatCurrency(r.grossHourly)}</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-400">å·²æ‰£æˆæœ¬æ™‚è–ª</span>
                        <span class="text-profit font-bold">$${formatCurrency(r.netHourly)}</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-400">å¹³å‡å–®ç‡Ÿæ”¶</span>
                        <span class="text-income">$${formatCurrency(r.grossPerOrder)}</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-400">å¹³å‡å–®æ·¨åˆ©</span>
                        <span class="text-profit font-bold">$${formatCurrency(r.netPerOrder)}</span>
                    </div>
                    <div class="flex justify-between mt-2 pt-2 border-t border-gray-50 col-span-2">
                        <span class="text-xs text-gray-400">æˆæœ¬çµæ§‹: æ²¹è€— $${formatCurrency(r.oilCost)} / è€—æ $${formatCurrency(r.maintenanceCost)}</span>
                    </div>
                </div>
            </div>
        </div>
    `).join('');
    
    document.getElementById('historyList').innerHTML = listHtml || `
        <div class="p-8 text-center text-gray-400 text-sm bg-white border border-gray-100 rounded-xl">
            ç„¡ç´€éŒ„
        </div>
    `;

    if (!document.getElementById('chartsPanel').classList.contains('hidden')) updateChart();
}

// === æ ¼å¼åŒ– ===
function formatCurrency(num) {
    if (isNaN(num)) return '0';
    return Math.abs(num).toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ",");
}
function formatDuration(h) {
    const hr = Math.floor(h);
    const min = Math.round((h - hr) * 60);
    return `${hr}h ${min}m`.replace('0h ', '').replace(' 0m','');
}

// === åœ–è¡¨ ===
function toggleCharts() {
    document.getElementById('chartsPanel').classList.toggle('hidden');
    document.getElementById('chartsHeader').classList.toggle('hidden');
    if (!document.getElementById('chartsPanel').classList.contains('hidden')) updateChart();
    else destroyChart();
}
function switchChartType(type) {
    chartType = type;
    document.getElementById('btnChartBar').className = type === 'bar' ? "px-3 py-1 text-xs rounded font-bold bg-white text-gray-800 shadow-sm" : "px-3 py-1 text-xs rounded font-bold text-gray-500";
    document.getElementById('btnChartPie').className = type === 'pie' ? "px-3 py-1 text-xs rounded font-bold bg-white text-gray-800 shadow-sm" : "px-3 py-1 text-xs rounded font-bold text-gray-500";
    updateChart();
}
function destroyChart() { if (chartInstance) { chartInstance.destroy(); chartInstance = null; } }

function updateChart() {
    destroyChart();
    const start = document.getElementById('chartStart').value;
    const end = document.getElementById('chartEnd').value;
    const groupBy = document.getElementById('chartGroupBy').value;
    if (!start || !end) return;

    const allData = getHistory().map(calculateRecordStats);
    const chartData = allData.filter(r => r.date >= start && r.date <= end);
    const ctx = document.getElementById('mainChart').getContext('2d');
    
    if (chartData.length === 0) return ctx.clearRect(0,0,300,300);

    let groupedData = {};
    chartData.forEach(r => {
        let label = r.date.slice(5);
        if (groupBy === 'month') label = r.date.slice(0, 7);
        if (groupBy === 'year') label = r.date.slice(0, 4);
        
        if (!groupedData[label]) groupedData[label] = { income: 0, netProfit: 0, cost: 0 };
        groupedData[label].income += r.income;
        groupedData[label].netProfit += r.netProfit;
        groupedData[label].cost += r.totalCost;
    });

    const labels = Object.keys(groupedData).sort();

    if (chartType === 'bar') {
        chartInstance = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [
                    {
                        label: 'æ·¨åˆ©æ½¤',
                        data: labels.map(l => groupedData[l].netProfit),
                        backgroundColor: '#6366F1',
                        borderRadius: 6,
                        barPercentage: 0.6
                    },
                    {
                        label: 'ç¸½æˆæœ¬',
                        data: labels.map(l => groupedData[l].cost),
                        backgroundColor: '#E5E7EB',
                        borderRadius: 6,
                        barPercentage: 0.6
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: { 
                        stacked: true, 
                        grid: { display: false },
                        ticks: { color: '#9CA3AF', font: {size: 10} }
                    },
                    y: { 
                        stacked: true, 
                        beginAtZero: true, 
                        grid: { color: '#F3F4F6', borderDash: [5, 5] },
                        ticks: { color: '#9CA3AF', font: {size: 10} }
                    }
                },
                plugins: {
                    legend: { labels: { color: '#4B5563', font: {size: 11}, usePointStyle: true, boxWidth: 6 } }
                }
            }
        });
    } else {
        const totalProfit = chartData.reduce((s, r) => s + r.netProfit, 0);
        const totalOil = chartData.reduce((s, r) => s + r.oilCost, 0);
        const totalMaint = chartData.reduce((s, r) => s + r.maintenanceCost, 0);
        chartInstance = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: ['æ·¨åˆ©', 'æ²¹è€—', 'è€—æ'],
                datasets: [{
                    data: [totalProfit, totalOil, totalMaint],
                    backgroundColor: ['#6366F1', '#FCD34D', '#EF4444'],
                    borderWidth: 0,
                    hoverOffset: 10
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'right', labels: { color: '#4B5563', usePointStyle: true } }
                }
            }
        });
    }
}
</script>
</body>
</html>
