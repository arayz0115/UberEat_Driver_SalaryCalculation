<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>

    <script src="https://www.gstatic.com/firebasejs/9.1.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.0/firebase-firestore-compat.js"></script>

    <script>
        // --- æ ¸å¿ƒå¸¸æ•¸ (é è¨­å€¼) ---
        const DEFAULT_FUEL_EFFICIENCY_KML = 42;
        const DEFAULT_MAINT_COST_PER_KM = 0.60;
        const GEMINI_API_KEY = "YOUR_GEMINI_API_KEY"; // âš ï¸ æ³¨æ„: æ‚¨å¿…é ˆåœ¨æ­¤è™•å¡«å…¥æ‚¨çš„ Gemini API Key

        // 1. Firebase å°ˆæ¡ˆé…ç½® (å¿…é ˆåœ¨åˆå§‹åŒ–ä¹‹å‰å®šç¾©)
        const FIREBASE_CONFIG = {
            apiKey: "AIzaSyAQiTfbvsIKUVuRBmwaR28448EFMg4F0-w",
            authDomain: "uber-driver-tracker.firebaseapp.com",
            projectId: "uber-driver-tracker",
            storageBucket: "uber-driver-tracker.firebasestorage.app",
            messagingSenderId: "665088105970",
            appId: "1:665088105970:web:d2c73e4e43ee4cf9545f6b"
        };
        const appId = FIREBASE_CONFIG.appId;

        // App æ ¸å¿ƒç‹€æ…‹è®Šæ•¸
        let db = null;
        let auth = null;
        let userId = null;
        let isAuthReady = false;
        let currentOilPrice = 30.0;
        let chartInstance = null; // åœ“é¤…åœ–å¯¦ä¾‹
        let userConfig = {
            fuelEfficiency: DEFAULT_FUEL_EFFICIENCY_KML,
            maintCostPerKm: DEFAULT_MAINT_COST_PER_KM
        };
        let currentViewDate = new Date(); // å ±è¡¨ç€è¦½åŸºæº–æ—¥
        let currentReportPeriod = 'day';
        const initialAuthToken = null; // å¦‚æœæ‚¨æœ‰è‡ªå®šç¾©èªè­‰ï¼Œè«‹åœ¨é€™è£¡è¨­å®š

        // å·¥å…·å‡½æ•¸
        const configDocPath = (uid) => `artifacts/${appId}/users/${uid}/config/costs`;

        // å¿…é ˆå®šç¾©åœ¨ try å€å¡Šä¹‹å¤–ï¼Œå› ç‚º try å€å¡Šå…§ä½¿ç”¨çš„æ˜¯æ¨¡çµ„åŒ–çš„ getFirestore()
        // è€Œå¤–éƒ¨å‡½æ•¸å¿…é ˆä½¿ç”¨å…¼å®¹æ¨¡å¼çš„ db.collection()
        const setLogLevel = (level) => { /* å…¼å®¹æ¨¡å¼ä¸‹ setLogLevel ç„¡æ•ˆï¼Œç•¥é */ };


        // --- Firebase åˆå§‹åŒ–èˆ‡èªè­‰ (ä½¿ç”¨ -compat æ¨¡å¼) ---
        try {
            // 38: åˆå§‹åŒ– Firebase App
            const app = firebase.initializeApp(FIREBASE_CONFIG);
            
            // 35 & 36: åˆå§‹åŒ– db å’Œ auth è®Šæ•¸ (ä½¿ç”¨ -compat å…¨åŸŸå­˜å–æ–¹æ³•)
            db = app.firestore();
            auth = app.auth();
            window.db = db; // ç‚ºäº†è®“å¤–éƒ¨å‡½æ•¸ä¹Ÿèƒ½å­˜å–
            
            // ç›£è½èªè­‰ç‹€æ…‹
            auth.onAuthStateChanged(async (user) => {
                if (user) {
                    userId = user.uid;
                    isAuthReady = true;
                    document.getElementById('loading-overlay').classList.add('hidden');
                    document.getElementById('user-info').textContent = `ID: ${userId}`;
                    window.userId = userId;
                    
                    await loadConfig();
                    await fetchOilPrice(true); // é¦–æ¬¡è¼‰å…¥æ™‚è‡ªå‹•ç²å–æ²¹åƒ¹
                    window.initApp();
                    
                } else if (!isAuthReady) {
                    if (initialAuthToken) {
                        await auth.signInWithCustomToken(initialAuthToken); // ä¿®æ­£ç‚º compat èªæ³•
                    } else {
                        await auth.signInAnonymously(); // ä¿®æ­£ç‚º compat èªæ³•
                    }
                }
            });
        } catch (error) {
            console.error("Firebase åˆå§‹åŒ–å¤±æ•—:", error);
            document.getElementById('loading-text').textContent = "é›²ç«¯åˆå§‹åŒ–å¤±æ•—ï¼Œè«‹æª¢æŸ¥è¨­å®šã€‚";
        }


        // --- è¨­å®šæª”è®€å¯« ---
        async function loadConfig() {
            if (!db || !userId) return;

            // ä¿®æ­£ï¼šåœ¨ compat æ¨¡å¼ä¸‹ï¼Œä½¿ç”¨ db.collection/doc/onSnapshot
            db.doc(configDocPath(userId)).onSnapshot((docSnap) => {
                if (docSnap.exists) {
                    const data = docSnap.data();
                    userConfig.fuelEfficiency = data.fuelEfficiency || DEFAULT_FUEL_EFFICIENCY_KML;
                    userConfig.maintCostPerKm = data.maintCostPerKm || DEFAULT_MAINT_COST_PER_KM;
                }
                updateConfigUI();
                liveCalculate();
            }, (error) => {
                console.error("è¼‰å…¥é…ç½®å¤±æ•—:", error);
                updateConfigUI();
            });
        }

        window.saveConfig = async function() {
            if (!db || !userId) {
                showMessage("é›²ç«¯å°šæœªé€£ç·šã€‚", 'error');
                return;
            }
            
            const fuel = parseFloat(document.getElementById('fuelEfficiencyInput').value);
            const maint = parseFloat(document.getElementById('maintCostInput').value);

            if (isNaN(fuel) || isNaN(maint) || fuel <= 0 || maint < 0) {
                showMessage("è«‹è¼¸å…¥æœ‰æ•ˆçš„åƒæ•¸å€¼ã€‚", 'error');
                updateConfigUI();
                return;
            }

            userConfig.fuelEfficiency = fuel;
            userConfig.maintCostPerKm = maint;

            try {
                // ä¿®æ­£ï¼šåœ¨ compat æ¨¡å¼ä¸‹ï¼Œä½¿ç”¨ db.doc().set()
                await db.doc(configDocPath(userId)).set(userConfig, { merge: true });
                showMessage("è¨­å®šå·²å„²å­˜åˆ°é›²ç«¯ï¼", 'success');
                liveCalculate();
            } catch (e) {
                console.error("å„²å­˜é…ç½®å¤±æ•—:", e);
                showMessage("å„²å­˜è¨­å®šåˆ°é›²ç«¯å¤±æ•—", 'error');
            }
        }

        function updateConfigUI() {
            document.getElementById('fuelEfficiencyInput').value = userConfig.fuelEfficiency;
            document.getElementById('maintCostInput').value = userConfig.maintCostPerKm;
            document.getElementById('fuelEfficiencyDisplay').textContent = `${userConfig.fuelEfficiency} km/L`;
            document.getElementById('maintCostDisplay').textContent = `$${userConfig.maintCostPerKm.toFixed(2)}/km`;
        }

        /**
         * è¼”åŠ©å‡½æ•¸ï¼šå°‡å°æ•¸æ™‚æ•¸è½‰æ›ç‚º H å°æ™‚ M åˆ†é˜æ ¼å¼
         * @param {number} decimalHours - ç¸½å°æ™‚æ•¸ (å«å°æ•¸, e.g., 8.5)
         * @returns {string} - H å°æ™‚ M åˆ†é˜ (e.g., "8 å°æ™‚ 30 åˆ†")
         */
        function formatHours(decimalHours) {
            if (isNaN(decimalHours) || decimalHours === 0) return '0 å°æ™‚ 0 åˆ†';
            const hours = Math.floor(decimalHours);
            const minutes = Math.round((decimalHours - hours) * 60);
            return `${hours} å°æ™‚ ${minutes} åˆ†`;
        }
        
        // --- å³æ™‚è¨ˆç®—åŠŸèƒ½ ---
        window.liveCalculate = function() {
            // è®€å–è¼¸å…¥å€¼
            const income = parseFloat(document.getElementById('income').value) || 0;
            const km = parseFloat(document.getElementById('mileage').value) || 0;
            const hours = parseFloat(document.getElementById('hours').value) || 0;
            const minutes = parseFloat(document.getElementById('minutes').value) || 0;
            const totalHours = hours + (minutes / 60);

            const fuelEff = userConfig.fuelEfficiency || DEFAULT_FUEL_EFFICIENCY_KML;
            const maintCostPerKm = userConfig.maintCostPerKm || DEFAULT_MAINT_COST_PER_KM;

            // æˆæœ¬è¨ˆç®—
            const gasCost = (km / fuelEff) * currentOilPrice;
            const maintCost = km * maintCostPerKm;
            const totalCost = gasCost + maintCost;
            const netProfit = income - totalCost;

            // æ™‚è–ªè¨ˆç®—
            let grossHourlyRate = 0;
            let netHourlyRate = 0;
            if (totalHours > 0) {
                grossHourlyRate = income / totalHours;
                netHourlyRate = netProfit / totalHours;
            }

            // æ›´æ–° UI æ•¸å€¼
            document.getElementById('liveGrossIncome').textContent = `$${income.toFixed(1)}`;
            document.getElementById('liveGasCost').textContent = `$${gasCost.toFixed(1)}`;
            document.getElementById('liveMaintCost').textContent = `$${maintCost.toFixed(1)}`;
            document.getElementById('liveNetProfit').textContent = `$${netProfit.toFixed(1)}`;
            document.getElementById('liveTotalCost').textContent = `$${totalCost.toFixed(1)}`;

            // æ™‚è–ªé¡¯ç¤º
            document.getElementById('liveGrossHourly').textContent = `$${grossHourlyRate.toFixed(1)}/hr`;
            document.getElementById('liveNetHourly').textContent = `$${netHourlyRate.toFixed(1)}/hr`;

            // èª¿æ•´æ·¨åˆ©é¡è‰²
            document.getElementById('liveNetProfit').classList.toggle('net-profit', netProfit >= 0);
            document.getElementById('liveNetProfit').classList.toggle('cost-val', netProfit < 0);
            document.getElementById('liveNetHourly').classList.toggle('net-profit', netHourlyRate >= 0);
            document.getElementById('liveNetHourly').classList.toggle('cost-val', netHourlyRate < 0);
        }

        // --- å‹•æ…‹æ²¹åƒ¹ç²å– (ä½¿ç”¨ Google Search) ---
        window.fetchOilPrice = async function(isInitial = false) {
            const button = document.getElementById('fetchOilPriceButton');
            const display = document.getElementById('oilPriceDisplay');
            
            // ä¿®æ­£ï¼šæª¢æŸ¥ API Key
            if (GEMINI_API_KEY === "YOUR_GEMINI_API_KEY") {
                console.error("è«‹åœ¨ç¨‹å¼ç¢¼ä¸­è¨­å®š GEMINI_API_KEY!");
                display.textContent = `$${currentOilPrice.toFixed(2)}/L (API Key éºå¤±)`;
                showMessage("âŒ Gemini API Key éºå¤±ï¼Œè«‹ä¿®æ­£ç¨‹å¼ç¢¼ã€‚", 'error');
                liveCalculate();
                return;
            }

            button.disabled = true;
            display.textContent = 'ç²å–ä¸­...';

            // ... (æ‚¨çš„æ²¹åƒ¹ API å‘¼å«é‚è¼¯ï¼Œä¿æŒä¸è®Š) ...
            const userQuery = "å°ç£ä¸­æ²¹ 92 ç„¡é‰›æ±½æ²¹ ä»Šæ—¥æ¯å…¬å‡åƒ¹æ ¼ï¼Œåªéœ€è¦çµ¦æˆ‘æ•¸å­—ï¼Œä¸è¦ä»»ä½•æ–‡å­—ã€ç¬¦è™Ÿæˆ–å–®ä½ã€‚";
            const apiKey = GEMINI_API_KEY // ğŸ‘ˆ ä½¿ç”¨å®šç¾©çš„å¸¸æ•¸
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                tools: [{ "google_search": {} }],
            };
            
            try {
                let response = null;
                let result = null;
                let retries = 0;
                const maxRetries = 3;

                while (retries < maxRetries) {
                    const delay = Math.pow(2, retries) * 1000;
                    if (retries > 0) await new Promise(resolve => setTimeout(resolve, delay));

                    response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (response.ok) {
                        result = await response.json();
                        break;
                    }
                    retries++;
                }
                
                if (!response.ok || !result) throw new Error("API å‘¼å«å¤±æ•—æˆ–çµæœç‚ºç©ºï¼Œå·²é”æœ€å¤§é‡è©¦æ¬¡æ•¸ã€‚");

                const text = result.candidates?.[0]?.content?.parts?.[0]?.text || '';
                
                // å¼·åŒ–è§£æï¼šæå–æ–‡æœ¬ä¸­æ‰€æœ‰æ•¸å­—å’Œå°æ•¸é»ï¼Œçµ„æˆä¸€å€‹æ•¸å­—
                const priceMatch = text.match(/[\d.]+/g);
                const price = priceMatch ? parseFloat(priceMatch.join('')) : NaN;
                
                if (!isNaN(price) && price > 0) {
                    currentOilPrice
